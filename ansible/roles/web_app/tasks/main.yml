---
- name: Perform Wipe
  when: web_app_full_wipe | default(false) | bool
  import_tasks: 0-wipe.yml
  tags:
    - wipe

- name: Deploy Web Application
  block:
    - name: Ensure Web App Directory Exists
      file:
        path: "{{ web_app_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Generate docker-compose.yml file from template
      template:
        src: docker-compose.yml.j2
        dest: "{{ web_app_dir }}/docker-compose.yml"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'

    - name: Pull the latest Docker image
      docker_image:
        name: "{{ docker_image }}"
        tag: "{{ docker_image_tag }}"
        source: pull
    - name: Ensure Docker service is running
      service:
        name: docker
        enabled: true
        state: started

    - name: Create and start the services
      community.docker.docker_compose_v2:
        project_src: "{{ web_app_dir }}"
        remove_orphans: true
        state: present

#    - name: Run the Web App container
#      docker_container:
#        name: "{{ web_app_name }}"
#        image: "{{ docker_image }}"
#        state: started
#        restart_policy: always
#        ports:
#          - "{{ web_app_external_port }}:{{ web_app_internal_port }}"
  tags:
    - deploy

