# Web Application Deployment Role

This role deploys a web application using its Docker image and Docker Compose. It pulls the latest image, renders a Docker Compose configuration, and starts the application container. Additionally, it supports wipe logic for removing existing deployments and leverages best practices such as task grouping, role dependencies, and tagging.

## Requirements

- **Ansible:** Version 2.9 or later.
- **Docker:** Must be installed and configured on the target host (this role depends on the `docker` role).
- **Target System:** A Linux-based host (or WSL for local testing).

## Role Variables

The following variables can be set to customize the deployment:

- `docker_image`:  
  The Docker image to deploy.  
  **Default:** `"sedoxxx/python-webapp:latest"`

- `app_port`:  
  The host port to bind the application container’s port 80.  
  **Default:** `8080`

- `web_app_full_wipe`:  
  Boolean to control whether to execute wipe logic (stop and remove the container and temporary files).  
  **Default:** `true`

## Role Structure

The role is organized as follows (some directories are irrelevant for our lab they were generated by **ansible-galaxy**):

```plaintext
roles/web_app/
├── defaults
│   └── main.yml         # Default variables (e.g., docker_image, app_port, web_app_full_wipe)
├── handlers
│   └── main.yml         # Handlers (e.g., to restart services)
├── meta
│   └── main.yml         # Role dependencies (e.g., depends on the docker role)
├── tasks
│   ├── 0-wipe.yml       # Tasks to wipe existing deployments (triggered by a variable and tag 'wipe')
│   └── main.yml         # Main tasks to deploy the application container (grouped into blocks with tags)
├── templates
│   └── docker-compose.yml.j2  # Jinja2 template for the Docker Compose configuration
└── README.md            # This documentation file
```

## Example Playbook

Below is an example playbook that uses this role:

```yaml
- hosts: all
  become: true
  roles:
    - web_app
```

For separate application deployments (e.g., Python or Node.js), you can create dedicated playbooks in `ansible/playbooks/dev/app_python/main.yaml` and `ansible/playbooks/dev/app_nodejs/main.yaml`.

## Usage

1. **Set Up Inventory:**  
   Create an inventory file (e.g., `ansible/inventory/default_local.yml` for local deployment).

2. **Run the Playbook:**  
   Execute the playbook to deploy your application:
   ```bash
   ansible-playbook ansible/playbooks/dev/main.yaml -i ansible/inventory/default_local.yml
   ```

3. **Selective Execution Using Tags:**  
   To run only specific tasks, use tags:
   - Pull Docker image:  
     ```bash
     ansible-playbook ... --tags docker
     ```
   - Execute wipe logic:  
     ```bash
     ansible-playbook ... --tags wipe
     ```

4. **Wipe Deployment (Optional):**  
   To remove the application container and related files, set the variable `web_app_full_wipe=true` (either in your inventory or as an extra-var) and run the playbook with the `wipe` tag:
   ```bash
   ansible-playbook ansible/playbooks/dev/main.yaml -i inventory/default_local.yml --extra-vars "web_app_full_wipe=true" --tags wipe
   ```

5. **Verify Deployment:**  
   After the playbook runs, verify that:
   - The Docker image was pulled successfully.
   - The Docker Compose file was generated at `/tmp/docker-compose.yml`.
   - The container is running (e.g., via `docker ps`).

## Additional Information

- **Best Practices Applied:**
  - **Task Grouping:** Tasks are grouped using blocks to logically separate image pulling, configuration templating, and container startup.
  - **Role Dependency:** The role depends on the `docker` role to ensure Docker is installed.
  - **Tagging:** Tasks are tagged (`docker`, `compose`, `deploy`, and `wipe`) for selective execution.
  - **Wipe Logic:** A separate task file and tag allow you to easily remove deployed containers.
  - **Templating:** A Jinja2 template is used for flexible Docker Compose configuration.
  
---
