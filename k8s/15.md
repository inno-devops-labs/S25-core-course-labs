# Lab 15

## Task 1

### Main components

- **Prometheus** is like system’s data collector and storage brain. Its main job is to regularly go out and pull in
  metrics data from various sources (this is called “scraping”), store that data over time, and allow users to ask
  questions about it using its own query language, PromQL.
- **Alertmanager**  is like thing that catches all alerts from *Prometheus*. t takes in alerts from Prometheus, cleans
  them up by removing duplicates, organizes them into logical groups, and then makes sure the right people (or systems)
  get notified in the right way — whether by email or another channel.
- **Grafana** is all about visual details. It’s a dashboard tool that connects to Prometheus (and other data sources) to
  let users create charts, graphs, and dashboards. Using Grafana we can see trends, spot issues and understand the
  system performance.
- **Noded exporter** - tool for *Prometheus* which gives visibility into the hardware and os stats of the machine
  in the *Kubernetes* cluster. It reports basic metrics like CPU usage, memory usage, disk activity, and network
  stats - basic stuff for understanding how machine is going.
- **kube-state-metrics** provides data about the status of deployments, how many pods are running, what resources are
  being requested vs. actually used, and so on — basically, insights into the state of your Kubernetes objects.
- **Prometheus operator** helps manage Prometheus setups in *Kubernetes*. Using it we can easily deploy without
  configuring *Prometheus* instances.
- **Pushgateway** is useful when we have short-lived jobs that we need to push metrics to *Prometheus*
- **Thanos / Cortex** are add-ons that extend *Prometheus* with long-term storage. It is useful for
  multi-cluster environments.

### Commands outputs

For the command `kubectl get po,sts,svc,pvc,cm -n monitoring`
The output is following:

```bash

NAME                                                         READY   STATUS    RESTARTS   AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0          3m56s
pod/monitoring-grafana-8df5cd697-ddlkl                       3/3     Running   0          4m16s
pod/monitoring-kube-prometheus-operator-56d9c87df7-vtjft     1/1     Running   0          4m16s
pod/monitoring-kube-state-metrics-5c4748cd88-d54fp           1/1     Running   0          4m16s
pod/monitoring-prometheus-node-exporter-9qjss                1/1     Running   0          4m16s
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0          3m56s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     3m56s
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     3m56s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   3m56s
service/monitoring-grafana                        ClusterIP   10.106.127.235   <none>        80/TCP                       4m16s
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.108.115.173   <none>        9093/TCP,8080/TCP            4m16s
service/monitoring-kube-prometheus-operator       ClusterIP   10.111.20.110    <none>        443/TCP                      4m16s
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.104.118.224   <none>        9090/TCP,8080/TCP            4m16s
service/monitoring-kube-state-metrics             ClusterIP   10.102.84.152    <none>        8080/TCP                     4m16s
service/monitoring-prometheus-node-exporter       ClusterIP   10.96.229.242    <none>        9100/TCP                     4m16s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     3m56s

NAME                                                                     DATA   AGE
configmap/kube-root-ca.crt                                               1      4m43s
configmap/monitoring-grafana                                             1      4m16s
configmap/monitoring-grafana-config-dashboards                           1      4m16s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      4m16s
configmap/monitoring-kube-prometheus-apiserver                           1      4m16s
configmap/monitoring-kube-prometheus-cluster-total                       1      4m16s
configmap/monitoring-kube-prometheus-controller-manager                  1      4m16s
configmap/monitoring-kube-prometheus-etcd                                1      4m16s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      4m16s
configmap/monitoring-kube-prometheus-grafana-overview                    1      4m16s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      4m16s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      4m16s
configmap/monitoring-kube-prometheus-kubelet                             1      4m16s
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      4m16s
configmap/monitoring-kube-prometheus-namespace-by-workload               1      4m16s
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      4m16s
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      4m16s
configmap/monitoring-kube-prometheus-nodes                               1      4m16s
configmap/monitoring-kube-prometheus-nodes-darwin                        1      4m16s
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      4m16s
configmap/monitoring-kube-prometheus-pod-total                           1      4m16s
configmap/monitoring-kube-prometheus-prometheus                          1      4m16s
configmap/monitoring-kube-prometheus-proxy                               1      4m16s
configmap/monitoring-kube-prometheus-scheduler                           1      4m16s
configmap/monitoring-kube-prometheus-workload-total                      1      4m16s
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   35     3m56s
```

### Explanation of kubectl get po,sts,svc,pvc,cm Output

**Pods (po)**:

- alertmanager-monitoring-kube-prometheus-alertmanager-0: Runs Alertmanager for alert handling (2/2 containers ready).
- monitoring-grafana-8df5cd697-ddlkl: Runs Grafana for visualization (3/3 containers ready).
- monitoring-kube-prometheus-operator-56d9c87df7-vtjft: Runs the Prometheus Operator to manage monitoring resources (1/1
  ready).
- monitoring-kube-state-metrics-5c4748cd88-d54fp: Runs kube-state-metrics to generate metrics about Kubernetes object
  states (1/1 ready).
- monitoring-prometheus-node-exporter-9qjss: Runs node-exporter on the node to collect host metrics (1/1 ready).
- prometheus-monitoring-kube-prometheus-prometheus-0: Runs the main Prometheus instance for scraping and storing
  metrics (2/2 containers ready).

All monitoring pods are in a Running state, indicating a healthy deployment of the Kube Prometheus Stack.

**StatefulSets (sts)**:

- alertmanager-monitoring-kube-prometheus-alertmanager: Manages the Alertmanager pod. (1/1 replica ready).
- prometheus-monitoring-kube-prometheus-prometheus: Manages the Prometheus pod. (1/1 replica ready).

StatefulSets provide stable identities and potentially stable storage for these core monitoring components.

**Services (svc)**:

- alertmanager-operated, prometheus-operated: Internal headless services for operator communication.
- monitoring-grafana, monitoring-kube-prometheus-alertmanager, monitoring-kube-prometheus-prometheus: ClusterIP services
  exposing the UIs/APIs for Grafana, Alertmanager, and Prometheus respectively. These are used with minikube service.
- monitoring-kube-prometheus-operator, monitoring-kube-state-metrics, monitoring-prometheus-node-exporter: ClusterIP
  services exposing metrics endpoints for the operator, kube-state-metrics, and node-exporter.

**PersistentVolumeClaims (pvc)**:

- None listed in the output for the monitoring namespace. This implies the default configuration for this specific chart
  version (or your installation values) might be using emptyDir volumes for Prometheus/Alertmanager data, meaning data
  would be lost on pod deletion/restart. Alternatively, PVCs might exist but were filtered out; confirm with kubectl get
  pvc -n monitoring.

**ConfigMaps (cm)**:

- Numerous ConfigMaps (monitoring-grafana*, monitoring-kube-prometheus-*,
  prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0) store configurations, default dashboards, Prometheus
  rules, and other settings for the monitoring stack.
- kube-root-ca.crt: Standard ConfigMap containing the cluster's root CA certificate.

For the command `kubectl get po,sts,svc,pvc,cm -n default`
Output:

```bash

NAME                                         READY   STATUS             RESTARTS   AGE
pod/app-0                                    0/1     ImagePullBackOff   0          8d
pod/my-app-86469ff4c-v6cvl                   0/1     ErrImagePull       0          72s
pod/post-install-hook                        0/1     Completed          0          72s
pod/pre-install-hook                         0/1     Completed          0          2m43s
pod/python-app-deployment-7b4f65774c-2srcw   0/1     ImagePullBackOff   0          9d

NAME                   READY   AGE
statefulset.apps/app   0/3     8d

NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/app-my-app          ClusterIP   10.109.7.57     <none>        80/TCP    8d
service/kubernetes          ClusterIP   10.96.0.1       <none>        443/TCP   9d
service/my-app              ClusterIP   10.99.39.186    <none>        80/TCP    72s
service/python-app-my-app   ClusterIP   10.109.91.123   <none>        80/TCP    9d

NAME                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-app-0   Bound    pvc-5a55270b-da68-42d0-a999-ffae95e825a7   1Gi        RWO            standard       <unset>                 8d

NAME                          DATA   AGE
configmap/app-config          1      8d
configmap/kube-root-ca.crt    1      9d
configmap/python-app-config   1      9d
```

default Namespace Output:

(This namespace contains multiple applications with some issues)

**Pods (po)**:

- app-0: A pod belonging to the app StatefulSet. It is in ImagePullBackOff status, indicating a persistent failure to
  pull its container image. (0/1 ready).
- my-app-86469ff4c-v6cvl: A pod belonging to the my-app Deployment. It is in ErrImagePull status, also indicating a
  failure to pull its container image. (0/1 ready).
- post-install-hook, pre-install-hook: Helm hook pods that ran successfully (Completed) during an installation process (
  likely for my-app).
- python-app-deployment-7b4f65774c-2srcw: A pod belonging to the python-app-deployment. It is also in ImagePullBackOff
  status. (0/1 ready).

Unfortunately, none of the application pods (app-0, my-app-*, python-app-*) are running successfully due to image pull
errors. This is because problems with docker

**StatefulSets (sts)**:

- app: A StatefulSet named app, intended to manage 3 replicas, but currently has 0 ready due to the image pull issues
  with its pods (like app-0).

**Services (svc)**:

- app-my-app: A ClusterIP service intended to expose the application managed by the app StatefulSet.
- kubernetes: The default Kubernetes API service.
- my-app: A ClusterIP service intended to expose the application managed by the my-app Deployment.

**PersistentVolumeClaims (pvc)**:

- data-app-0: A PVC requesting 1Gi of storage, successfully Bound to a PersistentVolume. This PVC is associated with the
  app-0 pod managed by the app StatefulSet, providing persistent storage for that specific pod instance.

**ConfigMaps (cm)**:

- app-config: Contains configuration data used by the app StatefulSet/pods.
- kube-root-ca.crt: Standard ConfigMap containing the cluster's root CA certificate.
- python-app-config: Contains configuration data used by the python-app-deployment/pods.


### Exploring data in Grafana

**CPU and memory consumption of StatefulSet**
- Dashboard: Kubernetes / Compute Resources / Workload
- Workload: StatefulSet app
- Namespace: default
- Pod: app-0
- CPU Usage: 0.2 millicores (due to ImagePullBackOff)
- Memory Usage: 3.1 MiB

**Pods with higher/lower CPU usage (default namespace)**
- Dashboard: Kubernetes / Compute Resources / Namespace (Pods)
- Highest CPU usage pod: monitoring-prometheus-node-exporter-9qjss – 28 millicores
- Lowest CPU usage pod: python-app-deployment-7b4f65774c-2srcw – 0.1 millicores
Others:
- my-app-86469ff4c-v6cvl: 0.0 millicores (ErrImagePull)
- post-install-hook: 0.0 millicores (completed)
- pre-install-hook: 0.0 millicores (completed)

**Node memory usage (% and MB)**
- Dashboard: Kubernetes / Compute Resources / Node (Exporter)
- Node: minikube
- Memory Usage:
- Percentage: 69%
- Absolute: 2.76 GiB / 4.0 GiB

**Number of Pods and Containers (Kubelet)**
- Dashboard: Kubernetes / Kubelet
- Running Pods: 7 (all in monitoring namespace)
- Running Containers: 11

**Network Usage of Pods (default namespace)**
- Dashboard: Kubernetes / Compute Resources / Namespace (Pods)
- Network I/O (bytes/sec):
  - app-0: 0 B/s rx, 0 B/s tx 
  - my-app-86469ff4c-v6cvl: 10 B/s rx, 6 B/s tx
  - python-app-deployment-7b4f65774c-2srcw: 0 B/s rx, 0 B/s tx

**Number of Active Alerts**
- Dashboard: Kubernetes / Compute Resources / Cluster
- Active alerts (Firing): 4
- Firing alerts:
  - Watchdog – Always firing (sanity check)
  - KubePodCrashLooping – app-0
  - KubePodImagePullBackOff – my-app, python-app
  - KubeStatefulSetReplicasMismatch – app

## Task 2

The output of the `kubectl exec pod/demo-0 -- cat /demo/test.html`
is the following:
```bash

Defaulted container "main" out of: main, init-downloader (init)
<!doctype html>
<html>
<head>
    <title>Example Domain</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
    body {
        background-color: #f0f0f2;
        margin: 0;
        padding: 0;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
        
    }
    div {
        width: 600px;
        margin: 5em auto;
        padding: 2em;
        background-color: #fdfdff;
        border-radius: 0.5em;
        box-shadow: 2px 3px 7px 2px rgba(0,0,0,0.02);
    }
    a:link, a:visited {
        color: #38488f;
        text-decoration: none;
    }
    @media (max-width: 700px) {
        div {
            margin: 0 auto;
            width: auto;
        }
    }
    </style>    
</head>

<body>
<div>
    <h1>Example Domain</h1>
    <p>This domain is for use in illustrative examples in documents. You may use this
    domain in literature without prior coordination or asking for permission.</p>
    <p><a href="https://www.iana.org/domains/example">More information...</a></p>
</div>
</body>
</html>
```


## Bonus

Since my app is not starting of ImagePullBackOff (docker problems) i have this:

`kubectl get pods`
```bash

NAME                                     READY   STATUS             RESTARTS   AGE
app-0                                    0/1     ImagePullBackOff   0          9d
demo-0                                   1/1     Running            0          5m49s
my-app-86469ff4c-v6cvl                   0/1     ImagePullBackOff   0          3h10m
post-install-hook                        0/1     Completed          0          3h10m
pre-install-hook                         0/1     Completed          0          3h11m
python-app-deployment-7b4f65774c-2srcw   0/1     ImagePullBackOff   0          9d
```


`kubectl port-forward pod/my-app-86469ff4c-v6cvl 8000:8000`
```bash

error: unable to forward port because pod is not running. Current status=Pending

```
