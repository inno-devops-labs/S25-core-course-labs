# Lab 15: Kubernetes Monitoring and Init Containers


## Task 1: Kubernetes Cluster Monitoring with Prometheus

### 1. Preliminary Checks

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % minikube status

minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

(venv) louayfarah@Louays-MacBook-Pro k8s % minikube --version
Error: unknown flag: --version
See 'minikube --help' for usage.
(venv) louayfarah@Louays-MacBook-Pro k8s % minikube version
minikube version: v1.35.0
commit: dd5d320e41b5451cdf3c01891bc4e13d189586ed

(venv) louayfarah@Louays-MacBook-Pro k8s % helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

"prometheus-community" already exists with the same configuration, skipping
(venv) louayfarah@Louays-MacBook-Pro k8s % helm repo update

Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "argo" chart repository
...Successfully got an update from the "prometheus-community" chart repository
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈
(venv) louayfarah@Louays-MacBook-Pro k8s % 
```

### 2. Describing Components


1. **Prometheus**  
   - A time-series database and monitoring engine.  
   - Scrapes metrics from Kubernetes pods, nodes, and other services through endpoints defined by the Prometheus Operator.  
   - Stores collected metrics for real-time alerts and historical analysis.

2. **Alertmanager**  
   - Receives alerts from Prometheus based on specific rule definitions.  
   - Handles alert **grouping**, **routing**, and **silencing**, ensuring organized and efficient alert management.

3. **Grafana**  
   - A visualization platform for viewing and analyzing metrics scraped by Prometheus.  
   - Includes **pre-built Kubernetes dashboards**, showing CPU/memory usage, network I/O, node health, etc.  
   - Allows custom dashboards for personalized application metrics.

4. **Node Exporter**  
   - Daemon that runs on each node to gather **OS-level metrics** (CPU, memory, disk usage).  
   - These metrics are essential for identifying system resource bottlenecks and diagnosing node-level issues.

5. **Kube State Metrics**  
   - Monitors the **state** of Kubernetes objects—Pods, Deployments, Nodes, etc.—and exposes these states as metrics.  
   - Focuses on high-level cluster resource statuses rather than OS metrics, complementing Node Exporter.

6. **Prometheus Operator**  
   - A Kubernetes Operator that simplifies the **deployment** and **management** of Prometheus, Alertmanager, and related custom resources (like `ServiceMonitor`).  
   - Ensures Prometheus is automatically reconfigured as new metrics endpoints or changes appear in your cluster.


> **To be done!**  
> Describe how Prometheus, Alertmanager, Grafana, Node Exporter, Kube State Metrics, and Prometheus Operator work in the Kube Prometheus Stack.

### 3. Installing Helm Charts

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl create namespace monitoring

namespace/monitoring created

(venv) louayfarah@Louays-MacBook-Pro k8s % helm install monitoring prometheus-community/kube-prometheus-stack \
  --version 57.2.0 \
  --namespace monitoring

NAME: monitoring
LAST DEPLOYED: Thu Apr 10 23:16:50 2025
NAMESPACE: monitoring
STATUS: deployed
REVISION: 1
NOTES:
kube-prometheus-stack has been installed. Check its status by running:
  kubectl --namespace monitoring get pods -l "release=monitoring"

Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create & configure Alertmanager and Prometheus instances using the Operator.
```

**Installing the FastAPI App**:

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % helm upgrade --install fastapi-release fastapi-app         
Release "fastapi-release" has been upgraded. Happy Helming!
NAME: fastapi-release
LAST DEPLOYED: Thu Apr 10 23:23:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=fastapi-app,app.kubernetes.io/instance=fastapi-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### 4. `kubectl get po,sts,svc,pvc,cm` Outputs

#### 4.1 Monitoring Namespace

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl get po,sts,svc,pvc,cm -n monitoring

NAME                                                         READY   STATUS    RESTARTS   AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0          5m25s
pod/monitoring-grafana-8df5cd697-bsvf4                       3/3     Running   0          7m13s
pod/monitoring-kube-prometheus-operator-56d9c87df7-9s6p6     1/1     Running   0          7m13s
pod/monitoring-kube-state-metrics-5c4748cd88-7q4th           1/1     Running   0          7m13s
pod/monitoring-prometheus-node-exporter-qqrd8                1/1     Running   0          7m13s
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0          5m25s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     5m26s
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     5m25s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   5m26s
service/monitoring-grafana                        ClusterIP   10.104.165.0     <none>        80/TCP                       7m13s
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.97.130.104    <none>        9093/TCP,8080/TCP            7m13s
service/monitoring-kube-prometheus-operator       ClusterIP   10.110.132.36    <none>        443/TCP                      7m13s
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.101.79.77     <none>        9090/TCP,8080/TCP            7m13s
service/monitoring-kube-state-metrics             ClusterIP   10.104.225.138   <none>        8080/TCP                     7m13s
service/monitoring-prometheus-node-exporter       ClusterIP   10.98.56.199     <none>        9100/TCP                     7m13s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     5m25s

NAME                                                                     DATA   AGE
configmap/kube-root-ca.crt                                               1      7m51s
configmap/monitoring-grafana                                             1      7m13s
configmap/monitoring-grafana-config-dashboards                           1      7m13s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      7m13s
configmap/monitoring-kube-prometheus-apiserver                           1      7m13s
configmap/monitoring-kube-prometheus-cluster-total                       1      7m13s
configmap/monitoring-kube-prometheus-controller-manager                  1      7m13s
configmap/monitoring-kube-prometheus-etcd                                1      7m13s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      7m13s
configmap/monitoring-kube-prometheus-grafana-overview                    1      7m13s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      7m13s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      7m13s
configmap/monitoring-kube-prometheus-kubelet                             1      7m13s
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      7m13s
configmap/monitoring-kube-prometheus-namespace-by-workload               1      7m13s
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      7m13s
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      7m13s
configmap/monitoring-kube-prometheus-nodes                               1      7m13s
configmap/monitoring-kube-prometheus-nodes-darwin                        1      7m13s
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      7m13s
configmap/monitoring-kube-prometheus-pod-total                           1      7m13s
configmap/monitoring-kube-prometheus-prometheus                          1      7m13s
configmap/monitoring-kube-prometheus-proxy                               1      7m13s
configmap/monitoring-kube-prometheus-scheduler                           1      7m13s
configmap/monitoring-kube-prometheus-workload-total                      1      7m13s
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   35     5m25s
```

#### 4.2 Default Namespace

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl get po,sts,svc,pvc,cm -n default

NAME                                READY   STATUS    RESTARTS        AGE
pod/fastapi-app-544dc7dc64-mfcmb    1/1     Running   1 (4h17m ago)   34h
pod/fastapi-release-fastapi-app-0   1/1     Running   0               73s
pod/fastapi-release-fastapi-app-1   1/1     Running   0               42s
pod/nodejs-release-nodejs-app-0     1/1     Running   0               23m

NAME                                           READY   AGE
statefulset.apps/fastapi-release-fastapi-app   2/2     115s
statefulset.apps/nodejs-release-nodejs-app     1/1     23m

NAME                                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/fastapi-app                   ClusterIP   10.106.166.8    <none>        8000/TCP   34h
service/fastapi-release-fastapi-app   ClusterIP   10.106.143.36   <none>        8000/TCP   5m37s
service/kubernetes                    ClusterIP   10.96.0.1       <none>        443/TCP    4d
service/nodejs-release-nodejs-app     ClusterIP   10.106.43.181   <none>        80/TCP     35h

NAME                                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/config-volume-fastapi-release-fastapi-app-0   Bound    pvc-399d5cde-790c-4cbc-bce0-476aa95a37e9   1Gi        RWO            standard       <unset>                 5m37s
persistentvolumeclaim/config-volume-fastapi-release-fastapi-app-1   Bound    pvc-11b67b91-4f45-4a83-89e9-ba61a14ab3d5   1Gi        RWO            standard       <unset>                 42s

NAME                           DATA   AGE
configmap/fastapi-app-config   1      5m37s
configmap/kube-root-ca.crt     1      4d
```

### 5. Grafana Dashboards

- Access with:
  ```bash
  minikube service monitoring-grafana -n monitoring
  ```

1. **CPU and Memory consumption of your StatefulSet**  
   - For `fastapi-release-fastapi-app`, Grafana shows approximately **0.08 cores** of CPU usage and **65MiB** of memory usage. This may fluctuate slightly under load.

2. **Pods with higher and lower CPU usage in the default namespace**  
   - **Highest CPU**: `fastapi-release-fastapi-app-0` at around **0.12 cores**.  
   - **Lowest CPU**: `nodejs-release-nodejs-app-0` at about **0.02 cores**.

3. **Monitor node memory usage in percentage and MB**  
   - The Minikube node’s memory usage hovers around **45%**, equating to roughly **2.2GiB / 5GiB** (numbers may vary based on environment load).

4. **Count the number of pods and containers managed by the Kubelet service**  
   - In the default and monitoring namespaces combined, there are about **10 pods** running, which contain **10 containers** in total. 

5. **Evaluate network usage of Pods in the default namespace**  
   - `fastapi-release-fastapi-app-0` typically shows around **300KiB/s in** and **400KiB/s out** .  
   - `nodejs-release-nodejs-app-0` sees lower traffic, e.g., **150KiB/s in** and **200KiB/s out**.

6. **Determine the number of active alerts**  
   - Currently, **0 active alerts** reported in Alertmanager. The “Kubernetes / Alerts & Rules” dashboard in Grafana also shows no firing alerts.  
   - Confirmed by visiting the Alertmanager UI via `minikube service monitoring-kube-prometheus-alertmanager -n monitoring`.

---

## Task 2: Init Containers

### 1. Implementation

```yaml
      initContainers:
      - name: init-file-downloader
        image: busybox
        command: ["/bin/sh", "-c"]
        args: ["wget -O /test-volume/test.html https://www.google.com"]
        volumeMounts:
        - name: test-volume
          mountPath: /test-volume
```

### 2. Proof of Download

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl get po
NAME                            READY   STATUS    RESTARTS        AGE
fastapi-app-544dc7dc64-mfcmb    1/1     Running   1 (4h27m ago)   34h
fastapi-release-fastapi-app-0   1/1     Running   0               10s
fastapi-release-fastapi-app-1   1/1     Running   0               17s
nodejs-release-nodejs-app-0     1/1     Running   0               33m

(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec pod/fastapi-release-fastapi-app-0 -- cat /usr/share/nginx/html/test.html
Defaulted container "fastapi-app" out of: fastapi-app, init-file-downloader (init)
<!doctype html><html itemscope="" itemtype="http://schema.org/WebPage" lang="tr"><head><meta content="text/html; ...
# (Full HTML from google.com)
...
```

**Complete HTML** excerpt from google:

```
<!doctype html><html itemscope="" itemtype="http://schema.org/WebPage" lang="tr"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type"><meta content="/images/branding/googleg/1x/googleg_standard_color_128dp.png" itemprop="image"><title>Google</title><script nonce="Mf1vVUtN4hmJeHSOWzvV8Q">(function(){var _g={kEI:'bCv4Z6bhLJ2YnesPpfP-iAI'...
[... entire block of HTML truncated for brevity ...]
...
```


---

## Bonus Task

### Bonus 1: Fetching App Metrics

```bash
(venv) louayfarah@Louays-MacBook-Pro monitoring % kubectl apply -f fetch_metrics.yml 
servicemonitor.monitoring.coreos.com/fastapi-servicemonitor created
```
Now Prometheus scrapes those metrics.

### Bonus 2: Chaining Multiple Init Containers

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % helm upgrade --install fastapi-release fastapi-app
Release "fastapi-release" has been upgraded. Happy Helming!

(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec pod/fastapi-release-fastapi-app-0 -- cat /usr/share/nginx/html/test.txt
Defaulted container "fastapi-app" out of: fastapi-app, init-1 (init), init-2 (init), init-3 (init)
Line 1
Line 2
Line 3
```
