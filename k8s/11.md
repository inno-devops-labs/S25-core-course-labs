# Kubernetes Secrets

## Secrets

```bash
> kubectl create secret generic secret --from-literal=PASSWORD=qwerty
secret/secret created

> kubectl get secrets
NAME                               TYPE                 DATA   AGE
secret                             Opaque               1      3m15s
sh.helm.release.v1.app-go.v1       helm.sh/release.v1   1      6d22h
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      6d22h

> kubectl get secret secret -o jsonpath='{.data}'
{"PASSWORD":"cXdlcnR5"}

> echo "cXdlcnR5" | base64 -d
qwerty
```

## Manage Secrets with Helm

```bash
> helm secrets upgrade --install app-python . -f secrets.yaml
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Tue Mar  4 23:05:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 4
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
secrets.yaml.dec
```

```bash
> kubectl get po
NAME                          READY   STATUS    RESTARTS   AGE
app-go-866dff6c6-cgn4q        1/1     Running   0          7d
app-python-65f6c9b79f-v496v   1/1     Running   0          2m6s
```

```bash
> kubectl exec app-python-65f6c9b79f-v496v -- printenv | grep PASSWORD
PASSWORD=qwerty
```

## Install Vault Using Helm Chart

```bash
> helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

> helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈

> helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Tue Mar  4 23:38:46 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1

> kubectl get pods
NAME                                    READY   STATUS              RESTARTS   AGE
app-go-866dff6c6-cgn4q                  1/1     Running             0          7d
app-python-65f6c9b79f-v496v             1/1     Running             0          21m
vault-0                                 0/1     ContainerCreating   0          30s
vault-agent-injector-66f45b5fd5-bddb2   1/1     Running             0          30s
```

## Set a Secret in Vault

```bash
> kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

/ $ vault kv put internal/database/config username="milana" password="my_pass"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T15:42:18.598497462Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T15:42:18.598497462Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    my_pass
username    milana
```

## Configure Kubernetes Authentication

```bash
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app

/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

## Manually Define a Kubernetes Service Account

```bash
> kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-go                 0         8d
app-python             0         8d
default                0         8d
vault                  0         43h
vault-agent-injector   0         43h

> kubectl create sa internal-app
serviceaccount/internal-app created

> kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-go                 0         8d
app-python             0         8d
default                0         8d
internal-app           0         20s
vault                  0         43h
vault-agent-injector   0         43h
```

## Implement Vault Secrets in Your Helm Chart

```bash
> kubectl patch deployment app-python --patch-file=patch-inject-secrets.yaml
deployment.apps/app-python patched

> cat vault/secrets/database-config.txt
data: map[password:my_pass username:milana]
metadata: map[created_time:2025-03-06T15:42:18.598497462Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay        1007G   22G  935G   3% /
tmpfs            64M     0   64M   0% /dev
shm              64M   16K   64M   1% /dev/shm
tmpfs           7.7G  4.0K  7.7G   1% /vault/secrets
/dev/vda1      1007G   22G  935G   3% /etc/hosts
tmpfs           7.7G   12K  7.7G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/scsi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```

## Bonus Task

### Python App

```bash
> kubectl describe deployments.apps app-python
Name:                   app-python
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 20:17:09 +0300
Labels:                 app.kubernetes.io/instance=app-python
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-python
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-python-0.1.0
Annotations:            deployment.kubernetes.io/revision: 2
                        meta.helm.sh/release-name: app-python
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app-python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=app-python,app.kubernetes.io/version=1.16.0
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=app-python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-python
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-python-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   app-python:
    Image:      milanamilana/python-web-app:latest
    Port:       5000/TCP
    Host Port:  0/TCP
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      PASSWORD:    <set to the key 'PASSWORD' in secret 'secret'>  Optional: false
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  app-python-8599b99bc5 (0/0 replicas created)
NewReplicaSet:   app-python-6c56d898d5 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set app-python-8599b99bc5 from 0 to 1
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set app-python-6c56d898d5 from 0 to 1
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled down replica set app-python-8599b99bc5 from 1 to 0
```

### Go App

```bash
> kubectl describe deployments.apps app-go
Name:                   app-go
Namespace:              default
CreationTimestamp:      Tue, 25 Feb 2025 22:40:29 +0300
Labels:                 app.kubernetes.io/instance=app-go
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-go
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-go-0.1.0
Annotations:            deployment.kubernetes.io/revision: 2
                        meta.helm.sh/release-name: app-go
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app-go,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=app-go,app.kubernetes.io/version=1.16.0
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=app-go
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-go
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-go-0.1.0
  Service Account:  app-go
  Containers:
   app-go:
    Image:      milanamilana/go-distroless-web-app:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:         100m
      memory:      128Mi
    Liveness:      http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:     http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:   <none>
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  app-go-866dff6c6 (0/0 replicas created)
NewReplicaSet:   app-go-6b9b5595d4 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  75s   deployment-controller  Scaled up replica set app-go-6b9b5595d4 from 0 to 1
  Normal  ScalingReplicaSet  73s   deployment-controller  Scaled down replica set app-go-866dff6c6 from 1 to 0
```

## Environment Variables

### Python App Env Vars

```bash
> app-python % kubectl exec -it app-python-66b7b4b8b9-2l76d --container app-python -- /bin/sh
$ printenv
VAULT_PORT_8201_TCP_PROTO=tcp
APP_PYTHON_SERVICE_PORT=5000
APP_PYTHON_PORT=tcp://10.110.237.202:5000
VAULT_SERVICE_HOST=10.110.35.223
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
APP_DEBUG=false
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
HOSTNAME=app-python-66b7b4b8b9-2l76d
APP_GO_SERVICE_PORT_HTTP=8080
HOME=/home/user
VAULT_PORT_8200_TCP=tcp://10.110.35.223:8200
VAULT_PORT=tcp://10.110.35.223:8200
VAULT_PORT_8201_TCP=tcp://10.110.35.223:8201
VAULT_SERVICE_PORT=8200
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.99.220.181:443
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
PYTHON_SHA256=2a9920c7a0cd236de33644ed980a13cbbc21058bfdc528febb6081575ed73be3
APP_GO_SERVICE_HOST=10.100.187.99
APP_GO_PORT_8080_TCP_ADDR=10.100.187.99
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.99.220.181
APP_GO_PORT_8080_TCP_PORT=8080
APP_GO_PORT_8080_TCP_PROTO=tcp
TERM=xterm
APP_GO_PORT=tcp://10.100.187.99:8080
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
APP_GO_SERVICE_PORT=8080
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.99.220.181:443
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
APP_PYTHON_PORT_5000_TCP_ADDR=10.110.237.202
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
APP_GO_PORT_8080_TCP=tcp://10.100.187.99:8080
APP_PYTHON_PORT_5000_TCP_PORT=5000
LANG=C.UTF-8
APP_PYTHON_PORT_5000_TCP_PROTO=tcp
APP_PYTHON_SERVICE_PORT_HTTP=5000
PYTHON_VERSION=3.11.11
APP_COURSE=devops
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
APP_PYTHON_SERVICE_HOST=10.110.237.202
APP_AUTHOR=milana
VAULT_SERVICE_PORT_HTTP=8200
KUBERNETES_SERVICE_HOST=10.96.0.1
APP_PYTHON_PORT_5000_TCP=tcp://10.110.237.202:5000
PWD=/app
VAULT_PORT_8200_TCP_ADDR=10.110.35.223
PASSWORD=qwerty
VAULT_PORT_8201_TCP_ADDR=10.110.35.223
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_PORT=8201
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.99.220.181
```

### Go App Env Vars

```bash
m.sirozhova@macbook-FN9T7TWJ52 app-go % kubectl exec -it app-go-6f9d49f666-ndbf7 --container app-go -- /bin/sh
/app $ printenv
APP_PYTHON_SERVICE_PORT=5000
APP_PYTHON_PORT=tcp://10.110.237.202:5000
VAULT_PORT_8201_TCP_PROTO=tcp
KUBERNETES_PORT=tcp://10.96.0.1:443
VAULT_SERVICE_HOST=10.110.35.223
KUBERNETES_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
APP_DEBUG=false
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
HOSTNAME=app-go-6f9d49f666-ndbf7
APP_GO_SERVICE_PORT_HTTP=8080
SHLVL=1
HOME=/home/user
VAULT_PORT_8200_TCP=tcp://10.110.35.223:8200
VAULT_PORT=tcp://10.110.35.223:8200
VAULT_PORT_8201_TCP=tcp://10.110.35.223:8201
VAULT_SERVICE_PORT=8200
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.99.220.181:443
APP_GO_PORT_8080_TCP_ADDR=10.100.187.99
APP_GO_SERVICE_HOST=10.100.187.99
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.99.220.181
APP_GO_PORT_8080_TCP_PORT=8080
APP_GO_PORT_8080_TCP_PROTO=tcp
TERM=xterm
APP_GO_SERVICE_PORT=8080
APP_GO_PORT=tcp://10.100.187.99:8080
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.99.220.181:443
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
APP_PYTHON_PORT_5000_TCP_ADDR=10.110.237.202
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
APP_GO_PORT_8080_TCP=tcp://10.100.187.99:8080
APP_PYTHON_PORT_5000_TCP_PORT=5000
APP_PYTHON_SERVICE_PORT_HTTP=5000
APP_PYTHON_PORT_5000_TCP_PROTO=tcp
APP_COURSE=devops
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
APP_PYTHON_SERVICE_HOST=10.110.237.202
APP_AUTHOR=milana
KUBERNETES_SERVICE_HOST=10.96.0.1
VAULT_SERVICE_PORT_HTTP=8200
APP_PYTHON_PORT_5000_TCP=tcp://10.110.237.202:5000
PWD=/app
VAULT_PORT_8200_TCP_ADDR=10.110.35.223
VAULT_PORT_8201_TCP_ADDR=10.110.35.223
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8200_TCP_PORT=8200
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.99.220.181
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_PORT=8201
```
