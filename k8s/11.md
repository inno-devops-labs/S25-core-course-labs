# Lab 11 report

## Create a Secret Using kubectl:

```bash
kubectl create secret generic my-secret --from-literal=MY_PASS=supersecret

Output:
secret/my-secret created
```

## Verify and Decode Secret:

```bash
kubectl get secrets

Output:
NAME                               TYPE                 DATA   AGE
my-secret                          Opaque               1      33s
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      10d
sh.helm.release.v1.python-app.v1   helm.sh/release.v1   1      10d
```

## Manage Secrets with Helm:

```bash
kubectl get secret my-secret -o yaml

Output:
apiVersion: v1
data:
  MY_PASS: c3VwZXJzZWNyZXQ=
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T18:18:17Z"
  name: my-secret
  namespace: default
  resourceVersion: "103755"
  uid: 21d0f478-7d68-407d-ac72-0648c9583340
type: Opaque
```

```bash
echo "c3VwZXJzZWNyZXQ=" | base64 --decode

Output:
supersecret
```

```bash
helm upgrade --install python-app ./python-app/

Output:
Release "python-app" has been upgraded. Happy Helming!
NAME: python-app
LAST DEPLOYED: Sun Mar  9 21:30:59 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

```bash
kubectl get pod

Output:
NAME                                     READY   STATUS      RESTARTS     AGE
python-app-569b4cf844-2pwg5              1/1     Running     0            3m1s
python-app-569b4cf844-rpgk6              1/1     Running     0            3m4s
python-app-569b4cf844-v4lkv              1/1     Running     0            3m3s
```

```bash
kubectl exec python-app-5c5446848f-62vqb -- printenv | grep MY_PASS

Output:
MY_PASS=supersecret
```

After adding python-app/secret.yaml and modifying python-app/deployment.yaml:

```bash
helm upgrade --install python-app .
kubectl get pods
kubectl exec python-app-d45985f4c-7b955 -- printenv | grep MY_PASS 

Output:
MY_PASS=my-super-secret-password
```

Apply secrets inject patch:

```bash
kubectl patch deployment python-app --patch "$(cat patch-inject-secrets.yaml)" 

Output:
deployment.apps/python-app patched
```

```bash
kubectl logs python-app-cf7fbd7cc-k79xn --container vault-agent 

Output:
==> Vault Agent started! Log data will stream in below:

==> Vault Agent configuration:

           Api Address 1: http://bufconn
                     Cgo: disabled
               Log Level: info
                 Version: Vault v1.18.1, built 2024-10-29T14:21:31Z
2025-03-09T19:56:14.447Z [INFO]  agent.sink.file: creating file sink
2025-03-09T19:56:14.447Z [INFO]  agent.sink.file: file sink configured: path=/home/vault/.vault-token mode=-rw-r----- owner=100 group=1000
             Version Sha: f479e5c85462477c9334564bc8f69531cdb03b65

2025-03-09T19:56:14.448Z [INFO]  agent.exec.server: starting exec server
2025-03-09T19:56:14.448Z [INFO]  agent.exec.server: no env templates or exec config, exiting
2025-03-09T19:56:14.448Z [INFO]  agent.auth.handler: starting auth handler
2025-03-09T19:56:14.448Z [INFO]  agent.sink.server: starting sink server
2025-03-09T19:56:14.448Z [INFO]  agent.auth.handler: authenticating
2025-03-09T19:56:14.448Z [INFO]  agent.template.server: starting template server
2025-03-09T19:56:14.448Z [INFO]  agent: (runner) creating new runner (dry: false, once: false)
2025-03-09T19:56:14.449Z [INFO]  agent: (runner) creating watcher
2025-03-09T19:56:14.452Z [INFO]  agent.auth.handler: authentication successful, sending token to sinks
2025-03-09T19:56:14.452Z [INFO]  agent.auth.handler: starting renewal process
2025-03-09T19:56:14.453Z [INFO]  agent.template.server: template server received new token
2025-03-09T19:56:14.453Z [INFO]  agent.sink.file: token written: path=/home/vault/.vault-token
2025-03-09T19:56:14.453Z [INFO]  agent: (runner) stopping
2025-03-09T19:56:14.453Z [INFO]  agent: (runner) creating new runner (dry: false, once: false)
2025-03-09T19:56:14.453Z [INFO]  agent: (runner) creating watcher
2025-03-09T19:56:14.453Z [INFO]  agent: (runner) starting
2025-03-09T19:56:14.455Z [INFO]  agent.auth.handler: renewed auth token
```

```bash
kubectl exec python-app-cf7fbd7cc-k79xn --container python-app -- cat /vault/secrets/database-config.txt

Output:
data: map[password:db-root username:admin]
metadata: map[created_time:2025-03-09T18:48:01.613879294Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```