# Secrets management

## `kubectl create secret`

```bash
➜  S25-core-course-labs git:(lab-11) ✗ kubectl create secret generic devops-secret --from-literal=course=devops
secret/devops-secret created
➜  S25-core-course-labs git:(lab-11) ✗ kubectl get secrets
NAME            TYPE     DATA   AGE
devops-secret   Opaque   1      6s
➜  S25-core-course-labs git:(lab-11) ✗ kubectl get secret devops-secret -o jsonpath='{.data}'
{"course":"ZGV2b3Bz"}
➜  S25-core-course-labs git:(lab-11) ✗ echo 'ZGV2b3Bz' | base64 -d
devops
```

As one can see, aftter `base64 -d` the value of secret is revealed :)

## Helm secrets

I've managed to encode my secret using GPG key. It allows me to store it in the repository.

Installation of the chart is performed via `helm secrets install moscow-time . -f secrets.yml`
and my passphrase in order to decode the secret and inject into container in decoded form.

```bash
➜  moscow-time git:(lab-11) ✗ kubectl get po
NAME                           READY   STATUS    RESTARTS   AGE
moscow-time-7dddc59496-7bjtb   1/1     Running   0          114s
moscow-time-7dddc59496-jzx7q   1/1     Running   0          114s
moscow-time-7dddc59496-lldwb   1/1     Running   0          114s
➜  moscow-time git:(lab-11) ✗ kubectl exec moscow-time-7dddc59496-lldwb  -- printenv | grep password
password=dev0p$c0urs3
```

## Vault secrets

Following Vault documentation, I've set up corresponing helm release and created a secret.
I've added pod annotations to `values.yaml` and this allows me to inject secrets on startup
without patch.

### Vault secret setup

Here are steps to create secret in vault

```bash
➜  k8s git:(lab-11) ✗ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-02-27T18:38:43.332876916Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-02-27T18:38:43.332876916Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

Here is a proof of pod secret existence

```bash
➜  k8s git:(lab-11) ✗ kubectl exec -it moscow-time-7f6787b9c6-lg7m8 --container moscow-time -- /bin/sh
/app $ ls
__pycache__       main.py           requirements.txt  static            templates
/app $ cd ..
/ $ ls
app    bin    dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var    vault
/ $ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-02-27T18:38:43.332876916Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $
```

I've also created a templated secret with a patch `patch.yml`. I've some issues in formatting this file
so I redeployed the application.

```bash
➜  moscow-time git:(lab-11) ✗ kubectl patch deployment moscow-time --patch-file=patch.yml
deployment.apps/moscow-time patched
➜  moscow-time git:(lab-11) ✗ kubectl exec -it moscow-time-84cc95f85b-f46kr --container moscow-time -- /bin/sh
/app $ cd ..
/ $ cat vault/secrets/database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard/ $
```

## Resources

Resources are easily configured in `values.yml` and setup. One can see below requests and limits.
They will be equal for the second app, so there is no need to show them again.

```bash
➜  k8s git:(lab-11) ✗ kubectl describe deployments.apps moscow-time
Name:                   moscow-time
Namespace:              default
CreationTimestamp:      Thu, 27 Feb 2025 22:36:51 +0300
Labels:                 app.kubernetes.io/instance=moscow-time
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=moscow-time
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=moscow-time-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: moscow-time
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=moscow-time,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=1.16.0
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=moscow-time
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=moscow-time
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=moscow-time-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   moscow-time:
    Image:      m0t9docker/pyapp:latest
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      ENVIRONMENT:  stage
    Mounts:         <none>
  Volumes:          <none>
  Node-Selectors:   <none>
  Tolerations:      <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   moscow-time-656fcc4cdc (3/3 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  4m12s  deployment-controller  Scaled up replica set moscow-time-656fcc4cdc from 0 to 3
```

## Environmental variables

They are also set using named templates of Helm. One can see below parameter `ENVIRONMENT=stage`

```bash
➜  k8s git:(lab-11) ✗ kubectl exec -it moscow-time-656fcc4cdc-8xjbc -- env

Defaulted container "moscow-time" out of: moscow-time, vault-agent, vault-agent-init (init)
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=moscow-time-656fcc4cdc-8xjbc
TERM=xterm
ENVIRONMENT=stage
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.109.137.125:443
MOSCOW_TIME_PORT_8000_TCP=tcp://10.110.64.42:8000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.109.137.125
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8201_TCP=tcp://10.111.143.39:8201
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.109.137.125:443
MOSCOW_TIME_SERVICE_PORT=8000
MOSCOW_TIME_PORT=tcp://10.110.64.42:8000
VAULT_SERVICE_HOST=10.111.143.39
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_ADDR=10.111.143.39
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
MOSCOW_TIME_SERVICE_HOST=10.110.64.42
MOSCOW_TIME_PORT_8000_TCP_PORT=8000
VAULT_SERVICE_PORT=8200
VAULT_SERVICE_PORT_HTTP=8200
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.109.137.125
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
MOSCOW_TIME_SERVICE_PORT_HTTP=8000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_PORT=tcp://10.96.0.1:443
MOSCOW_TIME_PORT_8000_TCP_PROTO=tcp
VAULT_PORT=tcp://10.111.143.39:8200
VAULT_PORT_8200_TCP=tcp://10.111.143.39:8200
VAULT_PORT_8200_TCP_PROTO=tcp
MOSCOW_TIME_PORT_8000_TCP_ADDR=10.110.64.42
VAULT_PORT_8200_TCP_ADDR=10.111.143.39
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
LANG=C.UTF-8
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
PYTHON_VERSION=3.10.16
PYTHON_SHA256=bfb249609990220491a1b92850a07135ed0831e41738cf681d63cf01b2a8fbd1
HOME=/home/user
```
