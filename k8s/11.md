
# Kubernetes secrets

So let's directly create a kubernetes opaque secret:

```bash
$ kubectl create secret generic pass_pair \
    --from-literal=username=admin \
    --from-literal=password='S!B\*d$zDsb='

secret/pass-pair created
```

Confirm that it was created:

```bash
$ kubectl get secret pass-pair -o yaml
apiVersion: v1
data:
  password: UyFCXCpkJHpEc2I9
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2025-03-03T14:34:52Z"
  name: pass-pair
  namespace: default
  resourceVersion: "1747"
  uid: 61ba6ba7-874f-49c0-b3be-7f49fa26ff95
type: Opaque
```

It was instructed to decode it back, so, okay:

```bash
$ echo UyFCXCpkJHpEc2I9 | base64 --decode
S!B\*d$zDsb=

$ echo YWRtaW4= | base64 --decode
admin
```

Key generation:

```bash
$ gpg --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: max
Name must be at least 5 characters long
Real name: smack
Email address: ibroden@yandex.ru
You selected this USER-ID:
    "smack <ibroden@yandex.ru>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key A017CBA2FC49927B marked as ultimately trusted
gpg: directory '/home/max/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/max/.gnupg/openpgp-revocs.d/7041F74FC9A29B7766315169A017CBA2FC49927B.rev'
public and secret key created and signed.

pub   rsa3072 2025-03-03 [SC] [expires: 2027-03-03]
      7041F74FC9A29B7766315169A017CBA2FC49927B
uid                      smack <ibroden@yandex.ru>
sub   rsa3072 2025-03-03 [E] [expires: 2027-03-03]

$ gpg --list-keys
/home/max/.gnupg/pubring.kbx
----------------------------
pub   rsa3072 2025-03-03 [SC] [expires: 2027-03-03]
      7041F74FC9A29B7766315169A017CBA2FC49927B
uid           [ultimate] smack <ibroden@yandex.ru>
sub   rsa3072 2025-03-03 [E] [expires: 2027-03-03]

$ helm secrets view secrets.yml
password: secret1111
```

So, we got the desired password decrypted, hence, secret is created!

## Let us deploy a service with that secret

install helm charts

```bash
$ helm secrets install chart-python chart-app-python/ -n default -f secrets.yaml
NAME: chart-python
LAST DEPLOYED: Tue Mar  4 00:29:07 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=chart-app-python,app.kubernetes.io/instance=chart-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed 'secrets.yaml.dec'
```

verify access:

```bash
$ kubectl exec chart-python-chart-app-python-79f6ffc7c8-h2jv8 -- env | grep CRED_PASSWORD
CRED_PASSWORD=secret1111
```

it also works for golang app:

```bash
$ helm secrets install chart-app-go chart-app-go/ -n default -f secrets.yaml
NAME: chart-app-go
LAST DEPLOYED: Tue Mar  4 00:36:17 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=chart-app-go,app.kubernetes.io/instance=chart-app-go" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed 'secrets.yaml.dec'
```

verify again:

```bash
$ kubectl exec chart-app-go-6b7f7fcbfc-cvpgw -- env | grep CRED_PASSWORD
CRED_PASSWORD=secret1111
```

the pods:

```bash
$ kubectl get po
NAME                                             READY   STATUS    RESTARTS   AGE
chart-app-go-6b7f7fcbfc-cvpgw                    1/1     Running   0          21s
chart-python-chart-app-python-79f6ffc7c8-h2jv8   1/1     Running   0          7m30s
chart-python-chart-app-python-79f6ffc7c8-z7jp2   1/1     Running   0          7m30s
```

## Vault

```bash
$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Tue Mar  4 01:07:47 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!
```

Setting secrets inside the vault

```bash
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="smack" password="secret1111"

$ vault kv put internal/database/config username="smack" password="secret1111"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-03T22:12:48.415273097Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

$ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-03T22:12:48.415273097Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    secret1111
username    smack
```

authentication:

```bash
$ kubectl exec -it vault-0 -- /bin/sh
$ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
$ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
$ vault policy write app-python - <<EOF
path "internal/data/database/config" {
   capabilities = ["read"]
}
EOF
Success! Uploaded policy: app-python

$ vault write auth/kubernetes/role/app-python \
      bound_service_account_names=app-python \
      bound_service_account_namespaces=default \
      policies=app-python \
      ttl=24h

Success! Data written to: auth/kubernetes/role/app-python
```

Verify vault presence, and secrets:

```bash
$ kubectl exec -it app-python-chart-app-python-6d6cf9fb4f-2qgtf -- /bin/sh
Defaulted container "chart-app-python" out of: chart-app-python, vault-agent, vault-agent-init (init)
/service $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  16.9G      2.3G     13.6G  15% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   256.0M      4.0K    256.0M   0% /vault/secrets
/dev/vda1                16.9G      2.3G     13.6G  15% /dev/termination-log
/dev/vda1                16.9G      2.3G     13.6G  15% /etc/resolv.conf
/dev/vda1                16.9G      2.3G     13.6G  15% /etc/hostname
/dev/vda1                16.9G      2.3G     13.6G  15% /etc/hosts
tmpfs                   256.0M     12.0K    256.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     1.4G         0      1.4G   0% /proc/asound
tmpfs                     1.4G         0      1.4G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     1.4G         0      1.4G   0% /proc/scsi
tmpfs                     1.4G         0      1.4G   0% /sys/firmware
/service $ cat /va
var/    vault/
/service $ cat /vault/secrets/database-config.txt
postgresql://smack:secret1111@postgres:5432/wizard/service
```

we see those `postgresql://smack:secret1111@postgres:5432/wizard/service`!

## Bonuses

### Env variables

We were also tasked to make env vars, so here they are:

```bash
$ kubectl exec app-python-b55f89869-mskd9 -- env | grep HELLO
HELLO=world

$ kubectl exec app-java-8577cc6cdd-mj7f4 -- env | grep HELLO
HELLO=world
```

also, helm named templates were used.

### Resource limitations

Recources were limited, and these proofs show that these limitations were applied:

```bash
$ kubectl describe deployments.apps app-python | grep -A 10 Containers
  Containers:
   chart-app-python:
    Image:      elonmaxx/app_python:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi

$ kubectl describe deployments.apps app-go | grep -A 10 Containers
  Containers:
   chart-app-go:
    Image:      elonmaxx/app_go:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     500m
      memory:  768Mi
    Requests:
      cpu:      500m
      memory:   768Mi

```
