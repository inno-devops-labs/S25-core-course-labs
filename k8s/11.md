## Create and Vetify the Secret

````
$ kubectl get secrets
NAME                               TYPE                 DATA   AGE
my-secret                          Opaque               2      19s
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      6d22h
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      6d20h
sh.helm.release.v1.web-app.v1      helm.sh/release.v1   1      6d22h
````
## Decode the secret
````
$ kubectl get secret my-secret -o yaml
apiVersion: v1
data:
  password: MTIz
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T14:03:36Z"
  name: my-secret
  namespace: default
  resourceVersion: "38264"
  uid: 690efd98-9810-48dc-8fe1-3c0caff74548
type: Opaque
````

````
$ kubectl get secret my-secret -o jsonpath="{.data}"
{"password":"MTIz","username":"YWRtaW4="}
````

````
$ kubectl get secret my-secret -o jsonpath="{.data.password}" | base64 --decode
123
````

## Manage Secrets with Helm

````
$ kubectl get po
NAME                                 READY   STATUS      RESTARTS      AGE
app-python-6d74f8f4ff-vbbkb          1/1     Running     1 (42m ago)   6d23h
my-app-app-python-78bdf49894-kgpg5   1/1     Running     0             2m1s
postinstall-hook                     0/1     Completed   0             2m1s
````

````
$ kubectl exec my-app-app-python-78bdf49894-kgpg5  -- printenv | grep MY_PASSWORD
MY_PASSWORD=pass
````

## Task2

**Verifying vault running**

````
NAME                                    READY   STATUS      RESTARTS      AGE
app-python-6d74f8f4ff-vbbkb             1/1     Running     1 (51m ago)   6d23h
my-app-app-python-78bdf49894-kgpg5      1/1     Running     0             10m
postinstall-hook                        0/1     Completed   0             10m
vault-0                                 1/1     Running     0             71s
vault-agent-injector-66f45b5fd5-dmsss   1/1     Running     0             71s
````

## Secret in Vault

````
vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T15:24:13.481544745Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    pass
username    admin
````

## Configure Kubernetes authentication

````
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
````

## Implement Vault Secrets in Helm Chart
````
$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python             0         7d
default                0         10d
my-app-app-python      0         59m
vault                  0         50m
vault-agent-injector   0         50m
(.venv) akvadevka@DevOps:~/PycharmProjects/Devops/S25-core-course-labs/k8s$ kubectl create sa internal-app
serviceaccount/internal-app created
(.venv) akvadevka@DevOps:~/PycharmProjects/Devops/S25-core-course-labs/k8s$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python             0         7d
default                0         10d
internal-app           0         4s
my-app-app-python      0         59m
vault                  0         50m
vault-agent-injector   0         50m
````
````
$ cat vault/secrets/database-config.txt 
 data: map[username:admin]
 metadata: map[created_time:2025-03-09T21:25:08.89976073Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
$ df -h
 Filesystem      Size  Used Avail Use% Mounted on
overlay          43G   21G   20G  51% /
tmpfs            64M     0   64M   0% /dev
shm              64M   16K   64M   1% /dev/shm
tmpfs            12G  4.0K   12G   0% /vault/secrets
/dev/sda3        43G   21G   20G  51% /etc/hosts
tmpfs            12G   12K   12G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           5.7G     0  5.7G   0% /proc/asound
tmpfs           5.7G     0  5.7G   0% /proc/acpi
tmpfs           5.7G     0  5.7G   0% /proc/scsi
tmpfs           5.7G     0  5.7G   0% /sys/firmware
````