# Task 1

## minikube start

```bash
meowal@meowal-1-2:~$ minikube start
üòÑ  minikube v1.35.0 on Ubuntu 24.04 (vbox/amd64)
‚ú®  Using the docker driver based on existing profile
üëç  Starting "minikube" primary control-plane node in "minikube" cluster
üöú  Pulling base image v0.0.46 ...
üîÑ  Restarting existing docker container for "minikube" ...
üê≥  Preparing Kubernetes v1.32.0 on Docker 27.4.1 ...
üîé  Verifying Kubernetes components...
    ‚ñ™ Using image docker.io/kubernetesui/dashboard:v2.7.0
    ‚ñ™ Using image docker.io/kubernetesui/metrics-scraper:v1.0.8
    ‚ñ™ Using image gcr.io/k8s-minikube/storage-provisioner:v5
üí°  Some dashboard features require the metrics-server addon. To enable all features please run:

	minikube addons enable metrics-server

üåü  Enabled addons: storage-provisioner, dashboard, default-storageclass
üèÑ  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default

```

## create secret

```bash
meowal@meowal-1-2:~$ kubectl create secret generic my-secret --from-literal=MY_PASS='chernushka'
secret/my-secret created

```

## Verify the secret

```bash
meowal@meowal-1-2:~/S25-core-course-labs$ kubectl get secrets
NAME                               TYPE                 DATA   AGE
my-secret                          Opaque               1      8m54s
sh.helm.release.v1.my-release.v1   helm.sh/release.v1   1      7d13h

meowal@meowal-1-2:~/S25-core-course-labs$ kubectl describe secret my-secret
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
MY_PASS:  10 bytes
```

## Decode the secret

```bash
meowal@meowkubectl get secret my-secret -o jsonpath="{.data.MY_PASS}" | base64 --decode4 --decode
chernushka
```

## create random key


```bash
meowal@meowal-1-2:~/S25-core-course-labs$ gpg --gen-key
gpg (GnuPG) 2.4.4; Copyright (C) 2024 g10 Code GmbH
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Aliia
Email address: bogapova.alia@gmail.com
You selected this USER-ID:
    "Aliia <bogapova.alia@gmail.com>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: directory '/home/meowal/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/meowal/.gnupg/openpgp-revocs.d/BB3D822FD37B1F9229D37558200F2996758A4826.rev'
public and secret key created and signed.

pub   ed25519 2025-03-06 [SC] [expires: 2028-03-05]
      BB3D822FD37B1F9229D37558200F2996758A4826
uid                      Aliia <bogapova.alia@gmail.com>
sub   cv25519 2025-03-06 [E] [expires: 2028-03-05]


```


## convert chernushkato Base64 and add to secrets.yaml

```bash
meowal@meowal-1-2:~/S25-core-course-labs$ echo -n "chernushka" | base64
Y2hlcm51c2hrYQ==

apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  MY_PASS: Y2hlcm51c2hrYQ==
```

## Encrypt secrets.yaml Using GPG Key, decrypt and verify decryption

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/templates$ sops --encrypt --pgp BB3D822FD37B1F9229D37558200F2996758A4826 --output secrets.enc.yaml secrets.yaml

meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/templates$ sops --decrypt secrets.enc.yaml > secrets.yaml

meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/templates$ cat secrets.enc.yaml
apiVersion: ENC[AES256_GCM,data:Qiw=,iv:0EA9Eh0jBGGYstZqI/KbtThAsCRpKe/UYimwMtQ/Fgs=,tag:3ryQJFAYh5TK71oh9+4tZQ==,type:str]
kind: ENC[AES256_GCM,data:waiOxQQT,iv:FEqPXRPGtJVYMC1G2TbbzZU29MvMX2uN34ZFPfFa6m0=,tag:B17vd5jnEQQ9jXyiobZYmg==,type:str]
metadata:
    name: ENC[AES256_GCM,data:0hQxDtJwojge,iv:MYZw7y2Gi4gi3nkZvV8xkztfA/voVIj+vLUHNcW4FUo=,tag:4ZKVoVoLZ93+AbZ0izprtQ==,type:str]
type: ENC[AES256_GCM,data:D2+tLzL7,iv:gpCr5IXTFhz8xZUbQUN9Exf9g+9mRhII3bowMgmshhQ=,tag:Y073qA8hvhKISFZQHO6LCQ==,type:str]
data:
    MY_PASS: ENC[AES256_GCM,data:wavkPLwsJG9Zq+FZC+jiiQ1IRD0=,iv:6y0IknsQbgdh4mwd4sK2zs74/+kre1WCalTKLNKr7B0=,tag:GkVk+IF0lTThfV7CrlkKZg==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2025-03-06T12:47:26Z"
    mac: ENC[AES256_GCM,data:ZP8ooJ+P6egSYqDPbDrDqWWp9mdZwcDiVgI45Rmn1q/kq7rUa6yVBI+NRGPxYdw2/wMWCWZ8SDcPPBmdAWIeaB1XZUHRFkurjN/miAefoj/7jVykkVGZOyXKQEfhbaep0mJLrmsjPZbj6/YnMwCe3mR1cMI/tAyFOykmbuV6YMM=,iv:ScSkyLi9KAwrQ5OhBaR4C9M57QgVGeOeAwimddX3cXs=,tag:Ff1gpgTqPq1hEU8xHxdIAQ==,type:str]
    pgp:
        - created_at: "2025-03-06T12:47:26Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hF4DUjquHYfbkOYSAQdAsboh5OU7UPExz7fyWQ3nl7vxQclPzu/CEezXSJegFHcw
            LkivRaNwMoaJQVMQ0Mv2dFE/0VMe/qiaPkK+CguI1VsNVYUpxUJu5X72NnURSFXO
            1GgBCQIQcb22jDOFXprRpOcMf6duCEqYkOnC8sy4ppmLjk2/RhtZ7i8+BZzVpRRk
            aP3FG+0Iu9RhE+wgXOYuUZ7BBdFNeaJ3MWESGHmzZXKAM2eD640E1UMk69ecau8q
            NfXKvGEwOdD+og==
            =Q/ln
            -----END PGP MESSAGE-----
          fp: BB3D822FD37B1F9229D37558200F2996758A4826
    unencrypted_suffix: _unencrypted
    version: 3.9.4
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/templates$ 

```
## create deployment YAML

```bash
env:
  - name: MY_PASS
    valueFrom:
      secretKeyRef:
        name: my-secret
        key: MY_PASS
```

## Deploy Helm Chart

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ helm create my-chart
Creating my-chart
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ helm upgrade --install my-release ./my-chart --namespace default
Release "my-release" does not exist. Installing it now.
NAME: my-release
LAST DEPLOYED: Thu Mar  6 16:47:25 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=my-chart,app.kubernetes.io/instance=my-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT


```

## Verify that the pod is running

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ kubectl get po
NAME                                    READY   STATUS    RESTARTS        AGE
time-app-d4cfc5cff-lzv6v                1/1     Running   1 (7m54s ago)   14m


#Check if the secret is accessible inside the pod
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ kubectl exec time-app-d4cfc5cff-txn2q  -- printenv | grep MY_PASS
MY_PASS=chernushka

```

## Update deployment.yaml file with 

```bash
resources:
  requests:
    memory: "128Mi"
    cpu: "250m"
  limits:
    memory: "256Mi"
    cpu: "500m"
```
# Task 2

## Install Vault Using Helm

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Thu Mar  6 18:29:41 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault

```

## Verify the installation

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS        AGE
time-app-d4cfc5cff-lzv6v                1/1     Running   1 (6m23s ago)   12m
vault-0                                 1/1     Running   0               2m43s
vault-agent-injector-66f45b5fd5-k6wbh   1/1     Running   0               2m43s
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ 

meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ 


```

## Set Up a Secret in Vault

```bash
#Access the Vault Pod:
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ kubectl exec -it vault-0 -- /bin/sh
/ $

#Enable the KV v2 Secrets Engine
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ 

#Put a secret 
/ $ vault kv put internal/database/config username="chernishka" password="cherni
shkovna"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T21:47:32.592115713Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2
/ $ 

#Verify
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T21:47:32.592115713Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2

====== Data ======
Key         Value
---         -----
password    chernishkovna
username    chernishka
/ $ 


```

## Enable the Kubernetes Auth Method

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

#Configure Vault to Connect to Kubernetes API Server
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

```

## Define a Vault Policy

```bash
#permission to read the secret stored at that path
/ $ vault policy write my-app-my-chart - <<EOF
> path "internal/data/database/config" {
>   capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: my-app-my-chart


#Create a Role in Vault for Kubernetes Authentication
/ $ vault write auth/kubernetes/role/my-app-my-chart \
>       bound_service_account_names=my-app-my-chart \
>       bound_service_account_namespaces=default \
>       policies=my-app-policy \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/my-app-my-chart
/ $ 

```

add annotations:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "my-app-my-chart"
    and
    podAnnotations:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "my-app-my-chart"
      vault.hashicorp.com/agent-inject-secret-internal-data-database-config:
  to values.yaml
  
add  template:
    metadata:
      labels:
        app: time-app
      annotations:
        vault.hashicorp.com/agent-inject: "true"
    	vault.hashicorp.com/role: "my-app-role"
    	vault.hashicorp.com/agent-inject-secret-database-config.txt: "secret
  to deployment.yaml
## Deploy Using Helm

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ helm secrets install my-app-my-chart ./my-chart -n default -f /home/meowal/S25-core-course-labs/k8s/time-app/charts/my-chart/templates/secrets.yaml
NAME: my-app-my-chart
LAST DEPLOYED: Fri Mar  7 01:21:35 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=my-chart,app.kubernetes.io/instance=my-app-my-chart" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ 

```

## 

```bash
meowal@meowal-1-2:~/S25-core-course-labs/k8s/time-app/charts$ kubectl get pods
NAME                                    READY   STATUS     RESTARTS      AGE
time-app-674ddcf8c5-n922v               0/2     Init:0/1   0             62s
time-app-d4cfc5cff-slvxq                1/1     Running    0             26m
vault-0                                 1/1     Running    2 (71m ago)   92m
vault-agent-injector-55fdd676d-rzdx2    0/1     Pending    0             3m59s
vault-agent-injector-66f45b5fd5-k6wbh   1/1     Running    2 (71m ago)   92m


```

