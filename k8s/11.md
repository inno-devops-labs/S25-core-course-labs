# Task 1

## `kubectl create secret generic db-user-pass --from-literal=username=admin --from-literal=password='gruda2030`

```
secret/db-user-pass created
```

## `kubectl get secrets`

```
NAME                                TYPE                 DATA   AGE
db-user-pass                        Opaque               2      94s
sh.helm.release.v1.helm-hooks.v1    helm.sh/release.v1   1      2d18h
sh.helm.release.v1.time-app-py.v1   helm.sh/release.v1   1      2d19h
```

## `kubectl describe secret db-user-pass`

```
Name:         db-user-pass
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  9 bytes
username:  5 bytes
```

## `kubectl get secret db-user-pass -o jsonpath='{.data}'`

```
{"password":"Z3J1ZGEyMDMw","username":"YWRtaW4="}
```

## `echo Z3J1ZGEyMDMw | base64 --decode`

```
gruda2030
```

## `echo YWRtaW4= | base64 --decode`

```
admin
```

## `helm plugin install https://github.com/zendesk/helm-secrets`

```
/usr/bin/dpkg
Selecting previously unselected package sops.
(Reading database ... 482794 files and directories currently installed.)
Preparing to unpack /tmp/sops ...
Unpacking sops (3.0.4) ...
Setting up sops (3.0.4) ...
Deprecation Info
  Please note, this project is no longer being maintained.
  Link to active helm-secret plugin could be found in helm documentation: https://helm.sh/docs/community/related/#helm-plugins
Installed plugin: secrets
```

## `gpg --gen-key`

```
gpg (GnuPG) 2.4.4; Copyright (C) 2024 g10 Code GmbH
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/home/leonidm/.gnupg' created
gpg: keybox '/home/leonidm/.gnupg/pubring.kbx' created
Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: leonidm
Email address: l.meshcheriakov@innopolis.university
You selected this USER-ID:
    "leonidm <l.meshcheriakov@innopolis.university>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /home/leonidm/.gnupg/trustdb.gpg: trustdb created
gpg: directory '/home/leonidm/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/leonidm/.gnupg/openpgp-revocs.d/E6F1630AB879E79C08D10BFF91D1194A82FF7879.rev'
public and secret key created and signed.

pub   ed25519 2025-03-05 [SC] [expires: 2028-03-04]
      E6F1630AB879E79C08D10BFF91D1194A82FF7879
uid                      leonidm <l.meshcheriakov@innopolis.university>
sub   cv25519 2025-03-05 [E] [expires: 2028-03-04]
```

## `export EDITOR="code --wait"`

## `sops -p E6F1630AB879E79C08D10BFF91D1194A82FF7879 secrets.yaml`

Inside VS code I wrote:
```
password: gruda2030
```

## `helm secrets view secrets.yaml`

```
password: gruda2030
```

## `kubectl delete secret db-user-pass -n default`

```
secret "db-user-pass" deleted
```

## `helm secrets install time-app-py ./time-app-py -n default -f ./secrets.yaml`

*I removed Helm hooks from the previous lab at this stage, because installation
was stuck because of them.*

```
NAME: time-app-py
LAST DEPLOYED: Wed Mar  5 17:05:34 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=time-app-py,app.kubernetes.io/instance=time-app-py" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './secrets.yaml.dec'
```

## `kubectl get po`

```
NAME                                      READY   STATUS      RESTARTS      AGE
helm-hooks-time-app-py-576d5885f4-j8n8q   1/1     Running     2 (62m ago)   2d19h
postinstall-hook                          0/1     Completed   0             4m27s
preinstall-hook                           0/1     Completed   0             4m33s
time-app-py-597d7b7b46-4ckm5              1/1     Running     0             4m2s
```

## `kubectl exec time-app-py-597d7b7b46-4ckm5 -- printenv | grep DB_PASSWORD`

```
DB_PASSWORD=gruda2030
```

# Task 2

## `helm repo add hashicorp https://helm.releases.hashicorp.com`

```
"hashicorp" has been added to your repositories
```

## `helm repo update`

```
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
```

## `helm install vault hashicorp/vault --set "server.dev.enabled=true"`

```
NAME: vault
LAST DEPLOYED: Wed Mar  5 17:28:24 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

## `kubectl get pods`

```
NAME                                      READY   STATUS      RESTARTS       AGE
helm-hooks-time-app-py-576d5885f4-j8n8q   1/1     Running     2 (128m ago)   2d20h
postinstall-hook                          0/1     Completed   0              70m
preinstall-hook                           0/1     Completed   0              70m
time-app-py-597d7b7b46-4ckm5              1/1     Running     0              70m
vault-0                                   1/1     Running     0              47m
vault-agent-injector-66f45b5fd5-rbdtp     1/1     Running     0              47m
```

## Set a secret in Vault `kubectl exec -it vault-0 -- /bin/sh`

```
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T15:17:21.271030567Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T15:17:21.271030567Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

## Configure Kubernetes authentication `kubectl exec -it vault-0 -- /bin/sh`

```
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write time-app-py - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: time-app-py
/ $ vault write auth/kubernetes/role/time-app-py \
>       bound_service_account_names=time-app-py \
>       bound_service_account_namespaces=default \
>       policies=time-app-py \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/time-app-py
/ $ exit
```

## `kubectl get serviceaccounts`

```
NAME                     SECRETS   AGE
default                  0         3d
helm-hooks-time-app-py   0         2d20h
time-app-py              0         75m
vault                    0         52m
vault-agent-injector     0         52m
```

## `helm uninstall time-app-py`

```
release "time-app-py" uninstalled
```

## `helm secrets install time-app-py ./time-app-py -n default -f ./secrets.yaml`

```
NAME: time-app-py
LAST DEPLOYED: Wed Mar  5 18:27:08 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=time-app-py,app.kubernetes.io/instance=time-app-py" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './secrets.yaml.dec'
```

## `kubectl get po`

```
NAME                                      READY   STATUS      RESTARTS       AGE
helm-hooks-time-app-py-576d5885f4-j8n8q   1/1     Running     2 (140m ago)   2d21h
postinstall-hook                          0/1     Completed   0              82m
preinstall-hook                           0/1     Completed   0              82m
time-app-py-74dc6b5589-24z2t              2/2     Running     0              45s
vault-0                                   1/1     Running     0              59m
vault-agent-injector-66f45b5fd5-rbdtp     1/1     Running     0              59m
```

## `kubectl exec -it time-app-py-74dc6b5589-24z2t -- /bin/sh`

```
Defaulted container "time-app-py" out of: time-app-py, vault-agent, vault-agent-init (init)
/ $ cat /vault/secrets/database-config.txt 
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-05T15:17:21.271030567Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  48.4G     20.0G     26.0G  43% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   256.0M      4.0K    256.0M   0% /vault/secrets
/dev/sda3                48.4G     20.0G     26.0G  43% /dev/termination-log
/dev/sda3                48.4G     20.0G     26.0G  43% /etc/resolv.conf
/dev/sda3                48.4G     20.0G     26.0G  43% /etc/hostname
/dev/sda3                48.4G     20.0G     26.0G  43% /etc/hosts
tmpfs                   256.0M     12.0K    256.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     1.9G         0      1.9G   0% /proc/asound
tmpfs                     1.9G         0      1.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/latency_stats
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     1.9G         0      1.9G   0% /proc/scsi
tmpfs                     1.9G         0      1.9G   0% /sys/firmware
/ $ exit
```