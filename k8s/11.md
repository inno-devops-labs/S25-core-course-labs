# Kubernetes Secrets Overview

## Kubernetes Secrets and Resource Management

### Required outputs

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl create secret generic devops-secret --from-literal=password=supersecret
secret/devops-secret created
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get secret devops-secret -o jsonpath='{.data.password}'
c3VwZXJzZWNyZXQ=
```

```text
root@DESKTOP-D43KHFL:/mnt/c/Users/egora/PycharmProjects/S25-core-course-labs/k8s# echo c3VwZXJzZWNyZXQ= | base64 -d
supersecretroot
```

### Outputs of Helm managing secrets

Secret is defined in secrets.yaml, env with a secret is added to the deployment.yaml file.
For this task I copied the whole repo on my Ubuntu and launch, because with WSL there were difficulties.
Everything is done as described in the video.

```text
(base) egor@NB-5965:~/S25-core-course-labs/k8s$ gpg --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Egor
Name must be at least 5 characters long
Real name: Egora
Email address: emeteoryc07@gmail.com
You selected this USER-ID:
    "Egora <emeteoryc07@gmail.com>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key EE374B9751943553 marked as ultimately trusted
gpg: directory '/home/egor/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/egor/.gnupg/openpgp-revocs.d/5515AAA832BF6FBE6E06A6DDEE374B9751943553.rev'
public and secret key created and signed.

pub   rsa3072 2025-03-05 [SC] [expires: 2027-03-05]
      5515AAA832BF6FBE6E06A6DDEE374B9751943553
uid                      Egora <emeteoryc07@gmail.com>
sub   rsa3072 2025-03-05 [E] [expires: 2027-03-05]

(base) egor@NB-5965:~/S25-core-course-labs/k8s$ gpg --list-keys
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: next trustdb check due at 2027-03-05
/home/egor/.gnupg/pubring.kbx
-----------------------------
pub   rsa3072 2025-03-05 [SC] [expires: 2027-03-05]
      5515AAA832BF6FBE6E06A6DDEE374B9751943553
uid           [ultimate] Egora <emeteoryc07@gmail.com>
sub   rsa3072 2025-03-05 [E] [expires: 2027-03-05]

(base) egor@NB-5965:~/S25-core-course-labs/k8s$ sops -p 5515AAA832BF6FBE6E06A6DDEE374B9751943553 secrets.yaml
```

```text
(base) egor@NB-5965:~/S25-core-course-labs/k8s$ helm secrets install flask-release ./flask-app/ -f ./flask-app/secrets.yaml 
[helm-secrets] Decrypt: ./flask-app/secrets.yaml
NAME: flask-release
LAST DEPLOYED: Wed Mar  5 19:10:56 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=flask-app,app.kubernetes.io/instance=flask-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: ./flask-app/secrets.yaml.dec
(base) egor@NB-5965:~/S25-core-course-labs/k8s$ kubectl get po
NAME                                       READY   STATUS    RESTARTS   AGE
flask-release-flask-app-5dd6f598bd-qgbdn   1/1     Running   0          89s
flask-release-flask-app-5dd6f598bd-sh8cq   1/1     Running   0          89s
flask-release-flask-app-5dd6f598bd-zzq2p   1/1     Running   0          89s
(base) egor@NB-5965:~/S25-core-course-labs/k8s$ kubectl exec flask-release-flask-app-5dd6f598bd-qgbdn -- printenv | grep password
PASSWORD=password
```

## Vault Secret Management System

This is also performed on Ubuntu, the logs are below:

```text
egor@amba:~/Documents/S25-core-course-labs/k8s$ minikube start --driver=docker
üòÑ  minikube v1.35.0 on Ubuntu 22.04
‚ú®  Using the docker driver based on user configuration
üìå  Using Docker driver with root privileges
üëç  Starting "minikube" primary control-plane node in "minikube" cluster
üöú  Pulling base image v0.0.46 ...
üíæ  Downloading Kubernetes v1.32.0 preload ...
    > preloaded-images-k8s-v18-v1...:  333.57 MiB / 333.57 MiB  100.00% 6.88 Mi
    > gcr.io/k8s-minikube/kicbase...:  500.31 MiB / 500.31 MiB  100.00% 5.32 Mi
üî•  Creating docker container (CPUs=2, Memory=3900MB) ...
üê≥  Preparing Kubernetes v1.32.0 on Docker 27.4.1 ...
    ‚ñ™ Generating certificates and keys ...
    ‚ñ™ Booting up control plane ...
    ‚ñ™ Configuring RBAC rules ...
üîó  Configuring bridge CNI (Container Networking Interface) ...
üîé  Verifying Kubernetes components...
    ‚ñ™ Using image gcr.io/k8s-minikube/storage-provisioner:v5
üåü  Enabled addons: storage-provisioner, default-storageclass
üí°  kubectl not found. If you need it, try: 'minikube kubectl -- get pods -A'
üèÑ  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default


egor@amba:~/Documents/S25-core-course-labs/k8s$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

egor@amba:~/Documents/S25-core-course-labs/k8s$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ‚éàHappy Helming!‚éà
```

```text
egor@amba:~/Documents/S25-core-course-labs/k8s$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Thu Mar  6 22:47:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault

egor@amba:~/Documents/S25-core-course-labs/k8s$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          3m44s
vault-agent-injector-66f45b5fd5-tnhwv   1/1     Running   0          3m44s
```

```text
egor@amba:~/Documents/S25-core-course-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" passwo
rd="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T19:52:39.659041147Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T19:52:39.659041147Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
egor@amba:~/Documents/S25-core-course-labs/k8s$ kubectl exec -it flask-release-flask-app-5d28a65323-dsq3c --container flask-app -- /bin/sh
/ $ cat ../vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-06T21:02:26 custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $
```

## Resource Management and Environment Variables

Performed on Ubuntu, the code is below:

```text
egor@amba:~/Documents/S25-core-course-labs/k8s$ kubectl describe deployments.apps flask-release-flask-app
Name:                   flask-release-flask-app
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 21:45:32 +0300
Labels:                 app.kubernetes.io/instance=flask-release-flask-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=flask-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=flask-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: flask-release-flask-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=flask-release-flask-app
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=flask-release-flask-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=flask-app
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   flask-app:
    Image:      rwkals/app_python_distroless:latest
    Port:       5000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     200m
      memory:  256Mi
    Requests:
      cpu:      200m
      memory:   256Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      APP_ENV:  prod
    Mounts:         <none>
  Volumes:          <none>
  Node-Selectors:   <none>
  Tolerations:      <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   flask-release-flask-app-5fcb6d7f46 (3/3 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  2m30s  deployment-controller  Scaled up replica set flask-release-flask-app-5fcb6d7f46 from 0 to 3
```

### Env variables

```text
egor@amba:~/Documents/S25-core-course-labs/k8s$ kubectl exec -it flask-release-flask-app-5fcb6d7f46-wq2cg -- env

Defaulted container "flask-app" out of: flask-app, vault-agent, vault-agent-init (init)
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=flask-release-flask-app-5fcb6d7f46-wq2cg
TERM=xterm
APP_ENV=prod
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.109.137.125:443
FLASK_APP_PORT_5000_TCP=tcp://10.244.0.123:5000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.109.137.125
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8201_TCP=tcp://10.111.143.39:8201
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
FLASK_APP_SERVICE_HOST=10.244.0.123
FLASK_APP_PORT_5000_TCP_PORT=5000
VAULT_SERVICE_HOST=10.111.143.39
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_ADDR=10.111.143.39
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.109.137.125
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
FLASK_APP_SERVICE_PORT_HTTP=5000
VAULT_PORT_8200_TCP=tcp://10.111.143.39:8200
KUBERNETES_PORT=tcp://10.96.0.1:443
LANG=C.UTF-8
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
PYTHON_VERSION=3.10.16
PYTHON_SHA256=bfb249609990220491a1b92850a07135ed0831e41738cf681d63cf01b2a8fbd1
HOME=/home/user
```
