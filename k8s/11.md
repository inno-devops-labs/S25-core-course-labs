# Lab 11: Kubernetes Secrets and Hashicorp Vault

In this lab we demonstrate how to securely manage sensitive data (such as passwords, tokens, or keys) within Kubernetes and how to integrate Hashicorp Vault for secret management. In addition, resource requests and limits for CPU and memory are configured for the application.

---

## Task 1: Kubernetes Secrets and Resource Management

### 1. Create a Secret Using kubectl

**Command:**
```bash
kubectl create secret generic my-secret --from-literal=MY_SECRET=my--secret
```
**Output**:
```commandline
secret/my-secret created
```

## 2. Verify and Decode Your Secret

### Command to view the secret in YAML format:

```bash
kubectl get secret my-secret -o yaml
```

**Output**:
```commandline
apiVersion: v1
data:
  MY_SECRET: bXktLXNlY3JldA==
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T11:14:13Z"
  name: my-secret
  namespace: default
  resourceVersion: "11546"
  uid: 4a2a7e4c-ff51-44f8-88ae-f55addf1af37
type: Opaque
```

To decode a secret:
```commandline
kubectl get secret my-secret -o jsonpath='{.data.MY_SECRET}' | base64 --decode
```

**Output**:
```commandline
my--secret
```

## 3. Manage Secrets with Helm

### 3a. Create a Helm Secret Template

In Helm chart’s `templates` folder, we create a file named `secrets.yaml` with the following content:

```yaml
apiVersion: v1
apiVersion: v1
kind: Secret
metadata:
 name: devops-secret
type: Opaque
data:
 MY_SECRET: {{ .Values.MY_SECRET | b64enc | quote }}
```

### 3b. Update the Deployment Template to Inject the Secret
In templates/deployment.yaml, we update the container’s env field to include the secret and additional environment variables:
```yaml
          env:
            - name: MY_SECRET
              valueFrom:
                secretKeyRef:
                  name: devops-secret
                  key: MY_SECRET
           {{- include "python-app.environmentVars" . | nindent 12 }}
```

The helper template python-app.environmentVars in _helpers.tpl should be:
```commandline
{{ define "python-app.environmentVars" }}
- name: APP_AUTHOR
  value: {{ .Values.environment.author | quote }}
- name: APP_DEBUG
  value: {{ .Values.environment.debug | quote }}
- name: APP_COURSE
  value: {{ .Values.environment.course | quote }}
{{- end }}
```

### 3c. Deploy and Verify via Helm

```yaml
helm secrets install python-app ./python-app -n default -f ./python-app/secrets.yml
```
**Output**:

```commandline
NAME: python-app
LAST DEPLOYED: Sun Mar  9 16:13:57 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './python-app/secrets.yml.dec'
```

List the pods to verify deployment:
```commandline
kubectl get po
```

**Output**:
```commandline
NAME                          READY   STATUS    RESTARTS   AGE
python-app-69586df8b9-4xrxq     1/1     Running   0          27s
```

```commandline
kubectl exec python-app-69586df8b9-4xrxq -- printenv | grep MY_SECRET
```

**Output**:
```commandline
MY_SECRET=my--secret
```

## Task 2: Vault Secret Management System

### 1. Install Vault Using Helm Chart

Added the HashiCorp repository, updated it, and installed Vault in development mode:

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

```commandline
"hashicorp" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈

NAME: vault
LAST DEPLOYED: Sun Mar 9 16:24:11 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

```
helm ls
```

**Output**:
```commandline
NAME    NAMESPACE   REVISION   UPDATED                                  STATUS    CHART            APP VERSION
vault   default     1          2025-03-09 16:24:11.685990291 +0300 MSK   deployed  vault-0.29.1     1.18.1
```

## 2. Follow the Vault Tutorial

### a. Set a Secret in Vault

Access the Vault pod (note: the container name is `vault`):

```bash
kubectl exec -it vault-0 -- /bin/sh
```

Inside the Vault pod, enable the KV secrets engine:
```commandline
vault secrets enable -path=internal kv-v2
```
```commandline
Success! Enabled the kv-v2 secrets engine at: internal/
```

Set a secret:
```commandline
vault kv put internal/database/config username="Nikoali01"
```

**Output**:
```commandline
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T14:42:31.712375015Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

Verify the secret:
```commandline
vault kv get internal/database/config
```

```commandline
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T14:42:31.712375015Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
username    Nikoali01
```

### b. Configure Kubernetes Authentication for Vault
Enable the Kubernetes auth method:

```commandline
vault auth enable kubernetes
```

**Output**:
```commandline
Success! Enabled kubernetes auth method at: kubernetes/
```

Configure Vault with your Kubernetes cluster information:
```commandline
vault write auth/kubernetes/config \
  kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```

**Output**:
```commandline
Success! Data written to: auth/kubernetes/config
```

### c. Define the Vault Policy and Role

Created a policy to allow read access to the secret:
```commandline
vault policy write internal-app - <<EOF
path "internal/data/database/config" {
   capabilities = ["read"]
}
EOF
```

**Output**:
```commandline
Success! Uploaded policy: internal-app
```

Created a role to bind the Kubernetes service account (we bind to internal-app):

```commandline
vault write auth/kubernetes/role/internal-app \
  bound_service_account_names=internal-app \
  bound_service_account_namespaces=default \
  policies=internal-app \
  ttl=24h
```

**Output**:
```commandline
Success! Data written to: auth/kubernetes/role/internal-app
```

Created the Kubernetes service account:

```commandline
kubectl create sa internal-app
```

**Output**:
```commandline
serviceaccount/internal-app created
```

### d.  Implement Vault Secrets Injection in Your Helm Chart

**patch-inject-secrets.yaml**:
```commandline
metadata:
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/agent-inject-secret-database-config.txt: "internal/data/database/config"
    vault.hashicorp.com/role: "internal-app"
```

Patching the deployment:
```commandline
kubectl patch deployment python-app --patch-file=./python-app/patch-inject-secrets.yaml
```

**Output**:
```commandline
deployment.apps/python-app patched
```

Upgradd Helm release so the new annotations are applied:
```commandline
helm upgrade --install python-app .
```

```commandline
Release "python-app" has been upgraded. Happy Helming!
```

```commandline
nikolai@nikolai-Yoga-Slim-7-Pro-14ACH5:~/Documents/DevOpsLabs/S25-core-course-labs/k8s/python-app$ kubectl get pods -l app.kubernetes.io/name=python-app
NAME                          READY   STATUS    RESTARTS   AGE
python-app-5897cf864c-2m2pq   1/2     Running   0          12s
python-app-69586df8b9-xjmsc   1/1     Running   0          13m
nikolai@nikolai-Yoga-Slim-7-Pro-14ACH5:~/Documents/DevOpsLabs/S25-core-course-labs/k8s/python-app$ kubectl exec -it python-app-5897cf864c-2m2pq --container python-app -- /bin/sh
# cat /vault/secrets/database-config.txt
data: map[username:Nikoali01]
metadata: map[created_time:2025-03-09T15:33:54.477611163Z custom_metadata:<nil> deletion_time: destroyed:false version:2]
#  df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          28G   26G  367M  99% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           1.2G  4.0K  1.2G   1% /vault/secrets
/dev/nvme0n1p5   28G   26G  367M  99% /etc/hosts
tmpfs           1.2G   12K  1.2G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           6.8G     0  6.8G   0% /proc/asound
tmpfs           6.8G     0  6.8G   0% /proc/acpi
tmpfs           6.8G     0  6.8G   0% /proc/scsi
tmpfs           6.8G     0  6.8G   0% /sys/firmware
tmpfs           6.8G     0  6.8G   0% /sys/devices/virtual/powercap
```

# Bonus Task: Resource Management & Environment Variables

### 1. Define requests and limits

```commandline
resources:
   limits:
     cpu: 400m
     memory: 256Mi
   requests:
     cpu: 100m
     memory: 256Mi
```

```commandline
helm upgrade --install python-app ./python-app
helm upgrade --install java-app ./java-app
```

```commandline
nikolai@nikolai-Yoga-Slim-7-Pro-14ACH5:~/Documents/DevOpsLabs/S25-core-course-labs/k8s$ kubectl describe pod java-app-7b67bbb59d-pzd2v
Name:             java-app-7b67bbb59d-pzd2v
Namespace:        default
Priority:         0
Service Account:  java-app
Node:             minikube/192.168.49.2
Start Time:       Sun, 09 Mar 2025 18:44:37 +0300
Labels:           app.kubernetes.io/instance=java-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=java-app
                  app.kubernetes.io/part-of=my-shared-library
                  app.kubernetes.io/version=0.1.0
                  helm.sh/chart=java-app-0.1.0
                  pod-template-hash=7b67bbb59d
Annotations:      <none>
Status:           Running
IP:               10.244.0.77
IPs:
  IP:           10.244.0.77
Controlled By:  ReplicaSet/java-app-7b67bbb59d
Containers:
  java-app:
    Container ID:   docker://668dbba61a7df3da7d5bacc292b366fd687ea16ba35b05d5ee13cfc2ce339819
    Image:          nickwidbestie/random-color-picker:6d9f319aeb8fe1782ca1a1037371a90ab8867a3f
    Image ID:       docker-pullable://nickwidbestie/random-color-picker@sha256:ebd3352214a6ad033e144fcc100efcceb6ccb356e09137dd368a471fa5226fcb
    Port:           8081/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sun, 09 Mar 2025 18:44:38 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     300m
      memory:  256Mi
    Requests:
      cpu:        100m
      memory:     256Mi
    Liveness:     http-get http://:8081/hex/color delay=5s timeout=1s period=10s #success=1 #failure=3
    Readiness:    http-get http://:8081/hex/color delay=5s timeout=1s period=10s #success=1 #failure=3
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-fz2ns (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  kube-api-access-fz2ns:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age    From               Message
  ----     ------     ----   ----               -------
  Normal   Scheduled  2m24s  default-scheduler  Successfully assigned default/java-app-7b67bbb59d-pzd2v to minikube
  Normal   Pulled     2m24s  kubelet            Container image "nickwidbestie/random-color-picker:6d9f319aeb8fe1782ca1a1037371a90ab8867a3f" already present on machine
  Normal   Created    2m24s  kubelet            Created container: java-app
  Normal   Started    2m24s  kubelet            Started container java-app
  Warning  Unhealthy  2m14s  kubelet            Liveness probe failed: Get "http://10.244.0.77:8081/hex/color": dial tcp 10.244.0.77:8081: connect: connection refused
  Warning  Unhealthy  2m13s  kubelet            Readiness probe failed: Get "http://10.244.0.77:8081/hex/color": dial tcp 10.244.0.77:8081: connect: connection refused
  Warning  Unhealthy  2m3s   kubelet            Liveness probe failed: Get "http://10.244.0.77:8081/hex/color": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
```

```commandline
nikolai@nikolai-Yoga-Slim-7-Pro-14ACH5:~/Documents/DevOpsLabs/S25-core-course-labs/k8s$ kubectl describe pod python-app-6b8d8f4c8c-kf77t 
Name:             python-app-6b8d8f4c8c-kf77t
Namespace:        default
Priority:         0
Service Account:  python-app
Node:             minikube/192.168.49.2
Start Time:       Sun, 09 Mar 2025 19:19:19 +0300
Labels:           app.kubernetes.io/instance=python-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=python-app
                  app.kubernetes.io/part-of=my-shared-library
                  app.kubernetes.io/version=0.1.0
                  helm.sh/chart=python-app-0.1.0
                  pod-template-hash=6b8d8f4c8c
Annotations:      <none>
Status:           Running
IP:               10.244.0.81
IPs:
  IP:           10.244.0.81
Controlled By:  ReplicaSet/python-app-6b8d8f4c8c
Containers:
  python-app:
    Container ID:   docker://53d341a85bc1a5a47014df22e4b1f582be9e56149c4b6976c83a2b53bb05341e
    Image:          nickwidbestie/region-time-api:latest
    Image ID:       docker-pullable://nickwidbestie/region-time-api@sha256:9eb66c0ca099d519ce46cb7ee2935feeb8b7411e2aa8ab4ece4142663db3ad99
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sun, 09 Mar 2025 19:19:27 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     400m
      memory:  256Mi
    Requests:
      cpu:      100m
      memory:   256Mi
    Liveness:   http-get http://:80/time/moscow delay=5s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:80/time/moscow delay=5s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_SECRET:   <set to the key 'MY_SECRET' in secret 'devops-secret'>  Optional: false
      APP_AUTHOR:  Nikoali01
      APP_DEBUG:   false
      APP_COURSE:  devops
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-tcvnm (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  kube-api-access-tcvnm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:                      <none>
```

## Environment variables

**_helpers.tpl**:
```commandline
{{/*
 Common environment variables
 */}}
{{- define "python-app.environmentVars" -}}
- name: APP_AUTHOR
  value: {{ .Values.environment.author | quote }}
- name: APP_DEBUG
  value: {{ .Values.environment.debug | quote }}
- name: APP_COURSE
  value: {{ .Values.environment.course | quote }}
{{- end -}}
```

**deployment.yaml**:
```commandline
          env:
            - name: MY_SECRET
              valueFrom:
                secretKeyRef:
                  name: devops-secret
                  key: MY_SECRET
           {{- include "python-app.environmentVars" . | nindent 12 }}
```

**values.yaml**:
```commandline
environment:
   debug: false
   author: Nikoali01
   course: devops
```

**Verify it**

```commandline
kubectl exec -it python-app-6b8d8f4c8c-kf77t -- printenv
```

**Output**:
```commandline
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=python-app-6b8d8f4c8c-kf77t
TERM=xterm
APP_AUTHOR=Nikoali01
APP_DEBUG=false
APP_COURSE=devops
MY_SECRET=my--secret
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
JAVA_APP_PORT_8081_TCP=tcp://10.106.201.31:8081
JAVA_APP_PORT_8081_TCP_PORT=8081
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_PORT=8201
JAVA_APP_SERVICE_PORT_HTTP=8081
JAVA_APP_PORT_8081_TCP_ADDR=10.106.201.31
KUBERNETES_SERVICE_PORT_HTTPS=443
PYTHON_APP_PORT=tcp://10.102.186.124:80
VAULT_SERVICE_PORT=8200
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8201_TCP_ADDR=10.108.135.221
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
JAVA_APP_SERVICE_PORT=8081
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.97.40.227:443
PYTHON_APP_PORT_80_TCP=tcp://10.102.186.124:80
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
PYTHON_APP_PORT_80_TCP_PORT=80
VAULT_PORT_8200_TCP_PORT=8200
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.97.40.227:443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.97.40.227
KUBERNETES_SERVICE_PORT=443
JAVA_APP_PORT=tcp://10.106.201.31:8081
KUBERNETES_SERVICE_HOST=10.96.0.1
PYTHON_APP_SERVICE_PORT=80
VAULT_SERVICE_HOST=10.108.135.221
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
JAVA_APP_SERVICE_HOST=10.106.201.31
PYTHON_APP_SERVICE_HOST=10.102.186.124
PYTHON_APP_SERVICE_PORT_HTTP=80
PYTHON_APP_PORT_80_TCP_PROTO=tcp
VAULT_SERVICE_PORT_HTTP=8200
VAULT_PORT=tcp://10.108.135.221:8200
VAULT_PORT_8200_TCP=tcp://10.108.135.221:8200
VAULT_PORT_8201_TCP=tcp://10.108.135.221:8201
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT=tcp://10.96.0.1:443
PYTHON_APP_PORT_80_TCP_ADDR=10.102.186.124
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8200_TCP_ADDR=10.108.135.221
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.97.40.227
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
JAVA_APP_PORT_8081_TCP_PROTO=tcp
LANG=C.UTF-8
GPG_KEY=E3FF2839C048B25C084DEBE9B26995E310250568
PYTHON_VERSION=3.9.21
PYTHON_SHA256=3126f59592c9b0d798584755f2bf7b081fa1ca35ce7a6fea980108d752a05bb1
NAME=RegionTimeAPI
HOME=/root
```