### **1.1 Creating a Secret Using `kubectl`**

#### **Secret Definition (`secret.yaml`)**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  MY_PASS: c2VjcmV0MTIz  # Base64 encoded value of 'secret123'
```

#### **Applying the Secret**
```bash
> kubectl apply -f secret.yaml
secret/my-secret created
```

#### **Verifying the Secret**
```bash
> kubectl get secrets
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      11s
```
##### **Output:**
```bash
> kubectl get secret my-secret -o yaml
apiVersion: v1
data:
  MY_PASS: c2VjcmV0MTIz
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"MY_PASS":"c2VjcmV0MTIz"},"kind":"Secret","metadata":{"annotations":{},"name":"my-secret","namespace":"default"},"type":"Opaque"}
  creationTimestamp: "2025-03-07T10:57:08Z"
  name: my-secret
  namespace: default
  resourceVersion: "540"
  uid: 6df3a967-8529-482d-97de-fb0aada8f7df
type: Opaque
```

#### **Decoding the Secret**
```bash
> echo "c2VjcmV0MTIz" | base64 --decode
secret123%            
```
---

### **1.2 Managing Secrets with Helm**

#### **`values.yaml` Configuration:**
```yaml
secretPassword: "secret123"
```

#### **Secret Template (`secrets.yaml`)**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  MY_PASS: {{ .Values.secretPassword | b64enc }}
```

#### **Deployment Configuration (`Deployment.yaml`)**
```yaml
env:
  - name: MY_PASS
    valueFrom:
      secretKeyRef:
        name: my-secret
        key: MY_PASS
```

#### **Deploying with Helm**
```bash
> helm upgrade --install app-python ./app-python --set secretPassword="secret123"
Release "app-python" does not exist. Installing it now.
NAME: app-python
LAST DEPLOYED: Fri Mar  7 14:17:42 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

#### **Verifying Secret in Pod**
```bash
> kubectl get pods

NAME                          READY   STATUS    RESTARTS   AGE
app-python-6d9b8ffd96-rpcmv   1/1     Running   0          3m22s

> kubectl exec -it app-python-6d9b8ffd96-rpcmv -- printenv | grep MY_PASS

MY_PASS=secret123
```
---
### **2.1 Installing Vault Using Helm**
```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
helm upgrade --install vault hashicorp/vault --set "server.dev.enabled=true"
```
#### **Verifying Vault Deployment**
```bash
> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
app-python-6d9b8ffd96-rpcmv             1/1     Running   0          8m52s
vault-0                                 1/1     Running   0          68s
vault-agent-injector-66f45b5fd5-2ffzl   1/1     Running   0          3m57s
```
---

### **2.2 Storing a Secret in Vault**
```bash
> kubectl exec -it vault-0 -- /bin/sh
/ $ vault kv put secret/myapp MY_PASS="vaultsecret123"
== Secret Path ==
secret/data/myapp

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T12:14:08.987454301Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2
/ $ vault kv get secret/myapp
== Secret Path ==
secret/data/myapp

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T12:14:08.987454301Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2

===== Data =====
Key        Value
---        -----
MY_PASS    vaultsecret123
/ $ vault write auth/kubernetes/role/app-python \
>       bound_service_account_names=app-python \
>       bound_service_account_namespaces=default \
>       policies=app-python \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/app-python
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write app-python - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: app-python
```
---

### **2.4 Injecting Vault Secrets in Helm**

#### **Modify `values.yaml`**
```yaml
vault:
  enabled: true
  role: "my-role"
```

#### **Modify `Deployment.yaml`**
```yaml
annotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/agent-inject-secret-myapp: "secret/myapp"
```

#### **Deploying with Helm**
```bash
> helm upgrade --install app-python ./app-python
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Fri Mar  7 14:42:29 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

#### **Verifying Injected Secrets**
```bash
kubectl exec -it <pod_name> -- cat /vault/secrets/myapp
```
##### **Output:**
```
MY_PASS="vaultsecret123"
```

---

### **3.1 Defining CPU and Memory Limits**

#### **Modify `values.yaml` in both apps**
```yaml
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "256Mi"
```

#### **Deploy and Verify**
```bash
helm upgrade --install app-python ./app-python
kubectl describe pod <pod_name>
```
##### **Output:**
```
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Fri Mar 07, 16:09]
└─[$] <git:(lab11*)> kubectl describe pod app-python-5c6bfdbf5d-gqchw
Name:             app-python-5c6bfdbf5d-gqchw
Namespace:        default
Priority:         0
Service Account:  app-python
Node:             minikube/192.168.49.2
Start Time:       Fri, 07 Mar 2025 16:09:28 +0300
Labels:           app.kubernetes.io/instance=app-python
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=app-python
                  helm.sh/chart=app-python-0.1.0
                  pod-template-hash=5c6bfdbf5d
Annotations:      kubectl.kubernetes.io/restartedAt: 2025-03-07T15:01:50+03:00
Status:           Running
IP:               10.244.0.14
IPs:
  IP:           10.244.0.14
Controlled By:  ReplicaSet/app-python-5c6bfdbf5d
Containers:
  app-python:
    Container ID:   docker://d4b664505f0c4eda4c49645bc543501eeabf8c8fd52571c8a63ee87128ffc2d2
    Image:          ramilevna/app_python
    Image ID:       docker-pullable://ramilevna/app_python@sha256:d4aa67b13cdef3a3926e15339ad5b5e20bf6e0951bc87f8aa707599c4e33cbe5
    Port:           4000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 07 Mar 2025 16:09:28 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  256Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASS:  <set to the key 'MY_PASS' in secret 'my-secret'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-qjxkt (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  kube-api-access-qjxkt:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  17s   default-scheduler  Successfully assigned default/app-python-5c6bfdbf5d-gqchw to minikube
  Normal  Pulled     17s   kubelet            Container image "ramilevna/app_python" already present on machine
  Normal  Created    17s   kubelet            Created container: app-python
  Normal  Started    17s   kubelet            Started container app-python
```