# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Create a Secret Using kubectl

#### Command:

```
kubectl get secrets -n default
```

#### Output:

```
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      47s
```

#### Command:

```
kubectl describe secret my-secret -n default
```

#### Output:

```
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
MY_PASS:  8 bytes
```

#### Command:

```
kubectl get secret my-secret -o jsonpath="{.data.MY_PASS}" -n default | base64 --decode
```

#### Output:

```
password
```

### Deploy Helm Chart and Verify Secret Injection

#### Command:

```
kubectl get po
```

#### Output:

```
NAME                          READY   STATUS    RESTARTS   AGE
app-my-app-67b4c49684-g674r   1/1     Running   0          2m21s
```

#### Command:

```
kubectl exec app-my-app-67b4c49684-g674r -- printenv | grep MY_PASS
```

#### Output:

```
MY_PASS=SuperSecret123
```

## Task 2: Vault Secret Management System

### Verify Running Pods

#### Command:

```
kubectl get pods 
```

#### Output:

```
NAME                                    READY   STATUS    RESTARTS   AGE
app-my-app-67b4c49684-g674r             1/1     Running   0          32m
orgchart-84d74965c9-8tsjh               2/2     Running   0          5m48s
vault-0                                 1/1     Running   0          27m
vault-agent-injector-66f45b5fd5-tthqw   1/1     Running   0          27m
```

### Verify Vault Agent Logs

#### Command

```
kubectl logs $(kubectl get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") --container vault-agent
```

#### Output:

```
==> Vault Agent started! Log data will stream in below:

==> Vault Agent configuration:

           Api Address 1: http://bufconn
                     Cgo: disabled
               Log Level: info
                 Version: Vault v1.18.1, built 2024-10-29T14:21:31Z
             Version Sha: f479e5c85462477c9334564bc8f69531cdb03b65

2025-03-05T07:36:39.271Z [INFO]  agent.sink.file: creating file sink
2025-03-05T07:36:39.271Z [INFO]  agent.sink.file: file sink configured: path=/home/vault/.vault-token mode=-rw-r----- owner=100 group=1000
2025-03-05T07:36:39.271Z [INFO]  agent.auth.handler: starting auth handler
2025-03-05T07:36:39.271Z [INFO]  agent.sink.server: starting sink server
2025-03-05T07:36:39.271Z [INFO]  agent.auth.handler: authenticating
2025-03-05T07:36:39.271Z [INFO]  agent.exec.server: starting exec server
2025-03-05T07:36:39.271Z [INFO]  agent.exec.server: no env templates or exec config, exiting
2025-03-05T07:36:39.271Z [INFO]  agent.template.server: starting template server
2025-03-05T07:36:39.272Z [INFO]  agent: (runner) creating new runner (dry: false, once: false)
2025-03-05T07:36:39.277Z [INFO]  agent.auth.handler: authentication successful, sending token to sinks
2025-03-05T07:36:39.277Z [INFO]  agent.auth.handler: starting renewal process
2025-03-05T07:36:39.322Z [INFO]  agent.sink.file: token written: path=/home/vault/.vault-token
2025-03-05T07:36:39.323Z [INFO]  agent: (runner) creating watcher
2025-03-05T07:36:39.323Z [INFO]  agent.template.server: template server received new token
2025-03-05T07:36:39.323Z [INFO]  agent: (runner) stopping
2025-03-05T07:36:39.323Z [INFO]  agent: (runner) creating new runner (dry: false, once: false)
2025-03-05T07:36:39.323Z [INFO]  agent: (runner) creating watcher
2025-03-05T07:36:39.323Z [INFO]  agent: (runner) starting
2025-03-05T07:36:39.325Z [INFO]  agent.auth.handler: renewed auth token
```

### Verify Secret Injection in Application

#### Command:

```
kubectl exec $(kubectl get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") --container orgchart -- cat /vault/secrets/database-config.txt 
```

#### Output:

```
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-05T07:20:15.525200187Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

### Verify Mounted Secrets Storage

#### Command:

```
kubectl exec -it $(kubectl get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") -- df -h
```

#### Output:

```
Filesystem                Size      Used Available Use% Mounted on
overlay                 952.3G     23.6G    927.9G   2% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
/dev/nvme0n1p3          952.3G     23.6G    927.9G   2% /dev/termination-log
tmpfs                    31.1G      4.0K     31.1G   0% /vault/secrets
/dev/nvme0n1p3          952.3G     23.6G    927.9G   2% /etc/resolv.conf
/dev/nvme0n1p3          952.3G     23.6G    927.9G   2% /etc/hostname
/dev/nvme0n1p3          952.3G     23.6G    927.9G   2% /etc/hosts
tmpfs                    31.1G     12.0K     31.1G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    15.5G         0     15.5G   0% /proc/asound
tmpfs                    15.5G         0     15.5G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/latency_stats
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                    15.5G         0     15.5G   0% /proc/scsi
tmpfs                    15.5G         0     15.5G   0% /sys/firmware
tmpfs                    15.5G         0     15.5G   0% /sys/devices/virtual/powercap
```

