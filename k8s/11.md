# Lab 11

## Task 1

Creating and verifying a secret:

```bash
kubectl create secret generic lab11-secret --from-literal=username=username --from-literal=password=password

kubectl get secrets
NAME           TYPE     DATA   AGE
lab11-secret   Opaque   2      11s

kubectl describe secret lab11-secret
Name:         lab11-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  8 bytes
username:  8 bytes
```

Decoding a secret:

```bash
kubectl get secret lab11-secret -o jsonpath="{.data.username}" | base64 --decode
username

kubectl get secret lab11-secret -o jsonpath="{.data.password}" | base64 --decode
password
```

After it I also created gpg-key to encode my secret, so it would be safely stored in the remote repo. Then I installed the chart:

```bash
helm secrets install app-python ./app-python -n default -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: app-python
LAST DEPLOYED: Fri Mar  7 17:48:20 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: ./secrets.yaml.dec
```

## Task 2

Installing Vault using Helm chart:

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" already exists with the same configuration, skipping
aksss-MacBook-Pro:k8s mangocandle$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Unable to get an update from the "hashicorp" chart repository (https://helm.releases.hashicorp.com):
        failed to fetch https://helm.releases.hashicorp.com/index.yaml : 403 Forbidden
Update Complete. ⎈Happy Helming!⎈

helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Fri Mar  7 18:42:17 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

Results:

```bash
kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
app-python-84f6658b8f-l9dls             1/1     Running   0          58m
vault-0                                 1/1     Running   0          5m13s
vault-agent-injector-66f45b5fd5-bf5q8   1/1     Running   0          5m15s
```

Then I followed the guide recommended in lab:

```bash
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T15:49:11.925754582Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T15:49:11.925754582Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

Adding a patch:

```bash
kubectl patch deployment app-python --patch-file=patch-inject-secrets.yaml
deployment.apps/app-python patched
```

Verifying the correct work:

```bash
kubectl get pods
NAME                                    READY   STATUS        RESTARTS   AGE
app-python-7b5cbff8d8-wfl6b             2/2     Running       0          15s
app-python-868b5d8f86-6hlj4             1/1     Terminating   0          78s
vault-0                                 1/1     Running       0          25m
vault-agent-injector-66f45b5fd5-bf5q8   1/1     Running       0          25m
aksss-MacBook-Pro:k8s mangocandle$ kubectl exec -it app-python-7b5cbff8d8-wfl6b -- sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
$ pwd
/app
$ ls
CI.md  DOCKER.md  PYTHON.md  README.md  app.py  requirements.txt  static  templates  tests  venv
$ cd ..
$
$ ls
app  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  vault
$ cd vault/secrets
$ ls
database-config.txt
$ cat database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard$
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          59G   14G   43G  24% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           3.9G  4.0K  3.9G   1% /vault/secrets
/dev/vda1        59G   14G   43G  24% /etc/hosts
tmpfs           3.9G   12K  3.9G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           2.0G     0  2.0G   0% /proc/acpi
tmpfs           2.0G     0  2.0G   0% /sys/firmware
```

## Resources (configured in values.yaml):

```bash
kubectl describe deployments.apps app-python
Name:                   app-python
Namespace:              default
CreationTimestamp:      Fri, 07 Mar 2025 19:06:38 +0300
Labels:                 <none>
Annotations:            deployment.kubernetes.io/revision: 2
Selector:               app=app-python
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app=app-python
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/agent-inject-status: update
                    vault.hashicorp.com/agent-inject-template-database-config.txt:
                      {{- with secret "internal/data/database/config" -}}
                      postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
                      {{- end -}}
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   app-python:
    Image:         mangocandle/app_python
    Port:          5001/TCP
    Host Port:     0/TCP
    Environment:   <none>
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  app-python-868b5d8f86 (0/0 replicas created)
NewReplicaSet:   app-python-7b5cbff8d8 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  4m8s   deployment-controller  Scaled up replica set app-python-868b5d8f86 from 0 to 1
  Normal  ScalingReplicaSet  3m5s   deployment-controller  Scaled up replica set app-python-7b5cbff8d8 from 0 to 1
  Normal  ScalingReplicaSet  2m58s  deployment-controller  Scaled down replica set app-python-868b5d8f86 from 1 to 0
```

Checking the environmental variables:

```bash
kubectl exec -it app-python-7b5cbff8d8-wfl6b -- env
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-python-7b5cbff8d8-wfl6b
TERM=xterm
VAULT_PORT_8201_TCP_PORT=8201
APP_PYTHON_PORT_80_TCP_ADDR=10.111.217.213
APP_JAVA_SERVICE_SERVICE_HOST=10.97.39.154
KUBERNETES_SERVICE_PORT_HTTPS=443
APP_PYTHON_SERVICE_SERVICE_HOST=10.96.83.123
APP_PYTHON_SERVICE_PORT_80_TCP=tcp://10.96.83.123:80
VAULT_SERVICE_PORT=8200
VAULT_SERVICE_PORT_HTTP=8200
APP_PYTHON_SERVICE_HOST=10.111.217.213
APP_PYTHON_PORT_80_TCP_PORT=80
KUBERNETES_SERVICE_HOST=10.96.0.1
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8200_TCP_ADDR=10.97.71.59
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
APP_PYTHON_PORT_80_TCP_PROTO=tcp
APP_JAVA_SERVICE_PORT_80_TCP=tcp://10.97.39.154:80
KUBERNETES_PORT=tcp://10.96.0.1:443
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_ADDR=10.97.71.59
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
APP_JAVA_SERVICE_PORT=tcp://10.97.39.154:80
APP_JAVA_SERVICE_PORT_80_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
VAULT_PORT=tcp://10.97.71.59:8200
VAULT_PORT_8201_TCP=tcp://10.97.71.59:8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.107.255.7
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
APP_PYTHON_SERVICE_PORT_80_TCP_PORT=80
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.107.255.7
APP_PYTHON_PORT_80_TCP=tcp://10.111.217.213:80
APP_JAVA_SERVICE_PORT_80_TCP_PORT=80
KUBERNETES_PORT_443_TCP_PORT=443
APP_PYTHON_SERVICE_SERVICE_PORT=80
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.107.255.7:443
VAULT_PORT_8201_TCP_PROTO=tcp
APP_PYTHON_SERVICE_PORT_HTTP=80
APP_PYTHON_PORT=tcp://10.111.217.213:80
APP_JAVA_SERVICE_SERVICE_PORT=80
APP_JAVA_SERVICE_PORT_80_TCP_ADDR=10.97.39.154
APP_PYTHON_SERVICE_PORT_80_TCP_ADDR=10.96.83.123
VAULT_SERVICE_HOST=10.97.71.59
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
APP_PYTHON_SERVICE_PORT=tcp://10.96.83.123:80
KUBERNETES_PORT_443_TCP_PROTO=tcp
APP_PYTHON_SERVICE_PORT_80_TCP_PROTO=tcp
VAULT_PORT_8200_TCP=tcp://10.97.71.59:8200
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.107.255.7:443
LANG=C.UTF-8
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
PYTHON_VERSION=3.11.11
PYTHON_SHA256=2a9920c7a0cd236de33644ed980a13cbbc21058bfdc528febb6081575ed73be3
HOME=/home/appuser
```
