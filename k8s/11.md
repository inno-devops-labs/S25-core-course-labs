# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Create a Secret Using kubectl

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl create secret generic my-secret --from-literal=MY_PASS=mysecretpassword
secret/my-secret created
```

### Verify and Decode Your Secret

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl get secret my-secret -o yaml
apiVersion: v1
data:
  MY_PASS: bXlzZWNyZXRwYXNzd29yZA==
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T18:18:27Z"
  name: my-secret
  namespace: default
  resourceVersion: "5918"
  uid: a6f0faaa-8f40-4100-9616-7ec286609909
type: Opaque
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> python -c "import base64; print(base64.b64decode('bXlzZWNyZXRwYXNzd29yZA==').decode('utf-8'))"     
mysecretpassword
```

### Retrieve the List of Pods

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl get po  
NAME                            READY   STATUS      RESTARTS      AGE
app-python-6c6b6cdff8-4hpg7     1/1     Running     2 (10m ago)   6d18h
app-python-6c6b6cdff8-fznhm     1/1     Running     2 (10m ago)   6d18h
app-python-6c6b6cdff8-n5npn     1/1     Running     2 (10m ago)   6d18h
```

### Manage Secrets with Helm

#### Upgrade Helm Deployment

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm upgrade app-python app-python
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sun Mar  9 21:54:34 2025
NAMESPACE: default
STATUS: deployed
REVISION: 4
```

#### Retrieve List of Pods After Upgrade

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl get pods
NAME                            READY   STATUS      RESTARTS   AGE
app-python-76fb5f95f7-cv4dl     1/1     Running     0          45s
app-python-76fb5f95f7-jkjqn     1/1     Running     0          48s
app-python-76fb5f95f7-ttnf2     1/1     Running     0          44s
```

#### Verify Secret Inside the Pod

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec app-python-76fb5f95f7-cv4dl -- printenv | findstr USERNAME
USERNAME=myuser
```

---

## Task 2: Vault Secret Management System

### Install Vault Using Helm Chart

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> 
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
```

### Unseal Vault

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm install vault hashicorp/vault --create-namespace --namespace vault
NAME: vault
LAST DEPLOYED: Sun Mar  9 22:03:42 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault status
Key                Value
---                -----
Seal Type          shamir
Initialized        false
Sealed             true
Total Shares       0
Threshold          0
Unseal Progress    0/0
Unseal Nonce       n/a
Version            1.18.1
Build Date         2024-10-29T14:21:31Z
Storage Type       file
HA Enabled         false
command terminated with exit code 2
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault operator init
Unseal Key 1: 1c8qhLviv8gwize5NZNK5HoG6ml8sBO/Cc8mnyGvMfaV
Unseal Key 2: ptIN+xXajkhj6mRNB4AQDr0o1jXvhi131Hoo+N6u2oBF
Unseal Key 3: 69nYZ5Ai7BtL0vXft87AcqDVZ9WHJ+rfyOtmX2dSAIwb
Unseal Key 4: jCS6Cln0oU7HUxeBnc7bgxCShN7g4t6e9jZLG/k4UC+q
Unseal Key 5: +aEN4w3uyHtWgo508jPt16OaotJzy0oLv8T3a1r2iG3p

Initial Root Token: XXXXXXXXXXXXXXXXXXXXX

Vault initialized with 5 key shares and a key threshold of 3. Please securely
distribute the key shares printed above. When the Vault is re-sealed,
restarted, or stopped, you must supply at least 3 of these keys to unseal it
before it can start servicing requests.

Vault does not store the generated root key. Without at least 3 keys to
reconstruct the root key, Vault will remain permanently sealed!

It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. See "vault operator rekey" for more information.
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault operator unseal 1c8qhLviv8gwize5NZNK5HoG6ml8sBO/Cc8mnyGvMfaV    
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       5
Threshold          3
Unseal Progress    1/3
Unseal Nonce       3924d8d1-0525-48fc-8421-e242bde22826
Version            1.18.1
Build Date         2024-10-29T14:21:31Z
Storage Type       file
HA Enabled         false
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault operator unseal ptIN+xXajkhj6mRNB4AQDr0o1jXvhi131Hoo+N6u2oBF    
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       5
Threshold          3
Unseal Progress    2/3
Unseal Nonce       3924d8d1-0525-48fc-8421-e242bde22826
Version            1.18.1
Build Date         2024-10-29T14:21:31Z
Storage Type       file
HA Enabled         false
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault operator unseal 69nYZ5Ai7BtL0vXft87AcqDVZ9WHJ+rfyOtmX2dSAIwb    
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    5
Threshold       3
Version         1.18.1
Build Date      2024-10-29T14:21:31Z
Storage Type    file
Cluster Name    vault-cluster-239786d9
Cluster ID      96d74188-7920-a5b8-4c3e-a0698799bd84
HA Enabled      false
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault login XXXXXXXXXXXXXXXXXXXXXXXXX
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                XXXXXXXXXXXXXXXXXXXXXXXXXXXXXx
token_accessor       OWgJqGAJpwWtQA4FFS5nrFmt
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]

PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s>  kubectl get pods -n vault
NAME                                   READY   STATUS    RESTARTS   AGE
vault-0                                1/1     Running   0          13m
vault-agent-injector-6c5fcb994-x6k5c   1/1     Running   0          13m

```

### Verify Vault Status

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault status
Key                      Value
---                      -----
Seal Type                shamir
Initialized              true
Sealed                   false
Total Shares             5
Threshold                3
Version                  1.18.1
Build Date               2024-10-29T14:21:31Z
Storage Type             file
Cluster Name             vault-cluster-239786d9
Cluster ID               96d74188-7920-a5b8-4c3e-a0698799bd84
HA Enabled               false
```

### Configure Kubernetes Authentication

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```

### Create Vault Role for Kubernetes

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault write auth/kubernetes/role/internal-app bound_service_account_names=internal-app-sa bound_service_account_namespaces=default policies=internal-app ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault read auth/kubernetes/role/internal-app
Key                                         Value
---                                         -----
alias_name_source                           serviceaccount_uid
bound_service_account_names                 [internal-app-sa]
bound_service_account_namespace_selector    n/a
bound_service_account_namespaces            [default]
policies                                    [internal-app]
token_bound_cidrs                           []
token_explicit_max_ttl                      0s
token_max_ttl                               0s
token_no_default_policy                     false
token_num_uses                              0
token_period                                0s
token_policies                              [internal-app]
token_ttl                                   24h
token_type                                  default
ttl                                         24h

```

### Store and Retrieve Secret from Vault

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault kv put secret/myapp/config username="appuser" password="apppassword"
====== Secret Path ======
secret/data/myapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:29:04.160021154Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it vault-0 -n vault -- vault kv get secret/myapp/config
====== Secret Path ======
secret/data/myapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:29:04.160021154Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    apppassword
username    appuser
```

### Implement Vault Secrets in Helm Chart

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
app-python-76fb5f95f7-b5t67      1/1     Running   0          10m
app-python-76fb5f95f7-nswvq      1/1     Running   0          10m
app-python-76fb5f95f7-pdkw8      1/1     Running   0          10m
vault-0                          1/1     Running   0          25m
vault-agent-injector-66f45b5fd5  1/1     Running   0          25m
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it $(kubectl get pod -l app.kubernetes.io/name=app-python -o jsonpath="{.items[0].metadata.name}") -- ls /mnt/secrets
vault-secret
```

```powershell
PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl exec -it $(kubectl get pod -l app.kubernetes.io/name=app-python -o jsonpath="{.items[0].metadata.name}") -- cat /mnt/secrets/vault-secret
apppassword
```

### Disk Usage Verification

```powershell
df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay         251G   12G  227G   5% /
tmpfs            64M     0   64M   0% /dev
tmpfs           986M     0  986M   0% /sys/fs/cgroup
shm              64M     0   64M   0% /dev/shm
/dev/sde        251G   12G  227G   5% /etc/hosts
tmpfs           2.0G   12K  2.0G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           986M     0  986M   0% /proc/acpi
tmpfs           986M     0  986M   0% /sys/firmware

```
