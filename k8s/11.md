# 11

```bash
$ kubectl create secret generic secret --from-literal=PASSWORD=test
secret/secret created
```

```bash
$ kubectl get secrets
NAME                               TYPE                 DATA   AGE
secret                             Opaque               1      42s
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      9d
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      9d
```

```bash
$ kubectl get secret secret -o yaml
apiVersion: v1
data:
  PASSWORD: dGVzdA==
kind: Secret
metadata:
  creationTimestamp: "2025-03-06T20:11:51Z"
  name: secret
  namespace: default
  resourceVersion: "2392"
  uid: 623ebd7b-aac0-4769-b9db-dbc674993027
type: Opaque
```

```bash
$ kubectl get secret secret -o jsonpath='{.data}'
{"PASSWORD":"dGVzdA=="}
```

```bash
$ echo "dGVzdA==" | base64 -d
test
```

```bash
$ sops -p 83D97ABE9F5A3A214BEE2CBBDCAAAA0EAC670670 secrets.yaml
# password: test
```

```bash
$ helm secrets view secrets.yaml
password: test
```

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
```

```bash
$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "stable" chart repository
Update Complete. ⎈Happy Helming!⎈
```

```bash
$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Fri Mar  7 00:45:27 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

```bash
$ kubectl get pods
NAME                                     READY   STATUS      RESTARTS        AGE
app-python-77fdsd33eaf-f43s2             1/1     Running     0               20m
helm-hooks-app-python-7588768b54-nwlwx   1/1     Running     2               9d
vault-0                                  1/1     Running     0               3m35s
vault-agent-injector-66f45b5fd5-skd57    1/1     Running     0               3m36s
```

```bash
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

/ $ vault kv put internal/database/config username="admin" password="test"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T0:52:18.598497462Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T0:52:18.598497462Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    test
username    admin
```

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

/ $ vault write auth/kubernetes/config \
      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

```bash
$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python             0         30m
helm-hooks-app-python  0         9d
vault                  0         9m12s
vault-agent-injector   0         9m13s

$ kubectl create sa internal-app
serviceaccount/internal-app created

$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python             0         30m
helm-hooks-app-python  0         9d
internal-app           0         20s
vault                  0         9m32s
vault-agent-injector   0         9m33s
```

```bash
$ kubectl exec -it app-python-77fdsd33eaf-f43s2 -- /bin/sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)

$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay         450G   53G  397G   3% /
tmpfs            64M     0   64M   0% /dev
tmpfs           7.7G  4.0K  7.7G   1% /vault/secrets
shm              64M   16K   64M   1% /dev/shm
/dev/vda1       450G   53G  397G   3% /etc/hosts
tmpfs           7.7G   12K  7.7G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/scsi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```

```bash
$ cat vault/secrets/database-config.txt
postgresql://admin:test@postgres:5432/wizard
```
