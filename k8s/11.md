# Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Creating a Secret Using kubectl

```bash
kubectl create secret generic db-credentials --from-literal=username=dbuser --from-literal=password=dbpassword
secret/db-credentials created
```

### Verifying and Decoding the Secret

Getting the secret in YAML format:
```bash
kubectl get secret db-credentials -o yaml
apiVersion: v1
data:
  password: ZGJwYXNzd29yZA==
  username: ZGJ1c2Vy
kind: Secret
metadata:
  creationTimestamp: "2025-03-08T10:21:06Z"
  name: db-credentials
  namespace: default
  resourceVersion: "6688"
  uid: a1f8e981-eb06-4193-b085-b4d4c91f3913
type: Opaque
```

Decoding the secret values:
```bash
echo ZGJ1c2Vy | base64 -d
dbuser

echo ZGJwYXNzd29yZA== | base64 -d
dbpassword
```

### Managing Secrets with Helm

1. Created a `secrets.yaml` file in the templates folder:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "moscow-time.fullname" . }}-secrets
  labels:
    {{- include "moscow-time.labels" . | nindent 4 }}
type: Opaque
data:
  # Values are base64 encoded
  db_username: {{ .Values.secrets.dbUsername | b64enc | quote }}
  db_password: {{ .Values.secrets.dbPassword | b64enc | quote }}
```

2. Added secrets configuration to `values.yaml`:

```yaml
# Secret values for the application
secrets:
  dbUsername: "moscow-admin"
  dbPassword: "strongpassword123"
```

3. Updated the deployment.yaml to use these secrets:

```yaml
env:
  - name: DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: {{ include "moscow-time.fullname" . }}-secrets
        key: db_username
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: {{ include "moscow-time.fullname" . }}-secrets
        key: db_password
```

4. Applied the changes with Helm:

```bash
helm upgrade --install moscow-time ./moscow-time
```

5. Verified that the pod was created and the secrets were injected:

```bash
kubectl get pods
NAME                           READY   STATUS    RESTARTS   AGE
moscow-time-6bf7465569-zrdnf   1/1     Running   0          5s

kubectl exec moscow-time-6bf7465569-zrdnf -- printenv | grep DB_
DB_USERNAME=moscow-admin
DB_PASSWORD=strongpassword123
```

The secrets have been successfully injected into the pod as environment variables.

## Task 2: Vault Secret Management System

### Installing Vault Using Helm Chart

1. Added the HashiCorp Helm repository:

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
```

2. Installed Vault in development mode:

```bash
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

3. Verified that the Vault pods are running:

```bash
kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
moscow-time-6bf7465569-zrdnf            1/1     Running   0          5m48s
vault-0                                 1/1     Running   0          33s
vault-agent-injector-66f45b5fd5-hjsjv   1/1     Running   0          33s
```

### Setting a Secret in Vault

1. Created a secret in Vault:

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault kv put secret/moscow-time/config username='vault-user' password='vault-password'"
========= Secret Path =========
secret/data/moscow-time/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T10:30:02.878532983Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

2. Verified the secret:

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault kv get secret/moscow-time/config"
========= Secret Path =========
secret/data/moscow-time/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T10:30:02.878532983Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    vault-password
username    vault-user
```

### Configuring Kubernetes Authentication

1. Enabled Kubernetes authentication in Vault:

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault auth enable kubernetes"
Success! Enabled kubernetes auth method at: kubernetes/
```

2. Configured the Kubernetes authentication method:

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault write auth/kubernetes/config kubernetes_host=https://kubernetes.default.svc"
Success! Data written to: auth/kubernetes/config
```

3. Created a policy for our application:

```bash
kubectl exec -it vault-0 -- sh -c "echo 'path \"secret/data/moscow-time/config\" { capabilities = [\"read\"] }' > /tmp/moscow-time-policy.hcl && vault policy write moscow-time-policy /tmp/moscow-time-policy.hcl"
Success! Uploaded policy: moscow-time-policy
```

4. Created a Kubernetes authentication role:

```bash
kubectl exec -it vault-0 -- sh -c "vault write auth/kubernetes/role/moscow-time bound_service_account_names=moscow-time bound_service_account_namespaces=default policies=moscow-time-policy ttl=24h"
Success! Data written to: auth/kubernetes/role/moscow-time
```

### Implementing Vault Secrets in Helm Chart

1. Updated `values.yaml` to include Vault annotations:

```yaml
# Vault configuration
vaultEnabled: true
vaultAgent:
  enabled: true
  role: "moscow-time"

podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "moscow-time"
  vault.hashicorp.com/agent-inject-secret-config: "secret/data/moscow-time/config"
  vault.hashicorp.com/agent-inject-template-config: |
    {{- with secret "secret/data/moscow-time/config" -}}
    VAULT_DB_USERNAME={{ .Data.data.username }}
    VAULT_DB_PASSWORD={{ .Data.data.password }}
    {{- end -}}
```

2. Upgraded the Helm chart:

```bash
helm upgrade --install moscow-time ./moscow-time
```

3. Verified that the pod has the Vault agent sidecar:

```bash
kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
moscow-time-799cd8bc4d-fwqlb            2/2     Running   0          4s
vault-0                                 1/1     Running   0          5m44s
vault-agent-injector-66f45b5fd5-hjsjv   1/1     Running   0          5m44s
```

4. Verified that the secrets are correctly injected:

```bash
kubectl exec -it moscow-time-799cd8bc4d-fwqlb -c moscow-time -- cat /vault/secrets/config
VAULT_DB_USERNAME=vault-user
VAULT_DB_PASSWORD=vault-password
```

5. Verified that the Vault secrets volume is mounted:

```bash
kubectl exec -it moscow-time-799cd8bc4d-fwqlb -c moscow-time -- df -h | grep vault
tmpfs                   640.0M      4.0K    640.0M   0% /vault/secrets
```

The Vault integration is working correctly, and the secrets from Vault are successfully injected into the application pod. 