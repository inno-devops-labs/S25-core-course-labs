# Kubernetes Secrets and Hashicorp Vault

## Task 1

- Create secret
  ```sh
  vm@vm /m/v/d/h/V/U/L/P/D/S25-core-course-labs (lab11)> kubectl create secret generic my-secret --from-literal=secret='very__secret_info'
  secret/my-secret created
  ```
- Confirme and decode the secret
  ```sh
  vm@vm /m/v/d/h/V/U/L/P/D/S25-core-course-labs (lab11)> kubectl get secrets
  NAME        TYPE     DATA   AGE
  my-secret   Opaque   1      116s
  vm@vm /m/v/d/h/V/U/L/P/D/S25-core-course-labs (lab11)> kubectl describe secret my-secret
  Name:         my-secret
  Namespace:    default
  Labels:       <none>
  Annotations:  <none>

  Type:  Opaque

  Data
  ====
  secret:  17 bytes
  vm@vm /m/v/d/h/V/U/L/P/D/S25-core-course-labs (lab11)> kubectl get secret my-secret -o jsonpath='{.data.secret}' | base64 -d
  very__secret_info⏎
  ```
- Manage secrets with Helm
  - Install plugin

    ```sh
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> helm plugin install https://github.com/zendesk/helm-secrets
    /usr/bin/dpkg
    [sudo] password for vm: 
    Selecting previously unselected package sops.
    (Reading database ... 247044 files and directories currently installed.)
    Preparing to unpack /tmp/sops ...
    Unpacking sops (3.0.4) ...
    Setting up sops (3.0.4) ...
    Deprecation Info
      Please note, this project is no longer being maintained.
      Link to active helm-secret plugin could be found in helm documentation: https://helm.sh/docs/community/related/#helm-plugins
    Installed plugin: secrets
    ```
  - Provide acknowlegement outputs

    ```sh
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11) [1]> helm install python-app --generate-name
    NAME: python-app-1741446994
    LAST DEPLOYED: Sat Mar  8 18:16:34 2025
    NAMESPACE: default
    STATUS: deployed
    REVISION: 1
    NOTES:
    1. Get the application URL by running these commands:
      export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app-1741446994" -o jsonpath="{.items[0].metadata.name}")
      export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
      echo "Visit http://127.0.0.1:8080 to use your application"
      kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl get pods
    NAME                                     READY   STATUS    RESTARTS   AGE
    python-app-1741446994-69f645c76d-bj8kw   1/1     Running   0          2m5s
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl exec python-app-1741446994-69f645c76d-bj8kw -- printenv | grep SECRET
    SECRET=very__secret_info
    ```

## Task 2

- Install `vault`

  ```sh
  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11) [1]> helm install vault ../../local-repo/vault-helm-main --set "server.dev.enabled=true"
  NAME: vault
  LAST DEPLOYED: Sat Mar  8 20:38:22 2025
  NAMESPACE: default
  STATUS: deployed
  REVISION: 1
  NOTES:
  Thank you for installing HashiCorp Vault!

  Now that you have deployed Vault, you should look over the docs on using
  Vault with Kubernetes available here:

  https://developer.hashicorp.com/vault/docs


  Your release is named vault. To learn more about the release, try:

    $ helm status vault
    $ helm get manifest vault
  ```
- Interactive shell out

  - Set secrets in Vault
    ```sh
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl exec -it vault-0 -- /bin/sh
    / $ vault secrets enable -path=internal kv-v2
    Success! Enabled the kv-v2 secrets engine at: internal/
    / $ vault kv put internal/database/config username="very-readonly-username" password="very-
    secret-password"
    ======== Secret Path ========
    internal/data/database/config

    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2025-03-08T17:46:38.480189858Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1
    / $ vault kv get internal/database/config
    ======== Secret Path ========
    internal/data/database/config

    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2025-03-08T17:46:38.480189858Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1

    ====== Data ======
    Key         Value
    ---         -----
    password    very-secret-password
    username    very-readonly-username
    / $ exit

    ```
  - Configure Kubernetes authentication
    ```sh
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl exec -it vault-0 -- /bin/sh
    / $ vault auth enable kubernetes
    Success! Enabled kubernetes auth method at: kubernetes/
    / $ vault write auth/kubernetes/config \
    >       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
    Success! Data written to: auth/kubernetes/config
    / $ vault policy write internal-app - <<EOF
    > path "internal/data/database/config" {
    >    capabilities = ["read"]
    > }
    > EOF
    Success! Uploaded policy: internal-app
    / $ vault write auth/kubernetes/role/internal-app \
    >       bound_service_account_names=internal-app \
    >       bound_service_account_namespaces=default \
    >       policies=internal-app \
    >       ttl=24h
    Success! Data written to: auth/kubernetes/role/internal-app
    / $ exit
    ```
  - Define a Kubernetes service account
    ```sh
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl get serviceaccounts
    NAME                   SECRETS   AGE
    default                0         3d6h
    vault                  0         40m
    vault-agent-injector   0         40m
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl create sa internal-app
    serviceaccount/internal-app created
    vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl get serviceaccounts
    NAME                   SECRETS   AGE
    default                0         3d6h
    internal-app           0         4s
    vault                  0         40m
    vault-agent-injector   0         40m

    ```
- Implement Vault Secrets in Helm Chart

  ```sh
  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl exec $(kubectl get pod -l app.kubernetes.io/instance=my-python-app -o jsonpath="{.items[0].metadata.name}") --container python-app -- ls /vault/secrets
  database-config.txt
  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11) [1]> kubectl exec -it my-python-app-5f8fd4c6f9-x27bt -- bash
  Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
  app_user@my-python-app-5f8fd4c6f9-x27bt:/app$ cat /va 
  app_user@my-python-app-5f8fd4c6f9-x27bt:/app$ cat /vault/secrets/database-config.txt 
  database:
    username: very-readonly-username
    password: very-secret-passwordapp_user@my-python-app-5f8fd4c6f9-x27bt:/app$ df -h
  Filesystem      Size  Used Avail Use% Mounted on
  overlay         140G   39G  100G  28% /
  tmpfs            64M     0   64M   0% /dev
  shm              64M   16K   64M   1% /dev/shm
  tmpfs            16G  4.0K   16G   1% /vault/secrets
  /dev/sda1       140G   39G  100G  28% /etc/hosts
  tmpfs            16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
  tmpfs           7.7G     0  7.7G   0% /proc/asound
  tmpfs           7.7G     0  7.7G   0% /proc/acpi
  tmpfs           7.7G     0  7.7G   0% /proc/scsi
  tmpfs           7.7G     0  7.7G   0% /sys/firmware
  tmpfs           7.7G     0  7.7G   0% /sys/devices/virtual/powercap
  ```
  ## Bonus


  ```sh

  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11) [1]> helm install my-python-app python-app \
                                                  --set env.cpuRequest="500m" \
                                                  --set env.cpuLimit="1000m" \
                                                  --set env.memoryRequest="128Mi" \
                                                  --set env.memoryLimit="256Mi"
  NAME: my-python-app
  LAST DEPLOYED: Sun Mar  9 00:17:00 2025
  NAMESPACE: default
  STATUS: deployed
  REVISION: 1
  NOTES:
  1. Get the application URL by running these commands:
    export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=my-python-app" -o jsonpath="{.items[0].metadata.name}")
    export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
    echo "Visit http://127.0.0.1:8080 to use your application"
    kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl get pods
  NAME                                 READY   STATUS    RESTARTS   AGE
  my-python-app-7cdfc47fdb-qb4kk       2/2     Running   0          18s
  vault-0                              1/1     Running   0          3h39m
  vault-agent-injector-cb67b46-qgcmt   1/1     Running   0          3h39m
  vm@vm /m/v/d/h/V/U/L/P/D/S/k8s (lab11)> kubectl describe pod my-python-app-7cdfc47fdb-qb4kk
  Name:             my-python-app-7cdfc47fdb-qb4kk
  Namespace:        default
  Priority:         0
  Service Account:  internal-app
  Node:             minikube/192.168.49.2
  Start Time:       Sun, 09 Mar 2025 00:17:04 +0300
  Labels:           app.kubernetes.io/instance=my-python-app
                    app.kubernetes.io/managed-by=Helm
                    pod-template-hash=7cdfc47fdb
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/agent-inject-status: injected
                    vault.hashicorp.com/agent-inject-template-database-config.txt:
                      {{- with secret "internal/data/database/config" -}}
                      database:
                        username: {{ .Data.data.username }}
                        password: {{ .Data.data.password }}
                      {{- end -}}
                    vault.hashicorp.com/role: internal-app
  Status:           Running
  IP:               10.244.0.59
  IPs:
    IP:           10.244.0.59
  Controlled By:  ReplicaSet/my-python-app-7cdfc47fdb
  Init Containers:
    vault-agent-init:
      Container ID:  docker://ba0a3e4c537be55c89a023ff61f423d3ce0ace7bf07e5f31caa4accbaa7e2248
      Image:         hashicorp/vault:1.18.1
      Image ID:      docker-pullable://hashicorp/vault@sha256:3580fa352195aa7e76449cb8fadeef6d2f90a454c38982d30cf094e9013be786
      Port:          <none>
      Host Port:     <none>
      Command:
        /bin/sh
        -ec
      Args:
        echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
      State:          Terminated
        Reason:       Completed
        Exit Code:    0
        Started:      Sun, 09 Mar 2025 00:17:05 +0300
        Finished:     Sun, 09 Mar 2025 00:17:05 +0300
      Ready:          True
      Restart Count:  0
      Limits:
        cpu:     500m
        memory:  128Mi
      Requests:
        cpu:     250m
        memory:  64Mi
      Environment:
        NAMESPACE:         default (v1:metadata.namespace)
        HOST_IP:            (v1:status.hostIP)
        POD_IP:             (v1:status.podIP)
        VAULT_LOG_LEVEL:   info
        VAULT_LOG_FORMAT:  standard
        VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOnRydWUsInBpZF9maWxlIjoiL2hvbWUvdmF1bHQvLnBpZCIsInZhdWx0Ijp7ImFkZHJlc3MiOiJodHRwOi8vdmF1bHQuZGVmYXVsdC5zdmM6ODIwMCJ9LCJ0ZW1wbGF0ZSI6W3siZGVzdGluYXRpb24iOiIvdmF1bHQvc2VjcmV0cy9kYXRhYmFzZS1jb25maWcudHh0IiwiY29udGVudHMiOiJ7ey0gd2l0aCBzZWNyZXQgXCJpbnRlcm5hbC9kYXRhL2RhdGFiYXNlL2NvbmZpZ1wiIC19fVxuZGF0YWJhc2U6XG4gIHVzZXJuYW1lOiB7eyAuRGF0YS5kYXRhLnVzZXJuYW1lIH19XG4gIHBhc3N3b3JkOiB7eyAuRGF0YS5kYXRhLnBhc3N3b3JkIH19XG57ey0gZW5kIC19fVxuIiwibGVmdF9kZWxpbWl0ZXIiOiJ7eyIsInJpZ2h0X2RlbGltaXRlciI6In19In1dLCJ0ZW1wbGF0ZV9jb25maWciOnsiZXhpdF9vbl9yZXRyeV9mYWlsdXJlIjp0cnVlfX0=
      Mounts:
        /home/vault from home-init (rw)
        /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xf26j (ro)
        /vault/secrets from vault-secrets (rw)
  Containers:
    python-app:
      Container ID:   docker://aba8b460796493c8ebf8c8b8254563e49be1884a69b4b8e5e9e1aa36ece38b5d
      Image:          voronm1522/devops:python-app
      Image ID:       docker-pullable://voronm1522/devops@sha256:0794a87603464503829f166f675a8a61807d63703d3c3b442171f267cdf1e675
      Port:           5000/TCP
      Host Port:      0/TCP
      State:          Running
        Started:      Sun, 09 Mar 2025 00:17:06 +0300
      Ready:          True
      Restart Count:  0
      Limits:
        cpu:     1
        memory:  256Mi
      Requests:
        cpu:      500m
        memory:   128Mi
      Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
      Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
      Environment:
        CPU_REQUEST:     500m
        CPU_LIMIT:       1000m
        MEMORY_REQUEST:  128Mi
        MEMORY_LIMIT:    256Mi
  ...
  ```
