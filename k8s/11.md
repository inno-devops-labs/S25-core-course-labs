# Kubernetes Secrets and Hashicorp Vault

## Kubernetes Secrets and Resource Management

### Create a Secret Using kubectl

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ kubectl create secret generic secret-devops --from-literal=MY_USER=netpo4ki --from-literal=MY_PASS=po4ki
secret/secret-devops created
```

### Verify and Decode Secret

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ kubectl get secrets
NAME            TYPE     DATA   AGE
secret-devops   Opaque   2      16s
```

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ kubectl describe secret secret-devops
Name:         secret-devops
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
MY_PASS:  5 bytes
MY_USER:  8 bytes
```

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ kubectl get secret secret-devops -o jsonpath='{.data}'
{"MY_PASS":"cG80a2k=","MY_USER":"bmV0cG80a2k="}%    
```

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ echo 'cG80a2k=' | base64 --decode
po4ki%
```

```txt
(venv) ➜  S25-core-course-labs git:(Lab-11) ✗ echo 'bmV0cG80a2k=' | base64 --decode
netpo4ki%     
```

### Manage Secrets with Helm

`helm secrets install python-web-app ./python-web-app -n default -f ./python-web-app/secrets.yaml`

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl get po
NAME                              READY   STATUS    RESTARTS   AGE
python-web-app-5bd6fd758f-8w75s   1/1     Running   0          49s
python-web-app-5bd6fd758f-9gt7h   1/1     Running   0          49s
python-web-app-5bd6fd758f-xtn77   1/1     Running   0          49s
```

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl exec python-web-app-5bd6fd758f-8w75s  -- printenv | grep password
password=po4ki
```

## Vault Secret Management System

### Create a Secret Using vault

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-pass
word"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:19:39.030150488Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:19:39.030150488Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

### Configuration of Kubernetes Authentication

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write python-web-app - <<EOF
> path "internal/data/database/config" {
>     capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: python-web-app
/ $ vault write auth/kubernetes/role/python-web-app bound_service_account_names=python-web-app boun
d_service_account_namespaces=default policies=python-web-app ttl=24h
Success! Data written to: auth/kubernetes/role/python-web-app
/ $ exit
```

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl exec -it python-web-app-5bd6fd758f-8w75s --container python-web-app -- /bin/sh
/app $ cd ..
/ $ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-09T19:34:39.028139688Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $ exit
```

## Resource Management and Environment Variables

### python-web-app:

```yaml
resources:
   limits:
     cpu: 100m
     memory: 128Mi
   requests:
     cpu: 100m
     memory: 128Mi
```

### go-web-app:

```yaml
resources:
  limits:
    cpu: 500m
    memory: 768Mi
  requests:
    cpu: 200m
    memory: 600Mi
```

### env

```txt
(venv) ➜  k8s git:(Lab-11) ✗ kubectl exec python-web-app-5bd6fd758f-8w75s -- env | grep MY
Defaulted container "python-web-app" out of: python-web-app, vault-agent, vault-agent-init (init)
MY_VAR=po4ki
```