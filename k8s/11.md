# Task 1: Kubernetes Secrets and Resource Management

## Creating and Verifying Kubernetes Secrets

### 1. Creating a Secret Using kubectl

```bash
kubectl create secret generic my-credentials --from-literal=username=admin --from-literal=password=supersecret123
```

Output:
```
secret/my-credentials created
```

### 2. Verifying the Secret

```bash
kubectl get secret my-credentials -o yaml
```

Output:
```yaml
apiVersion: v1
data:
  password: c3VwZXJzZWNyZXQxMjM=
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T07:53:57Z"
  name: my-credentials
  namespace: default
  resourceVersion: "7184"
  uid: 5230f0f8-3655-4859-a8aa-f041afef21cd
type: Opaque
```

### 3. Decoding the Secret

```bash
echo "Username: $(kubectl get secret my-credentials -o jsonpath='{.data.username}' | base64 --decode)"
echo "Password: $(kubectl get secret my-credentials -o jsonpath='{.data.password}' | base64 --decode)"
```

Output:
```
Username: admin
Password: supersecret123
```

## Managing Secrets with Helm

### 1. Creating a Secrets.yaml Template

Created a `secrets.yaml` file in the templates folder:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "js-app.fullname" . }}-secret
  labels:
    {{- include "js-app.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.secrets }}
  {{- range $key, $value := .Values.secrets }}
  {{ $key }}: {{ $value | b64enc | quote }}
  {{- end }}
  {{- end }}
```

### 2. Adding Secret Values to values.yaml

Added the following to `values.yaml`:

```yaml
secrets:
  MY_USERNAME: "admin"
  MY_PASS: "supersecret123"
```

### 3. Updated Deployment to Use Secrets

Modified deployment.yaml to add environment variables:

```yaml
env:
  - name: MY_USERNAME
    valueFrom:
      secretKeyRef:
        name: {{ include "js-app.fullname" . }}-secret
        key: MY_USERNAME
  - name: MY_PASS
    valueFrom:
      secretKeyRef:
        name: {{ include "js-app.fullname" . }}-secret
        key: MY_PASS
```

### 4. Deployed Helm Chart

```bash
helm upgrade --install js-app ./k8s/js-app
```

### 5. Pod List

```bash
kubectl get po
```

Output:
```
NAME                                 READY   STATUS      RESTARTS       AGE
...
js-app-ff86cc467-826qg               1/1     Running     0              27s
js-app-ff86cc467-lzshf               1/1     Running     0              27s
js-app-ff86cc467-r57jg               1/1     Running     0              27s
...
```

### 6. Verifying Secrets Inside Pod

```bash
kubectl exec js-app-ff86cc467-826qg -- printenv | grep MY_
```

Output:
```
MY_USERNAME=admin
MY_PASS=supersecret123
```

## Resource Management

The application has the following resource limits and requests configured in values.yaml:

```yaml
resources:
  limits:
    cpu: "0.5"
    memory: "512Mi"
  requests:
    cpu: "0.2"
    memory: "256Mi"
```

These resource constraints ensure that:
- The application will not use more than 0.5 CPU cores and 512Mi of memory
- The application is guaranteed to have at least 0.2 CPU cores and 256Mi of memory

# Task 2: Vault Secret Management System

## Installing Vault Using Helm Chart

### 1. Adding Hashicorp Helm Repository

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
```

### 2. Installing Vault in Development Mode

```bash
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

## Setting Up Vault for Secret Management

### 1. Enabling the KV Secrets Engine

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault secrets enable -path=internal kv-v2"
```

Output:
```
Success! Enabled the kv-v2 secrets engine at: internal/
```

### 2. Creating a Secret in Vault

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault kv put internal/database/config username='db-admin' password='db-password-123'"
```

Output:
```
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T07:57:31.230860879Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

### 3. Enabling Kubernetes Authentication

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault auth enable kubernetes"
```

Output:
```
Success! Enabled kubernetes auth method at: kubernetes/
```

### 4. Configuring Kubernetes Authentication

```bash
kubectl exec -it vault-0 -- /bin/sh -c "vault write auth/kubernetes/config kubernetes_host=https://\$KUBERNETES_PORT_443_TCP_ADDR:443"
```

Output:
```
Success! Data written to: auth/kubernetes/config
```

### 5. Creating a Vault Policy

Created a policy file `js-app-policy.hcl`:

```hcl
path "internal/data/database/config" {
  capabilities = ["read"]
}
```

Applied the policy:

```bash
kubectl exec -it vault-0 -- vault policy write js-app /tmp/js-app-policy.hcl
```

Output:
```
Success! Uploaded policy: js-app
```

### 6. Creating a Kubernetes Authentication Role

```bash
kubectl exec -it vault-0 -- vault write auth/kubernetes/role/js-app bound_service_account_names=js-app bound_service_account_namespaces=default policies=js-app ttl=24h
```

Output:
```
Success! Data written to: auth/kubernetes/role/js-app
```

## Implementing Vault Integration in Helm Chart

### 1. Adding Vault Annotations to values.yaml

```yaml
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "js-app"
  vault.hashicorp.com/agent-inject-secret-database-config.txt: "internal/data/database/config"
  vault.hashicorp.com/agent-inject-template-database-config.txt: |
    {{- with secret "internal/data/database/config" -}}
    export DB_USERNAME="{{ .Data.data.username }}"
    export DB_PASSWORD="{{ .Data.data.password }}"
    {{- end -}}
```

### 2. Verifying Vault Secret Injection

```bash
kubectl exec -it js-app-586dd797-5tqb2 -c js-app -- cat /vault/secrets/database-config.txt
```

Output:
```
export DB_USERNAME="db-admin"
export DB_PASSWORD="db-password-123"
```

### 3. Checking Disk Usage

```bash
kubectl exec -it js-app-586dd797-5tqb2 -c js-app -- df -h
```

Output:
```
Filesystem                Size      Used Available Use% Mounted on
overlay                 297.9G     18.9G    279.0G   6% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
/dev/vdb1               297.9G     18.9G    279.0G   6% /dev/termination-log
tmpfs                   640.0M      4.0K    640.0M   0% /vault/secrets
/dev/vdb1               297.9G     18.9G    279.0G   6% /etc/resolv.conf
/dev/vdb1               297.9G     18.9G    279.0G   6% /etc/hostname
/dev/vdb1               297.9G     18.9G    279.0G   6% /etc/hosts
tmpfs                   640.0M     12.0K    640.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     5.9G         0      5.9G   0% /sys/firmware
``` 