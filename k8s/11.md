# Secrets Management

## Task 1

Creation of a secret using `kubectl`:

```bash
k8s % kubectl create secret generic my-secret \
  --from-literal=username=admin \
  --from-literal=password='SuperSecret123'

secret/my-secret created
```

Checking secret using `kubectl get secrets` command and in list I have my recently created secret `my-secret`:

```bash
k8s % kubectl get secrets
NAME                                       TYPE                 DATA   AGE
my-secret                                  Opaque               2      8s
sh.helm.release.v1.app-nodejs-library.v1   helm.sh/release.v1   1      5d21h
sh.helm.release.v1.app-nodejs-library.v2   helm.sh/release.v1   1      5d20h
sh.helm.release.v1.app-nodejs.v1           helm.sh/release.v1   1      5d21h
sh.helm.release.v1.app-nodejs.v2           helm.sh/release.v1   1      5d21h
sh.helm.release.v1.app-python-library.v1   helm.sh/release.v1   1      5d21h
sh.helm.release.v1.app-python-library.v2   helm.sh/release.v1   1      5d21h
sh.helm.release.v1.app-python.v1           helm.sh/release.v1   1      5d23h
sh.helm.release.v1.helm-hooks.v1           helm.sh/release.v1   1      5d22h
sh.helm.release.v1.helm-hooks.v2           helm.sh/release.v1   1      5d22h
sh.helm.release.v1.helm-hooks.v3           helm.sh/release.v1   1      5d22h
sh.helm.release.v1.helm-hooks.v4           helm.sh/release.v1   1      5d21h
sh.helm.release.v1.helm-hooks.v5           helm.sh/release.v1   1      5d21h
```

Verification of secret presence:

```bash
k8s % kubectl get secret my-secret -o yaml

apiVersion: v1
data:
  password: U3VwZXJTZWNyZXQxMjM=
  username: YWRtaW4=
kind: Secret
metadata:
  creationTimestamp: "2025-03-04T07:21:22Z"
  name: my-secret
  namespace: default
  resourceVersion: "28948"
  uid: 986b2283-54ed-42a6-83d6-36eddae26b84
type: Opaque
```

Decryption of secret:

![Decrypt secret](./pics/kubectl_secret.png)

The creation of gpg key:

```bash
% gpg --list-keys
gpg: проверка таблицы доверия
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: глубина: 0  достоверных:   1  подписанных:   0  доверие: 0-, 0q, 0n, 0m, 0f, 1u
gpg: срок следующей проверки таблицы доверия 2028-03-03
[keyboxd]
---------
pub   ed25519 2025-03-04 [SC] [   годен до: 2028-03-03]
      C182F57B183FB6DC69DB7BC9ADB764F4E121FE81
uid         [  абсолютно ] Ilsiia <i.nasibullina@innopolis.university>
sub   cv25519 2025-03-04 [E] [   годен до: 2028-03-03]
```

After following the tutorial video I installed `app-python` with secrets.yaml:

```bash
app-python % helm secrets install app-python . -f secrets.yaml 
NAME: app-python
LAST DEPLOYED: Tue Mar  4 15:15:28 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
secrets.yaml.dec
```

Verification of creating secrets with `sops`:

![Sops](./pics/helm_view.png)

The pods name is highlighted in the screenshot below:

![Kubectl pod](./pics/kubectl_get_po.png)

The result of command kubectl exec app-python -- printenv | grep MY_PASS`:

![Pass](./pics/app_python_pass.png)

## Task 2

Installing Vault:

![Vault](./pics/kubectl_vault.png)

Setting the secret in vault:

```bash
app-python % kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T12:36:14.027193549Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T12:36:14.027193549Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

Configuring Kubernetes Authentication:

```bash
app-python % kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ 
/ $ vault policy write app-python - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: app-python
/ $ vault write auth/kubernetes/role/app-python \
>       bound_service_account_names=app-python \
>       bound_service_account_namespaces=default \
>       policies=app-python \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/app-python
/ $ exit
```

The result of injecting credentials:

```bash
app-python % kubectl exec -it app-python-55d9655f8b-7mqrz -- /bin/sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
/app_python $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  58.4G     43.4G     12.0G  78% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M     16.0K     64.0M   0% /dev/shm
tmpfs                     3.8G      4.0K      3.8G   0% /vault/secrets
/dev/vda1                58.4G     43.4G     12.0G  78% /dev/termination-log
/dev/vda1                58.4G     43.4G     12.0G  78% /etc/resolv.conf
/dev/vda1                58.4G     43.4G     12.0G  78% /etc/hostname
/dev/vda1                58.4G     43.4G     12.0G  78% /etc/hosts
tmpfs                     3.8G     12.0K      3.8G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     1.9G         0      1.9G   0% /sys/firmware
/app_python $ cat /vault/secrets/database-config.txt 
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard
```

## Bonus

### Limiting resources

For resource limiting I added these lines in `values.yaml` in `app-python` and `app-nodejs` charts:

```yaml
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:  
    cpu: 100m
    memory: 128Mi
```

The result in `app-python`:

```bash
app-python % kubectl describe deployments.apps app-python                  
Name:                   app-python
Namespace:              default
CreationTimestamp:      Tue, 04 Mar 2025 17:41:43 +0300
Labels:                 app.kubernetes.io/instance=app-python
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-python
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-python-0.1.0
Annotations:            deployment.kubernetes.io/revision: 6
                        meta.helm.sh/release-name: app-python
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app-python,app.kubernetes.io/name=app-python
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app=app-python
                    app.kubernetes.io/instance=app-python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-python
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-python-0.1.0
  Annotations:      kubectl.kubernetes.io/restartedAt: 2025-03-04T18:31:24+03:00
                    vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/agent-inject-status: update
                    vault.hashicorp.com/agent-inject-template-database-config.txt:
                      {{- with secret "internal/data/database/config" -}}
                      postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
                      {{- end -}}
                    vault.hashicorp.com/role: app-python
  Service Account:  app-python
  Containers:
   app-python:
    Image:      ilsiia/app-python:latest
    Port:       5000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
```

The result in `app-nodejs`:

```bash
app-nodejs % kubectl describe deployments.apps app-nodejs                                                   
Name:                   app-nodejs
Namespace:              default
CreationTimestamp:      Wed, 26 Feb 2025 12:45:05 +0300
Labels:                 app.kubernetes.io/instance=app-nodejs
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-nodejs
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-nodejs-0.1.0
Annotations:            deployment.kubernetes.io/revision: 2
                        meta.helm.sh/release-name: app-nodejs
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app-nodejs,app.kubernetes.io/name=app-nodejs
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=app-nodejs
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-nodejs
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-nodejs-0.1.0
  Service Account:  app-nodejs
  Containers:
   app-nodejs:
    Image:      ilsiia/app-nodejs:latest
    Port:       3001/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:         100m
      memory:      128Mi
    Liveness:      http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:     http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
```

### Environment Variables

The result of adding environment variables in `app-nodejs`:

```bash
app-nodejs % kubectl exec app-nodejs-5d6b4fbcb-scgzt -- env | grep MY
MY_ENV=hello
```

The result of adding environment variables in `app-python`:

```bash
app-python % kubectl exec app-python-97d4c854f-q26mq -- env | grep M
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
HOSTNAME=app-python-97d4c854f-q26mq
MY_PASS=SuperSecret1234!
MY_VAR=ilsiia
```
