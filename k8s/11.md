# 1. Kubernetes Secrets and Resource Management

## 1. Creating and Verifying Secrets

### Create Secret
```bash
$ kubectl create secret generic moscow-time-secret \
  --from-literal=APP_SECRET='my-super-secret-key' \
  --from-literal=APP_ENV='production'
secret/moscow-time-secret created
```

## 2. Verify and Decode Your Secret

### View Secret
```bash
$ kubectl get secret moscow-time-secret -o yaml
apiVersion: v1
data:
  APP_ENV: cHJvZHVjdGlvbg==
  APP_SECRET: bXktc3VwZXItc2VjcmV0LWtleQ==
kind: Secret
metadata:
  creationTimestamp: "2025-03-07T12:15:21Z"
  name: moscow-time-secret
  namespace: default
  resourceVersion: "8234"
  uid: 5fdc9cf1-9d4d-4918-8727-aa262e5f9bbc
type: Opaque
```

### Decode Secrets
```bash
$ echo cHJvZHVjdGlvbg== | base64 --decode
production

$ echo bXktc3VwZXItc2VjcmV0LWtleQ== | base64 --decode
my-super-secret-key
```

## 3. Manage Secrets with Helm

### Deploy with Helm
```bash
$ helm install python-app ./python-app
NAME: python-app
LAST DEPLOYED: Fri Mar  7 15:35:16 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
```

### Verify Pods
```bash
$ kubectl get pods
NAME                          READY   STATUS      RESTARTS   AGE
pre-install-hook-55sdk        0/1     Completed   0          91s
python-app-6b4779d5d8-59qx6   1/1     Running     0          66s
```

### Verify Secrets in Pod
```bash
$ kubectl exec python-app-6b4779d5d8-59qx6 -- printenv | grep APP_
APP_SECRET=my-super-secret-key
APP_ENV=production
PYTHON_APP_PORT_80_TCP_ADDR=10.96.61.157
PYTHON_APP_PORT_80_TCP=tcp://10.96.61.157:80
PYTHON_APP_SERVICE_PORT_HTTP=80
PYTHON_APP_PORT_80_TCP_PROTO=tcp
PYTHON_APP_PORT_80_TCP_PORT=80
PYTHON_APP_SERVICE_HOST=10.96.61.157
PYTHON_APP_SERVICE_PORT=80
PYTHON_APP_PORT=tcp://10.96.61.157:80
```

# 2. Vault Secret Management System

## 1. Install Vault Using Helm Chart:
```bash
$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈

$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Fri Mar  7 16:22:40 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

$ kubectl get pods
NAME                                    READY   STATUS              RESTARTS   AGE
pre-install-hook-55sdk                  0/1     Completed           0          49m
python-app-6b4779d5d8-59qx6             1/1     Running             0          49m
vault-0                                 0/1     ContainerCreating   0          2m3s
vault-agent-injector-66f45b5fd5-sv8gp   1/1     Running             0          2m3s
```

## 2. Configure Vault


### Set a secret in Vault

```bash
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T13:34:37.856021511Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T13:34:37.856021511Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

### Configure Kubernetes Authentication:
```bash
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

/ $ vault write auth/kubernetes/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
    token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
    kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
    issuer="https://kubernetes.default.svc.cluster.local"
Success! Data written to: auth/kubernetes/config
```

### Create a Policy and Role:
```bash
/ $ vault policy write python-app - <<EOF
path "secret/data/python-app/*" {
  capabilities = ["read"]
}
EOF
Success! Uploaded policy: python-app

/ $ vault write auth/kubernetes/role/python-app \
    bound_service_account_names=python-app \
    bound_service_account_namespaces=default \
    policies=python-app \
    ttl=24h
Success! Data written to: auth/kubernetes/role/python-app
```

## 3. Vault Secrets in Helm Chart

### Store Secrets in Vault:
```bash
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault kv put secret/python-app/config \
    app_secret="vault-managed-secret" \
    app_env="production-vault"
Success! Data written to: secret/python-app/config
```

### Enable KV Secrets Engine:
```bash
$ kubectl exec -it vault-0 -- sh -c 'vault secrets enable -path=secret kv-v2'
Success! Enabled kv-v2 secrets engine at: secret/
```

### Verify Vault Integration:
```bash
# Redeploy our application to use Vault
$ helm upgrade python-app ./python-app
Release "python-app" has been upgraded. Happy Helming!

# Wait for the new pod to be ready
$ kubectl get pods
NAME                                    READY   STATUS      RESTARTS   AGE
pre-install-hook-55sdk                  0/1     Completed   0          106m
python-app-7f6d6fb48-9ff8f              1/1     Running     0          23s
vault-0                                 1/1     Running     0          59m
vault-agent-injector-66f45b5fd5-sv8gp   1/1     Running     0          59m

# Verify the secrets from Vault
$ kubectl exec -it python-app-cdcd6b665-nbp72 -- cat /vault/secrets/config
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
data: map[app_env:production-vault app_secret:vault-managed-secret]
metadata: map[created_time:2025-03-07T13:57:32.529846785Z custom_metadata:<nil> deletion_time: destroyed:false version:1]

# Check mounted secrets
$ kubectl exec -it python-app-cdcd6b665-nbp72 -- df -h | grep vault
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
tmpfs                   640.0M      4.0K    640.0M   0% /vault/secrets