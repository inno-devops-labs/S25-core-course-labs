## Create a Secret Using kubectl

```bash
minikube kubectl -- create secret generic secret --from-literal=pass=word
```
```bash
secret/secret created
```

```bash
minikube kubectl -- get secrets
```
```bash
NAME     TYPE     DATA   AGE
secret   Opaque   1      54s
```

```bash
minikube kubectl -- get secret secret -o jsonpath='{.data}'
```
```bash
{"pass":"d29yZA=="}
```

```bash
minikube kubectl -- get secret secret -o jsonpath='{.data.pass}' | base64 --decode
```
```bash
word
```

## Helm

```bash
gpg --gen-key
```
```bash
gpg (GnuPG) 2.4.4; Copyright (C) 2024 g10 Code GmbH
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Ivan
Email address: i.lishchenko@innopolis.university
You selected this USER-ID:
    "Ivan <i.lishchenko@innopolis.university>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: directory '/home/vboxuser/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/vboxuser/.gnupg/openpgp-revocs.d/A440E73AAA9020D2B4708DF6E81C51EFA4F85927.rev'
public and secret key created and signed.

pub   ed25519 2025-03-09 [SC] [expires: 2028-03-08]
      A440E73AAA9020D2B4708DF6E81C51EFA4F85927
uid                      Ivan <i.lishchenko@innopolis.university>
sub   cv25519 2025-03-09 [E] [expires: 2028-03-08]


```

```bash
sops -p A440E73AAA9020D2B4708DF6E81C51EFA4F85927 secrets.yaml
```

I have saved ```password:passwordSecret```

Now to view it:
```bash
helm secrets view secrets.yaml
```
```bash
password: passwordSecret
```

After following the tutorial, creating the secrets.yaml in the app and changing the deployment I install the helm chart:

```bash
helm secrets install python-app ./python-app -n default -f ./secrets.yaml
```
```bash 
NAME: python-app
LAST DEPLOYED: Sun Mar  9 16:30:14 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './secrets.yaml.dec'
```
```bash
minikube kubectl -- get po
```
```bash
NAME                          READY   STATUS    RESTARTS   AGE
python-app-799687d9c5-mn6p8   1/1     Running   0          3m16s
```
So, to check my password:
```bash
minikube kubectl -- exec python-app-799687d9c5-mn6p8 -- printenv | grep MY_PASSWORD
```
```bash
MY_PASSWORD=passwordSecret
```

## Vault

Please, add that this part requires VPN because it does.

Here is what is done after installing:

```bash
minikube kubectl -- get pods
```
```bash
NAME                                    READY   STATUS    RESTARTS   AGE
python-app-799687d9c5-mn6p8             1/1     Running   0          16m
vault-0                                 1/1     Running   0          7m10s
vault-agent-injector-66f45b5fd5-lfk42   1/1     Running   0          7m10s
```

Let's get inside and follow the tutorial:
```bash
minikube kubectl -- exec -it vault-0 -- /bin/sh
```
```bash
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T16:57:20.797336497Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T16:57:20.797336497Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

In there, let's authenticate:

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write python-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: python-app
/ $ vault write auth/kubernetes/role/python-app \
>       bound_service_account_names=python-app \
>       bound_service_account_namespaces=default \
>       policies=python-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/python-app
```


```bash
minikube kubectl -- create sa internal-app
```
```bash
serviceaccount/internal-app created
```

Only after this I realized that I can just not do the part with the internal-app and only keep the python app, so it is there for now

```bash
minikube kubectl -- get serviceaccounts
```
```bash
NAME                   SECRETS   AGE
default                0         94m
internal-app           0         3s
python-app             0         47m
vault                  0         38m
vault-agent-injector   0         38m
```


After changing the .yaml files, inside I get:
```bash
/ $ cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-09T16:57:20.797336497Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  49.0G     13.1G     33.4G  28% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   256.0M      4.0K    256.0M   0% /vault/secrets
/dev/sda2                49.0G     13.1G     33.4G  28% /dev/termination-log
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/resolv.conf
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/hostname
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/hosts
tmpfs                   256.0M     12.0K    256.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     3.9G         0      3.9G   0% /proc/asound
tmpfs                     3.9G         0      3.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/latency_stats
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.9G         0      3.9G   0% /proc/scsi
tmpfs                     3.9G         0      3.9G   0% /sys/firmware
```

After applying the template here is what I get inside:

```bash
$ cat /vault/secrets/database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard/usr/local/app 
$ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  49.0G     13.1G     33.4G  28% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
/dev/sda2                49.0G     13.1G     33.4G  28% /dev/termination-log
tmpfs                   256.0M      4.0K    256.0M   0% /vault/secrets
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/resolv.conf
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/hostname
/dev/sda2                49.0G     13.1G     33.4G  28% /etc/hosts
tmpfs                   256.0M     12.0K    256.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     3.9G         0      3.9G   0% /proc/asound
tmpfs                     3.9G         0      3.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/latency_stats
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.9G         0      3.9G   0% /proc/scsi
tmpfs                     3.9G         0      3.9G   0% /sys/firmware
```

Also, I made the limits for CPU and memory. 
It also seems like whilst doing it all I have completed the bonus tasks. And updated the `_helpers.tpl` as necessary.
How can I know that I got the bonus points? If not, what was missing?
