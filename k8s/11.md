# Secrets & Vault

## Kubernetes Secrets

### Create & Verify

```shell
kubectl create secret generic my-secret --from-literal=SECRET_KEY=abc123
```

```text
secret/my-secret created
```

```shell
kubectl get secrets
```

```text
NAME                                    TYPE                 DATA   AGE
my-secret                               Opaque               1      22s
sh.helm.release.v1.helm-hooks.v1        helm.sh/release.v1   1      9d
sh.helm.release.v1.moscow-time-app.v1   helm.sh/release.v1   1      10d
```

### Decode

```shell
kubectl get secret my-secret -o jsonpath='{.data}' | python -c "import sys, json; print(json.load(sys.stdin)['SECRET_KEY'])" | base64 -d
```

```text
abc123
```

### Manage with Helm

#### Install secrets plugin

```shell
helm plugin install https://github.com/jkroepke/helm-secrets
```

#### Generate key

```shell
gpg --gen-key
```

```text
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: anijack
Email address: mr@anjk.ru
You selected this USER-ID:
    "anijack <mr@anjk.ru>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key 0DA729813886F047 marked as ultimately trusted
gpg: directory '/root/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/root/.gnupg/openpgp-revocs.d/CD793C55ECBFB611EB438BF50DA729813886F047.rev'
public and secret key created and signed.

pub   rsa3072 2025-03-08 [SC] [expires: 2027-03-08]
      CD793C55ECBFB611EB438BF50DA729813886F047
uid                      anijack <mr@anjk.ru>
sub   rsa3072 2025-03-08 [E] [expires: 2027-03-08]
```

#### Create `secrets.yaml`

```shell
sops -p CD793C55ECBFB611EB438BF50DA729813886F047 secrets.yaml
```

#### Install secrets

```shell
helm secrets upgrade --install moscow-time-app . -f secrets.yaml
```

```text
NAME: moscow-time-app
LAST DEPLOYED: Tue Mar  8 23:51:02 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services moscow-time-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed 'secrets.yaml.dec'
```

#### Verify

```shell
kubectl get po
```

```text
NAME                             READY   STATUS    RESTARTS   AGE
moscow-time-app-6cd0806c-6f36c   1/1     Running   0          1m2s
```

```shell
kubectl exec moscow-time-app-6cd0806c-6f36c -- printenv | grep SECRET_KEY
```

```text
SECRET_KEY=abc123
```
