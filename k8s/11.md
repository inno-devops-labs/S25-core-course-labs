# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Secrets management with `kubectl`

### Create secret:

```
kubectl create secret generic devops-secret --from-literal=username=dmhd6219 --from-literal=password=qwerty
```

```
PS C:\Projects\University\S25\DevOps\S25-core-course-labs\k8s> kubectl create secret generic devops-secret --from-literal=username=dmhd6219 --from-literal=password=qwerty
secret/devops-secret created
```

### Verify secret:

```
kubectl get secrets
```

```
PS C:\Projects\University\S25\DevOps\S25-core-course-labs\k8s> kubectl get secrets
NAME            TYPE     DATA   AGE
devops-secret   Opaque   2      32s
```

```
kubectl describe secret devops-secret
```

```
PS C:\Projects\University\S25\DevOps\S25-core-course-labs\k8s> kubectl describe secret devops-secret
Name:         devops-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  6 bytes
username:  8 bytes
```

### Decode secret

```
kubectl get secret devops-secret -o jsonpath="{.data.password}" | % { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }
```

```
PS C:\Projects\University\S25\DevOps\S25-core-course-labs\k8s> kubectl get secret devops-secret -o jsonpath="{.data.password}" | % { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }
qwerty
```

## Secrets management with `helm`

Here I got some problems on my Windows machine, so I will switch to WSL.

### Create a gpg keypair:

```
root@dmhd6219-laptop:/home/S25-core-course-labs/k8s# gpg --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: dmhd6219
Email address: s.sviatkin@innopolis.university
You selected this USER-ID:
    "dmhd6219 <s.sviatkin@innopolis.university>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key 9028A48982C6906E marked as ultimately trusted
gpg: revocation certificate stored as '/root/.gnupg/openpgp-revocs.d/3F2A6A56F12DFFAFEDD3BC0C9028A48982C6906E.rev'
public and secret key created and signed.

pub   rsa3072 2025-04-24 [SC] [expires: 2027-04-24]
      3F2A6A56F12DFFAFEDD3BC0C9028A48982C6906E
uid                      dmhd6219 <s.sviatkin@innopolis.university>
sub   rsa3072 2025-04-24 [E] [expires: 2027-04-24]
```

### Create secrets.yaml file using sops:

```
root@dmhd6219-laptop:/home/S25-core-course-labs/k8s# sops -p 3F2A6A56F12DFFAFEDD3BC0C9028A48982C6906E secrets.yaml
```

### Install secrets to app-python:


```
root@dmhd6219-laptop:/home/S25-core-course-labs/k8s# helm secrets install app-python app-python/ -n default -f secrets.yaml
[helm-secrets] Decrypt: secrets.yaml
NAME: app-python
LAST DEPLOYED: Mon Apr 21 15:40:18 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  http://app-python.local/
[helm-secrets] Removed: secrets.yaml.dec

```

### Verify:

```
root@dmhd6219-laptop:/home/S25-core-course-labs/k8s# kubectl get po
NAME                          READY   STATUS    RESTARTS   AGE
app-python-7cd899c5d5-5lr2m   1/1     Running   0          4m18s
```

```
root@dmhd6219-laptop:/home/S25-core-course-labs/k8s# kubectl exec app-python-7cd899c5d5-5lr2m -- env | grep MY_PASSWORD
MY_PASSWORD=qwerty
```