# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

Creating a secret:
```sh
$ kubectl create secret generic my-secret --from-literal=username=admin --from-literal=password=supersecret

secret/my-secret created

$ kubectl get secrets
NAME                                    TYPE                 DATA   AGE
my-secret                               Opaque               2      24m
sh.helm.release.v1.app-python-helm.v1   helm.sh/release.v1   1      26m
sh.helm.release.v1.app-python-helm.v2   helm.sh/release.v1   1      24m
sh.helm.release.v1.helm-hooks.v1        helm.sh/release.v1   1      9d
```

```sh
$ kubectl get secret my-secret -o yaml

apiVersion: v1
data:
  password: c3VwZXJzZWNyZXQ=
  username: YWRtaW4=
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: app-python-helm
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2025-03-08T10:17:34Z"
  labels:
    app.kubernetes.io/managed-by: Helm
  name: my-secret
  namespace: default
  resourceVersion: "17748"
  uid: 2affb40b-81b0-480d-b0d3-f6b4db28cdc8
type: Opaque

$ kubectl get secret my-secret -o jsonpath="{.data.username}" | base64 --decode
admin

$ kubectl get secret my-secret -o jsonpath="{.data.password}" | base64 --decode
supersecret
```
Retrieve the list of pods:
```sh
$ kubectl get po

NAME                                          READY   STATUS      RESTARTS      AGE
app-python-5467f97795-crvvz                   1/1     Running     5 (42s ago)   10d
app-python-5467f97795-qvmt8                   1/1     Running     5 (42s ago)   10d
app-python-5467f97795-r7rlx                   1/1     Running     5 (42s ago)   10d
app-python-helm-54f744fb87-v4clw              1/1     Running     1 (42s ago)   51m
helm-hooks-app-python-helm-7dfd5889c9-rxcc6   1/1     Running     4 (42s ago)   10d
nginx-statefulset-0                           1/1     Running     2 (42s ago)   174m
postinstall-hook                              0/1     Completed   0             10d
preinstall-hook                               0/1     Completed   0             10d
```

```sh
$ kubectl get svc

NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
app-python                   LoadBalancer   10.98.201.163    <pending>     5000:30646/TCP      10d
app-python-helm              ClusterIP      10.108.90.241    <none>        5000/TCP            100m
helm-hooks-app-python-helm   ClusterIP      10.110.28.67     <none>        5000/TCP            10d
kubernetes                   ClusterIP      10.96.0.1        <none>        443/TCP             10d
vault                        ClusterIP      10.105.253.179   <none>        8200/TCP,8201/TCP   51m
vault-agent-injector-svc     ClusterIP      10.109.60.210    <none>        443/TCP             51m
vault-internal               ClusterIP      None             <none>        8200/TCP,8201/TCP   51m
```

```sh
$ kubectl exec app-python-helm-54f744fb87-v4clw -- print-env | grep USERNAME
```

## Task 2: Vault Secret Management System

1. Install Vault Using Helm Chart:
   
```sh
$ helm repo add hashicorp https://helm.releases.hashicorp.com
$ helm repo update
$ helm install vault hashicorp/vault
```

```sh
$ kubectl get pods
$ kubectl get svc
```
```sh
$ kubectl logs vault-0

==> Vault server configuration:

Administrative Namespace: 
             Api Address: http://10.244.0.57:8200
                     Cgo: disabled
         Cluster Address: https://vault-0.vault-internal:8201
   Environment Variables: APP_PYTHON_HELM_PORT, APP_PYTHON_HELM_PORT_5000_TCP, APP_PYTHON_HELM_PORT_5000_TCP_ADDR, APP_PYTHON_HELM_PORT_5000_TCP_PORT, APP_PYTHON_HELM_PORT_5000_TCP_PROTO, APP_PYTHON_HELM_SERVICE_HOST, APP_PYTHON_HELM_SERVICE_PORT, APP_PYTHON_HELM_SERVICE_PORT_HTTP, APP_PYTHON_PORT, APP_PYTHON_PORT_5000_TCP, APP_PYTHON_PORT_5000_TCP_ADDR, APP_PYTHON_PORT_5000_TCP_PORT, APP_PYTHON_PORT_5000_TCP_PROTO, APP_PYTHON_SERVICE_HOST, APP_PYTHON_SERVICE_PORT, HELM_HOOKS_APP_PYTHON_HELM_PORT, HELM_HOOKS_APP_PYTHON_HELM_PORT_5000_TCP, HELM_HOOKS_APP_PYTHON_HELM_PORT_5000_TCP_ADDR, HELM_HOOKS_APP_PYTHON_HELM_PORT_5000_TCP_PORT, HELM_HOOKS_APP_PYTHON_HELM_PORT_5000_TCP_PROTO, HELM_HOOKS_APP_PYTHON_HELM_SERVICE_HOST, HELM_HOOKS_APP_PYTHON_HELM_SERVICE_PORT, HELM_HOOKS_APP_PYTHON_HELM_SERVICE_PORT_HTTP, HOME, HOSTNAME, HOST_IP, KUBERNETES_PORT, KUBERNETES_PORT_443_TCP, KUBERNETES_PORT_443_TCP_ADDR, KUBERNETES_PORT_443_TCP_PORT, KUBERNETES_PORT_443_TCP_PROTO, KUBERNETES_SERVICE_HOST, KUBERNETES_SERVICE_PORT, KUBERNETES_SERVICE_PORT_HTTPS, NAME, PATH, POD_IP, PWD, SHLVL, SKIP_CHOWN, SKIP_SETCAP, VAULT_ADDR, VAULT_AGENT_INJECTOR_SVC_PORT, VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP, VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR, VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT, VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO, VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST, VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT, VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS, VAULT_API_ADDR, VAULT_CLUSTER_ADDR, VAULT_K8S_NAMESPACE, VAULT_K8S_POD_NAME, VAULT_PORT, VAULT_PORT_8200_TCP, VAULT_PORT_8200_TCP_ADDR, VAULT_PORT_8200_TCP_PORT, VAULT_PORT_8200_TCP_PROTO, VAULT_PORT_8201_TCP, VAULT_PORT_8201_TCP_ADDR, VAULT_PORT_8201_TCP_PORT, VAULT_PORT_8201_TCP_PROTO, VAULT_SERVICE_HOST, VAULT_SERVICE_PORT, VAULT_SERVICE_PORT_HTTP, VAULT_SERVICE_PORT_HTTPS_INTERNAL, VERSION
              Go Version: go1.22.8
              Listener 1: tcp (addr: "[::]:8200", cluster address: "[::]:8201", disable_request_limiter: "false", max_request_duration: "1m30s", max_request_size: "33554432", tls: "disabled")
               Log Level: 
                   Mlock: supported: true, enabled: false
           Recovery Mode: false
                 Storage: file
                 Version: Vault v1.18.1, built 2024-10-29T14:21:31Z
             Version Sha: f479e5c85462477c9334564bc8f69531cdb03b65

2025-03-08T11:57:02.852Z [INFO]  proxy environment: http_proxy="" https_proxy="" no_proxy=""
2025-03-08T11:57:02.855Z [INFO]  incrementing seal generation: generation=1
2025-03-08T11:57:02.868Z [INFO]  core: Initializing version history cache for core
2025-03-08T11:57:02.868Z [INFO]  events: Starting event system
==> Vault server started! Log data will stream in below:

2025-03-08T11:57:05.527Z [INFO]  core: security barrier not initialized
2025-03-08T11:57:05.527Z [INFO]  core: seal configuration missing, not initialized
```

`secrets.yaml`:
```sh
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  username: {{ .Values.secret.username | b64enc }}
  password: {{ .Values.secret.password | b64enc }}
```

### Vault configurations
Enable Kubernetes Authentication inside the Vault pod:
```sh
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes

Success! Enabled kubernetes auth method at: kubernetes/
```

```sh
$ kubectl exec -it vault-0 -- vault secrets enable -path=secret kv

Success! Enabled the kv secrets engine at: secret/
```

Set a Secret in Vault inside the Vault pod and verify:
```sh
/ $ vault kv put secret/myapp username=admin password=supersecret

Success! Data written to: secret/myapp

/ $ vault kv get secret/myapp
====== Data ======
Key         Value
---         -----
password    supersecret
username    admin
/ $ 
```

```sh
$ kubectl exec -it app-python-helm-54b6555dbf-vqntv -- bash

appuser@app-python-helm-54b6555dbf-vqntv:/app$
```

```sh
$ kubectl exec -it app-python-helm-54b6555dbf-vqntv -- printenv | grep VAULT

VAULT_PORT_8201_TCP=tcp://10.105.253.179:8201
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_ADDR=10.105.253.179
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8200_TCP=tcp://10.105.253.179:8200
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_SERVICE_HOST=10.105.253.179
VAULT_PORT_8201_TCP_PORT=8201
VAULT_SERVICE_PORT=8200
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
VAULT_PORT_8200_TCP_ADDR=10.105.253.179
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.109.60.210:443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.109.60.210
VAULT_PORT=tcp://10.105.253.179:8200
VAULT_SERVICE_PORT_HTTP=8200
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.109.60.210
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.109.60.210:443
```

## Bonus Task: Resource Management and Environment Variables

We need to edit `values.yaml`:

```sh
resources:
  limits:
    cpu: "500m"
    memory: "256Mi"
  requests:
    cpu: "250m"
    memory: "128Mi"
```

Then upgrade the app:
```sh
$ helm upgrade --install app-python-helm ./app-python-helm
```

And now we can verify:
```sh
$ kubectl get pod app-python-helm-54f744fb87-v4clw -o=jsonpath='{.spec.containers[*].resources}'

{"limits":{"cpu":"500m","memory":"256Mi"},"requests":{"cpu":"250m","memory":"128Mi"}}
```

Next we need to modify the `_helpers.tpl`:
```sh
{{- define "app.envVars" -}}
env:
  - name: DATABASE_URL
    value: {{ .Values.database.url }}
  - name: SECRET_KEY
    value: {{ .Values.secret.key }}
{{- end }}
```
