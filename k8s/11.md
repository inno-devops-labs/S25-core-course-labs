# Kubernetes Secrets Management

## Creating secrets with kubectl

1. Created a secret for database credentials:

```bash
kubectl create secret generic test-secret --from-literal=USER=root --from-literal=PASSWORD=toor
```

```bash
secret/test-secret created
```

2. Verified the secret: `kubectl get secret test-secret -o jsonpath='{.data}'`

```bash
{"PASSWORD":"dG9vcg==","USER":"cm9vdA=="}
```

3. Decoded obtained secret:

```bash
echo 'dG9vcg==' | base64 --decode
echo 'cm9vdA==' | base64 --decode
```

```bash
toor
root
```

## Managing secrets with Helm

### List of pods:

```bash
kubectl get po
```

```bash
NAME                                     READY   STATUS      RESTARTS        AGE
helm-hooks-post-install-hook             0/1     Completed   0               91m
helm-hooks-pre-install-hook              0/1     Completed   0               92m
helm-hooks-python-app-774897fd5d-bxtj8   1/1     Running     2 (2m45s ago)   91m
helm-hooks-python-app-774897fd5d-ssmdq   1/1     Running     2 (2m45s ago)   91m
helm-hooks-python-app-774897fd5d-v5kvm   1/1     Running     2 (2m45s ago)   91m
python-app-79dbfff4fb-bzmw7              1/1     Running     1 (2m45s ago)   33m
python-app-79dbfff4fb-qx2dw              1/1     Running     1 (2m45s ago)   33m
python-app-79dbfff4fb-xv97z              1/1     Running     1 (2m45s ago)   33m
python-app-pre-install-hook              0/1     Completed   0               34m
```

### Verifying secret inside the pod:

```bash
kubectl exec -it python-app-79dbfff4fb-bzmw7 -- printenv | grep PASSWORD
```

```bash
PASSWORD=toor
```

## Vault

### Installing

```bash
git clone https://github.com/hashicorp/vault-helm.git && cd vault-helm
helm install vault . --set "server.dev.enabled=true"

echo 'k8s/vault-helm' >> ../.gitignore
```
### Setting a secret

```bash
ubuntu@fhmhd8tturtcnb6bcjnt:~/S25-DevOps-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ 
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:42:09.942053669Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:42:09.942053669Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

### Configuring Kubernetes Authentication

```bash
ubuntu@fhmhd8tturtcnb6bcjnt:~/S25-DevOps-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
> 
>     capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```
