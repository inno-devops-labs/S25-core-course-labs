# Lab 11

## Task 1
### Adding a kubernetes secret
```bash
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl create namespace lab11

namespace/lab11 created
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl create secret generic my-secret --from-literal=MY_PASS="SuperSecret123" -n lab11 

secret/my-secret created
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl get secrets -n lab11

NAME        TYPE     DATA   AGE
my-secret   Opaque   1      23s
```

### Decoding the kubernetes secret
```bash
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl get secret my-secret -n lab11 -o yaml

apiVersion: v1
data:
  MY_PASS: U3VwZXJTZWNyZXQxMjM=
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T18:27:27Z"
  name: my-secret
  namespace: lab11
  resourceVersion: "438"
  uid: e59f8d22-69f5-46f6-a140-64dbe8b7d3d8
type: Opaque
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % echo U3VwZXJTZWNyZXQxMjM= | base64 -d
SuperSecret123%
```

### Configuring the secret using helm
```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % helm upgrade --install fastapi-release ./fastapi-app         
Release "fastapi-release" does not exist. Installing it now.
NAME: fastapi-release
LAST DEPLOYED: Sun Mar  9 19:48:13 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=fastapi-app,app.kubernetes.io/instance=fastapi-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl get po
NAME                                         READY   STATUS              RESTARTS   AGE
fastapi-release-fastapi-app-8d45b5d8-gxdtv   0/1     ContainerCreating   0          44s
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec fastapi-release-fastapi-app-8d45b5d8-gxdtv  --printenv | grep MY_PASS
error: unknown flag: --printenv
See 'kubectl exec --help' for usage.
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec fastapi-release-fastapi-app-8d45b5d8-gxdtv  -- printenv | grep MY_PASS
MY_PASS=SuperSecret123
```


## Task 2

### Installing Vault
```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % helm repo add hashicorp https://helm.releases.hashicorp.com

"hashicorp" has been added to your repositories
(venv) louayfarah@Louays-MacBook-Pro k8s % helm repo update

Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈
(venv) louayfarah@Louays-MacBook-Pro k8s % helm upgrade --install vault hashicorp/vault --set "server.dev.enabled=true" 
Release "vault" does not exist. Installing it now.
NAME: vault
LAST DEPLOYED: Sun Mar  9 19:52:40 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

### Setting a secret in Vault
```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec -it vault-0 -- sh
/ $ vault kv put secret/mysecret apppassword="VaultSuperSecret"
==== Secret Path ====
secret/data/mysecret

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T18:54:39.55347496Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ exit
```

### Kubernetes Authentication

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl exec -it vault-0 -- sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>   kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
>   token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
>   kubernetes_ca_cert="@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
Success! Data written to: auth/kubernetes/config
/ $ cat <<EOF | vault policy write myapp-policy -
> path "secret/data/mysecret" {
>   capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: myapp-policy
/ $ vault write auth/kubernetes/role/myapp-role \
>   bound_service_account_names=myapp-sa \
>   policies=myapp-policy \
>   ttl=24h
Error writing data to auth/kubernetes/role/myapp-role: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/auth/kubernetes/role/myapp-role
Code: 400. Errors:

* "bound_service_account_namespaces" can not be empty if "bound_service_account_namespace_selector" is not set
/ $ vault write auth/kubernetes/role/myapp-role \
>   bound_service_account_names=myapp-sa \
>   bound_service_account_namespaces=default \
>   policies=myapp-policy \
>   ttl=24h
Success! Data written to: auth/kubernetes/role/myapp-role
/ $ exit
```