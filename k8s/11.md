# Kubernetes Secrets and Hashicorp Vault

## Kubernetes Secrets and Resource Management

### `kubectl create secret generic token-secret --from-literal=API_TOKEN=helloworld`

```console
secret/token-secret created
```

### `kubectl describe secret token-secret`

```console
Name:         token-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
API_TOKEN:  10 bytes
```

### `kubectl get secret token-secret -o jsonpath="{.data.API_TOKEN}" | base64 --decode`

```console
helloworld
```

### Managing secrets with Helm

1. Created `secrets.yaml` template
2. Added secrets.api_token to `values.yaml`
3. Updated `deployment.yaml` to use the secret

### `helm upgrade app-python ./app-python`

```console
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sun Mar  9 12:21:26 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### `kubectl get pods`

```console
NAME                          READY   STATUS      RESTARTS   AGE
app-python-75d7945f84-gzxg6   1/1     Running     0          12s
post-install-hook             0/1     Completed   0          6d16h
pre-install-hook              0/1     Completed   0          6d15h
```

### `kubectl exec app-python-75d7945f84-gzxg6 -- printenv | grep API_TOKEN`

```console
API_TOKEN=helloworld
```

## Vault Secret Management System

### Installation

```console
curl -LO https://github.com/hashicorp/vault-helm/archive/refs/heads/main.zip
```

```console
unzip main.zip
```

```console
helm install vault ./vault-helm-main/ --set "server.dev.enabled=true"
```

### `kubectl get pods -l app.kubernetes.io/name=vault`

```console
NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          2m48s
```

### `kubectl exec -it vault-0 -- /bin/sh`

```console
/ $ export VAULT_ADDR='http://127.0.0.1:8200'
/ $ export VAULT_TOKEN='root'
/ $ vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.18.1
Build Date      2024-10-29T14:21:31Z
Storage Type    inmem
Cluster Name    vault-cluster-ba285453
Cluster ID      c17cd5a5-db6e-5d68-e3ce-4f97660c4fde
HA Enabled      false
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config api_token="goodbyeworld"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T09:38:43.668339149Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T09:38:43.668339149Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key          Value
---          -----
api_token    goodbyeworld
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
> kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
> token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
> kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
> issuer="https://kubernetes.default.svc.cluster.local"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>   capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/moscow-time-app \
> bound_service_account_names="moscow-time-app" \
> bound_service_account_namespaces="default" \
> policies="internal-app" \
> ttl=24h
Success! Data written to: auth/kubernetes/role/moscow-time-app
/ $ exit
```

### Vault Secrets in Helm Chart

Updated `values.yaml` to include `podAnnotations` for Vault.

### `helm upgrade app-python ./app-python`

```console
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sun Mar  9 12:45:22 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### `kubectl get pods -l app.kubernetes.io/name=app-python`

```console
NAME                          READY   STATUS     RESTARTS   AGE
app-python-8f7b8684-2bbp6     1/2     Running    0          12m
```

### Verify that secrets are injected

`export POD_NAME=$(kubectl get pods -l app.kubernetes.io/name=app-python -o jsonpath="{.items[0].metadata.name}")`

`kubectl exec $POD_NAME -- cat /vault/secrets/database-config.txt`

Output:

```console
database:
  api_token: goodbyeworld
```
