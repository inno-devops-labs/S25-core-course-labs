# Kubernetes secrets management

## Kubernetes Secrets and Resource Management

### Create secrets

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> kubectl create secret generic my-secret --from-literal=MY_USER=admin --from-literal=MY_PASS=salfetka8

secret/my-secret created
```

### Confirm and decode secrets

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> kubectl get secrets
NAME        TYPE     DATA   AGE
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> kubectl describe secret my-secret
Namespace:    default
Annotations:  <none>

Type:  Opaque

Data
====
MY_PASS:  9 bytes
MY_USER:  5 bytes
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> kubectl get secret my-secret -o jsonpath='{.data}'
{"MY_PASS":"c2FsZmV0a2E4","MY_USER":"YWRtaW4="}
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> [Text.Encoding]::Utf8.GetString([Convert]::FromBase64String('c2FsZmV0a2E4'))
salfetka8
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs> [Text.Encoding]::Utf8.GetString([Convert]::FromBase64String('YWRtaW4='))    
admin
```

### Manage secrets with helm

Using GPG key

`helm secrets install moscow-time ./moscow-time-py -n default -f ./moscow-time-py/secrets.yaml`

```bash
yeaphm@DESKTOP-A1FDFJ3:/mnt/e/Documents/Innop/C3/S2/devops/S25-core-course-labs/k8s$ kubectl get po
NAME                                          READY   STATUS    RESTARTS   AGE
moscow-time-moscow-time-py-74f6b5c6df-r9vmb   1/1     Running   0          2m18s
moscow-time-moscow-time-py-74f6b5c6df-tkg2v   1/1     Running   0          2m18s
moscow-time-moscow-time-py-74f6b5c6df-xwwb8   1/1     Running   0          2m18s
yeaphm@DESKTOP-A1FDFJ3:/mnt/e/Documents/Innop/C3/S2/devops/S25-core-course-labs/k8s$ kubectl exec moscow-time-moscow-time-py-74f6b5c6df-r9vmb  -- printenv | grep password
password=salfetka
```

## Vault Secret Management System

### Set secrets in vault

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T16:42:29.684074683Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T16:42:29.684074683Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

### Configure Kubernetes Authentication

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write moscow-time-py - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: moscow-time-py
/ $ vault write auth/kubernetes/role/moscow-time-py \
>       bound_service_account_names=moscow-time-py \
>       bound_service_account_namespaces=default \
>       policies=moscow-time-py \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/moscow-time-py
```

### Vault secrets result

I had problems to show the secrets because of distroless image and absence of any tools.
So I had to redeploy it, and then it worked fine.

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec -it moscow-time-py-75c6fb67c-vxmhc --container moscow-time-py -- /bin/sh
/app $ cd ..
/ $ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-05T17:41:58.85955106Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

## Bonus

### Resource Management

I have set up resource limits and requests in values.yaml files of both apps:

```yaml
resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 100m
      memory: 128Mi
```

Here the result of description with limits included:

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl describe deployments.apps moscow-time-py
Name:                   moscow-time-py
Namespace:              default
CreationTimestamp:      Wed, 05 Mar 2025 21:27:15 +0300
Labels:                 app.kubernetes.io/instance=moscow-time-py
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=moscow-time-py
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=moscow-time-py-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: moscow-time-py
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=moscow-time-py,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=moscow-time-py,app.kubernetes.io/version=1.16.0
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=moscow-time-py
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=moscow-time-py
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=moscow-time-py-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: moscow-time-py
  Service Account:  moscow-time-py
  Containers:
   moscow-time-py:
    Image:      efimpuzhalov/moscow-time-py-app:latest
    Port:       5000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASS:  <set to the key 'password' in secret 'password'>  Optional: false
    Mounts:     <none>
  Volumes:      <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   moscow-time-py-5d85dbfbfc (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  74s   deployment-controller  Scaled up replica set moscow-time-py-5d85dbfbfc from 0 to 1
```

### Environment Variables

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec moscow-time-py-7f978d5fcc-d2cw9 -- env | grep MY
Defaulted container "moscow-time-py" out of: moscow-time-py, vault-agent, vault-agent-init (init)
MY_PASS=??????_z???â†’
MY_VAR=salfetka
```
