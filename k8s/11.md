# Secrets & Vault

## Kubernetes Secrets

### Create & Verify

```shell
kubectl create secret generic my-secret --from-literal=SECRET_KEY=abc123
```

```text
secret/my-secret created
```

```shell
kubectl get secrets
```

```text
NAME                                    TYPE                 DATA   AGE
my-secret                               Opaque               1      22s
sh.helm.release.v1.helm-hooks.v1        helm.sh/release.v1   1      9d
sh.helm.release.v1.moscow-time-app.v1   helm.sh/release.v1   1      10d
```

### Decode

```shell
kubectl get secret my-secret -o jsonpath='{.data}' | python -c "import sys, json; print(json.load(sys.stdin)['SECRET_KEY'])" | base64 -d
```

```text
abc123
```

### Manage with Helm

#### Install secrets plugin

```shell
helm plugin install https://github.com/jkroepke/helm-secrets
```

#### Generate key

```shell
gpg --gen-key
```

```text
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
There is NO WARRANTY, to the extent permitted by law.

gpg: directory '/root/.gnupg' created
gpg: keybox '/root/.gnupg/pubring.kbx' created
Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: anijack
Email address: mr@anjk.ru
You selected this USER-ID:
    "anijack <mr@anjk.ru>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key 0DA729813886F047 marked as ultimately trusted
gpg: directory '/root/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/root/.gnupg/openpgp-revocs.d/CD793C55ECBFB611EB438BF50DA729813886F047.rev'
public and secret key created and signed.

pub   rsa3072 2025-03-08 [SC] [expires: 2027-03-08]
      CD793C55ECBFB611EB438BF50DA729813886F047
uid                      anijack <mr@anjk.ru>
sub   rsa3072 2025-03-08 [E] [expires: 2027-03-08]
```

#### Create `secrets.yaml`

```shell
sops -p CD793C55ECBFB611EB438BF50DA729813886F047 secrets.yaml
```

#### Install secrets

```shell
helm secrets upgrade --install moscow-time-app . -f secrets.yaml
```

```text
NAME: moscow-time-app
LAST DEPLOYED: Tue Mar  8 23:51:02 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services moscow-time-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed 'secrets.yaml.dec'
```

#### Verify

```shell
kubectl get po
```

```text
NAME                             READY   STATUS    RESTARTS   AGE
moscow-time-app-6cd0806c-6f36c   1/1     Running   0          1m2s
```

```shell
kubectl exec moscow-time-app-6cd0806c-6f36c -- printenv | grep SECRET_KEY
```

```text
SECRET_KEY=abc123
```

## Secrets Vault

### Install Vault

```shell
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

```shell
kubectl get pods
```

```text
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          9m45s
vault-agent-injector-66f45b5fd5-pnlgw   1/1     Running   0          9m45s
```

### Inject secrets

> First, you need to start an interactive shell session on the `vault-0` pod:
> ```shell
> kubectl exec -it vault-0 -- /bin/sh
> ```

#### Enable kv-v2 secrets

```shell
vault secrets enable -path=internal kv-v2
```

```text
Success! Enabled the kv-v2 secrets engine at: internal/
```

#### Create a secret

```shell
vault kv put internal/database/config username="anijack" password="abc123"
```

```text
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T21:16:50.932699173Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

#### Verify

```shell
vault kv get internal/database/config
```

```text
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T21:16:50.932699173Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    abc123
username    anijack
```

### Configure Kubernetes Authentication

#### Enable authentication

```shell
vault auth enable kubernetes
```

```text
Success! Enabled kubernetes auth method at: kubernetes/
```

#### Configure authentication

```shell
vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```

```text
Success! Data written to: auth/kubernetes/config
```

#### Write policy

```shell
vault policy write internal-app - <<EOF
path "internal/data/database/config" {
   capabilities = ["read"]
}
EOF
```

```text
Success! Uploaded policy: internal-app
```

#### Create authentication role

```shell
vault write auth/kubernetes/role/internal-app \
      bound_service_account_names=internal-app \
      bound_service_account_namespaces=default \
      policies=internal-app \
      ttl=24h
```

```text
Success! Data written to: auth/kubernetes/role/internal-app
```

### Define Kubernetes Service Account

```shell
kubectl create sa internal-app
```

```text
serviceaccount/internal-app created
```

```shell
kubectl get serviceaccounts
```

```text
NAME                   SECRETS   AGE
default                0         47m
internal-app           0         16s
vault                  0         26m
vault-agent-injector   0         26m
```

### Implement Vault Secrets

#### Launch application

```shell
kubectl apply --filename .\deployment.yml
```

```text
deployment.apps/app-deployment created
```

```shell
kubectl get pods
```

```text
NAME                                    READY   STATUS    RESTARTS   AGE
app-deployment-76497f5457-4dxn7         1/1     Running   0          18m
app-deployment-76497f5457-6clfc         1/1     Running   0          18m
app-deployment-76497f5457-sxm8w         1/1     Running   0          18m
vault-0                                 1/1     Running   0          55m
vault-agent-injector-66f45b5fd5-pnlgw   1/1     Running   0          55m
```

#### Inject secrets into the pod

`patch-inject-secrets.yaml`
```yaml
spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'internal-app'
        vault.hashicorp.com/agent-inject-secret-database-config.txt: 'internal/data/database/config'
```

```shell
kubectl patch deployment app-deployment --patch "$(cat patch-inject-secrets.yaml)"
```

```text
deployment.apps/app-deployment patched
```

#### Verify

Access the container:

```shell
kubectl exec -it app-deployment-6456cbf97f-fw2kq -- bash
```

```shell
cat /vault/secrets/database-config.txt
```

```text
metadata: map[created_time:2025-03-08T21:16:50.932699173Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```shell
df -h
```

```text
Filesystem      Size  Used Avail Use% Mounted on
overlay        1007G   48G  909G   5% /
tmpfs            64M     0   64M   0% /dev
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
shm              64M     0   64M   0% /dev/shm
tmpfs           7.8G  4.0K  7.8G   1% /vault/secrets
/dev/sdd       1007G   48G  909G   5% /etc/hosts
tmpfs           7.8G   12K  7.8G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/acpi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```