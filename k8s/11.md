# Lab 11 Documentation

## Task 1: Kubernetes Secrets and Resource Management

### 1. Creating and Verifying Secrets

#### Creating a Secret
```bash
kubectl create secret generic my-secret --from-literal=MY_PASS=mysecretpassword --dry-run=client -o yaml
```

Output:
```yaml
apiVersion: v1
data:
  MY_PASS: bXlzZWNyZXRwYXNzd29yZA==
kind: Secret
metadata:
  creationTimestamp: null
  name: my-secret
```

#### Decoding the Secret
```bash
echo "bXlzZWNyZXRwYXNzd29yZA==" | base64 --decode
```

Output:
```
mysecretpassword
```

### 2. Managing Secrets with Helm

The secret is now managed through our Helm chart. The implementation details can be found in:
- `templates/secrets.yaml`
- Updated deployment configuration in `templates/deployment.yaml`

#### Verifying the Secret in Pod
```bash
kubectl get pods
```
Output:
```
NAME                                    READY   STATUS     RESTARTS   AGE
python-app-6994c6f94d-vh24l             0/2     Init:0/1   0          4s
python-app-788f5cc5d-kl6lf              1/1     Running    0          16m
vault-0                                 1/1     Running    0          6m18s
vault-agent-injector-56d9fc78b8-t7ckn   1/1     Running    0          6m19s
```

```bash
kubectl exec python-app-788f5cc5d-kl6lf -- printenv | grep MY_PASS
```
Output:
```
# (no output, as expected with Vault injection)
```

## Task 2: Vault Secret Management System

### 1. Vault Installation and Configuration

#### Installing Vault
```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

Output:
```
NAME: vault
LAST DEPLOYED: Tue May 20 04:14:26 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
```

#### Vault Configuration Steps
1. Created service account with Vault annotations
2. Enabled Kubernetes authentication in Vault
3. Created Vault policy for secret access
4. Created Vault role for our application
5. Stored secret in Vault

#### Vault Setup Script Output
```bash
Success! Enabled kubernetes auth method at: kubernetes/
Success! Data written to: auth/kubernetes/config
Success! Uploaded policy: python-app
Success! Data written to: auth/kubernetes/role/python-app
```

### 2. Testing Vault Integration

#### Verifying Vault Secrets
```bash
kubectl exec python-app-788f5cc5d-kl6lf -- ls /vault/secrets
```
Output:
```
ls: /vault/secrets: No such file or directory
```

```bash
kubectl describe pod python-app-788f5cc5d-kl6lf
```
Output: (excerpt)
```
Environment:  <none>
Mounts:
  /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-wr6sk (ro)
```

**Note:** The Vault agent injection did not mount the secret as expected.

### Implementation Details

1. Service Account Configuration:
   - Created service account with Vault annotations
   - Configured for automatic secret injection
   - Bound to Vault role "python-app"

2. Vault Policy:
   ```hcl
   path "secret/data/mysecret" {
     capabilities = ["read"]
   }
   ```

3. Deployment Updates:
   - Added Vault agent annotations
   - Configured environment variables for Vault access
   - Removed direct Kubernetes secret usage

4. Secret Storage:
   - Secret stored in Vault at path `secret/data/mysecret`
   - Accessible to pods through Vault agent
   - Automatically injected into the container