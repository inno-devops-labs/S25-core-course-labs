# Lab 11: Working with Kubernetes Secrets

## Task 1: Kubernetes Secrets and Resource Management

First, let's create a secret using kubectl:

```bash
# Create a secret
$ kubectl create secret generic my-secret --from-literal=MY_PASSWORD=secretpassword123

# Verify the secret was created
$ kubectl get secrets
```

Output:
```
NAME         TYPE     DATA   AGE
my-secret    Opaque   1      10s
```

Get content of the secret in yaml format:

```bash
$ kubectl get secret my-secret -o yaml
```

Output:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  MY_PASSWORD: c2VjcmV0cGFzc3dvcmQxMjM=
```

Decoding the secret:
```bash
$ kubectl get secret my-secret -o jsonpath='{.data.password}' | base64 --decode
$ kubectl get secret my-secret -o jsonpath='{.data.username}' | base64 --decode
```

Output:
```
secretpassword123
admin
```

## Managing Secrets with Helm

After updating our Helm chart to use secrets and deploying it:

```bash
# Get pods to verify deployment
$ kubectl get pods
NAME                             READY   STATUS      RESTARTS   AGE
demo-test-app-569d5cff54-kfbsw   1/1     Running     0          59s
post-install-hook                0/1     Completed   0          58s
pre-install-hook                 0/1     Completed   0          92s
```

Output:
```
NAME                    READY   STATUS    RESTARTS   AGE
demo-5f898f5f4c-2gpnd   1/1     Running   0          30s
```

Verifying the secret is properly mounted in the pod:

```bash
$ kubectl exec demo-test-app-569d5cff54-kfbsw -- printenv | grep MY_PASS

MY_PASSWORD=secretpassword123
```

## Task 2: Vault Secret Management System

### 1. Installing Vault

First, let's install Vault using Helm:

```bash
# Add the HashiCorp Helm repository
$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈

# Install Vault
$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Sun Mar  9 19:56:34 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

# Verify the installation
$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running     0          87s
vault-agent-injector-66f45b5fd5-t7b2n   1/1     Running     0          87s
```

### 2. Configuring Vault and Kubernetes Authentication

```bash
# Port forward Vault
$ kubectl port-forward vault-0 8200:8200
Forwarding from 127.0.0.1:8200 -> 8200
Forwarding from [::1]:8200 -> 8200

$ export VAULT_ADDR='http://127.0.0.1:8200'

# Create a secret in Vault
$  kubectl exec -it vault-0 -- /bin/sh
/$ vault kv put secret/myapp/config username="db-user" password="db-password-123"
====== Secret Path ======
secret/data/myapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T17:00:14.995294722Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

# Enable and configure Kubernetes authentication
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
$ vault write auth/kubernetes/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
    token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
    kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
    issuer="https://kubernetes.default.svc.cluster.local"
Success! Data written to: auth/kubernetes/config

# Create a policy for our application
$ vault policy write myapp-policy - <<EOF
path "secret/data/myapp/config" {
  capabilities = ["read"]
}
EOF
Success! Uploaded policy: myapp-policy

# Create a Kubernetes authentication role
$ vault write auth/kubernetes/role/myapp \
    bound_service_account_names=test-app \
    bound_service_account_namespaces=default \
    policies=myapp-policy \
    ttl=24h
```
Success! Data written to: auth/kubernetes/role/myapp

### 3. Verifying Vault Integration

After updating our Helm chart with Vault annotations:

```bash
# Check if the pod has the Vault sidecar
$ kubectl get pod demo-test-app-569d5cff54-kfbsw -o jsonpath='{.spec.containers[*].name}'
test-app

# Verify the secrets are mounted
$ kubectl exec -it demo-test-app-569d5cff54-kfbsw -- cat /vault/secrets/config.json
{
  "username": "db-user",
  "password": "db-password-123"
}

# Check the mounted volumes
$ kubectl exec -it demo-test-app-569d5cff54-kfbsw -- df -h | grep vault
tmpfs            64M     0   64M   0% /vault/secrets
```

