# Secrets

## Task 1

```bash
$ kubectl create secret generic db-creds --from-literal=username=default --from-literal=password='defaultpassword'
secret/db-creds created

$ kubectl get secrets
NAME       TYPE     DATA   AGE
db-creds   Opaque   2      11s

$ kubectl get secret db-creds -o yaml
apiVersion: v1
data:
  password: ZGVmYXVsdHBhc3N3b3Jk
  username: ZGVmYXVsdA==
kind: Secret
metadata:
  creationTimestamp: "2025-03-09T09:11:20Z"
  name: db-creds
  namespace: default
  resourceVersion: "555"
  uid: 919cb489-8690-4c29-b578-7ed9557fda1e
type: Opaque

$ kubectl get secret db-creds -o yaml | grep password | awk '{print $2}' | base64 --decode
defaultpassword

$ kubectl get secret db-creds -o yaml | grep username | awk '{print $2}' | base64 --decode
default
```

Make sure that you have sops and the helm plugin installed, then create a keypair:

```bash
$ gpg --gen-key
gpg (GnuPG) 2.4.7; Copyright (C) 2024 g10 Code GmbH
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: exampleUser
Email address: example@mail.org
You selected this USER-ID:
    "exampleUser <example@mail.org>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /home/justcgh9/.gnupg/trustdb.gpg: trustdb created
gpg: directory '/home/justcgh9/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/justcgh9/.gnupg/openpgp-revocs.d/B20586E5869997D953D115D9A74345C892EB8C14.rev'
public and secret key created and signed.

pub   ed25519 2025-03-09 [SC] [expires: 2028-03-08]
      B20586E5869997D953D115D9A74345C892EB8C14
uid                      exampleUser <example@mail.org>
sub   cv25519 2025-03-09 [E] [expires: 2028-03-08]
```


```bash
$ sops -p B20586E5869997D953D115D9A74345C892EB8C14 secrets.yaml

$ helm secrets view secrets.yaml
password: secret123

$ helm secrets install app-python app-python/ -n default -f secrets.yaml
NAME: app-python
LAST DEPLOYED: Sun Mar  9 12:48:04 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed 'secrets.yaml.dec'
```


```bash
$ kubectl get po
NAME                         READY   STATUS    RESTARTS   AGE
app-python-699f6c4b6-4tq2t   1/1     Running   0          3m39s

$ kubectl exec app-python-699f6c4b6-4tq2t -- env | grep MY_PASSWORD
MY_PASSWORD=secret123

$ kubectl get secret credentials -o yaml | grep password | awk '{print $2}' | base64 --decode
secret1234
```

## Task 2

```bash
$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "stable" chart repository
Update Complete. ⎈Happy Helming!⎈

$ helm install vault hashicorp/vault --set "server.dev.enables=true"
NAME: vault
LAST DEPLOYED: Sun Mar  9 13:18:46 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault

$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
app-go-79894d8d94-dtnxm                 1/1     Running   0          35m
app-python-765cb6969f-sfk56             1/1     Running   0          42m
vault-0                                 1/1     Running   0          62s
vault-agent-injector-66f45b5fd5-jxrfq   1/1     Running   0          62s

$ kubectl exec -it vault-0 -- /bin/sh

/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-example-username" password="db-example-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T10:48:55.202697538Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T10:48:55.202697538Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-example-password
username    db-example-username

/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

/ $ vault policy write app-python - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: app-python

/ $ vault policy write app-go - <<EOF
> path "internal/data/database/config" {
> capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: app-go

/ $ vault write auth/kubernetes/role/app-python \
>       bound_service_account_names=app-python \
>       bound_service_account_namespaces=default \
>       policies=app-python \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/app-python

/ $ vault write auth/kubernetes/role/app-go \
> bound_service_account_names=app-go \
> bound_service_account_namespaces=default \
>       policies=app-go \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/app-go

/ $ exit

$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-go                 0         46m
app-python             0         53m
default                0         110m
vault                  0         11m
vault-agent-injector   0         11m

```

After that I needed to update `values.yaml`, specifically `podAnnotations`, and reinstall the python app:

```bash
$ helm uninstall app-python
release "app-python" uninstalled

$ helm secrets install app-python app-python/ -n default -f secrets.yaml
NAME: app-python
LAST DEPLOYED: Sun Mar  9 14:20:08 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-python)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
removed 'secrets.yaml.dec'

$ kubectl exec -it app-python-756d6cd557-txz2k -- /bin/sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay         476G   98G  377G  21% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           256M  4.0K  256M   1% /vault/secrets
/dev/sdb2       476G   98G  377G  21% /etc/hosts
tmpfs           256M   12K  256M   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/asound
tmpfs           3.9G     0  3.9G   0% /proc/acpi
tmpfs           3.9G     0  3.9G   0% /proc/scsi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
tmpfs           3.9G     0  3.9G   0% /sys/devices/virtual/powercap

$ cat /vault/secrets/database-config.txt
postgresql://db-example-username:db-example-password@postgres:5432/wizard
```

## Bonus


```bash
$ kubectl exec app-python-765cb6969f-sfk56 -- env | grep HELLO
HELLO=world

$ kubectl describe deployments.apps app-python | grep -A 10 Containers
  Containers:
   app-python:
    Image:      justcgh/moscow-time-app:latest
    Port:       8081/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
```

```bash
$ helm install app-go app-go/
NAME: app-go
LAST DEPLOYED: Sun Mar  9 13:11:22 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services app-go)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT

$ kubectl describe deployments.apps app-go | grep -A 10 Containers
  Containers:
   app-go:
    Image:      justcgh/url-shortener:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     300m
      memory:  512Mi
    Requests:
      cpu:     300m
      memory:  512Mi

$ kubectl exec app-go-79894d8d94-dtnxm -- env | grep HELLO
HELLO=world
```