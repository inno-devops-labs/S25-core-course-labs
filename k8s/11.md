# Secrets Management in Kubernetes

## Task 1:

### `kubectl create secret` command:

---
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs$ kubectl create secret generic devops-secret --from-literal=kube=kuberdevops
secret/devops-secret created
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs$ kubectl get secrets
NAME            TYPE     DATA   AGE
devops-secret   Opaque   1      7s
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs$ kubectl get secret devops-secret -o jsonpath='{.data}'
{"kube":"a3ViZXJkZXZvcHM="}
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs$ echo 'a3ViZXJkZXZvcHM=' | base64 -d
kuberdevops
```

The successfully `base64` decoded secret is revealed.

### Helm secrets

---
I have used `gpg` together with the `sops` to create the key pair and create `secrets.yml` file which contains my strongly secured password.
After all these manipulations, we can finally add `templates/secrets.yaml` file which contains description from where to get our secret for the `helm chart`.
Also, change the `templates/deployment.yaml` file to add `env` section for future environment of pods.
We can finally install the `'python-app' helm chart` to check that our key is persistent inside the container:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ helm secrets install python-app ./python-app/ -n default -f ./python-app/secrets.yml
[helm-secrets] Decrypt: ./python-app/secrets.yml
NAME: python-app
LAST DEPLOYED: Thu Mar  6 20:22:56 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
[helm-secrets] Removed: ./python-app/secrets.yml.dec

nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
python-app-669c89cb6f-blcjk   1/1     Running   0          5m16s
python-app-669c89cb6f-bplsj   1/1     Running   0          5m16s
python-app-669c89cb6f-phh54   1/1     Running   0          5m16s

nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-669c89cb6f-blcjk  -- printenv | grep MY_PASS
MY_PASS=simplepass123
```

## Task 2:

### Vault secrets management

---

I installed vault as it was mentioned in the guide and there are 2 more pods especially for `vault`:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
python-app-669c89cb6f-blcjk             1/1     Running   0          20m
python-app-669c89cb6f-bplsj             1/1     Running   0          20m
python-app-669c89cb6f-phh54             1/1     Running   0          20m
vault-0                                 1/1     Running   0          57s
vault-agent-injector-84b987db6f-c7ptg   1/1     Running   0          57s
```

### Steps to create secrete in vault:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T17:45:08.603156741Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T17:45:08.603156741Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

Secret is inside the pods:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
python-app-b6fb85455-btvvz              2/2     Running   0          25s
vault-0                                 1/1     Running   0          7m10s
vault-agent-injector-84b987db6f-2sjz5   1/1     Running   0          7m10s
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec -it python-app-b6fb85455-btvvz --container python-app -- /bin/sh
/app $ ls
__pycache__       main.py           requirements.txt
/app $ cd ..
/ $ ls
app    dev    home   media  opt    root   sbin   sys    usr    vault
bin    etc    lib    mnt    proc   run    srv    tmp    var
/ $ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-06T18:15:46.956850949Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
/ $ exit
```

### Resource management:

Command to check resources of changed deployment:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl describe deployments.apps python-app
Name:                   python-app
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 21:34:42 +0300
Labels:                 app.kubernetes.io/instance=python-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=python-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=python-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: python-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=python-app,app.kubernetes.io/name=python-app
Replicas:               3 desired | 3 updated | 3 total | 0 available | 3 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=python-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=python-app
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=python-app-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   python-app:
    Image:      zerohalf/moscow-time-app:latest
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:8000/ delay=3s timeout=1s period=5s #success=1 #failure=3
    Readiness:  http-get http://:8000/ delay=3s timeout=1s period=5s #success=1 #failure=3
    Environment:
      MY_PASS:     <set to the key 'password' in secret 'credentials'>  Optional: false
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      False   MinimumReplicasUnavailable
  Progressing    True    ReplicaSetUpdated
OldReplicaSets:  <none>
NewReplicaSet:   python-app-58cc9c8b67 (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  31s   deployment-controller  Scaled up replica set python-app-58cc9c8b67 to 3
```

### Environment variables:

```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec -it python-app-58cc9c8b67-f8vvf -- env
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=python-app-58cc9c8b67-f8vvf
ENVIRONMENT=stage
LANG=C.UTF-8
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
PYTHON_VERSION=3.10.16
PYTHON_SHA256=bfb249609990220491a1b92850a07135ed0831e41738cf681d63cf01b2a8fbd1
MY_PASS=simplepass123
PYTHON_APP_PORT_8000_TCP_PROTO=tcp
PYTHON_APP_PORT_8000_TCP_PORT=8000
KUBERNETES_PORT=tcp://10.43.0.1:443
PYTHON_APP_SERVICE_PORT=8000
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
PYTHON_APP_PORT=tcp://10.43.202.214:8000
PYTHON_APP_SERVICE_PORT_HTTP=8000
PYTHON_APP_PORT_8000_TCP_ADDR=10.43.202.214
KUBERNETES_SERVICE_HOST=10.43.0.1
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.43.0.1
PYTHON_APP_SERVICE_HOST=10.43.202.214
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443
PYTHON_APP_PORT_8000_TCP=tcp://10.43.202.214:8000
TERM=xterm
HOME=/home/user
```