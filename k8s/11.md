# Kubernetes Secrets and Hashicorp Vault

## Task 1

How I create and show secret:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl create secret generic app-secret --from-literal=MY_PASS=my_pass

secret/app-secret created

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get secrets

NAME                                    TYPE                 DATA   AGE
app-secret                              Opaque               1      5s
sh.helm.release.v1.python-time-app.v1   helm.sh/release.v1   1      6m2s

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get secret app-secret -o yaml

apiVersion: v1
data:
  MY_PASS: bXlfcGFzcw==
kind: Secret
metadata:
  creationTimestamp: "2025-03-04T17:43:42Z"
  name: app-secret
  namespace: default
  resourceVersion: "2210"
  uid: 51ba88a8-c5f8-4f14-896c-77348ad2a171
type: Opaque
```

And then decode it:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ echo "bXlfcGFzcw==" | base64 -d

my_pass
```

As the next step I configured secrets with Helm according to provided video and encrypt MY_PASS secret using helm-secrets and my gpg key. Then I installed an application and this is an output for the required commands:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm secrets install python-time-app ./python-time-app -n default -f ./secrets.yaml

NAME: python-time-app
LAST DEPLOYED: Thu Mar  6 20:13:39 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-app,app.kubernetes.io/instance=python-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './secrets.yaml.dec'

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get po

NAME                               READY   STATUS    RESTARTS   AGE
python-time-app-8657468d6b-r8lph   1/1     Running   0          47s

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec python-time-app-8657468d6b-r8lph -- printenv | grep MY_PASS

MY_PASS=my_pass
```

---

## Task 2

I adhered to the provided guide, upgrade python-time-app:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm upgrade --install python-time-app ./python-time-app -f ./secrets.yaml

Release "python-time-app" has been upgraded. Happy Helming!
NAME: python-time-app
LAST DEPLOYED: Thu Mar  6 20:22:42 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-app,app.kubernetes.io/instance=python-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

Then patch it:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl patch deployment python-time-app --patch "$(cat ./python-time-app/patch-inject-secrets.yaml)"

deployment.apps/python-time-app patched

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get pods

NAME                                    READY   STATUS        RESTARTS   AGE
python-time-app-5f5f65fd66-r9j7j        2/2     Running       0          10s
python-time-app-7f7dc47c96-cnggg        1/1     Terminating   0          51s
vault-0                                 1/1     Running       0          4m54s
vault-agent-injector-66f45b5fd5-vtrdr   1/1     Running       0          4m55s
```

And display required commands:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec -it python-time-app-5f5f65fd66-r9j7j -- bash

Defaulted container "python-time-app" out of: python-time-app, vault-agent, vault-agent-init (init)

python_user@python-time-app-5f5f65fd66-r9j7j:/app_python$ cat /vault/secrets/database-config.txt

data: map[password:my_pass username:gleb]
metadata: map[created_time:2025-03-06T17:19:09.356312424Z custom_metadata:<nil> deletion_time: destroyed:false version:1]

python_user@python-time-app-5f5f65fd66-r9j7j:/app_python$ df -h

Filesystem      Size  Used Avail Use% Mounted on
overlay          64G   55G  7.0G  89% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           7.8G  4.0K  7.8G   1% /vault/secrets
/dev/sda2        64G   55G  7.0G  89% /etc/hosts
tmpfs           7.8G   12K  7.8G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/asound
tmpfs           3.9G     0  3.9G   0% /proc/acpi
tmpfs           3.9G     0  3.9G   0% /proc/scsi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```

---

## Bonus Task

### Resource Management

Firstly, I updated values.yaml and added resources section. Then, I upgraded python-time-app and displayed the it, where shown the resources limits:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm upgrade --install python-time-app ./python-time-app -f ./secrets.yaml

Release "python-time-app" has been upgraded. Happy Helming!
NAME: python-time-app
LAST DEPLOYED: Thu Mar  6 20:33:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 5
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-app,app.kubernetes.io/instance=python-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl describe deployments.apps python-time-app

Name:                   python-time-app
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 20:13:53 +0300
Labels:                 app.kubernetes.io/instance=python-time-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=python-time-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=python-time-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 4
                        meta.helm.sh/release-name: python-time-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=python-time-app,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=python-time-app,app.kubernetes.io/version=1.16.0,helm.sh/chart=python-time-app-0.1.0
Replicas:               1 desired | 1 updated | 2 total | 2 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=python-time-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=python-time-app
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=python-time-app-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   python-time-app:
    Image:      bugay/python-msk-time-app:1.0
    Port:       5000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
    Environment:
      MY_PASS:     <set to the key 'MY_PASS' in secret 'app-secret-1'>  Optional: false
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    ReplicaSetUpdated
OldReplicaSets:  python-time-app-8657468d6b (0/0 replicas created), python-time-app-7f7dc47c96 (0/0 replicas created), python-time-app-5f5f65fd66 (1/0 replicas created)
NewReplicaSet:   python-time-app-65db674446 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  19m    deployment-controller  Scaled up replica set python-time-app-8657468d6b from 0 to 1
  Normal  ScalingReplicaSet  10m    deployment-controller  Scaled up replica set python-time-app-7f7dc47c96 from 0 to 1
  Normal  ScalingReplicaSet  10m    deployment-controller  Scaled down replica set python-time-app-8657468d6b from 1 to 0
  Normal  ScalingReplicaSet  9m46s  deployment-controller  Scaled up replica set python-time-app-5f5f65fd66 from 0 to 1
  Normal  ScalingReplicaSet  9m42s  deployment-controller  Scaled down replica set python-time-app-7f7dc47c96 from 1 to 0
  Normal  ScalingReplicaSet  4s     deployment-controller  Scaled up replica set python-time-app-65db674446 from 0 to 1
  Normal  ScalingReplicaSet  0s     deployment-controller  Scaled down replica set python-time-app-5f5f65fd66 from 1 to 0
```

And then done the same thing for the scala-time-app:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm upgrade --install scala-time-app ./scala-time-app

Release "scala-time-app" does not exist. Installing it now.
NAME: scala-time-app
LAST DEPLOYED: Thu Mar  6 20:38:10 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=scala-time-app,app.kubernetes.io/instance=scala-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl describe deployments.apps scala-time-app

Name:                   scala-time-app
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 20:38:23 +0300
Labels:                 app.kubernetes.io/instance=scala-time-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=scala-time-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=scala-time-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: scala-time-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=scala-time-app,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=scala-time-app,app.kubernetes.io/version=1.16.0,helm.sh/chart=scala-time-app-0.1.0
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=scala-time-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=scala-time-app
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=scala-time-app-0.1.0
  Service Account:  scala-time-app
  Containers:
   scala-time-app:
    Image:      bugay/scala-msk-time-app-distroless:1.0
    Port:       9090/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:         100m
      memory:      128Mi
    Environment:   <none>
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   scala-time-app-bf97757dc (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  42s   deployment-controller  Scaled up replica set scala-time-app-bf97757dc from 0 to 1
```

### Environment Variables

Now I added environment variables to the _helpers.tpl, upgraded the container and shown these variables:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm upgrade --install python-time-app ./python-time-app -f ./secrets.yaml 

Release "python-time-app" has been upgraded. Happy Helming!
NAME: python-time-app
LAST DEPLOYED: Thu Mar  6 20:49:33 2025
NAMESPACE: default
STATUS: deployed
REVISION: 8
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-app,app.kubernetes.io/instance=python-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get pods

NAME                                    READY   STATUS        RESTARTS   AGE
python-time-app-7c85cb5bf6-9ngt5        2/2     Running       0          22s
scala-time-app-bf97757dc-8mjp8          1/1     Running       0          11m
vault-0                                 1/1     Running       0          31m
vault-agent-injector-66f45b5fd5-vtrdr   1/1     Running       0          31m

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec python-time-app-7c85cb5bf6-9ngt5 -- env | grep AUTHOR

Defaulted container "python-time-app" out of: python-time-app, vault-agent, vault-agent-init (init)
AUTHOR=gleb

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec python-time-app-7c85cb5bf6-9ngt5 -- env | grep COURSE

Defaulted container "python-time-app" out of: python-time-app, vault-agent, vault-agent-init (init)
COURSE=DevOps-S25
```

And the same steps for the second application:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm uninstall scala-time-app

release "scala-time-app" uninstalled

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm install scala-time-app ./scala-time-app

NAME: scala-time-app
LAST DEPLOYED: Thu Mar  6 21:01:26 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=scala-time-app,app.kubernetes.io/instance=scala-time-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get pods

NAME                                    READY   STATUS    RESTARTS   AGE
python-time-app-7c85cb5bf6-9ngt5        2/2     Running   0          13m
scala-time-app-74c4f8f599-wfmrs         1/1     Running   0          63s
vault-0                                 1/1     Running   0          44m
vault-agent-injector-66f45b5fd5-vtrdr   1/1     Running   0          44m

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec scala-time-app-74c4f8f599-wfmrs -- env | grep AUTHOR

AUTHOR=gleb

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec scala-time-app-74c4f8f599-wfmrs -- env | grep COURSE

COURSE=DevOps-S25
```

---
