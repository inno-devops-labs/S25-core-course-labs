# Lab 11

## Task 1

Creating and verifying a secret:

```bash
kubectl create secret generic lab11-secret --from-literal=username=username --from-literal=password=password

kubectl get secrets
NAME           TYPE     DATA   AGE
lab11-secret   Opaque   2      11s

kubectl describe secret lab11-secret
Name:         lab11-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  8 bytes
username:  8 bytes
```

Decoding a secret:

```bash
kubectl get secret lab11-secret -o jsonpath="{.data.username}" | base64 --decode
username

kubectl get secret lab11-secret -o jsonpath="{.data.password}" | base64 --decode
password
```

After it I also created gpg-key to encode my secret, so it would be safely stored in the remote repo. Then I installed the chart:

```bash
helm secrets install app-python ./app-python -n default -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: app-python
LAST DEPLOYED: Fri Mar  7 17:48:20 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: ./secrets.yaml.dec
```

## Task 2

Installing Vault using Helm chart:

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" already exists with the same configuration, skipping
aksss-MacBook-Pro:k8s mangocandle$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Unable to get an update from the "hashicorp" chart repository (https://helm.releases.hashicorp.com):
        failed to fetch https://helm.releases.hashicorp.com/index.yaml : 403 Forbidden
Update Complete. ⎈Happy Helming!⎈

helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Fri Mar  7 18:42:17 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

Results:

```bash
kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
app-python-84f6658b8f-l9dls             1/1     Running   0          58m
vault-0                                 1/1     Running   0          5m13s
vault-agent-injector-66f45b5fd5-bf5q8   1/1     Running   0          5m15s
```

Then I followed the guide recommended in lab:

```bash
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T15:49:11.925754582Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-07T15:49:11.925754582Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

Adding a patch:

```bash
kubectl patch deployment app-python --patch-file=patch-inject-secrets.yaml
deployment.apps/app-python patched
```
