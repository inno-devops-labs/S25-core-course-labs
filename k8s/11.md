# Lab 11: Kubernetes Secrets and Hashicorp Vault
- Daniil Vasilev, d.vasilev@innopolis.university

## Task 1: Kubernetes Secrets and Resource Management
### Step 1: Create a Secret Using kubectl:
- ```bash
  kubectl create secret generic test-secret --from-literal=PASS=testpassword
  ```

### Step 2: Verify and Decode The Secret:
- ```bash
  kubectl get secrets
  ```
  ![alt text](assets/images-11/image.png)
- ```bash
  kubectl describe secret test-secret
  ```
  ![alt text](assets/images-11/image-1.png)
- ```bash
  kubectl get secret test-secret -o jsonpath="{.data.PASS}"
  ```
  ![alt text](assets/images-11/image-2.png)
- ```text
  dGVzdHBhc3N3b3Jk
  Decoded base64: testpassword
  ```

### Step 3: Manage Secrets with Helm
- `kubectl get po`: 
- ![alt text](assets/images-11/image-3.png)
- `kubectl exec demo-5f898f5f4c-2gpnd -- printenv`: 
- ![alt text](assets/images-11/image-4.png)

## Task 2: Vault Secret Management System

### Step 2 & 3:
- Setting a Secret in Vault Result:
  - ![alt text](assets/images-11/image-5.png)
- Configuring Kubernetes Authentication:
  - ![alt text](assets/images-11/image-7.png)
- Configuring Policy:
  - ![alt text](assets/images-11/image-6.png)
- Creating a Kubernetes authentication role:
  - ![alt text](assets/images-11/image-9.png)
- Pods status while upgrading:
  - ![alt text](assets/images-11/image-11.png)
- Pods status after container upgrade:
  - ![alt text](assets/images-11/image-12.png)
- Test (After apply)
  - ![alt text](assets/images-11/image-10.png)

## Bonus Task
### Step 2 & 3: Set up requests and limits for CPU and Memory for both charts, add env. variables
- Upgraded both charts: 
- ![alt text](assets/images-11/image-13.png)
- Included into `deployment.yml`: ```yaml
                                  {{- include "fastapi-mt.envVars" . | nindent 10 }} # For fastapi (python) web app
                                  {{- include "gin-mt.envVars" . | nindent 10 }} # For gin (go) web app
                                  ```
- Included into `values.yaml`: ```yaml
                               resources:
                                 requests:
                                   cpu: "250m"
                                   memory: "128Mi"
                                 limits:
                                   cpu: "500m"
                                   memory: "256Mi"
                               ```
- Included into `_helpers.tpl`: ```yaml
                                {{- define "gin-mt.envVars" -}} # And {{- define "fastapi-mt.envVars" -}} for the second
                                env:
                                  - name: ENV_MODE
                                    value: "development"
                                  - name: Vault_Password
                                    value: "/vault/secrets/password"
                                  - name: Vault_Key
                                    value: "/vault/secrets/unique-key"
                                {{- end }}
                                ```
- Result 1: (got via `kubectl describe pod $(kubectl get pod -l app.kubernetes.io/name=fastapi-mt -o jsonpath="{.items[0].metadata.name}")`)
  - ![alt text](assets/images-11/image-14.png)
- Result 2: (got via `kubectl describe pod $(kubectl get pod -l app.kubernetes.io/name=gin-mt -o jsonpath="{.items[0].metadata.name}")`)
  - ![alt text](assets/images-11/image-15.png)