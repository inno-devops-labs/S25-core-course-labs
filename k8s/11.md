# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1:

- let's reconnect to the same instance that we have created for the previous 2 labs
- let's create a sectret using `kubectl`:
- ![img](assets_11/image1.png)
- let's verify that the secret has been created:
- ![img](assets_11/image2.png)
- let's get the details of the secret by executing `minikube kubectl -- get secret my-secret -o yaml`:

  ```
  apiVersion: v1
  data:
    MY_PASS: c3VwZXJzZWNyZXRwYXNzd29yZA==
  kind: Secret
  metadata:
    creationTimestamp: "2025-03-05T20:29:46Z"
    name: my-secret
    namespace: default
    resourceVersion: "19321"
    uid: 91f048bf-82a7-4a1a-93f8-90f74b6b0cf8
  type: Opaque


  ```
- let's decode the secret value:
- ![img](assets_11/image4.png)
- video
- let's install `secrets` plugin for `helm`
- ![img](assets_11/image5.png)
- let's check that it got installed:
- ![img](assets_11/image6.png)
- let's create a key using `gpg` and check that it got added to the keys list
- ![img](assets_11/image7.png)
- let's create `secrets.yaml` by executing

  ```
  sosp C27A767F23238C90EC7B42E65A2CD70308FC3C4C secrets.yaml
  ```
- and let's write inside it the following:

  ```
  password: secret1234
  ```
- let's check `secrets.yaml` by executing `cat secrets.yaml`:

  ```
  password: ENC[AES256_GCM,data:oIyVQRFPlCjNMw==,iv:5R0sr42n6WSoR+9hZ0oFC3VTKVSw/x/AJU9qoM96PWw=,tag:3wkScxYNiJL9B1zo9NMcyA==,type:str]
  sops:
      kms: []
      gcp_kms: []
      lastmodified: '2025-03-05T22:08:34Z'
      mac: ENC[AES256_GCM,data:77u0BiDrhLcywkPSgK7+t9CrxoFNAUrsGKARtpaj1Vd7lJ5aXKv0i01hsECDWfQ+BC1FsD/aFglyQGR0YXJquujTUrqwFeYaRduq4bwswzGKo6mPUUi/zmiQ5+YJ+FKdkMWxbZ5Y4mNWFDN9btYm+IOg5LJGfmxe4Tv1p3dLKvg=,iv:aibIP5R9filxWDRQb4IrQGyedtKwQk/i7XCzYIHU9QY=,tag:4uZ0Y1MttfQXw4MOZVQq+A==,type:str]
      pgp:
      -   created_at: '2025-03-05T22:07:38Z'
          enc: |
              -----BEGIN PGP MESSAGE-----

              hF4Dwup2HkqkFM8SAQdAGCHY6wZwDjjpKrhx9QJ2JHS6FhDxI+oRWnBI83t1sBEw
              SoNkgbisGlnH4pScD1irWE0v4Uo1YzsaU/FjYkSdRzOiEBl5DztHGIvx6J83vsz+
              1GgBCQIQMyzycZDtpzK92jjLhF7aq/dBWhT3tyNzLgtaW+2Rig+k4l9PT93h0vOp
              /InOXHNwCkqBFToZ1LK02LbVzvRpkM7YtGjj1n+Nj2T4hvF+QCxpgtB1ESO5uZyN
              pdGHFQC1eOCCHg==
              =Y5CF
              -----END PGP MESSAGE-----
          fp: C27A767F23238C90EC7B42E65A2CD70308FC3C4C
      unencrypted_suffix: _unencrypted
      version: 3.0.3
  ```
- let's decode the secret:
- ![img](assets_11/image8.png)
- let's add `secrets.yaml` file to `/helm/app-python/templates/`:

  ```
  apiVersion: v1
  kind: Secret
  metadata:
    name: credentials
    labels:
      app: app-python
      chart: '{{ .Chart.Name }}-{{ .Chart.Version }}'
      release: '{{ .Release.Name }}'
      heritage: '{{ .Release.Service }}'
  type: Opaque
  data:
    password: {{ .Values.password | b64enc | quote }}
  ```
- let's update `deployment.yaml` file in `/helm/app-python/` by adding the following lines under `spec.template.spec.containers`:

  ```
  env:
  - name: MY_PASSWORD
    valueFrom:
      secretKeyRef:
        name: credentials
        key: password
  ```
- let's uninstall the previous `app-python` and reinstall it again using the secret:
- ![img](assets_11/image3.png)
- ![img](assets_11/image9.png)
- let's check that it got installed
- ![img](assets_11/image10.png)
- let's retrieve the list of pods:
- ![img](assets_11/image11.png)
- we can see that the pod name is `app-python-5c5d5d98c9-kjljd`
- let's verify the secret inside the pod:
- ![img](assets_11/image12.png)
- we can see that it matches the password that we have selected earlier

## Task 2:

- let's install the `vault helm chart` and check that it got installed:
- ![img](assets_11/image13.png)
- let's start an interactive shell session on the `vault-0` pod and enable kv-v2 secrets at the path `internal`:
- ![img](assets_11/image14.png)
- now let's set a secret by executing `vault kv put internal/app-python/config username="ammar" password="secret1234"` and then let's verify that we can read that secret at the path ``internal/app-python/config``:
- ![img](assets_11/image15.png)
- now let's enable the Kubernetes authentication method and configure the Kubernetes authentication method to use the location of the Kubernetes API:
- ![img](assets_11/image16.png)
- now let's write out the policy named `internal-app` that enables the `read` capability for secrets at path `internal/app-python/config`:

  ```
  $ vault policy write internal-app - <<EOF
  path "`internal/app-python/config`" {
     capabilities = ["read"]
  }
  EOF
  ```
- and we get the output:

  ```
  Success! Uploaded policy: internal-app
  ```
- now let's create a Kubernetes authentication role named `internal-app`:

  ```
  vault write auth/kubernetes/role/internal-app \
        bound_service_account_names=internal-app \
        bound_service_account_namespaces=default \
        policies=internal-app \
        ttl=24h
  ```
- and we get the output:

  ```
  Success! Data written to: auth/kubernetes/role/internal-app
  ```
- as we used `helm create` for our chart, `serviceaccount.yaml` was automatically created
- values
- let's create `patch-inject-secrets.yaml`:

  ```
  spec:
    template:
      metadata:
        annotations:
          vault.hashicorp.com/agent-inject: 'true'
          vault.hashicorp.com/role: 'internal-app'
          vault.hashicorp.com/agent-inject-secret-config.txt: 'internal/app-python/config'
  ```
- let's patch `app-python`:
- ![img](assets_11/image8.png)
- we can see how a new pod got created, but it took long time intializing, so i cannot access it and apply `df -h`
- ![img](assets_11/image19.png)

## Bonus:

- let's update `values.yaml` by adding for both charts:

  ```
  resources:
    requests:
      cpu: "250m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"
  ```
- and let's update this part of `deployment.yaml`:

  ```
  containers:
          - name: {{ .Chart.Name }}
            resources:
              {{- toYaml .Values.resources | nindent 12 }}
  ```
- let's verify resource settings for `app-python` and `app-go`:
- ![img](assets_11/image17.png)
- let's add the following to `_helpers.tpl`:

  - app-python:

    ```
    {{/*
    Define environment variables for the app.
    */}}
    {{- define "app-python.envVars" -}}
    {{- range $key, $value := .Values.env }}
    - name: {{ $key }}
      value: {{ $value | quote }}
    {{- end }}
    {{- end }}
    ```
  - app-go:

    ```
    {{/*
    Define environment variables for the app.
    */}}
    {{- define "app-go.envVars" -}}
    {{- range $key, $value := .Values.env }}
    - name: {{ $key }}
      value: {{ $value | quote }}
    {{- end }}
    {{- end }}
    ```
- let's modify `env` section in `deployment.yaml`:
- - app-python:
    ```
    env:
      {{- include "app-python.envVars" . | nindent 12 }}
    ```
- - app-go:
    ```
    env:
      {{- include "app-go.envVars" . | nindent 12 }}
    ```
- let's add environment variables to `values.yaml` for both charts:

  ```
  env:
    APP_ENV: "production"
    DEBUG: "false"
    SECRET_KEY: "supersecretkey"
  ```
- and that's how environment variables got moved to the `_helpers.tpl` file
