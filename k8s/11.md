# Lab 11

## Task 1

### Create kubectl secret

```bash
kubectl create secret generic my-personal-secret --from-literal=some-secret-data=password
```

Output:

```text
secret/my-personal-secret created
```

### Verify secrets

```bash
kubectl get secrets
```

Output:

```text
NAME                                TYPE                 DATA   AGE
my-personal-secret                  Opaque               1      70s
```

### Decode the secret

```bash
kubectl get secret my-personal-secret -o jsonpath='{.data}'
```

Output:

```text
{"some-secret-data":"cGFzc3dvcmQ="}  
```

```bash
echo "cGFzc3dvcmQ=" | base64 -d
```

Output:

```text
password 
```

## Manage Secrets with Helm

```bash
helm secrets upgrade --install python-time . -f secrets.yaml
```

Output:

```text
[helm-secrets] Decrypt: secrets.yaml
Release "python-time" has been upgraded. Happy Helming!
NAME: python-time
LAST DEPLOYED: Sun Mar  9 22:04:18 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time,app.kubernetes.io/instance=python-time" -o jsonpath="{.items[0].metadata.name}")    
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: secrets.yaml.dec
```

```bash
kubectl get po
```

Output:

```text
NAME                          READY   STATUS      RESTARTS   AGE
python-time-c6fb76766-24bkk   1/1     Running     0          99s
```

```bash
kubectl exec python-time-c6fb76766-24bkk -- printenv | grep MY_PASSWORD
```

Output:

```text
MY_PASSWORD=secret-password
```

## Task 2

### Enable Vault and Set the secret

```text
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
```

```text
vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:16:54.575808025Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

```text
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T19:16:54.575808025Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

### Kubernetes Auth

```text
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```

```text
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
```

```text
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
```

```text
/ $ vault write auth/kubernetes/role/internal-app \
vice_account_n>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

### Service account

```text
kubectl create sa internal-app
serviceaccount/internal-app created
```

```text
kubectl get serviceaccounts
NAME                   SECRETS   AGE
default                0         13d
internal-app           0         14s
python-time            0         12d
vault                  0         11m
vault-agent-injector   0         11m
```

```text
kubectl patch deployment python-time --patch-file=patch-inject-secrets.yaml
deployment.apps/python-time patched
```

```text
kubectl exec -it python-time-55b66d779d-chwmd  --container python-time -- /bin/sh
$ cd / 
$ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-09T20:18:33.654888925Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```text
df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay        1007G   16G  941G   2% /
tmpfs            64M     0   64M   0% /dev
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
shm              64M   16K   64M   1% /dev/shm
/dev/sde       1007G   16G  941G   2% /etc/hosts
tmpfs           7.7G  4.0K  7.7G   1% /vault/secrets
tmpfs           7.7G   12K  7.7G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/acpi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```
