# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### 2. Verify and Decode Your Secret

I started by verifying the secret I created using the `kubectl get secrets` command:

```bash
kubectl get secrets
```

**Output:**

```log
NAME                               TYPE                 DATA   AGE
db-user-pass                       Opaque               2      107s
sh.helm.release.v1.app-go.v1       helm.sh/release.v1   1      3d2h
sh.helm.release.v1.app-python.v1   helm.sh/release.v1   1      3d2h
```

Next, I described the secret to view its details:

```bash
kubectl describe secret db-user-pass
```

**Output:**

```log
Name:         db-user-pass
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  12 bytes
username:  5 bytes
```

To decode the secret, I used the following command:

```bash
kubectl get secret db-user-pass -o jsonpath='{.data}'
```

**Output:**

```log
{"password":"UyFCXCpkJHpEc2I9","username":"YWRtaW4="}
```

I then decoded the password and username using `base64`:

```bash
echo 'UyFCXCpkJHpEc2I9' | base64 --decode
```

**Output:**

```log
S!B\*d$zDsb=
```

```bash
echo 'YWRtaW4=' | base64 --decode
```

**Output:**

```log
admin
```

### 3. Manage Secrets with Helm

I retrieved the list of pods to verify the deployment:

```bash
kubectl get pods
```

**Output:**

```log
NAME                         READY   STATUS    RESTARTS   AGE
secrets-1-6445c587fb-qjxhr   1/1     Running   0          5s
```

To verify the secret inside the pod, I executed the following command:

```bash
kubectl exec secrets-1-6445c587fb-qjxhr -- printenv | grep MY_PASSWORD
```

**Output:**

```log
MY_PASSWORD=innopolis1234
```

## Task 2: Vault Secret Management System

### 1. Install Vault Using Helm Chart

I installed Vault using the Helm chart and verified the installation:

```bash
kubectl get pods
```

**Output:**

```log
NAME                                    READY   STATUS    RESTARTS   AGE
secrets-1-6445c587fb-qjxhr              1/1     Running   0          18m
vault-0                                 1/1     Running   0          57s
vault-agent-injector-66f45b5fd5-ct2nw   1/1     Running   0          57s
```

### 2. Set Secret in Vault

I accessed the Vault pod and enabled the KV secrets engine:

```bash
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
```

**Output:**

```log
Success! Enabled the kv-v2 secrets engine at: internal/
```

I then set a secret in Vault:

```bash
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
```

**Output:**

```log
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-01T11:54:33.372745052Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

### 3. Configure Kubernetes Authentication

I enabled Kubernetes authentication and configured it:

```bash
/ $ vault auth enable kubernetes
```

**Output:**

```log
Success! Enabled kubernetes auth method at: kubernetes/
```

```bash
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```

**Output:**

```log
Success! Data written to: auth/kubernetes/config
```

I then created a policy and role for the internal app:

```bash
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
```

**Output:**

```log
Success! Uploaded policy: internal-app
```

```bash
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
```

**Output:**

```log
Success! Data written to: auth/kubernetes/role/internal-app
```

### 4. Verify Injected Secrets

I verified that the credentials were successfully injected into the pod:

```bash
kubectl get pods
```

**Output:**

```log
NAME                                    READY   STATUS    RESTARTS      AGE
secrets-f9556bd97-8rdgs                 2/2     Running   0             52s
vault-0                                 1/1     Running   2 (13h ago)   26h
vault-agent-injector-66f45b5fd5-ct2nw   1/1     Running   2 (13h ago)   26h
```

I accessed the pod and checked the injected secrets:

```bash
kubectl exec -it secrets-f9556bd97-8rdgs -- bash
```

```bash
root@secrets-f9556bd97-8rdgs:/# cat vault/secrets/database-config.txt 
```

**Output:**

```log
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-02T12:04:50.331028391Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

I also checked the disk usage:

```bash
root@secrets-f9556bd97-8rdgs:/# df -h
```

**Output:**

```log
Filesystem      Size  Used Avail Use% Mounted on
overlay         468G   79G  366G  18% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
/dev/nvme0n1p2  468G   79G  366G  18% /etc/hosts
tmpfs            16G  4.0K   16G   1% /vault/secrets
tmpfs            16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           7.8G     0  7.8G   0% /proc/asound
tmpfs           7.8G     0  7.8G   0% /proc/acpi
tmpfs           7.8G     0  7.8G   0% /proc/scsi
tmpfs           7.8G     0  7.8G   0% /sys/firmware
tmpfs           7.8G     0  7.8G   0% /sys/devices/virtual/powercap
```

### 5. Apply Template and Verify

After applying the template, I verified the updated pod:

```bash
kubectl get po
```

**Output:**

```log
NAME                                    READY   STATUS    RESTARTS      AGE
secrets-7cdd458897-zz22n                2/2     Running   0             30s
vault-0                                 1/1     Running   2 (15h ago)   28h
vault-agent-injector-66f45b5fd5-ct2nw   1/1     Running   2 (15h ago)   28h
```

I accessed the pod and checked the updated secrets:

```bash
kubectl exec -it secrets-7cdd458897-zz22n -- bash
```

```bash
root@secrets-7cdd458897-zz22n:/# cat /vault/secrets/database-config.txt
```

**Output:**

```log
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard
```

I also checked the disk usage again:

```bash
root@secrets-7cdd458897-zz22n:/# df -h
```

**Output:**

```log
Filesystem      Size  Used Avail Use% Mounted on
overlay         468G   79G  366G  18% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs            16G  4.0K   16G   1% /vault/secrets
/dev/nvme0n1p2  468G   79G  366G  18% /etc/hosts
tmpfs            16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           7.8G     0  7.8G   0% /proc/asound
tmpfs           7.8G     0  7.8G   0% /proc/acpi
tmpfs           7.8G     0  7.8G   0% /proc/scsi
tmpfs           7.8G     0  7.8G   0% /sys/firmware
tmpfs           7.8G     0  7.8G   0% /sys/devices/virtual/powercap
```

## Bonus Task: Resource Management and Environment Variables

### 1. Configure Resource Requests and Limits

I configured resource requests and limits for both the `app-go` and `app-python` deployments:

```bash
kubectl get pods
```

**Output:**

```log
NAME                                    READY   STATUS    RESTARTS      AGE
app-go-6d9bb84b76-jlx6j                 1/1     Running   0             84s
app-python-7cfb4fb46-b4jk6              1/1     Running   0             2m38s
secrets-7cdd458897-zz22n                2/2     Running   0             34m
vault-0                                 1/1     Running   2 (15h ago)   28h
vault-agent-injector-66f45b5fd5-ct2nw   1/1     Running   2 (15h ago)   28h
```

I verified the resource configurations:

```bash
kubectl get pod app-go-6d9bb84b76-jlx6j -o=jsonpath="{.spec.containers[*].resources}"
```

**Output:**

```log
{"limits":{"cpu":"500m","memory":"100Mi"},"requests":{"cpu":"500m","memory":"50Mi"}}
```

```bash
kubectl get pod app-python-7cfb4fb46-b4jk6 -o=jsonpath="{.spec.containers[*].resources}"
```

**Output:**

```log
{"limits":{"cpu":"500m","memory":"100Mi"},"requests":{"cpu":"500m","memory":"50Mi"}}
```

### 2. Add Environment Variables

I added environment variables for my name and email to both the `app-go` and `app-python` deployments:

```bash
kubectl exec -it app-python-59df778758-w4fn5 -- printenv
```

**Output:**

```log
PATH=/opt/venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-python-59df778758-w4fn5
TERM=xterm
NAME=Mohamad Nour Shahin
EMAIL=mo.shahin@innopolis.university
...
```

```bash
kubectl exec -it app-go-645b5598b8-rx766 -- printenv
```

**Output:**

```log
PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-go-645b5598b8-rx766
TERM=xterm
NAME=Mohamad Nour Shahin
EMAIL=mo.shahin@innopolis.university
...
```
