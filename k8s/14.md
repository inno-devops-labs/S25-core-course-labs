# Lab 14: Kubernetes StatefulSet
## Task 1: Implement StatefulSet in Helm Chart

```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ helm template --debug python-web ./k8s/python-web
install.go:225: 2025-04-23 23:49:04.725482808 +0500 +05 m=+0.133119283 [debug] Original chart version: ""
install.go:242: 2025-04-23 23:49:04.725544193 +0500 +05 m=+0.133180668 [debug] CHART PATH: /home/devops/S25-core-course-labs/k8s/python-web

---
# Source: python-web/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: python-web/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: python-web-secrets
type: Opaque
data:
  MY_USER: ZnJpZG9yb3ZpY2gwNA==
  MY_PASS: MTIz
---
# Source: python-web/templates/service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: python-web-headless
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  clusterIP: None
  ports:
  - port: 80
    name: http
  selector:
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
---
# Source: python-web/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
---
# Source: python-web/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: python-web-headless
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: python-web
      app.kubernetes.io/instance: python-web
  template:
    metadata:
      labels:
        app.kubernetes.io/name: python-web
        app.kubernetes.io/instance: python-web
    spec:
      serviceAccountName: python-web
      containers:
        - name: python-web
          image: "fridorovich04/python-web:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: MY_USERNAME
              valueFrom:
                secretKeyRef:
                  name: python-web-secrets
                  key: MY_USER
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: python-web-secrets
                  key: MY_PASS
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          livenessProbe:
            httpGet:
              initialDelaySeconds: 10
              path: /
              port: http
              timeoutSeconds: 5
          readinessProbe:
            httpGet:
              initialDelaySeconds: 10
              path: /
              port: http
              timeoutSeconds: 5
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 2Gi
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
---
# Source: python-web/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "python-web-test-connection"
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['python-web:8000']
  restartPolicy: Never
---
# Source: python-web/templates/post-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "python-web-post-install-hook"
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
      - name: post-install
        image: busybox
        command: ["/bin/sh", "-c", "echo 'Post-install hook is running'; sleep 20"]
      restartPolicy: Never
---
# Source: python-web/templates/pre-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "python-web-pre-install-hook"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
      - name: pre-install
        image: busybox
        command: ["/bin/sh", "-c", "echo 'Pre-install hook is running'; sleep 20"]
      restartPolicy: Never
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ helm install python-web ./k8s/python-web --dry-run --debug
install.go:225: 2025-04-23 23:57:53.936181248 +0500 +05 m=+0.221667484 [debug] Original chart version: ""
install.go:242: 2025-04-23 23:57:53.937243167 +0500 +05 m=+0.222729413 [debug] CHART PATH: /home/devops/S25-core-course-labs/k8s/python-web

NAME: python-web
LAST DEPLOYED: Wed Apr 23 23:57:53 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: fridorovich04/python-web
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    initialDelaySeconds: 10
    path: /
    port: http
    timeoutSeconds: 5
nameOverride: ""
nodeSelector: {}
persistence:
  accessModes: ReadWriteOnce
  enabled: true
  size: 2Gi
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    initialDelaySeconds: 10
    path: /
    port: http
    timeoutSeconds: 5
replicaCount: 3
resources: {}
secrets:
  password: "123"
  user: fridorovich04
securityContext: {}
service:
  port: 8000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
tolerations: []
updateStrategy:
  rollingUpdate:
    partition: 0
  type: RollingUpdate
volumeMounts: []
volumes: []

HOOKS:
---
# Source: python-web/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "python-web-test-connection"
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['python-web:8000']
  restartPolicy: Never
---
# Source: python-web/templates/post-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "python-web-post-install-hook"
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
      - name: post-install
        image: busybox
        command: ["/bin/sh", "-c", "echo 'Post-install hook is running'; sleep 20"]
      restartPolicy: Never
---
# Source: python-web/templates/pre-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: "python-web-pre-install-hook"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
      - name: pre-install
        image: busybox
        command: ["/bin/sh", "-c", "echo 'Pre-install hook is running'; sleep 20"]
      restartPolicy: Never
MANIFEST:
---
# Source: python-web/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: python-web/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: python-web-secrets
type: Opaque
data:
  MY_USER: ZnJpZG9yb3ZpY2gwNA==
  MY_PASS: MTIz
---
# Source: python-web/templates/service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: python-web-headless
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  clusterIP: None
  ports:
  - port: 80
    name: http
  selector:
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
---
# Source: python-web/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
---
# Source: python-web/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: python-web
  labels:
    helm.sh/chart: python-web-0.2.0
    app.kubernetes.io/name: python-web
    app.kubernetes.io/instance: python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: python-web-headless
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: python-web
      app.kubernetes.io/instance: python-web
  template:
    metadata:
      labels:
        app.kubernetes.io/name: python-web
        app.kubernetes.io/instance: python-web
    spec:
      serviceAccountName: python-web
      containers:
        - name: python-web
          image: "fridorovich04/python-web:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: MY_USERNAME
              valueFrom:
                secretKeyRef:
                  name: python-web-secrets
                  key: MY_USER
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: python-web-secrets
                  key: MY_PASS
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          livenessProbe:
            httpGet:
              initialDelaySeconds: 10
              path: /
              port: http
              timeoutSeconds: 5
          readinessProbe:
            httpGet:
              initialDelaySeconds: 10
              path: /
              port: http
              timeoutSeconds: 5
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 2Gi
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-web,app.kubernetes.io/instance=python-web" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ helm upgrade python-web ./k8s/python-web
Release "python-web" has been upgraded. Happy Helming!
NAME: python-web
LAST DEPLOYED: Wed Apr 23 23:58:52 2025
NAMESPACE: default
STATUS: deployed
REVISION: 4
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-web,app.kubernetes.io/instance=python-web" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ kubectl get statefulsets
NAME         READY   AGE
python-web   3/3     15h
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ kubectl get pods -w
NAME                                     READY   STATUS    RESTARTS   AGE
python-web-0                             1/1     Running   0          15h
python-web-1                             1/1     Running   0          15h
python-web-2                             1/1     Running   0          15h
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ kubectl get pvc
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-python-web-0   Bound    pvc-8c4b17f4-59e9-4d66-9317-56556531c1fd   2Gi        RWO            standard       <unset>                 15h
```
```txt
fridorovich@DESKTOP-FRR2QTC:/home/devops/S25-core-course-labs$ kubectl get sts
NAME         READY   AGE
python-web   3/3     15h
```