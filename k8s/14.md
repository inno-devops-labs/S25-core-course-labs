
# Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

- Test with command: `helm install --dry-run --debug`

```bash
ebob@laptop moscow-time % helm install --dry-run --debug moscow-time .
install.go:224: 2025-03-23 18:31:40.339205 +0800 +08 m=+0.106937126 [debug] Original chart version: ""
install.go:241: 2025-03-23 18:31:40.339869 +0800 +08 m=+0.107601584 [debug] CHART PATH: /Users/ebob/Code/devops-labs/k8s/moscow-time

NAME: moscow-time
LAST DEPLOYED: Sun Mar 23 18:31:40 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
common-lib:
  global: {}
  labels: {}
image:
  pullPolicy: IfNotPresent
  repository: ebob/moscow-time
  tag: v1.1
ingress:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  className: nginx
  enabled: true
  hosts:
  - host: moscow-time.local
    paths:
    - path: /
      pathType: Prefix
livenessProbe:
  httpGet:
    path: /
    port: http
persistence:
  enabled: true
  size: 1Gi
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 3
resources:
  limits:
    cpu: 500m
    memory: 128Mi
  requests:
    cpu: 250m
    memory: 64Mi
service:
  port: 80
  targetPort: 8080
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: internal-app

HOOKS:
---
# Source: moscow-time/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: moscow-time-post-install
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: post-install-job
    image: busybox
    command: ['sh', '-c', 'echo "Starting post-install hook"; sleep 20; echo "Post-install hook completed"']
---
# Source: moscow-time/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: moscow-time-pre-install
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: pre-install-job
    image: busybox
    command: ['sh', '-c', 'echo "Starting pre-install hook"; sleep 20; echo "Pre-install hook completed"']
---
# Source: moscow-time/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "moscow-time-test-connection"
  labels:
    helm.sh/chart: moscow-time-0.1.0
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['moscow-time:80']
  restartPolicy: Never
MANIFEST:
---
# Source: moscow-time/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: internal-app
  labels:
    helm.sh/chart: moscow-time-0.1.0
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: moscow-time/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: moscow-time
  labels:
    helm.sh/chart: moscow-time-0.1.0
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
---
# Source: moscow-time/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: moscow-time
  labels:
    helm.sh/chart: moscow-time-0.1.0
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: moscow-time-headless
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: moscow-time
      app.kubernetes.io/instance: moscow-time
  template:
    metadata:
      labels:
        app.kubernetes.io/name: moscow-time
        app.kubernetes.io/instance: moscow-time
    spec:
      serviceAccountName: internal-app
      containers:
        - name: moscow-time
          image: "ebob/moscow-time:v1.1"
          ports:
            - name: http
              containerPort: 80
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 1Gi
---
# Source: moscow-time/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: moscow-time
  labels:
    helm.sh/chart: moscow-time-0.1.0
    app.kubernetes.io/name: moscow-time
    app.kubernetes.io/instance: moscow-time
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: "moscow-time.local"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: moscow-time
                port:
                  number: 80
```

- Deploy it

```bash
ebob@laptop moscow-time % helm install moscow-time .
NAME: moscow-time
LAST DEPLOYED: Sun Mar 23 18:33:21 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
```

## Task 2: StatefulSet Exploration and Optimization

- Verify the StatefulSet and pods

```bash
ebob@laptop moscow-time % kubectl get statefulsets,pods,pvc -l app.kubernetes.io/name=moscow-time

NAME                           READY   AGE
statefulset.apps/moscow-time   3/3     54s

NAME                READY   STATUS    RESTARTS   AGE
pod/moscow-time-0   1/1     Running   0          54s
pod/moscow-time-1   1/1     Running   0          30s
pod/moscow-time-2   1/1     Running   0          28s

NAME                                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-moscow-time-0   Bound    pvc-5eed4c6c-6faf-42e8-a5cb-07ca28765cd7   1Gi        RWO            standard       <unset>                 54s
persistentvolumeclaim/data-moscow-time-1   Bound    pvc-45103bff-3905-4d29-b483-e43999e8932f   1Gi        RWO            standard       <unset>                 30s
persistentvolumeclaim/data-moscow-time-2   Bound    pvc-bfedd12a-290f-4df3-8b81-912406c49eb9   1Gi        RWO            standard       <unset>                 28s
```

- The `moscow-time` StatefulSet has **3 replicas**, all in the `Running` state.

- Each pod (`moscow-time-0`, `moscow-time-1`, `moscow-time-2`) has an associated **PersistentVolumeClaim**.

- Each PVC is bound to a unique **PersistentVolume** with **ReadWriteOnce access mode**, meaning each pod gets a separate volume.

---

- Access app in multiple times

```bash
ebob@laptop devops-labs % curl http://127.0.0.1:59541/visits
Visits: 5
ebob@laptop devops-labs % curl http://127.0.0.1:59541/visits
Visits: 11
ebob@laptop devops-labs % curl http://127.0.0.1:59541/visits
Visits: 11
ebob@laptop devops-labs % curl http://127.0.0.1:59541/visits
Visits: 11
ebob@laptop devops-labs % curl http://127.0.0.1:59541/visits
Visits: 8
```

- Check Data Persistence in StatefulSet Pods

```bash
ebob@laptop devops-labs % kubectl exec moscow-time-0 -- cat /tmp/visits
5%
ebob@laptop devops-labs % kubectl exec moscow-time-1 -- cat /tmp/visits
11%
ebob@laptop devops-labs % kubectl exec moscow-time-2 -- cat /tmp/visits
8%
```

### **Differences in Visit Counts**

#### **Observations**

- The `curl` requests return varying visit counts: **5**, **11**, **11**, **11**, **8**.

- Each pod shows different visit values when reading `/tmp/visits`:

  - `moscow-time-0`: **5**

  - `moscow-time-1`: **11**

  - `moscow-time-2`: **8**

#### **Explanation**

- **Load Balancing and Sticky Sessions**

  - `Service` is of type `ClusterIP`, meaning requests are load-balanced across all three pods.

  - Each request may hit a **different pod**, leading to different visit counts being returned.

  - If `Service` doesn't enforce **sticky sessions**, requests are randomly distributed.

- **StatefulSet with Separate Storage per Pod**

  - Each pod has **its own PVC and storage** (`/data/visits` in StatefulSet spec).

  - Since each pod tracks visits independently in its PVC, there is **no shared counter** across all replicas.

  - This is expected behavior for StatefulSets when using separate storage.

- **Different Visit Counts Due to Distribution**

  - Requests get routed to different pods, which have **independent visit counters**.

  - This results in fluctuating values when you repeatedly `curl` the service.

### Persistent Storage Validation & Headless Service Access

- Delete pod 0

```bash
ebob@laptop devops-labs % kubectl delete pod moscow-time-0
pod "moscow-time-0" deleted
ebob@laptop devops-labs % kubectl get pvc
NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-moscow-time-0   Bound    pvc-5eed4c6c-6faf-42e8-a5cb-07ca28765cd7   1Gi        RWO            standard       <unset>                 19m
data-moscow-time-1   Bound    pvc-45103bff-3905-4d29-b483-e43999e8932f   1Gi        RWO            standard       <unset>                 19m
data-moscow-time-2   Bound    pvc-bfedd12a-290f-4df3-8b81-912406c49eb9   1Gi        RWO            standard       <unset>                 19m
ebob@laptop devops-labs % kubectl exec moscow-time-0 -- cat /tmp/visits
cat: can't open '/tmp/visits': No such file or directory
ebob@laptop ~ % kubectl exec -i -t dnsutils -- nslookup moscow-time-0.moscow-time
Server:         10.96.0.10
Address:        10.96.0.10#53

** server can't find moscow-time-0.moscow-time: NXDOMAIN

command terminated with exit code 1
```

### Monitoring & Alerts

#### **How Probes Ensure Pod Health**

- **Liveness Probe**: Checks if the pod is still running and responsive. If it fails, Kubernetes restarts the pod.

- **Readiness Probe**: Ensures the pod is ready to serve traffic. If it fails, the pod is removed from the service endpoints, preventing traffic from being sent to an unhealthy instance.

#### **Why They’re Critical for Stateful Apps**

- **Prevents Serving Stale or Inconsistent Data**: A pod might be running but unable to handle requests due to a database issue or a crashed process.

- **Ensures Graceful Recovery**: When a pod fails, Kubernetes automatically restarts it to restore the desired state.

- **Avoids Routing Traffic to Unhealthy Pods**: Readiness probes prevent clients from reaching an uninitialized or faulty pod.

### Ordering Guarantee and Parallel Operations

#### **Why Ordering Guarantees Are Unnecessary for This App**

- This application does **not** require a specific startup or shutdown sequence.

- Each replica maintains its own visit count and does not depend on a leader or strict ordering.

### Allowing Parallel Pod Management

- By default, StatefulSets launch pods **one at a time** (`OrderedReady` update strategy).

- To allow **parallel scaling and termination**, we use **the** `Parallel` **pod management policy**.

## Bonus Task: Update Strategies

### Exploring Update Strategies

Kubernetes provides two update strategies for StatefulSets:

1. OnDelete

- **Behavior**: Updates are applied only when manually deleting pods.

- **Use Case**: Suitable for apps requiring manual intervention before updating (e.g., databases, stateful services).

```yaml
updateStrategy:
  type: OnDelete
```

2. RollingUpdate

- **Behavior**: Pods are updated one by one (or per partition) automatically.

- **Use Case**: Recommended for stateful apps that can handle incremental updates.

```yaml
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    partition: 1
```

- **Partition**: Specifies the number of pods to keep at the old version before upgrading others.

### Apply and Verify

```bash
ebob@laptop omsk-time % helm install omsk-time .
NAME: omsk-time
LAST DEPLOYED: Sun Mar 23 23:36:15 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
ebob@laptop omsk-time % kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
dnsutils      1/1     Running   0          5h8m
omsk-time-0   1/1     Running   0          31m
omsk-time-1   1/1     Running   0          31m
omsk-time-2   1/1     Running   0          31m
ebob@laptop omsk-time % kubectl get po,sts,svc,pvc
NAME              READY   STATUS    RESTARTS   AGE
pod/dnsutils      1/1     Running   0          5h9m
pod/omsk-time-0   1/1     Running   0          33m
pod/omsk-time-1   1/1     Running   0          33m
pod/omsk-time-2   1/1     Running   0          33m

NAME                         READY   AGE
statefulset.apps/omsk-time   3/3     33m

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   5h44m
service/omsk-time    ClusterIP   10.103.54.43   <none>        80/TCP    33m

NAME                                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-moscow-time-0   Bound    pvc-5eed4c6c-6faf-42e8-a5cb-07ca28765cd7   1Gi        RWO            standard       <unset>                 5h36m
persistentvolumeclaim/data-moscow-time-1   Bound    pvc-45103bff-3905-4d29-b483-e43999e8932f   1Gi        RWO            standard       <unset>                 5h35m
persistentvolumeclaim/data-moscow-time-2   Bound    pvc-bfedd12a-290f-4df3-8b81-912406c49eb9   1Gi        RWO            standard       <unset>                 5h35m
persistentvolumeclaim/data-omsk-time-0     Bound    pvc-43927f8c-a2c7-4a64-a005-5520d7bbd674   1Gi        RWO            standard       <unset>                 3h29m
persistentvolumeclaim/data-omsk-time-1     Bound    pvc-49a2223a-257f-4b0f-aef4-9c8f6c5bead8   1Gi        RWO            standard       <unset>                 3h29m
persistentvolumeclaim/data-omsk-time-2     Bound    pvc-45c81a9e-3c4d-4e94-bda2-bbb0790dfe38   1Gi        RWO            standard       <unset>                 3h29m
```
