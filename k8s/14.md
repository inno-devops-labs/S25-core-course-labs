# Kubernetes StatefulSet

## Task 1

On this step I updated deployment.yaml, renamed in to statefulset.yaml, added persistence and volumeMounts to values.yaml. After that, I runned `helm install --dry-run --debug python-stateful ./python-time-app` and get 2 errors regarding internal-app servicename and app-python-configmap that already were presented in default namespace. After deleting them, everything works perfectly:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm install python-stateful ./python-time-app

NAME: python-stateful
LAST DEPLOYED: Sat Mar 15 17:03:35 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-app,app.kubernetes.io/instance=python-stateful" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~$ kubectl get pods

NAME                                READY   STATUS    RESTARTS   AGE
python-stateful-python-time-app-0   1/1     Running   0          20s
python-stateful-python-time-app-1   1/1     Running   0          20s
python-time-app-7784b5b74d-xftgw    1/1     Running   0          171m
python-time-app-7784b5b74d-z8fgx    1/1     Running   0          3h5m
scala-time-app-7bbcf4579-sc8v8      1/1     Running   0          97m
vault-0                             1/1     Running   0          3h26m
```

---

## Task 2

### Part 1. Research and Documentation

After I installed it using helm:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/app_python$ kubectl get po,sts,svc,pvc

NAME                                    READY   STATUS    RESTARTS        AGE
pod/python-stateful-python-time-app-0   1/1     Running   0               2m35s
pod/python-stateful-python-time-app-1   1/1     Running   0               2m35s
pod/python-time-app-7784b5b74d-xftgw    1/1     Running   1 (4h12m ago)   24h
pod/python-time-app-7784b5b74d-z8fgx    1/1     Running   1 (4h12m ago)   25h
pod/scala-time-app-7bbcf4579-sc8v8      1/1     Running   1 (4h12m ago)   23h
pod/vault-0                             1/1     Running   1 (4h12m ago)   25h

NAME                                               READY   AGE
statefulset.apps/python-stateful-python-time-app   2/2     2m41s
statefulset.apps/vault                             1/1     9d

NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/kubernetes                        ClusterIP   10.96.0.1        <none>        443/TCP   25h
service/python-stateful-python-time-app   ClusterIP   10.109.154.185   <none>        80/TCP    2m41s
service/python-time-app                   ClusterIP   10.98.205.252    <none>        80/TCP    25h
service/scala-time-app                    ClusterIP   10.111.210.146   <none>        80/TCP    23h

NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/python-data-python-stateful-python-time-app-0   Bound    pvc-28ff0ba4-c919-4c4f-b2db-4e7228b156e3   1Gi        RWO            standard       <unset>                 13m
persistentvolumeclaim/python-data-python-stateful-python-time-app-1   Bound    pvc-882f4e49-0a2e-4fef-a0f0-6aa6e80c1c5a   1Gi        RWO            standard       <unset>                 13m
```

I go to the application using different tabs of my browser multiple times and det these results:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec -it python-stateful-python-time-app-0 -- cat data/visits

61

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec -it python-stateful-python-time-app-1 -- cat data/visits

68
```

Visits are different since each pod has its own persistent volume with its own `visits` file, so they are fully independent.

### Part 2. Persistent Storage Validation

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl delete pod/python-stateful-python-time-app-0

pod "python-stateful-python-time-app-0" deleted

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get pvc

NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
python-data-python-stateful-python-time-app-0   Bound    pvc-28ff0ba4-c919-4c4f-b2db-4e7228b156e3   1Gi        RWO            standard       <unset>                 22m
python-data-python-stateful-python-time-app-1   Bound    pvc-882f4e49-0a2e-4fef-a0f0-6aa6e80c1c5a   1Gi        RWO            standard       <unset>                 22m

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec -it python-stateful-python-time-app-0 -- cat data/visits

61
```

### Part 3. Headless Service Access

*To do it I firstly install `dnsutils` in Dockerfile of my application, since in my initial python image there was no `nslookup` command.*

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec python-stateful-python-time-app-0 -- nslookup python-stateful-python-time-app-1.python-stateful-python-time-app

Server:   10.96.0.10
Address:  10.96.0.10#53

Name: python-stateful-python-time-app-1.python-stateful-python-time-app.default.svc.cluster.local
Address: 10.244.0.231

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl exec python-stateful-python-time-app-1 -- nslookup python-stateful-python-time-app-0.python-stateful-python-time-app

Server:   10.96.0.10
Address:  10.96.0.10#53

Name: python-stateful-python-time-app-0.python-stateful-python-time-app.default.svc.cluster.local
Address: 10.244.0.230
```

### Part 4. Monitoring & Alerts

**How probes ensure pod health:**

I added (actually, uncommented) `livenessProbe` and `readinessProbe` from the `values.yaml`. They trying to access `/` endpoint of the applicaton on each pod testing liveness and readiness of application respectively.

If `livenessProbe` fails - Kubernetes restarts the pod, if `readinessProbe` fails - pod will be removed from the service (and come back when `readinessProbe` will success).

**Why they’re critical for stateful apps:**

1. `livenessProbe` and `readinessProbe` ensure that pods are only allowed to serve traffic when they are able to handle state management;

2. `readinessProbe` guarantees that critical operations are performed only when pods are ready for it.

### Part 5. Ordering Guarantee and Parallel Operations

**Why ordering guarantees are unnecessary for my app:**

1. There are no data dependencies (since pods are stateful and have its own `visits` files);

2. There are no configuration like master-slave or any depends-on requrements between stateful pods.

---

## Bonus Task

### Part 1. Apply StatefulSet to Bonus App

I completed all the steps to configure statefulset for my Scala application and installed it using helm:

```bash
gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ helm upgrade --install scala-stateful ./scala-time-app -n default

Release "scala-stateful" has been upgraded. Happy Helming!
NAME: scala-stateful
LAST DEPLOYED: Sun Mar 16 15:55:01 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=scala-time-app,app.kubernetes.io/instance=scala-stateful" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

gleb@gleb-VMware-Virtual-Platform:~/Desktop/DevOps/Labs/S25-core-course-labs/k8s$ kubectl get po,sts,svc,pvc

NAME                                    READY   STATUS    RESTARTS       AGE
pod/python-stateful-python-time-app-0   1/1     Running   0              30m
pod/python-stateful-python-time-app-1   1/1     Running   0              30m
pod/python-time-app-7784b5b74d-xftgw    1/1     Running   1 (5h8m ago)   25h
pod/python-time-app-7784b5b74d-z8fgx    1/1     Running   1 (5h8m ago)   25h
pod/scala-stateful-scala-time-app-0     0/1     Running   0              65s
pod/scala-time-app-7bbcf4579-sc8v8      1/1     Running   1 (5h8m ago)   24h
pod/vault-0                             1/1     Running   1 (5h8m ago)   26h

NAME                                               READY   AGE
statefulset.apps/python-stateful-python-time-app   2/2     30m
statefulset.apps/scala-stateful-scala-time-app     0/1     65s
statefulset.apps/vault                             1/1     9d

NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/kubernetes                        ClusterIP   10.96.0.1        <none>        443/TCP   26h
service/python-stateful-python-time-app   ClusterIP   10.103.82.85     <none>        80/TCP    30m
service/python-time-app                   ClusterIP   10.98.205.252    <none>        80/TCP    25h
service/scala-stateful-scala-time-app     ClusterIP   10.109.121.195   <none>        80/TCP    65s
service/scala-time-app                    ClusterIP   10.111.210.146   <none>        80/TCP    24h

NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/python-data-python-stateful-python-time-app-0   Bound    pvc-28ff0ba4-c919-4c4f-b2db-4e7228b156e3   1Gi        RWO            standard       <unset>                 70m
persistentvolumeclaim/python-data-python-stateful-python-time-app-1   Bound    pvc-882f4e49-0a2e-4fef-a0f0-6aa6e80c1c5a   1Gi        RWO            standard       <unset>                 70m
persistentvolumeclaim/scala-data-scala-stateful-scala-time-app-0      Bound    pvc-34ae972c-cc62-42ac-8dd8-364e2af980ae   1Gi        RWO            standard       <unset>                 65s
```

### Part 2. Explore Update Strategies

I implemented Rolling Updates in both my applications.

**Update Strategies Comparison**  

|                   | **OnDelete**                                                                 | **RollingUpdate**                                                                 |
|-------------------|------------------------------------------------------------------------------|-----------------------------------------------------------------------------------|
| **Description**   | Appying updates when pods are manually deleted.                              | Appying updates automatically, one pod at a time (with number ≥ partition).       |
| **Use Case 1**    | Update manually any time                                                     | Maintain availability during updating                                             |
| **Use Case 2**    | Verify manually updates                                                      | Automation of updating process                                                    |
| **Use Case 3**    | Update important or critical applications manually to ensure correct updating| Canary testing with different partition number                                    |

---

**Comparison with Deployment Update Strategies**  

|                      | **Deployment**                                      | **StatefulSet**                                                   |
|----------------------|-----------------------------------------------------|-------------------------------------------------------------------|
| **Updates order**    | All pods simultaneously                             | One pod at a time in reverse order                                |
| **Rollbacks**        | Creates new pods, delete old ones                   | Maintains pod identity and persistent volunme claims associations |
| **Pods identity**    | Creates new pods with new identifiers               | Maintains pods network identifiers                                |

---
