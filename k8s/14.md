# Lab 14: Kubernetes StatefulSet

This document details the steps and observations when migrating the **FastAPI** application to a **StatefulSet**. It includes the command outputs, validation checks, and an overview of the persistent storage verification, DNS resolution, and ordering guarantees.

---

## 1. Dry Run and Deployment

### 1.1 Helm Dry Run

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % helm install --dry-run --debug fastapi-release fastapi-app 
install.go:225: 2025-04-10 20:19:50.54356 +0300 +03 m=+0.018874043 [debug] Original chart version: ""
install.go:242: 2025-04-10 20:19:50.543595 +0300 +03 m=+0.018909460 [debug] CHART PATH: /Users/louayfarah/Documents/S25-core-course-labs/k8s/fastapi-app

NAME: fastapi-release
LAST DEPLOYED: Thu Apr 10 20:19:50 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 2
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: louayfarah/timezone_app_python
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 2
resources: {}
secrets:
  myPass: SuperSecret123
securityContext: {}
service:
  port: 8000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
storage:
  size: 1Gi
storageClass: standard
tolerations: []
volumeMounts: []
volumes: []

HOOKS:
---
# Source: fastapi-app/templates/hooks.yaml
apiVersion: v1
kind: Pod
metadata:
  name: preinstall-hook
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
    - name: preinstall-hook
      image: busybox
      command: ["sh", "-c"]
      args: ["echo 'Running pre-install'; sleep 20"]
  restartPolicy: Never

apiVersion: v1
kind: Pod
metadata:
  name: postinstall-hook
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
    - name: postinstall-hook
      image: busybox
      command: ["sh", "-c"]
      args: ["echo 'Running post-install'; sleep 20"]
  restartPolicy: Never
---
# Source: fastapi-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "fastapi-release-fastapi-app-test-connection"
  labels:
    helm.sh/chart: fastapi-app-0.1.0
    app.kubernetes.io/name: fastapi-app
    app.kubernetes.io/instance: fastapi-release
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['fastapi-release-fastapi-app:8000']
  restartPolicy: Never
MANIFEST:
---
# Source: fastapi-app/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fastapi-release-fastapi-app
  labels:
    app.kubernetes.io/name: fastapi-app
    helm.sh/chart: fastapi-app-0.1.0
    app.kubernetes.io/instance: fastapi-release
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: fastapi-app/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  labels:
    app: myapp
type: Opaque
data:
  MY_PASS: "U3VwZXJTZWNyZXQxMjM="
---
# Source: fastapi-app/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fastapi-app-config
  labels:
    app: myapp
data:
  config.json: |-
    
    {
        "sampleUrl": "https://www.google.com",
        "featureFlag": true
    }
---
# Source: fastapi-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: fastapi-release-fastapi-app
  labels:
    helm.sh/chart: fastapi-app-0.1.0
    app.kubernetes.io/name: fastapi-app
    app.kubernetes.io/instance: fastapi-release
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: fastapi-app
    app.kubernetes.io/instance: fastapi-release
---
# Source: fastapi-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: fastapi-release-fastapi-app
  labels:
    helm.sh/chart: fastapi-app-0.1.0
    app.kubernetes.io/name: fastapi-app
    app.kubernetes.io/instance: fastapi-release
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: fastapi-release-fastapi-app-headless
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: fastapi-app
      app.kubernetes.io/instance: fastapi-release
  # Optional: podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        helm.sh/chart: fastapi-app-0.1.0
        app.kubernetes.io/name: fastapi-app
        app.kubernetes.io/instance: fastapi-release
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: fastapi-release-fastapi-app
      containers:
      - name: fastapi-app
        image: "louayfarah/timezone_app_python:latest"
        imagePullPolicy: IfNotPresent
        env:
          - name: MY_PASS
            valueFrom:
              secretKeyRef:
                name: my-secret
                key: MY_PASS
        ports:
          - name: http
            containerPort: 8000
            protocol: TCP
        resources:
          requests:
            memory: "128Mi"
            cpu: "250m"
          limits:
            memory: "256Mi"
            cpu: "500m"
        volumeMounts:
          - name: config-volume
            mountPath: /config.json
            subPath: config.json
  volumeClaimTemplates:
    - metadata:
        name: config-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=fastapi-app,app.kubernetes.io/instance=fastapi-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### 1.2 Actual Install/Upgrade

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % 
Release "fastapi-release" has been upgraded. Happy Helming!
NAME: fastapi-release
LAST DEPLOYED: Thu Apr 10 20:21:40 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=fastapi-app,app.kubernetes.io/instance=fastapi-release" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

---

## 2. Check Resources

```bash
(venv) louayfarah@Louays-MacBook-Pro k8s % kubectl get po,sts,svc,pvc
NAME                                             READY   STATUS    RESTARTS        AGE
pod/fastapi-app-544dc7dc64-mfcmb                 1/1     Running   1 (3h16m ago)   33h
pod/fastapi-release-fastapi-app-0                1/1     Running   0               67s
pod/fastapi-release-fastapi-app-1                1/1     Running   0               34s
pod/nodejs-release-nodejs-app-6f98f884d7-q7jw4   1/1     Running   1 (3h16m ago)   33h

NAME                                           READY   AGE
statefulset.apps/fastapi-release-fastapi-app   2/2     67s

NAME                                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/fastapi-app                   ClusterIP   10.106.166.8    <none>        8000/TCP   33h
service/fastapi-release-fastapi-app   ClusterIP   10.99.236.238   <none>        8000/TCP   3d23h
service/kubernetes                    ClusterIP   10.96.0.1       <none>        443/TCP    3d23h
service/nodejs-release-nodejs-app     ClusterIP   10.106.43.181   <none>        80/TCP     34h

NAME                                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/config-volume-fastapi-release-fastapi-app-0   Bound    pvc-84809331-4d6a-4eee-82e4-2f5de1095469   1Gi        RWO            standard       <unset>                 122m
persistentvolumeclaim/config-volume-fastapi-release-fastapi-app-1   Bound    pvc-456d14e2-a806-4093-b941-6285be872988   1Gi        RWO            standard       <unset>                 122m
persistentvolumeclaim/nodejs-release-nodejs-app-pvc                 Bound    pvc-8d383e4f-5517-4505-aa83-404f09b58b6a   1Gi        RWO            standard       <unset>                 34h
```

---

## 3. Accessing the App

You can run:

```bash
minikube service fastapi-release-fastapi-app
```

to open the Service in your browser (or do a port-forward if needed).

---

## 4. Examining Pod Data and Persistence

### 4.1 Checking Data per Pod

Examples:

```
kubectl exec fastapi-release-fastapi-app-0 -- cat /data/visits.txt  # e.g., "0%"
kubectl exec fastapi-release-fastapi-app-1 -- cat /data/visits.txt  # e.g., "15%"
```

Because each replica in a StatefulSet has its own PVC, the data may differ.

### 4.2 Persistent Storage Validation

```bash
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl delete pod fastapi-release-fastapi-app-0                  
pod "fastapi-release-fastapi-app-0" deleted
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl get pods -w                                               

NAME                                         READY   STATUS    RESTARTS        AGE
fastapi-app-544dc7dc64-mfcmb                 1/1     Running   1 (3h28m ago)   33h
fastapi-release-fastapi-app-0                1/1     Running   0               4s
fastapi-release-fastapi-app-1                1/1     Running   0               12m
nodejs-release-nodejs-app-6f98f884d7-q7jw4   1/1     Running   1 (3h28m ago)   34h
^C
(venv) louayfarah@Louays-MacBook-Pro S25-core-course-labs % kubectl exec fastapi-release-fastapi-app-0 -- cat data/visits.txt
15%
```

Once the Pod restarts, the data is still there (the PVC remains).

---

## 5. Headless Service / DNS Resolution

You can verify DNS lookups with:

```bash
kubectl exec fastapi-release-fastapi-app-1 -- nslookup fastapi-release-fastapi-app-1.fastapi-release-fastapi-app-headless
```

It should resolve to a stable FQDN reflecting the Pod’s ordinal index.

---

## 6. Liveness / Readiness Probes

You can add these lines in the container spec to ensure K8s only sends traffic to healthy pods:

```yaml
livenessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
```

---

## 7. Ordering Guarantee vs. Parallel PodManagement

By default, **StatefulSets** bring up and tear down pods in **strict ordinal order**. If your application does **not** need that guarantee, you can speed up Pod creation or deletion with:

```yaml
podManagementPolicy: Parallel
```

> **Note**: This field is immutable once the StatefulSet is created. If you want to switch from `OrderedReady` to `Parallel`, you must recreate or rename the StatefulSet.

---

## Bonus: Update Strategies

### OnDelete vs. RollingUpdate

- **OnDelete**:  
  No automatic rolling updates. You must delete each pod for the changes to apply. Useful for databases or apps that need manual checks or migrations.
- **RollingUpdate** (Default):  
  K8s automatically replaces pods in a controlled sequence. You can add a `partition` to do a partial (canary) rollout.

### Compare with Deployment

Deployments also do rolling updates, but they don’t guarantee stable network IDs or per-pod volumes. StatefulSets are designed for stateful apps, providing ordinal Pod identities and persistent volume uniqueness.
