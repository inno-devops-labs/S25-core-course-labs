# lab 14

## task 1

rename `templates/deployment.yaml` to `templates/statefulset.yaml`

update values.yaml

```bash
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ helm install --dry-run --debug helm-python-app ./helm-python-app
install.go:225: 2025-03-11 11:31:28.841317277 +0300 MSK m=+0.030245106 [debug] Original chart version: ""
install.go:242: 2025-03-11 11:31:28.841357716 +0300 MSK m=+0.030285545 [debug] CHART PATH: /home/sofia/innop/spr2025/dev-ops/S25-core-course-labs/k8s/helm-python-app

NAME: helm-python-app
LAST DEPLOYED: Tue Mar 11 11:31:28 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: adeepresession/app_python
  tag: v1.1
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
library-chart:
  global: {}
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 3
resources: {}
secret:
  token: token_value
securityContext: {}
service:
  port: 8080
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
tolerations: []
vaultAgent:
  image: hashicorp/vault:1.14.0
volumeMounts:
- mountPath: /data/config.json
  name: config-volume
  readOnly: true
  subPath: config.json
volumes:
- configMap:
    name: app-conifg
  name: config-volume

HOOKS:
---
# Source: helm-python-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "helm-python-app-test-connection"
  labels:
    helm.sh/chart: helm-python-app-0.1.0
    app.kubernetes.io/name: helm-python-app
    app.kubernetes.io/instance: helm-python-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['helm-python-app:8080']
  restartPolicy: Never
---
# Source: helm-python-app/templates/post-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: post-install-hook
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: post-install-job
          image: busybox
          command: ["sh", "-c", "echo post-install-hook running; sleep 20"]
---
# Source: helm-python-app/templates/pre-install-hook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pre-install-hook
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: pre-install-job
          image: busybox
          command: ["sh", "-c", "echo pre-install-hook running; sleep 20"]
MANIFEST:
---
# Source: helm-python-app/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: helm-python-app
  labels:
    helm.sh/chart: helm-python-app-0.1.0
    app.kubernetes.io/name: helm-python-app
    app.kubernetes.io/instance: helm-python-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: helm-python-app/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: token
type: Opaque
data:
  token: "dG9rZW5fdmFsdWU="
---
# Source: helm-python-app/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: default
data:
  config.json: |

    {
        "greeting": "have a nice day! :)"
    }
---
# Source: helm-python-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: helm-python-app
  labels:
    helm.sh/chart: helm-python-app-0.1.0
    app.kubernetes.io/name: helm-python-app
    app.kubernetes.io/instance: helm-python-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: helm-python-app
    app.kubernetes.io/instance: helm-python-app
---
# Source: helm-python-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: helm-python-app
  labels:
    helm.sh/chart: helm-python-app-0.1.0
    app.kubernetes.io/name: helm-python-app
    app.kubernetes.io/instance: helm-python-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: helm-python-app
      app.kubernetes.io/instance: helm-python-app
  template:
    metadata:
      labels:
        helm.sh/chart: helm-python-app-0.1.0
        app.kubernetes.io/name: helm-python-app
        app.kubernetes.io/instance: helm-python-app
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: helm-python-app
      containers:
        - name: helm-python-app
          image: "adeepresession/app_python:v1.1"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          volumeMounts:
            - name: app-config-volume
              mountPath: /app_python/config
          env:
            - name: TOKEN
              valueFrom:
                secretKeyRef:
                  name: token
                  key: token

      volumes:
        - name: app-config-volume
          configMap:
            name: app-config

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=helm-python-app,app.kubernetes.io/instance=helm-python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

## task 2

Include the output of kubectl get po,sts,svc,pvc commands.

```
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl get po,sts,svc,pvc
NAME                                       READY   STATUS    RESTARTS        AGE
pod/helm-python-app-0                      1/1     Running   0               6m7s
pod/helm-python-app-1                      1/1     Running   0               29m
pod/helm-python-app-2                      1/1     Running   0               29m
pod/vault-0                                1/1     Running   2 (4d22h ago)   5d22h
pod/vault-agent-injector-bbd76949d-zvnk8   1/1     Running   2 (4d22h ago)   5d22h

NAME                               READY   AGE
statefulset.apps/helm-python-app   3/3     29m
statefulset.apps/vault             1/1     5d22h

NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python-helm-python-app   ClusterIP   10.109.99.23     <none>        8080/TCP            4d23h
service/helm-python-app              ClusterIP   10.107.62.92     <none>        8080/TCP            29m
service/kubernetes                   ClusterIP   10.96.0.1        <none>        443/TCP             13d
service/vault                        ClusterIP   10.105.237.147   <none>        8200/TCP,8201/TCP   5d22h
service/vault-agent-injector-svc     ClusterIP   10.104.155.192   <none>        443/TCP             5d22h
service/vault-internal               ClusterIP   None             <none>        8200/TCP,8201/TCP   5d22h

NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-vault-0   Bound    pvc-46dfe2f8-1457-4e64-a618-e9fee483a69f   10Gi       RWO            standard       <unset>                 6d1h
```

Check the content of your file in each pod, e.g., kubectl exec pod/demo-0 -- cat visits

```
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl exec helm-python-app-0 -- cat visits
13%
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl exec helm-python-app-1 -- cat visits
26%
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl exec helm-python-app-2 -- cat visits
20%
```

Persistent Storage Validation

```
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl exec helm-python-app-2 -- cat visits
20%
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl delete pod helm-python-app-2
pod "helm-python-app-2" deleted
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl get po
NAME                                   READY   STATUS    RESTARTS        AGE
helm-python-app-0                      1/1     Running   0               7m53s
helm-python-app-1                      1/1     Running   0               31m
helm-python-app-2                      1/1     Running   0               13s
vault-0                                1/1     Running   2 (4d22h ago)   5d22h
vault-agent-injector-bbd76949d-zvnk8   1/1     Running   2 (4d22h ago)   5d22h
[~/innop/spr2025/dev-ops/S25-core-course-labs/k8s]$ kubectl exec helm-python-app-2 -- cat visits
20%
```

### How probes ensure pod health.

To maintain pod health, probes continuously monitor its status.
The liveness probe restarts the pod if it becomes unresponsive,
while the readiness probe ensures that only ready pods receive traffic.

### Why theyâ€™re critical for stateful apps.

Without probes, a StatefulSet could serve traffic from an unhealthy pod or fail to recover properly from failures.

### Explain why ordering guarantees are unnecessary for your app.

because it does not have interdependent pods, can scale independently, does not rely on sequential initialization

### Implement a way to instruct the StatefulSet controller to launch or terminate all Pods in parallel.

using `podManagementPolicy: Parallel`
