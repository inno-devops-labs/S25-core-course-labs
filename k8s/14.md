# StatefulSet

## Task 2

Fixed, refactored and redeployed:

```bash
➜  k8s git:(lab14) kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS      RESTARTS      AGE
pod/timeapp-0                               2/2     Running     0             23s
pod/timeapp-1                               2/2     Running     0             19s
pod/timeapp-2                               2/2     Running     0             14s
pod/timeapp-post-install                    0/1     Completed   0             23s
pod/timeapp-pre-install                     0/1     Completed   0             28s
pod/vault-0                                 1/1     Running     1 (16h ago)   21h
pod/vault-agent-injector-75f9dfc9c8-n6sp9   1/1     Running     1 (16h ago)   21h

NAME                       READY   AGE
statefulset.apps/timeapp   3/3     23s
statefulset.apps/vault     1/1     21h

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             72d
service/timeapp                    ClusterIP   10.109.228.63    <none>        8080/TCP            23s
service/timeapp-headless           ClusterIP   None             <none>        8080/TCP            23s
service/vault                      ClusterIP   10.109.54.202    <none>        8200/TCP,8201/TCP   21h
service/vault-agent-injector-svc   ClusterIP   10.104.142.236   <none>        443/TCP             21h
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   21h

NAME                                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-volume-timeapp-0   Bound    pvc-f4706424-72c3-4a9a-aa8f-851d51c3d4d6   1Gi        RWO            standard       <unset>                 23s
persistentvolumeclaim/data-volume-timeapp-1   Bound    pvc-c5813a58-fc74-4174-ae8f-09a0f974006c   1Gi        RWO            standard       <unset>                 19s
persistentvolumeclaim/data-volume-timeapp-2   Bound    pvc-bbd851cd-23b8-4082-8442-df9df3407758   1Gi        RWO            standard       <unset>                 14s
persistentvolumeclaim/timeapp-data-pvc        Bound    pvc-7970d7ff-cfcf-4df6-8885-b2137d92e122   1Gi        RWO            standard       <unset>                 23s
```

Checking visits:

```bash
➜  k8s git:(lab14) ✗ kubectl exec pod/timeapp-2 -c timeapp -- cat /data/visits.txt
4%
➜  k8s git:(lab14) ✗ kubectl exec pod/timeapp-1 -c timeapp -- cat /data/visits.txt
1%
➜  k8s git:(lab14) ✗ kubectl exec pod/timeapp-0 -c timeapp -- cat /data/visits.txt
3%
```

Each statefulset replica has it's own separate mounts, unlike deployments

Verifying persistent storage:

```bash
➜  k8s git:(lab14) ✗ kubectl delete pod timeapp-0
pod "timeapp-0" deleted
➜  k8s git:(lab14) ✗ kubectl get pvc
NAME                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-volume-timeapp-0   Bound    pvc-f4706424-72c3-4a9a-aa8f-851d51c3d4d6   1Gi        RWO            standard       <unset>                 6m46s
data-volume-timeapp-1   Bound    pvc-c5813a58-fc74-4174-ae8f-09a0f974006c   1Gi        RWO            standard       <unset>                 6m42s
data-volume-timeapp-2   Bound    pvc-bbd851cd-23b8-4082-8442-df9df3407758   1Gi        RWO            standard       <unset>                 6m37s
timeapp-data-pvc        Bound    pvc-7970d7ff-cfcf-4df6-8885-b2137d92e122   1Gi        RWO            standard       <unset>                 6m46s
➜  k8s git:(lab14) ✗ kubectl exec pod/timeapp-0 -c timeapp -- cat /data/visits.txt
3%
```

DNS resolution:

```bash
➜  k8s git:(lab14) ✗ kubectl exec timeapp-0 -- nslookup timeapp-headless
Defaulted container "timeapp" out of: timeapp, vault-agent, vault-agent-init (init)
Server:		10.96.0.10
Address:	10.96.0.10:53

Name:	timeapp-headless.default.svc.cluster.local
Address: 10.244.0.189
Name:	timeapp-headless.default.svc.cluster.local
Address: 10.244.0.188
Name:	timeapp-headless.default.svc.cluster.local
Address: 10.244.0.190
```

Liveness probes continuosly check if container is running properl and restart container if check fails. It helps to catch deadlocks and unrecoverable errors, ensuring high SLA.
Readiness probes determine if container can accept traffic and remove pod from service if it is failing. This helps to prevent traffic during strartup and maintencance.

Why we need it for stateful apps?

- Prevents writes to pods not fully initialized
- Ensures database connections are ready before accepting requests
- Controls rollout sequence during scaling operations
- Maintains stable network identity during updates
- Gives stateful services time to recover persistent data
- Prevents split-brain scenarios in clustered applications
- Allows proper draining before pod termination
- Ensures completion of in-progress transactions

The ordering is not so needed, because there is no need for ordered initiazliation or termination. Each pod services identical content and there are no inter-pod communication. New replicas do not depend on existing instances and there are no master-slave relationships.
