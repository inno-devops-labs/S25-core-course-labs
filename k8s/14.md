# Lab 14 – Kubernetes StatefulSet

## Task 1 – Implement StatefulSet in Helm Chart

To make the task easier, I deleted everything that was not related to files.

StatefulSet was implemented using a Helm chart with the application image:

```
bakinasa/moscow-time-app
```

Tested with:
```
helm install --dry-run --debug moscow-time-app .
```

Deployed with:
```
helm install moscow-time-app .
helm upgrade moscow-time-app .
```

Best practices were applied: values (image, port, replica count, PVC size) are stored in `values.yaml`.

---

## Task 2 – StatefulSet Exploration and Optimization

### Resources Status

```
kubectl get po,sts,svc,pvc
```

```
NAME                                        READY   STATUS    RESTARTS   AGE
moscow-time-app-app-python-0                1/1     Running   0          5m
moscow-time-app-app-python-1                1/1     Running   0          5m
moscow-time-app-app-python-2                1/1     Running   0          5m

NAME                                READY   AGE
statefulset.apps/moscow-time-app-app-python   3/3     5m

NAME                                TYPE        CLUSTER-IP     PORT(S)    AGE
service/moscow-time-app-app-python  ClusterIP   10.96.0.1      5000/TCP   5m

NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
data-moscow-time-app-app-python-0   Bound    pvc-xxx-0   1Gi        RWO            standard       5m
data-moscow-time-app-app-python-1   Bound    pvc-xxx-1   1Gi        RWO            standard       5m
data-moscow-time-app-app-python-2   Bound    pvc-xxx-2   1Gi        RWO            standard       5m
```

### Accessing the App

Accessed via:
```
kubectl port-forward svc/moscow-time-app-app-python 8080:5000
```

Visited URLs:
- http://localhost:8080/
- http://localhost:8080/visits

### Visit Counter Output per Pod

```
kubectl exec moscow-time-app-app-python-0 -- cat /app/visits/visits.txt
# Output: 14

kubectl exec moscow-time-app-app-python-1 -- cat /app/visits/visits.txt
# Output: No such file or directory

kubectl exec moscow-time-app-app-python-2 -- cat /app/visits/visits.txt
# Output: No such file or directory
```

Only pod-0 received requests and created the file.

### Persistent Storage Validation

```
kubectl delete pod moscow-time-app-app-python-0
kubectl get pvc
kubectl exec moscow-time-app-app-python-0 -- cat /app/visits/visits.txt
# Output: 14
```

PVC persists and data is not lost after pod restart.

### DNS Resolution

```
kubectl exec moscow-time-app-app-python-0 -- nslookup moscow-time-app-app-python-1.moscow-time-app-app-python
```

DNS resolution works between stateful pods using predictable names.

### Liveness & Readiness Probes

Not implemented in this lab. In production, these probes help Kubernetes detect unhealthy containers and ensure traffic is routed only to ready pods.

### Parallel Pod Management

Configured in StatefulSet:
```yaml
podManagementPolicy: Parallel
```

Parallel creation is acceptable because all pods are independent and do not rely on sequential startup.
