# Lab 14

## Task 1

```bash
$ helm install --dry-run --debug app-python app-python/
install.go:225: 2025-03-16 23:25:18.119497835 +0500 +05 m=+0.244711449 [debug] Original chart version: ""
install.go:242: 2025-03-16 23:25:18.119563154 +0500 +05 m=+0.244776742 [debug] CHART PATH: /home/kira/devops/S25-core-course-labs/k8s/app-python

NAME: app-python
LAST DEPLOYED: Sun Mar 16 23:25:18 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
environment:
  appname: app_python
  myname: Kira
fullnameOverride: ""
image:
  repository: kira354/python-app
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
library-chart:
  global: {}
mySecret: mypassword
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
replicaCount: 2
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi
securityContext: {}
service:
  port: 5000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
tolerations: []
volumeClaimTemplates:
- metadata:
    name: app-python-volume
  spec:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
volumeMounts:
- mountPath: /app/data/config.json
  name: app-python-config-volume
  subPath: config.json
- mountPath: /app/data
  name: app-python-volume
volumes:
- configMap:
    name: app-python-config
  name: app-python-config-volume

HOOKS:
---
# Source: app-python/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: postinstall-hook
  annotations:
    helm.sh/hook: post-install
    "helm.sh/hook-delete-policy": "hook-succeeded"
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 20']
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: app-python/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
        helm.sh/hook: pre-install
        "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: app-python/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "app-python-test-connection"
  labels:
    helm.sh/chart: app-python-0.1.0
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['app-python:5000']
  restartPolicy: Never
MANIFEST:
---
# Source: app-python/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-python
  labels:
    helm.sh/chart: app-python-0.1.0
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: app-python/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: credentials
  labels:
    app: app-python
    chart: 'app-python-0.1.0'
    release: 'app-python'
    heritage: 'Helm'
type: Opaque
data:
  password: "ZGVmYXVsdF9wYXNz"
---
# Source: app-python/templates/configmap.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-python-config
  labels:
    helm.sh/chart: app-python-0.1.0
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
data:
  config.json: |-
    {
        "name": "kira"
    }
---
# Source: app-python/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: app-python
  labels:
    helm.sh/chart: app-python-0.1.0
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  clusterIP: None
  type: ClusterIP
  ports:
    - port: 5000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
---
# Source: app-python/templates/statefulset.yml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: app-python
  labels:
    helm.sh/chart: app-python-0.1.0
    app.kubernetes.io/name: app-python
    app.kubernetes.io/instance: app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: app-python
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: app-python
      app.kubernetes.io/instance: app-python
  template:
    metadata:
      labels:
        helm.sh/chart: app-python-0.1.0
        app.kubernetes.io/name: app-python
        app.kubernetes.io/instance: app-python
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: app-python
      containers:
        - name: app-python
          image: "kira354/python-app:latest"
          imagePullPolicy: 
          env:
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: credentials
                  key: password
            - name: APP_NAME
              value: "app_python"
            - name: MY_NAME
              value: "Kira"

          envFrom:
           - configMapRef:
               name: app-python-config

          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - mountPath: /app/data/config.json
              name: app-python-config-volume
              subPath: config.json
            - mountPath: /app/data
              name: app-python-volume
      volumes:
        - configMap:
            name: app-python-config
          name: app-python-config-volume
  volumeClaimTemplates:
    - metadata:
        name: app-python-volume
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
  ```

## Task 2

### Research and Documentation:


#### Output of kubectl get po,sts,svc,pvc commands

```sh
kubectl get po,sts,svc,pvc
NAME                                         READY   STATUS    RESTARTS      AGE
pod/app-python-0                             1/1     Running   0             6m12s
pod/app-python-1                             1/1     Running   0             6m11s
pod/vault-0                                  1/1     Running   4 (48m ago)   7d11h
pod/vault-agent-injector-66f45b5fd5-bf2q8    1/1     Running   4 (48m ago)   7d11h

NAME                          READY   AGE
statefulset.apps/app-python   2/2     6m12s
statefulset.apps/vault        1/1     7d11h

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python                 ClusterIP   None             <none>        5000/TCP            6m13s
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             8d
service/vault                      ClusterIP   10.102.147.74    <none>        8200/TCP,8201/TCP   7d11h
service/vault-agent-injector-svc   ClusterIP   10.99.86.230     <none>        443/TCP             7d11h
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   7d11h

NAME                                                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/app-python-volume-app-python-0   Bound    pvc-66c774db-11f8-463c-9ce7-408c43839e60   1Gi        RWO            standard       <unset>                 11m
persistentvolumeclaim/app-python-volume-app-python-1   Bound    pvc-35d8babc-540a-4b21-9fff-93ff68a5d42c   1Gi        RWO            standard       <unset>                 10m
```

#### minikube service name_of_your_statefulset command to access app

```sh
$ kubectl exec app-python-0 -- cat /app/data/visits.txt
318
$ kubectl exec app-python-1 -- cat /app/data/visits.txt
328
```

#### Differences

The load balancer tries to balance these requests, but both apps have independent visits.txt and no sync. Thats why the values are a bit different.


### Persistent Storage Validation

```sh
kubectl delete pod app-python-0
pod "app-python-0" deleted
kira@kira-VirtualBox:~/devops/S25-core-course-labs/k8s$ kubectl get pvc
NAME                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
app-python-volume-app-python-0   Bound    pvc-66c774db-11f8-463c-9ce7-408c43839e60   1Gi        RWO            standard       <unset>                 44m
app-python-volume-app-python-1   Bound    pvc-35d8babc-540a-4b21-9fff-93ff68a5d42c   1Gi        RWO            standard       <unset>                 43m
kira@kira-VirtualBox:~/devops/S25-core-course-labs/k8s$ kubectl exec app-python-0 -- cat /app/data/visits.txt
318
```

### Headless Service Access

```sh
kubectl exec app-python-0 -- nslookup app-python-1.app-python.default.svc.cluster.local
;; Got recursion not available from 10.96.0.10
Server:         10.96.0.10
Address:        10.96.0.10#53

Name:   app-python-1.app-python.default.svc.cluster.local
Address: 10.244.0.174
```

### Monitoring & Alerts

Kubernetes liveness and readiness probes help maintain application stability:

- Liveness Probe: Detects if the pod is stuck or unresponsive. If it fails, Kubernetes restarts the pod to restore functionality.
- Readiness Probe: Ensures the pod is fully initialized before receiving traffic. If it fails, Kubernetes temporarily removes the pod from the service until it becomes ready again.

These probes prevent traffic from reaching unhealthy pods and enable self-healing by automatically restarting or isolating malfunctioning instances.

### Ordering Guarantee and Parallel Operations

Order guarantees do not matter for me because each pod is independent of each other, and every one of them has its own persistent volume