# Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s> helm install
 --dry-run --debug helm-hooks ./myapp   
install.go:225: 2025-03-16 23:26:00.1768882 +0300 MSK m=+0.201437301 [debug] Original chart version: ""
install.go:242: 2025-03-16 23:26:00.1779791 +0300 MSK m=+0.202528201 [debug] CHART PATH: C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s\myapp        

NAME: helm-hooks
LAST DEPLOYED: Sun Mar 16 23:26:00 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: nikolaevaelizaveta/my-flask-app
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 1
resources: {}
securityContext: {}
service:
  port: 80
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
storageClass: standard
storageSize: 1Gi
tolerations: []
vault:
  agentInjectSecret: mysecret.txt
  enabled: true
  role: userliza
  secretPath: secret/data/myapp
volumeMounts:
- mountPath: /config
  name: config-volume
  readOnly: true
- mountPath: /app/data
  name: web-site-volume
  readOnly: false
volumes:
- configMap:
    name: config
  name: config-volume
- name: web-site-volume

HOOKS:
---
# Source: myapp/templates/hooks.yml
apiVersion: v1
kind: Pod
metadata:
  name: "helm-hooks-myapp-preinstall"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  containers:
    - name: preinstall
      image: busybox
      command: ["sh", "-c", "sleep 20"]
  restartPolicy: Never
---
# Source: myapp/templates/hooks.yml
apiVersion: v1
kind: Pod
metadata:
  name: "helm-hooks-myapp-postinstall"
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-delete-policy: hook-succeeded
spec:
  containers:
    - name: postinstall
      image: busybox
      command: ["sh", "-c", "sleep 20"]
  restartPolicy: Never
---
# Source: myapp/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "helm-hooks-myapp-test-connection"
  labels:
    helm.sh/chart: myapp-0.1.0
    app.kubernetes.io/name: myapp
    app.kubernetes.io/instance: helm-hooks
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['helm-hooks-myapp:80']
  restartPolicy: Never
MANIFEST:
---
# Source: myapp/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: helm-hooks-myapp
  labels:
    helm.sh/chart: myapp-0.1.0
    app.kubernetes.io/name: myapp
    app.kubernetes.io/instance: helm-hooks
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: myapp/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  namespace: default
data:
  MY_PASS: bXlzZWNyZXRwYXNzd29yZA==
type: Opaque
---
# Source: myapp/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
data:
  config: |-
    {
        "app_name": "My Flask App",
        "version": "1.0.0",
        "maintainer": "Elizaveta Nikolaeva"
    }
---
# Source: myapp/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: helm-hooks-myapp
  labels:
    helm.sh/chart: myapp-0.1.0
    app.kubernetes.io/name: myapp
    app.kubernetes.io/instance: helm-hooks
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: myapp
    app.kubernetes.io/instance: helm-hooks
---
# Source: myapp/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: helm-hooks-myapp-statefulset
  labels:
    helm.sh/chart: myapp-0.1.0
    app.kubernetes.io/name: myapp
    app.kubernetes.io/instance: helm-hooks
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: "helm-hooks-myapp-headless"
  replicas: 1
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: "myapp"
  template:
    metadata:
      labels:
        app: "myapp"
    spec:
      serviceAccountName: helm-hooks-myapp
      volumes:
        - name: config-volume
          configMap:
            name: config
      initContainers:
        - name: download-file
          image: busybox:1.36.1
          command: ['wget']
          args:
            - "-O"
            - "/app/data/web-site.html"
            - "http://example.com/"
          volumeMounts:
            - name: config-volume
              mountPath: /config
              readOnly: true
            - name: web-site-volume
              mountPath: /app/data
              readOnly: false
      containers:
        - name: myapp
          image: "nikolaevaelizaveta/my-flask-app:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 5000
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: web-site-volume
              mountPath: /app/data
  volumeClaimTemplates:
    - metadata:
        name: web-site-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "standard"
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=myapp,app.kubernetes.io/instance=helm-hooks" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

No issues arised, so we can deploy it.

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s> helm install helm-hooks ./myapp
NAME: helm-hooks
LAST DEPLOYED: Sun Mar 16 23:26:21 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=myapp,app.kubernetes.io/instance=helm-hooks" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

## Task 2: StatefulSet Exploration and Optimization

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s>   kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS    RESTARTS      AGE
pod/helm-hooks-myapp-statefulset-0          1/1     Running   0             2m23s
pod/python-app-myapp-86cf5bd6f6-thwj6       1/1     Running   4 (19m ago)   5d11h
pod/vault-0                                 1/1     Running   4 (22m ago)   12d
pod/vault-agent-injector-66f45b5fd5-szgkj   1/1     Running   5 (23m ago)   12d

NAME                                            READY   AGE
statefulset.apps/helm-hooks-myapp-statefulset   1/1     2m23s
statefulset.apps/vault                          1/1     12d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/helm-hooks-myapp           ClusterIP   10.111.166.133   <none>        80/TCP              2m23s
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             17d
service/python-app-myapp           ClusterIP   10.106.174.216   <none>       
 80/TCP              5d11h
service/vault                      ClusterIP   10.98.74.19      <none>        8200/TCP,8201/TCP   12d
service/vault-agent-injector-svc   ClusterIP   10.103.28.7      <none>        443/TCP             12d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   12d

NAME                                                                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/web-site-volume-helm-hooks-myapp-statefulset-0   Bound    pvc-cd129870-2684-4d0b-9c10-05d6fb108f02   1Gi        RWO            standard       <unset>                 42m
```


Pode deletion:
```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s> kubectl delete pod helm-hooks-myapp-statefulset-0
pod "helm-hooks-myapp-statefulset-0" deleted
```

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs\k8s>   kubectl get pvc
NAME                                             STATUS   VOLUME             
                        CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
web-site-volume-helm-hooks-myapp-statefulset-0   Bound    pvc-cd129870-2684-4d0b-9c10-05d6fb108f02   1Gi        RWO            standard       <unset>                 46m
```

