# Lab 14: Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

```bash
$ helm install --dry-run --debug test-app ./test-app
install.go:225: 2025-04-06 16:41:32.240883738 +0300 MSK m=+0.017362119 [debug] Original chart version: ""
install.go:242: 2025-04-06 16:41:32.240906421 +0300 MSK m=+0.017384802 [debug] CHART PATH: /home/nvy/other/S25-core-course-labs/k8s/test-app

NAME: test-app
LAST DEPLOYED: Sun Apr  6 16:41:32 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: jlfkajlkifj/app_python
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 2
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
secret:
  DB_PASSWORD: password123
  DB_USER: admin
  MY_PASSWORD: secretpassword123
securityContext: {}
service:
  port: 8000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
tolerations: []
vault:
  annotations: {}
  enabled: false
volumeMounts: []
volumes: []

HOOKS:
---
# Source: test-app/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: post-install-hook
  annotations:
    "helm.sh/hook": post-install
spec:
  containers:
    - name: post-install-container
      image: busybox
      command: ["sh", "-c", "sleep 20"]
  restartPolicy: Never
---
# Source: test-app/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pre-install-hook
  annotations:
    "helm.sh/hook": pre-install
spec:
  containers:
    - name: pre-install-container
      image: busybox
      command: ["sh", "-c", "sleep 20"]
  restartPolicy: Never
---
# Source: test-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "test-app-test-connection"
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['test-app:8000']
  restartPolicy: Never
MANIFEST:
---
# Source: test-app/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-app
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: test-app/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: test-app-secret
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
---
# Source: test-app/templates/configmap.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-app-config
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
data:
  config.json: |
    {
      "username": "admin",
      "password": "password123"
    }
---
# Source: test-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-app
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
---
# Source: test-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test-app
  labels:
    helm.sh/chart: test-app-0.1.0
    app.kubernetes.io/name: test-app
    app.kubernetes.io/instance: test-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: test-app
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: test-app
      app.kubernetes.io/instance: test-app
  template:
    metadata:
      labels:
        app.kubernetes.io/name: test-app
        app.kubernetes.io/instance: test-app
    spec:
      containers:
        - name: test-app
          image: "jlfkajlkifj/app_python:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=test-app,app.kubernetes.io/instance=test-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

## Task 2: StatefulSet Exploration and Optimization

```bash
$ kubectl get sts,pods,svc,pvc -n default
NAME                        READY   AGE
statefulset.apps/test-app   2/2     85s

NAME                                       READY   STATUS      RESTARTS   AGE
pod/post-install-hook                      0/1     Completed   0          34m
pod/pre-install-hook                       0/1     Completed   0          3m19s
pod/python-app-test-app-7f986454b5-gc469   1/1     Running     0          135m
pod/python-app-test-app-7f986454b5-qcshb   1/1     Running     0          50m
pod/test-app-0                             1/1     Running     0          85s
pod/test-app-1                             1/1     Running     0          82s

NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/kubernetes            ClusterIP   10.96.0.1        <none>        443/TCP    141m
service/python-app-test-app   ClusterIP   10.101.251.131   <none>        8000/TCP   135m
service/test-app              ClusterIP   10.110.136.219   <none>        8000/TCP   85s

NAME                                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-test-app-0   Bound    pvc-ad7c6a85-80ec-4cff-97eb-a13d0b7ec7cc   1Gi        RWO            standard       <unset>                 85s
persistentvolumeclaim/data-test-app-1   Bound    pvc-aa3bea1e-0a7b-44bd-bd62-e2a6a63e03cc   1Gi        RWO            standard       <unset>                 82s
```


I accessed my application using:

```bash
[nvy@nvy k8s]$ minikube service test-app
```

Content of visits:
```bash
$ kubectl exec test-app-0 -- cat /data/visits
$ kubectl exec test-app-1 -- cat /data/visits
# output
14
10
```

The PVC after deleting the pod with `kubectl delete pod test-app-0`:
```bash
$ kubectl get pvc
NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-test-app-0   Bound    pvc-ad7c6a85-80ec-4cff-97eb-a13d0b7ec7cc   1Gi        RWO            standard       <unset>                 6m45s
data-test-app-1   Bound    pvc-aa3bea1e-0a7b-44bd-bd62-e2a6a63e03cc   1Gi        RWO            standard       <unset>                 6m42s
```

Reading the data:
```bash
$ kubectl exec data-test-app-0 -- cat /data/visits
```

#### Headless Service Access

```bash
$ kubectl exec test-app-0 -- nslookup test-app-1.test-app.default.svc.cluster.local
Server:		10.96.0.10
Address:	10.96.0.10:53


Name:	test-app-1.test-app.default.svc.cluster.local
Address: 10.244.0.48
```

#### Monitoring & Alerts
Probes Implementation
Added to statefulset.yaml:

```yaml
livenessProbe:
  httpGet:
    path: /
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /
    port: 8000
  initialDelaySeconds: 2
  periodSeconds: 5
Role of Probes:
```

Liveness Probe: Restarts pods if they become unresponsive, ensuring service availability.
Readiness Probe: Prevents traffic to pods during startup or failure, crucial for stateful apps to avoid data corruption during unstable states.
Criticality: Ensures pods handle stateful operations (e.g., database writes) only when fully operational.

Ordering Guarantee and Parallel Operations

Parallel Implementation:

```yaml
spec:
  podManagementPolicy: Parallel
```
This allows simultaneous scaling of pods, improving operational speed.
