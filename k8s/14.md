# Lab 14: Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

```bash
  > helm install --dry-run --debug app-python-helm ./app-python-helm

  install.go:225: 2025-03-17 01:50:16.5420501 +0300 MSK m=+0.080654601 [debug] Original chart version: ""
  install.go:242: 2025-03-17 01:50:16.5420501 +0300 MSK m=+0.080654601 [debug] CHART PATH: C:\S25-core-course-labs\k8s\app-python-helm

  NAME: app-python-helm
  LAST DEPLOYED: Mon Mar 17 01:50:16 2025
  NAMESPACE: default
  STATUS: pending-install
  REVISION: 1
  USER-SUPPLIED VALUES:
  {}

  COMPUTED VALUES:
  affinity: {}
  autoscaling:
    enabled: false
    maxReplicas: 100
    minReplicas: 1
    targetCPUUtilizationPercentage: 80
  fullnameOverride: ""
  image:
    pullPolicy: IfNotPresent
    repository: anyarylova/app_python
    tag: latest
  imagePullSecrets: []
  ingress:
    annotations: {}
    className: ""
    enabled: false
    hosts:
    - host: chart-example.local
      paths:
      - path: /
        pathType: ImplementationSpecific
    tls: []
  livenessProbe:
    httpGet:
      path: /
      port: http
  nameOverride: ""
  nodeSelector: {}
  podAnnotations: {}
  podLabels: {}
  podSecurityContext: {}
  readinessProbe:
    httpGet:
      path: /
      port: http
  replicaCount: 3
  resources: {}
  secrets:
    password: S!B\*d$zDsb=
    username: admin
  securityContext: {}
  service:
    port: 80
    type: ClusterIP
  serviceAccount:
    annotations: {}
    automount: true
    create: true
    name: ""
  tolerations: []
  vault:
    enabled: true
    role: app-python
    secretPath: internal/data/database/config
  volumeMounts: []
  volumes: []

  HOOKS:
  ---
  # Source: app-python-helm/templates/hooks/post-install.yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: "app-python-helm-postinstall"
    annotations:
      helm.sh/hook: post-install
      helm.sh/hook-delete-policy: before-hook-creation
  spec:
    containers:
      - name: post-install
        image: busybox
        command: ["sh", "-c", "sleep 20"]
    restartPolicy: Never
  ---
  # Source: app-python-helm/templates/hooks/pre-install.yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: "app-python-helm-preinstall"
    annotations:
      helm.sh/hook: pre-install
      helm.sh/hook-delete-policy: before-hook-creation
  spec:
    containers:
      - name: preinstall
        image: busybox
        command: ["sh", "-c", "sleep 20"]
    restartPolicy: Never
  ---
  # Source: app-python-helm/templates/tests/test-connection.yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: "app-python-helm-test-connection"
    labels:
      helm.sh/chart: app-python-helm-0.1.0
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
      app.kubernetes.io/version: "1.16.0"
      app.kubernetes.io/managed-by: Helm
    annotations:
      "helm.sh/hook": test
  spec:
    containers:
      - name: wget
        image: busybox
        command: ['wget']
        args: ['app-python-helm:80']
    restartPolicy: Never
  MANIFEST:
  ---
  # Source: app-python-helm/templates/serviceaccount.yaml
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: app-python-helm
    labels:
      helm.sh/chart: app-python-helm-0.1.0
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
      app.kubernetes.io/version: "1.16.0"
      app.kubernetes.io/managed-by: Helm
  automountServiceAccountToken: true
  ---
  # Source: app-python-helm/templates/secrets.yaml
  apiVersion: v1
  kind: Secret
  metadata:
    name: helm-secret
  type: Opaque
  data:
    username: YWRtaW4=
    password: UyFCXCpkJHpEc2I9
  ---
  # Source: app-python-helm/templates/configmap.yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: app-python-helm-config
    labels:
      helm.sh/chart: app-python-helm-0.1.0
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
      app.kubernetes.io/version: "1.16.0"
      app.kubernetes.io/managed-by: Helm
  data:
    config.json: |-

      {
        "app_name": "Moscow Time",
        "version": "1.0"
      }
  ---
  # Source: app-python-helm/templates/service.yaml
  apiVersion: v1
  kind: Service
  metadata:
    name: app-python-helm
    labels:
      helm.sh/chart: app-python-helm-0.1.0
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
      app.kubernetes.io/version: "1.16.0"
      app.kubernetes.io/managed-by: Helm
  spec:
    type: ClusterIP
    ports:
      - port: 80
        targetPort: http
        protocol: TCP
        name: http
    selector:
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
  ---
  # Source: app-python-helm/templates/statefulset.yaml
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: app-python-helm
    labels:
      helm.sh/chart: app-python-helm-0.1.0
      app.kubernetes.io/name: app-python-helm
      app.kubernetes.io/instance: app-python-helm
      app.kubernetes.io/version: "1.16.0"
      app.kubernetes.io/managed-by: Helm
  spec:
    serviceName: app-python-helm
    podManagementPolicy: Parallel
    replicas: 3
    volumeClaimTemplates:
      - metadata:
          name: data
        spec:
          accessModes: [ "ReadWriteOnce" ]
          resources:
            requests:
              storage: 1Gi
    selector:
      matchLabels:
        app.kubernetes.io/name: app-python-helm
        app.kubernetes.io/instance: app-python-helm
    template:
      metadata:
        labels:
          helm.sh/chart: app-python-helm-0.1.0
          app.kubernetes.io/name: app-python-helm
          app.kubernetes.io/instance: app-python-helm
          app.kubernetes.io/version: "1.16.0"
          app.kubernetes.io/managed-by: Helm
      spec:
        serviceAccountName: app-python-helm
        containers:
          - name: app-python-helm
            image: "anyarylova/app_python:latest"
            imagePullPolicy: IfNotPresent
            ports:
              - name: http
                containerPort: 8000
                protocol: TCP
            env:
              - name: USERNAME
                valueFrom:
                  secretKeyRef:
                    name: helm-secret
                    key: password
            volumeMounts:
                    name: helm-secret
                    key: password
            volumeMounts:
        volumes:
          - name: config-volume
                    name: helm-secret
                    key: password
            volumeMounts:
                    key: password
            volumeMounts:
            volumeMounts:
        volumes:
        volumes:
          - name: config-volume
            configMap:
              name: app-python-helm-config
```

## Task 2: StatefulSet Exploration and Optimization

### Output of `kubectl get po,sts,svc,pvc`

```bash
  > kubectl get po,sts,svc,pvc

  NAME                                              READY   STATUS      RESTARTS       AGE
  pod/app-python-helm-0                             1/1     Running     0              16m
  pod/app-python-helm-1                             1/1     Running     0              16m
  pod/app-python-helm-2                             1/1     Running     0              16m
  pod/app-python-helm-postinstall                   0/1     Completed   0              7d5h
  pod/app-python-helm-preinstall                    0/1     Completed   0              7d5h
  pod/helm-hooks-app-python-helm-6b964dfd8-s5ksb    1/1     Running     1 (7d ago)     7d5h
  pod/python-app-app-python-helm-5d55c4c99d-bssxs   1/1     Running     0              6h23m
  pod/python-app-app-python-helm-5d55c4c99d-fdlpr   1/1     Running     0              6h36m
  pod/python-app-app-python-helm-5d55c4c99d-tptzq   1/1     Running     0              6h23m
  pod/python-app-app-python-helm-postinstall        0/1     Completed   0              6h23m
  pod/python-app-app-python-helm-preinstall         0/1     Completed   0              6h24m
  pod/vault-0                                       1/1     Running     1 (7h9m ago)   7d5h
  pod/vault-agent-injector-66f45b5fd5-x6ckc         1/1     Running     1 (7d ago)     7d5h

  NAME                               READY   AGE
  statefulset.apps/app-python-helm   3/3     16m
  statefulset.apps/vault             1/1     7d5h

  NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE    
  service/app-python-helm              LoadBalancer   10.106.123.157   <pending>     80:32709/TCP        7d5h   
  service/helm-hooks-app-python-helm   ClusterIP      10.106.16.250    <none>        80/TCP              15d    
  service/kubernetes                   ClusterIP      10.96.0.1        <none>        443/TCP             18d    
  service/python-app-app-python-helm   ClusterIP      10.110.178.39    <none>        80/TCP              6h36m  
  service/vault                        ClusterIP      10.104.247.153   <none>        8200/TCP,8201/TCP   7d5h   
  service/vault-agent-injector-svc     ClusterIP      10.98.213.41     <none>        443/TCP             7d5h
  service/vault-internal               ClusterIP      None             <none>        8200/TCP,8201/TCP   7d5h   

  NAME                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
  persistentvolumeclaim/data-app-python-helm-0   Bound    pvc-09237f71-0dae-4f7f-b156-bf9b7de24e08   1Gi        RWO            standard       <unset>                 16m
  persistentvolumeclaim/data-app-python-helm-1   Bound    pvc-c7c963c3-07e1-45c4-beb9-2a69dbfc8665   1Gi        RWO            standard       <unset>                 16m
  persistentvolumeclaim/data-app-python-helm-2   Bound    pvc-67c14991-50be-4fde-9c8c-7ee707aa4d53   1Gi        RWO            standard       <unset>                 16m
```

### Output of `kubectl exec pod/app-python-helm-0 -- cat visits`

```bash 
  > kubectl exec pod/app-python-helm-0 -- cat data/visits.txt
  5

  > kubectl exec pod/app-python-helm-1 -- cat data/visits.txt
  3
```

### Persistent Storage Validation

```bash
  > kubectl delete pod app-python-helm-0 
  pod "app-python-helm-0" deleted

  > kubectl get pvc

  NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
  data-app-python-helm-0   Bound    pvc-09237f71-0dae-4f7f-b156-bf9b7de24e08   1Gi        RWO            standard       <unset>                 4d20h
  data-app-python-helm-1   Bound    pvc-c7c963c3-07e1-45c4-beb9-2a69dbfc8665   1Gi        RWO            standard       <unset>                 4d20h
  data-app-python-helm-2   Bound    pvc-67c14991-50be-4fde-9c8c-7ee707aa4d53   1Gi        RWO            standard       <unset>                 4d20h

  > kubectl exec app-python-helm-0 -- cat data/visits.txt
  5
```

### Headless Service Access

```bash
> kubectl exec -i -t dnsutils -- nslookup app-python-helm-0.app-python-helm

Server:         10.96.0.10
Address:        10.96.0.10#53

Name:   app-python-helm-0.app-python-helm.default.svc.cluster.local
Address: 10.244.0.148

> kubectl exec -i -t dnsutils -- nslookup app-python-helm-1.app-python-helm  

Server:         10.96.0.10
Address:        10.96.0.10#53

Name:   app-python-helm-1.app-python-helm.default.svc.cluster.local
Address: 10.244.0.131

> kubectl exec -i -t dnsutils -- nslookup app-python-helm-2.app-python-helm
Server:         10.96.0.10
Address:        10.96.0.10#53

Name:   app-python-helm-2.app-python-helm.default.svc.cluster.local
Address: 10.244.0.142
```

### Monitoring & Alerts

Added liveness and readiness probes to `StatefulSet`.

- Liveness Probe: Ensures the pod is running. If a liveness probe fails, Kubernetes restarts the pod.

- Readiness Probe: Ensures the pod is ready to accept traffic. If a readiness probe fails, the pod is removed from service endpoints. and traffic is redirected.

Both endpoints is part of self-healing quality attribute. They help to detect issues in individual pods and fix them without damaging the overall service.

### Ordering Guarantee and Parallel Operations

In `StatefulSet` manifest, setting `podManagementPolicy: Parallel` tells the controller to create or terminate all pods in parallel rather than sequentially.

- StatefulSets normally create pods in order. For this application, there is no strict dependency between pods, so it does not require strict ordering.
