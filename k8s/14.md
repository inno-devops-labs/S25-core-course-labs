# Kubernetes StatefulSet

## StatefulSet in Helm Chart

### Test chart

```shell
helm install --dry-run --debug moscow-time-app moscow-time-app
```

### Deploy 

```shell
helm install moscow-time-app moscow-time-app
```

## Exploration and Optimization

### Research 

```shell
kubectl get po,sts,svc,pvc
```

```text
NAME                    READY   STATUS    RESTARTS   AGE
pod/moscow-time-app-0   1/1     Running   0          2m13s
pod/moscow-time-app-1   1/1     Running   0          2m13s

NAME                               READY   AGE
statefulset.apps/moscow-time-app   2/2     2m13s

NAME                      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/kubernetes        ClusterIP      10.96.0.1       <none>        443/TCP          8h
service/moscow-time-app   ClusterIP      10.108.64.190   <none>        5000/TCP         2m13s

NAME                                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/moscow-time-app-data-moscow-time-app-0   Bound    pvc-ab5ba937-2589-aaee-e1e7-7600a4024a75   1Gi        RWO            standard       <unset>                 2m13s
persistentvolumeclaim/moscow-time-app-data-moscow-time-app-1   Bound    pvc-3d3fc575-4aa1-0e1c-7ba6-4e6bca892664   1Gi        RWO            standard       <unset>                 2m13s
```

#### Access app

```shell
minikube service moscow-time-app
```

#### Analyze visits file content

After visiting site from different tabs and browsers, we can see that counter values are differ because of separate local visits files in each pod:

```shell
kubectl exec pod/moscow-time-app-0 -- cat visits/visits.txt
```

```text
5
```

```shell
kubectl exec pod/moscow-time-app-1 -- cat visits/visits.txt
```

```text
1
```

### Persistent Storage Validation

#### Delete pod

```shell
kubectl delete pod moscow-time-app-0
```

#### Verify

```shell
kubectl get pvc
```

```text
NAME                                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/moscow-time-app-data-moscow-time-app-0   Bound    pvc-ab5ba937-2589-aaee-e1e7-7600a4024a75   1Gi        RWO            standard       <unset>                 11m
persistentvolumeclaim/moscow-time-app-data-moscow-time-app-1   Bound    pvc-3d3fc575-4aa1-0e1c-7ba6-4e6bca892664   1Gi        RWO            standard       <unset>                 11m
```

```shell
kubectl exec pod/moscow-time-app-0 -- cat visits/visits.txt
```

```text
5
```

### Headless Service Access

#### Access pods via DNS

```shell
kubectl exec moscow-time-app-0 -- nslookup moscow-time-app-1.moscow-time-app.default.svc.cluster.local
```

```text
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   moscow-time-app-1.moscow-time-app.default.svc.cluster.local
Address: 10.244.0.105
```

```shell
kubectl exec moscow-time-app-1 -- nslookup moscow-time-app-0.moscow-time-app.default.svc.cluster.local
```

```text
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   moscow-time-app-0.moscow-time-app.default.svc.cluster.local
Address: 10.244.0.104
```