# Task 1

```bash
helm install --dry-run --debug app-python ./app-python
install.go:225: 2025-03-13 02:06:09.978973 +0300 MSK m=+0.454474254 [debug] Original chart version: ""
install.go:242: 2025-03-13 02:06:09.98053 +0300 MSK m=+0.456031568 [debug] CHART PATH: /Users/akss/Desktop/study/S25-core-course-labs/k8s/app-python

NAME: app-python
LAST DEPLOYED: Thu Mar 13 02:06:10 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
enabled: false
maxReplicas: 100
minReplicas: 1
targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
pullPolicy: IfNotPresent
repository: mangocandle/app_python
tag: latest
imagePullSecrets: []
ingress:
annotations: {}
className: ""
enabled: false
hosts:

- host: chart-example.local
  paths: - path: /
  pathType: ImplementationSpecific
  tls: []
  nameOverride: ""
  nodeSelector: {}
  password: password
  persistence:
  size: 1Gi
  podAnnotations: {}
  podLabels: {}
  podSecurityContext: {}
  probes:
  liveness:
  initialDelaySeconds: 30
  periodSeconds: 10
  readiness:
  initialDelaySeconds: 30
  periodSeconds: 10
  replicaCount: 2
  resources: {}
  securityContext: {}
  service:
  port: 5001
  type: ClusterIP
  serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: internal-app
  tolerations: []
  volumeMounts: []
  volumes: []

## HOOKS:

# Source: app-python/templates/postinstall-hook.yaml

apiVersion: v1
kind: Pod
metadata:
name: postinstall-hook
annotations:
"helm.sh/hook": "post-install"
"helm.sh/hook-delete-policy": hook-succeeded
spec:
containers: - name: post-install-container
image: busybox
imagePullPolicy: Always
command: ["sh", "-c", "echo The post-install hook is running && sleep 15"]
restartPolicy: Never
terminationGracePeriodSeconds: 0

---

# Source: app-python/templates/preinstall-hook.yaml

apiVersion: v1
kind: Pod
metadata:
name: preinstall-hook
annotations:
"helm.sh/hook": "pre-install"
"helm.sh/hook-delete-policy": hook-succeeded
spec:
containers: - name: pre-install-container
image: busybox
imagePullPolicy: IfNotPresent
command: ["sh", "-c", "echo The pre-install hook is running && sleep 20"]
restartPolicy: Never
terminationGracePeriodSeconds: 0

---

# Source: app-python/templates/tests/test-connection.yaml

apiVersion: v1
kind: Pod
metadata:
name: "app-python-test-connection"
labels:
helm.sh/chart: app-python-0.1.0
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
app.kubernetes.io/version: "1.16.0"
app.kubernetes.io/managed-by: Helm
annotations:
"helm.sh/hook": test
spec:
containers: - name: wget
image: busybox
command: ['wget']
args: ['app-python:5001']
restartPolicy: Never
MANIFEST:

---

# Source: app-python/templates/serviceaccount.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
name: internal-app
labels:
helm.sh/chart: app-python-0.1.0
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
app.kubernetes.io/version: "1.16.0"
app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true

---

# Source: app-python/templates/secrets.yaml

apiVersion: v1
kind: Secret
metadata:
name: credentials
labels:
app: app-python
chart: "app-python-0.1.0"
release: "app-python"
heritage: ""
type: Opaque
data:
password: "password"

---

# Source: app-python/templates/configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
name: config
data:
config: |-
{
"app_name": "Python app for Moscow Time",
"version": "1.0.0",
"maintainer": "Liubov Smirnova"
}

---

# Source: app-python/templates/service.yaml

apiVersion: v1
kind: Service
metadata:
name: app-python-headless
labels:
helm.sh/chart: app-python-0.1.0
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
app.kubernetes.io/version: "1.16.0"
app.kubernetes.io/managed-by: Helm
spec:
clusterIP: None
ports: - port: 5001
targetPort: 5001
selector:
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python

---

# Source: app-python/templates/statefulset.yaml

apiVersion: apps/v1
kind: StatefulSet
metadata:
name: app-python
labels:
helm.sh/chart: app-python-0.1.0
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
app.kubernetes.io/version: "1.16.0"
app.kubernetes.io/managed-by: Helm
spec:
replicas: 2
serviceName: app-python-headless
selector:
matchLabels:
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
template:
metadata:
labels:
app.kubernetes.io/name: app-python
app.kubernetes.io/instance: app-python
spec:
serviceAccountName: internal-app
containers: - name: app-python
image: "mangocandle/app_python:latest"
ports: - containerPort: 5001
livenessProbe:
httpGet:
path: /
port: 5001
initialDelaySeconds: 30
periodSeconds: 10
readinessProbe:
httpGet:
path: /
port: 5001
initialDelaySeconds: 30
periodSeconds: 10
volumeClaimTemplates: - metadata:
name: data
spec:
accessModes: [ "ReadWriteOnce" ]
resources:
requests:
storage: 1Gi

NOTES:

1. Get the application URL by running these commands:
   export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

```bash
helm install app-python ./app-python
NAME: app-python
LAST DEPLOYED: Thu Mar 13 02:06:18 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

Checking the deployment:

```bash
kubectl get statefulset -n default
NAME         READY   AGE
app-python   2/2     3m8s

kubectl get pods
NAME           READY   STATUS    RESTARTS   AGE
app-python-0   1/1     Running   0          3m4s
app-python-1   1/1     Running   0          44s

get pvc -n default
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-app-python-0   Bound    pvc-979b7467-6637-4662-b5ad-d250c624b721   1Gi        RWO            standard       <unset>                 4m37s
data-app-python-1   Bound    pvc-37d0192e-2cfc-4c54-bb38-664f3ccb61fb   1Gi        RWO            standard       <unset>
```

## Task 2

```bash
kubectl get po,sts,svc,pvc
NAME               READY   STATUS    RESTARTS   AGE
pod/app-python-0   1/1     Running   0          5m27s
pod/app-python-1   1/1     Running   0          3m7s

NAME                          READY   AGE
statefulset.apps/app-python   2/2     5m27s

NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
service/app-python-headless   ClusterIP   None         <none>        5001/TCP   5m27s
service/kubernetes            ClusterIP   10.96.0.1    <none>        443/TCP    7m35s

NAME                                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-app-python-0   Bound    pvc-979b7467-6637-4662-b5ad-d250c624b721   1Gi        RWO            standard       <unset>                 5m27s
persistentvolumeclaim/data-app-python-1   Bound    pvc-37d0192e-2cfc-4c54-bb38-664f3ccb61fb   1Gi        RWO            standard       <unset>                 3m7s

minikube service app-python-headless
|-----------|---------------------|-------------|--------------|
| NAMESPACE |        NAME         | TARGET PORT |     URL      |
|-----------|---------------------|-------------|--------------|
| default   | app-python-headless |             | No node port |
|-----------|---------------------|-------------|--------------|
üòø  service default/app-python-headless has no node port
‚ùó  Services [default/app-python-headless] have type "ClusterIP" not meant to be exposed, however for local development minikube allows you to access this !
üèÉ  Starting tunnel for service app-python-headless.
|-----------|---------------------|-------------|------------------------|
| NAMESPACE |        NAME         | TARGET PORT |          URL           |
|-----------|---------------------|-------------|------------------------|
| default   | app-python-headless |             | http://127.0.0.1:50549 |
|-----------|---------------------|-------------|------------------------|
üéâ  Opening service default/app-python-headless in default browser...
‚ùó  Because you are using a Docker driver on darwin, the terminal needs to be open to run it.
```

For app-python-0:

```bash
kubectl exec -it app-python-0 -- /bin/sh
$ ls
CI.md      PYTHON.md  app.py  requirements.txt  templates  venv
DOCKER.md  README.md  data    static            tests
$ cat data/visits
15
```

For app-python-1:

```bash
kubectl exec -it app-python-1 -- /bin/sh
$ cat data/visits
19
```

Explanation: files contain different values beacuse they have different Persistent Volumes.

Deleting Pod, PV is still present:

```bash
kubectl delete pod app-python-0
pod "app-python-0" deleted
aksss-MacBook-Pro:S25-core-course-labs mangocandle$ kubectl get pvc
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-app-python-0   Bound    pvc-979b7467-6637-4662-b5ad-d250c624b721   1Gi        RWO            standard       <unset>                 14m
data-app-python-1   Bound    pvc-37d0192e-2cfc-4c54-bb38-664f3ccb61fb   1Gi        RWO            standard       <unset>                 11m
```

Then the pod is recreated:

```bash
kubectl get pods
NAME           READY   STATUS    RESTARTS   AGE
app-python-0   1/1     Running   0          49s
app-python-1   1/1     Running   0          12m
```

And the data stored in it is the same:

```bash
kubectl exec -it app-python-0 -- /bin/sh
$ cat data/visits
15$
```

Verifying DNS (as long as nslookup was not installed in my pod's container, I used command cat etc/resolv.conf):

```bash
kubectl exec -it app-python-0 -- /bin/sh
$ nslookup app-python-1.app-python
/bin/sh: 1: nslookup: not found
$ cat /etc/resolv.conf
nameserver 10.96.0.10
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5
```
