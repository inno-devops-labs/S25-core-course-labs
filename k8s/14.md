# Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

Apply chart with `statefulset` implementation:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ helm install python-app ./python-app/
NAME: python-app
LAST DEPLOYED: Sat Mar 15 16:53:51 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
  
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl get pods,sts,svc,pvc
NAME               READY   STATUS    RESTARTS   AGE
pod/python-app-0   1/1     Running   0          89s
pod/python-app-1   1/1     Running   0          89s
pod/python-app-2   1/1     Running   0          89s

NAME                          READY   AGE
statefulset.apps/python-app   3/3     89s

NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
service/kubernetes   ClusterIP   10.43.0.1     <none>        443/TCP          51d
service/python-app   NodePort    10.43.52.67   <none>        8000:30919/TCP   89s

NAME                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/python-app-pvc-python-app-0   Bound    pvc-3e6775a9-4e82-4526-bd59-653b0ac27099   100Mi      RWO            local-path     <unset>                 89s
persistentvolumeclaim/python-app-pvc-python-app-1   Bound    pvc-93605fab-6d22-4129-b88e-2fe13893db30   100Mi      RWO            local-path     <unset>                 89s
persistentvolumeclaim/python-app-pvc-python-app-2   Bound    pvc-280d71bd-7fbe-4e77-b496-435b8d3e8602   100Mi      RWO            local-path     <unset>                 89s
```

Check how many `visits` exist for each pod:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- cat /data/visits.txt
9
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-1 -- cat /data/visits.txt
4
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- cat /data/visits.txt
3
```

This happens because each pod in the Kubernetes cluster maintains its own independent volume, where it stores a unique `visits.txt` file.
When a `service load balancer` distributes incoming requests across the multiple pods, each request may be routed to a different pod.
Since each pod operates in isolation and has its own separate `visits.txt` file, the data stored in these files is not shared or synchronized across the pods.
As a result, when you attempt to read from these files, the content you retrieve will vary depending on which pod handles the request.

## Delete pod and check PVC

```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- cat /data/visits.txt
9
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl delete pod python-app-0
pod "python-app-0" deleted
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl get pods,sts,svc,pvc
NAME               READY   STATUS    RESTARTS   AGE
pod/python-app-0   0/1     Running   0          6s
pod/python-app-1   1/1     Running   0          12m
pod/python-app-2   1/1     Running   0          12m

NAME                          READY   AGE
statefulset.apps/python-app   2/3     12m

NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
service/kubernetes   ClusterIP   10.43.0.1     <none>        443/TCP          51d
service/python-app   NodePort    10.43.52.67   <none>        8000:30919/TCP   12m

NAME                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/python-app-pvc-python-app-0   Bound    pvc-3e6775a9-4e82-4526-bd59-653b0ac27099   100Mi      RWO            local-path     <unset>                 12m
persistentvolumeclaim/python-app-pvc-python-app-1   Bound    pvc-93605fab-6d22-4129-b88e-2fe13893db30   100Mi      RWO            local-path     <unset>                 12m
persistentvolumeclaim/python-app-pvc-python-app-2   Bound    pvc-280d71bd-7fbe-4e77-b496-435b8d3e8602   100Mi      RWO            local-path     <unset>                 12m
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- cat /data/visits.txt
9
```

## Check DNS resolution

I can only check pods via FQDN and PQDN does not work for me:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- nslookup python-app-0.python-app.default.svc.cluster.local
Server:         10.43.0.10
Address:        10.43.0.10:53

Name:   python-app-0.python-app.default.svc.cluster.local
Address: 10.42.0.112


nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-1 -- nslookup python-app-1.python-app.default.svc.cluster.local
Server:         10.43.0.10
Address:        10.43.0.10:53

Name:   python-app-1.python-app.default.svc.cluster.local
Address: 10.42.0.110


nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-2 -- nslookup python-app-2.python-app.default.svc.cluster.local
Server:         10.43.0.10
Address:        10.43.0.10:53


Name:   python-app-2.python-app.default.svc.cluster.local
Address: 10.42.0.111
```

Not working PQDN:
```
nikita@LAPTOP-DOBKKTS4:~/S25-core-course-labs/k8s$ kubectl exec python-app-0 -- nslookup python-app-1.python-app
Server:         10.43.0.10
Address:        10.43.0.10:53

** server can't find python-app-1.python-app: NXDOMAIN

** server can't find python-app-1.python-app: NXDOMAIN

command terminated with exit code 1
```

## Liveness and Readiness probes

`Liveness and Readiness probes` are checks performed by kubelet to monitor the state of containers.
`Liveness` ensures that the container is running, while `Readiness` checks if it is ready to handle traffic. HTTP requests to the same endpoint as an example.

These probes are essential for stability: `Liveness` restarts the container if it fails, and `Readiness` temporarily removes it from load balancing if it’s not ready.
This helps prevent errors during updates or overloads. For example, you can manually disable Readiness to give the container time to complete tasks without receiving new requests.

## `Parallel` operations

Order guarantees are essential in StatefulSets with a master-replica architecture, where the master pod must start before the others.
In my сhart for application, there are no such dependencies, so all pods can start simultaneously using `podManagementPolicy: Parallel` policy.

## Updating strategies

StatefulSet supports two update strategies: `RollingUpdate` and `OnDelete`.
By default, `RollingUpdate` is used, which updates pods sequentially.
If the `rollingUpdate.partition` parameter is set, only pods with an ordinal number higher than the specified value are updated (e.g., for `Canary` Release).
`OnDelete` updates pods only after they are manually deleted.