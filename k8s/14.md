# Lab 14

## Task 1. Deploying stateful set

I have created a `statefulset.yaml` and `values.yaml` and specified 3 replicas to be created.

```text
» helm install --dry-run --debug python-time ./python-time   
install.go:225: 2025-03-11 19:47:55.193171391 +0300 MSK m=+0.279758524 [debug] Original chart version: ""
install.go:242: 2025-03-11 19:47:55.193874321 +0300 MSK m=+0.280461506 [debug] CHART PATH: /mnt/c/All/inno/devops/k8s/python-time

NAME: python-time
LAST DEPLOYED: Tue Mar 11 19:47:55 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: Always
  repository: mishablin/devops-labs
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /health
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /health
    port: http
replicaCount: 3
resources: {}
securityContext: {}
service:
  port: 5000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: false
  name: internal-app
tolerations: []
volumeMounts: []
volumes: []

HOOKS:
---
# Source: python-time/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "python-time-test-connection"
  labels:
    helm.sh/chart: python-time-0.1.0
    app.kubernetes.io/name: python-time
    app.kubernetes.io/instance: python-time
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['python-time:5000']
  restartPolicy: Never
MANIFEST:
---
# Source: python-time/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-app-config
data:
  config.json: |-

    {
      "user": "mikhail",
      "grade": 10
    }
---
# Source: python-time/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: python-time
  labels:
    helm.sh/chart: python-time-0.1.0
    app.kubernetes.io/name: python-time
    app.kubernetes.io/instance: python-time
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 5000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: python-time
    app.kubernetes.io/instance: python-time
---
# Source: python-time/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: python-time
  labels:
    helm.sh/chart: python-time-0.1.0
    app.kubernetes.io/name: python-time
    app.kubernetes.io/instance: python-time
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: python-time
      app.kubernetes.io/instance: python-time
  template:
    metadata:
      labels:
        helm.sh/chart: python-time-0.1.0
        app.kubernetes.io/name: python-time
        app.kubernetes.io/instance: python-time
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: internal-app
      containers:
        - name: python-time
          image: "mishablin/devops-labs:latest"
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /health
              port: http
          readinessProbe:
            httpGet:
              path: /health
              port: http
          volumeMounts:
            - name: config-volume
              mountPath: /src/config.json
              subPath: config.json
            - name: visits-data
              mountPath: /src/data
      volumes:
        - name: config-volume
          configMap:
            name: my-app-config
  volumeClaimTemplates:
    - metadata:
        name: visits-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 10Mi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time,app.kubernetes.io/instance=python-time" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

## Task 2. StatefulSet Exploration and Optimization

### Research and documentation

```text
» kubectl get po,sts,svc,pvc                                
NAME                READY   STATUS    RESTARTS   AGE
pod/python-time-0   1/1     Running   0          35s
pod/python-time-1   1/1     Running   0          31s
pod/python-time-2   1/1     Running   0          28s

NAME                           READY   AGE
statefulset.apps/python-time   3/3     35s

NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/kubernetes    ClusterIP   10.96.0.1       <none>        443/TCP    132m
service/python-time   ClusterIP   10.110.135.55   <none>        5000/TCP   35s

NAME                                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/visits-data-python-time-0   Bound    pvc-8c806d27-d075-44fe-9477-56b5f7b10691   10Mi       RWO            standard       <unset>                 85m
persistentvolumeclaim/visits-data-python-time-1   Bound    pvc-3a4bdf2a-66af-4c2d-b86f-626330852082   10Mi       RWO            standard       <unset>                 85m
persistentvolumeclaim/visits-data-python-time-2   Bound    pvc-b67e4257-43be-4a96-bd15-0f454f7bd9b7   10Mi       RWO            standard       <unset>                 85m```
```

```text
/mnt/c/All/inno/devops/k8s (lab14*) » kubectl exec python-time-0 -- cat visits.txt                
22                                                                                                
/mnt/c/All/inno/devops/k8s (lab14*) » kubectl exec python-time-1 -- cat visits.txt                
15                                                                                                
/mnt/c/All/inno/devops/k8s (lab14*) » kubectl exec python-time-2 -- cat visits.txt                
19
```

We can see that the visits for each replica is different. This behaviour happens because of the load balancer that
routes requests to different pods. And each of the pods has its own `visits.txt` file, that's why the number of
visits for each replica is different.

### Persistent storage validation

```text
» kubectl exec python-time-0 -- cat /src/data/visits.txt 
22
```

```text
» kubectl delete pod python-time-0                    
pod "python-time-0" deleted
```

```text
» kubectl get pvc                                             
NAME                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
visits-data-python-time-0   Bound    pvc-8c806d27-d075-44fe-9477-56b5f7b10691   10Mi       RWO            standard       <unset>                 88m
visits-data-python-time-1   Bound    pvc-3a4bdf2a-66af-4c2d-b86f-626330852082   10Mi       RWO            standard       <unset>                 87m
visits-data-python-time-2   Bound    pvc-b67e4257-43be-4a96-bd15-0f454f7bd9b7   10Mi       RWO            standard       <unset>                 87m
```

```text
» kubectl exec python-time-0 -- cat /src/data/visits.txt
22                                     
```

### Headless Service Access

```text
» kubectl exec python-time-0 -- nslookup python-time-1.python-time
Server:         10.96.0.10
Address:        10.96.0.10:53

** server can't find python-time-1.python-time: NXDOMAIN

** server can't find python-time-1.python-time: NXDOMAIN

command terminated with exit code 1
```

### Monitoring and alerts

To add liveness and readiness probe I have created a special endpoint in my python application `/health`.
When the application is running, this endpoint returns status `OK` to the sender.
In my `values.yaml` file I have added this code to specify the endpoint for the healthcheck:

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: http
readinessProbe:
  httpGet:
    path: /health
    port: http
```

These probes are necessary for kubernetes to understand if a pod is alive and ready to accept requests. It may
automatically restart the pod if it fails. Moreover, it allows to check if the pod should be seen by the load balancer,
as we do not want to send requests to the dead pod.

### Ordering Guarantee and Parallel Operations

Ordering guarantees are needed in clusters with master-replicas, when some pods are dependent on other
pods. In this application there are no pods that depend on other pods, therefore there is no need for ordering.

#### Parallel launch of pods

`podManagementPolicy: Parallel`
