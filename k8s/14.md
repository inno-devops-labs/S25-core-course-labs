# StatefulSet

## Task 2

### The output of `kubectl get po,sts,svc,pvc` command:

```bash
kubectl get po,sts,svc,pvc

NAME                                              READY   STATUS    RESTARTS      AGE
pod/app-python-helm-0                             1/1     Running   0             4m17s
pod/app-python-helm-1                             1/1     Running   0             4m17s
pod/go-app-app-go-helm-68c6df86b4-45h5x           1/1     Running   1 (20h ago)   21h
pod/python-app-app-python-helm-766b5c48f6-8rrcb   1/1     Running   1 (20h ago)   22h
pod/python-app-app-python-helm-766b5c48f6-kdx2r   1/1     Running   1 (20h ago)   22h
pod/vault-0                                       1/1     Running   6 (20h ago)   14d
pod/vault-agent-injector-66f45b5fd5-94mb7         1/1     Running   6 (20h ago)   14d

NAME                               READY   AGE
statefulset.apps/app-python-helm   2/2     4m17s
statefulset.apps/vault             1/1     14d

NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
service/app-python-helm              ClusterIP   10.105.53.110   <none>        8001/TCP            4m17s
service/go-app-app-go-helm           ClusterIP   10.101.69.68    <none>        8002/TCP            21h
service/kubernetes                   ClusterIP   10.96.0.1       <none>        443/TCP             20d
service/python-app-app-python-helm   ClusterIP   10.104.36.23    <none>        8001/TCP            3d21h
service/vault                        ClusterIP   10.98.41.68     <none>        8200/TCP,8201/TCP   14d
service/vault-agent-injector-svc     ClusterIP   10.99.176.178   <none>        443/TCP             14d
service/vault-internal               ClusterIP   None            <none>        8200/TCP,8201/TCP   14d

NAME                                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/app-python-visits-app-python-helm-0   Bound    pvc-2eac42ee-a097-41eb-8398-588233d5549a   2Gi        RWO            standard       <unset>                 4m17s
persistentvolumeclaim/app-python-visits-app-python-helm-1   Bound    pvc-94c80647-fad4-4677-9fbc-acaa55debeed   2Gi        RWO            standard       <unset>                 4m17s
```

### Check the content of file in each pod

```bash
kubectl exec pods/app-python-helm-0 -- cat visits/visits-py.txt \
          && echo \
          && kubectl exec pods/app-python-helm-1 -- cat visits/visits-py.txt

217
284
```

As we can see, the number of visits is different in each pod. This is because the pods are stateful and have their own persistent storage. The data is stored in the PVC, which is bound to the pods.

### Persistent Storage Validation

```bash
kubectl delete pod app-python-helm-0

pod "app-python-helm-0" deleted
```

```bash
kubectl get pvc
NAME                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
app-python-visits-app-python-helm-0   Bound    pvc-2eac42ee-a097-41eb-8398-588233d5549a   2Gi        RWO            standard       <unset>                 17m
app-python-visits-app-python-helm-1   Bound    pvc-94c80647-fad4-4677-9fbc-acaa55debeed   2Gi        RWO            standard       <unset>                 17m
```

```bash
kubectl exec pods/app-python-helm-0 -- cat visits/visits-py.txt

227
```

As we can see, the data is still available in the PVC even after deleting the pod. This demonstrates the persistence of data in a StatefulSet.

Number of visits increasing in the background because of liveness/readiness probes.

### Headless Service Access

```bash
kubectl exec app-python-helm-0 -- nslookup app-python-helm-1.app-python-helm.default.svc.cluster.local

Server:		10.96.0.10
Address:	10.96.0.10:53

Name:	app-python-helm-1.app-python-helm.default.svc.cluster.local
Address: 10.244.1.239

```

```bash
kubectl exec app-python-helm-1 -- nslookup app-python-helm-0.app-python-helm.default.svc.cluster.local

Server:		10.96.0.10
Address:	10.96.0.10:53

Name:	app-python-helm-0.app-python-helm.default.svc.cluster.local
Address: 10.244.1.240
```

### Monitoring & Alerts

I have liveness and readiness probes configured in `values.yaml`:

```yaml
livenessProbe:
  httpGet:
    path: /
    port: http
readinessProbe:
  httpGet:
    path: /
    port: http
```

Probes check the health of the pods by sending HTTP requests to the specified path and port.

If the probes fail:
- The pod is restarted (liveness probe).
- The pod will not receive traffic (readiness probe).

Probes are critical for stateful apps because they ensure that the pods are healthy and ready to serve traffic.
This is important for maintaining the availability and reliability of stateful applications.

### Ordering Guarantee and Parallel Operations

Ordering guarantees are unnecessary for my app because the app does not require strict ordering of operations between pods.
Each pod is stateful and has its own persistent storage, so the order of operations does not matter.
There is no dependency between the pods, and they can operate independently.

## Bonus Task

### Apply StatefulSet to Bonus App

```bash
kubectl get po,sts,svc,pvc

NAME                                              READY   STATUS              RESTARTS      AGE
pod/app-go-helm-0                                 0/1     ContainerCreating   0             9s
pod/app-python-helm-0                             1/1     Running             0             18m
pod/app-python-helm-1                             1/1     Running             0             35m
pod/go-app-app-go-helm-68c6df86b4-45h5x           1/1     Running             1 (20h ago)   21h
pod/python-app-app-python-helm-766b5c48f6-8rrcb   1/1     Running             1 (20h ago)   23h
pod/python-app-app-python-helm-766b5c48f6-kdx2r   1/1     Running             1 (20h ago)   23h
pod/vault-0                                       1/1     Running             6 (20h ago)   14d
pod/vault-agent-injector-66f45b5fd5-94mb7         1/1     Running             6 (20h ago)   14d

NAME                               READY   AGE
statefulset.apps/app-go-helm       0/1     9s
statefulset.apps/app-python-helm   2/2     35m
statefulset.apps/vault             1/1     14d

NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
service/app-go-helm                  ClusterIP   10.108.205.7    <none>        8002/TCP            9s
service/app-python-helm              ClusterIP   10.105.53.110   <none>        8001/TCP            35m
service/go-app-app-go-helm           ClusterIP   10.101.69.68    <none>        8002/TCP            21h
service/kubernetes                   ClusterIP   10.96.0.1       <none>        443/TCP             20d
service/python-app-app-python-helm   ClusterIP   10.104.36.23    <none>        8001/TCP            3d21h
service/vault                        ClusterIP   10.98.41.68     <none>        8200/TCP,8201/TCP   14d
service/vault-agent-injector-svc     ClusterIP   10.99.176.178   <none>        443/TCP             14d
service/vault-internal               ClusterIP   None            <none>        8200/TCP,8201/TCP   14d

NAME                                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/app-go-visits-app-go-helm-0           Bound    pvc-898ab3ce-c412-4f77-8007-7d8792178b86   2Gi        RWO            standard       <unset>                 9s
persistentvolumeclaim/app-python-visits-app-python-helm-0   Bound    pvc-2eac42ee-a097-41eb-8398-588233d5549a   2Gi        RWO            standard       <unset>                 35m
persistentvolumeclaim/app-python-visits-app-python-helm-1   Bound    pvc-94c80647-fad4-4677-9fbc-acaa55debeed   2Gi        RWO            standard       <unset>                 35m
```

## Update Strategies

### `OnDelete` vs. `RollingUpdate`

- `OnDelete`: Old pods are deleted only after new ones are running, ensuring no downtime.
  - Use Case: Best when you need control over pod deletion.

- `RollingUpdate`: Gradually replaces old pods with new ones, keeping the service available.
  - Use Case: Ideal for zero-downtime updates.

### Comparison with `Recreate`

- `Recreate`: Deletes all old pods before creating new ones, causing downtime.
  - Use Case: Suitable when downtime is acceptable.
  - Difference: `RollingUpdate` avoids downtime, while `Recreate` doesn't.
