# StatefulSet Implementation

## Initial Setup and Verification

### Resource Status
```bash
$ kubectl get pods,sts,svc,pvc
NAME                    READY   STATUS    RESTARTS   AGE
pod/myapp-stateful-0   1/1     Running   0          10m
pod/myapp-stateful-1   1/1     Running   0          10m
pod/myapp-stateful-2   1/1     Running   0          10m

NAME                              READY   AGE
statefulset.apps/myapp-stateful   3/3     10m

NAME                     TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
service/myapp-service    NodePort    10.96.x.x    <none>        8000:30001/TCP   1m
service/myapp-headless   ClusterIP   None         <none>        8000/TCP   10m

NAME                                     STATUS   VOLUME   CAPACITY   ACCESS MODES   AGE
persistentvolumeclaim/data-myapp-stateful-0   Bound    ...      1Gi        RWO            1m
persistentvolumeclaim/data-myapp-stateful-1   Bound    ...      1Gi        RWO            1m
persistentvolumeclaim/data-myapp-stateful-2   Bound    ...      1Gi        RWO            1m
```

### Health Checks
The StatefulSet includes both liveness and readiness probes:
- Liveness probe: Checks if the application is running
- Readiness probe: Ensures the application is ready to receive traffic
```yaml
livenessProbe:
  httpGet:
    path: /
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /
    port: 8000
  initialDelaySeconds: 5
  periodSeconds: 10
```

### Persistent Storage
Each pod in the StatefulSet has its own persistent volume:
- Volume mounted at `/data`
- Size: 1Gi
- Access Mode: ReadWriteOnce

### DNS Resolution
StatefulSet pods have predictable DNS names:
```bash
$ kubectl exec myapp-stateful-0 -- nslookup myapp-stateful-0.myapp-headless
```

## Testing

### DNS Resolution Test Results
```bash
$ kubectl exec myapp-stateful-0 -- nslookup myapp-stateful-1.myapp-headless
Server:         10.96.0.10
Address:        10.96.0.10#53

Name:   myapp-stateful-1.myapp-headless.default.svc.cluster.local
Address: 10.244.0.98
```

### Pod-to-Pod Communication Test
```bash
$ kubectl exec myapp-stateful-0 -- wget myapp-stateful-1.myapp-headless:8000
--2025-03-10 00:24:42--  http://myapp-stateful-1.myapp-headless:8000/
HTTP request sent, awaiting response... 200 OK
Length: 49 [text/html]
```

### Visit Counter Test Results
```bash
# Check visit counters in different pods showing individual state
$ kubectl exec myapp-stateful-0 -- cat /data/visits.txt
132

$ kubectl exec myapp-stateful-1 -- cat /data/visits.txt
126

$ kubectl exec myapp-stateful-2 -- cat /data/visits.txt
115
```

### Key Findings
1. DNS Resolution:
   - Each pod has a stable DNS name
   - Pods can resolve each other by DNS names
   - Format: `<pod-name>.<service-name>.default.svc.cluster.local`

2. State Management:
   - Each pod maintains its own visit counter
   - Counters persist across pod restarts
   - Independent state per pod demonstrated

3. Network Communication:
   - Direct pod-to-pod communication works
   - Headless service enables DNS-based discovery
   - HTTP services accessible between pods

### StatefulSet Features
1. Stable Network Identity:
   - Each pod has a predictable hostname
   - Pods are accessible via: `<pod-name>.<service-name>`

2. Persistent Storage:
   - Each pod has its own PVC
   - Data persists across pod restarts

3. Health Monitoring:
   - Liveness probe checks application health
   - Readiness probe ensures service availability

### Pod Management Policy
```yaml
spec:
  podManagementPolicy: Parallel  # Allows parallel pod operations
```

## Testing Results

### Persistence Test
- Individual counters per pod
- Counter values persist across pod restarts
- Each pod maintains its own state

### Network Identity Test
Each pod is accessible through its stable network identity:
- myapp-stateful-0.myapp-headless
- myapp-stateful-1.myapp-headless
- myapp-stateful-2.myapp-headless

### Service Access
- NodePort service exposes application on port 30001
- Headless service enables direct pod access
- Load balancing across all pods

### Pod Deletion Test
```bash
# Delete a pod and verify data persistence
$ kubectl delete pod myapp-stateful-0
$ kubectl get pods
$ kubectl exec myapp-stateful-0 -- cat /data/visits.txt
``` 