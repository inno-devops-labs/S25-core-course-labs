# Stateful Set

I followed tutorial and completed `helm install`. I have defined 
`podManagementPolicy` as Parallel and `volumeClaimTemplates`
 in `statefulset.yaml` and moved parameters to `values.yaml`

```
$ kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS              RESTARTS      AGE
pod/js-app-d54cb5949-fmwpp                  1/1     Running             0             41m
pod/python-app-0                            0/1     ContainerCreating   0             9s
pod/python-app-1                            0/1     ContainerCreating   0             9s
pod/python-app-2                            0/1     ContainerCreating   0             9s
pod/python-app-d99d949f4-64jh9              1/1     Running             0             41m
pod/python-app-d99d949f4-9pfpk              1/1     Running             0             41m
pod/vault-0                                 1/1     Running             8 (49m ago)   11d
pod/vault-agent-injector-66f45b5fd5-dzmw9   1/1     Running             8             11d

NAME                          READY   AGE
statefulset.apps/python-app   0/3     10s
statefulset.apps/vault        1/1     11d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/js-app                     ClusterIP   10.101.194.242   <none>        3000/TCP            41m
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             11d
service/python-app                 ClusterIP   10.110.250.191   <none>        5000/TCP            10s
service/vault                      ClusterIP   10.106.60.87     <none>        8200/TCP,8201/TCP   11d
service/vault-agent-injector-svc   ClusterIP   10.106.180.175   <none>        443/TCP             11d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   11d

NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/python-pvc-python-app-0   Bound    pvc-028a856f-9025-4cfe-97ce-9c1cfc5ec861   100Mi      RWO            standard       <unset>                 10s
persistentvolumeclaim/python-pvc-python-app-1   Bound    pvc-25f355a2-feda-4040-a068-af00a0c9b16f   100Mi      RWO            standard       <unset>                 9s
persistentvolumeclaim/python-pvc-python-app-2   Bound    pvc-06c01dc3-98ae-4cb1-a977-eaefd5d55bef   100Mi      RWO            standard       <unset>                 9s
```

## Accessing app

Command `minikube service python-app` returned me an address of my app. I openned it in different
tabs and reloaded page several times

![get visits](./readme_images/statefulset/exec_visits.png)

Because of the balancer work, different requests come to different pods to split the load. Each pod
has unique volume `data` for storing `visits` with the number of request, therefore each pod has
its own `visits` file that is not equal to such files in different pods.

## Delete pod

![delete pod](./readme_images/statefulset/persistent_storage.png)

After deletion, pod was successfully recreated.

## Headless service access

Initial command doesn't work for me:
```
$ kubectl exec python-app-0 -- nslookup python-app-1.python-app
;; Got recursion not available from 10.96.0.10
;; Got recursion not available from 10.96.0.10
;; Got recursion not available from 10.96.0.10
Server:		10.96.0.10
Address:	10.96.0.10#53

** server can't find python-app-1.python-app: NXDOMAIN

command terminated with exit code 1
```

However, we can use:


## Liveness and Readiness probes

Inside `values.yaml` both `livenessProbe` and `readinessProbe` are already defined and pointing to
`/` of the app. They are crutial to indicate whether the container is ready and health to apply
some actions on it. For example, even the previous step required one firstly to check if 
a container is ready or not yet.

## Ordering of pods

Some order is needed in case if one pod depends on another. For example, one pod is considered as the
main one, what other pods could somehow use. However, in our case all 3 pods are independent from each
other and hence can be started in parallel.


# Bonus

### Complited same steps for `js-app`

```
$ kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS    RESTARTS       AGE
pod/js-app-0                                0/1     Running   0              17s
pod/js-app-d54cb5949-fmwpp                  1/1     Running   1 (109m ago)   3h22m
pod/python-app-0                            1/1     Running   0              34m
pod/python-app-1                            1/1     Running   0              34m
pod/python-app-2                            1/1     Running   0              34m
pod/python-app-d99d949f4-64jh9              1/1     Running   1 (109m ago)   3h22m
pod/python-app-d99d949f4-9pfpk              1/1     Running   1 (109m ago)   3h22m
pod/vault-0                                 1/1     Running   9 (109m ago)   11d
pod/vault-agent-injector-66f45b5fd5-dzmw9   1/1     Running   9 (109m ago)   11d

NAME                          READY   AGE
statefulset.apps/js-app       0/1     17s
statefulset.apps/python-app   3/3     35m
statefulset.apps/vault        1/1     11d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/js-app                     ClusterIP   10.100.197.172   <none>        3000/TCP            17s
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             11d
service/python-app                 ClusterIP   10.103.35.145    <none>        5000/TCP            35m
service/vault                      ClusterIP   10.106.60.87     <none>        8200/TCP,8201/TCP   11d
service/vault-agent-injector-svc   ClusterIP   10.106.180.175   <none>        443/TCP             11d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   11d

NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/js-pvc-js-app-0           Bound    pvc-9a4bbf64-839a-4561-8221-d1773ea71efe   100Mi      RWO            standard       <unset>                 17s
persistentvolumeclaim/python-pvc-js-app-0       Bound    pvc-0e3bfe46-26ec-4bec-a027-daf6eb31b4be   100Mi      RWO            standard       <unset>                 2m6s
persistentvolumeclaim/python-pvc-python-app-0   Bound    pvc-028a856f-9025-4cfe-97ce-9c1cfc5ec861   100Mi      RWO            standard       <unset>                 160m
persistentvolumeclaim/python-pvc-python-app-1   Bound    pvc-25f355a2-feda-4040-a068-af00a0c9b16f   100Mi      RWO            standard       <unset>                 160m
persistentvolumeclaim/python-pvc-python-app-2   Bound    pvc-06c01dc3-98ae-4cb1-a977-eaefd5d55bef   100Mi      RWO            standard       <unset>                 160m
```

### Update strategies

Implemented `RollingUpdate`

#### onDelete

Pods are updated only when they were manually deleted. This helps to prevent automatic update of 
pods (if needed manual control)

#### RollingUpdate

Needed for stateful applications where pods should be updated in a specific order (in reverse 
order from the highest ordinal to the lowest). `partition` defines means only pods with greater
or equal ordinal will be updated
