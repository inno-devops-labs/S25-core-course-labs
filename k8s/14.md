# Lab 14: Kubernetes StatefulSet | Mametov Eldar
In this report, you will see all my steps to successfully complete lab 14.


## Task 1: Implement StatefulSet in Helm Chart
I have studied the documentation and adapted my code by statefulset. You can see the change in the code files

```
lekski@LAPTOP-EA8M0FT5:/mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s$ helm install --dry-run --debug my-web-app ./web-apps
install.go:225: 2025-03-14 16:59:03.918372538 +0300 MSK m=+1.827746236 [debug] Original chart version: ""
install.go:242: 2025-03-14 16:59:03.925078402 +0300 MSK m=+1.834452171 [debug] CHART PATH: /mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s/web-apps

NAME: my-web-app
LAST DEPLOYED: Fri Mar 14 16:59:06 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: lekski/python-web-app
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: true
  hosts:
  - host: new-python-web-app.local
    paths:
    - path: /
      pathType: Prefix
  tls: []
livenessProbe:
  failureThreshold: 3
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 5
mylibchart:
  affinity: {}
  autoscaling:
    enabled: false
    maxReplicas: 100
    minReplicas: 1
    targetCPUUtilizationPercentage: 80
  fullnameOverride: ""
  global: {}
  image:
    pullPolicy: IfNotPresent
    repository: nginx
    tag: ""
  imagePullSecrets: []
  ingress:
    annotations: {}
    className: ""
    enabled: false
    hosts:
    - host: chart-example.local
      paths:
      - path: /
        pathType: ImplementationSpecific
    tls: []
  livenessProbe:
    httpGet:
      path: /
      port: http
  nameOverride: ""
  nodeSelector: {}
  podAnnotations: {}
  podLabels: {}
  podSecurityContext: {}
  readinessProbe:
    httpGet:
      path: /
      port: http
  replicaCount: 1
  resources: {}
  securityContext: {}
  service:
    port: 80
    type: ClusterIP
  serviceAccount:
    annotations: {}
    automount: true
    create: true
    name: ""
  tolerations: []
  volumeMounts: []
  volumes: []
nameOverride: ""
nodeSelector: {}
password: my-secret-password
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
  vault.hashicorp.com/agent-inject-template-database-config.txt: |
    {{- with secret "internal/data/database/config" -}}
    postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
    {{- end -}}
  vault.hashicorp.com/role: web-apps
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 5
replicaCount: 1
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi
securityContext: {}
service:
  port: 8000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: web-apps
tolerations: []
useStatefulSet: true
volumeMounts: []
volumes: []

HOOKS:
---
# Source: web-apps/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       # "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: post-install-container
    image: busybox:latest
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: web-apps/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
       "helm.sh/hook": "pre-install"
       # "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: pre-install-container
    image: busybox:latest
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: web-apps/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "my-web-app-web-apps-test-connection"
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['my-web-app-web-apps:8000']
  restartPolicy: Never
MANIFEST:
---
# Source: web-apps/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: web-apps
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: web-apps/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: credentials
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  password: "bXktc2VjcmV0LXBhc3N3b3Jk"
---
# Source: web-apps/templates/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-apps-config
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
data:
  config.json: |-

    {
        "myname": "Eldar"
    }
---
# Source: web-apps/templates/service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-web-app-web-apps-headless
  labels:
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: 1.16.0
    app.kubernetes.io/managed-by: Helm
spec:
  clusterIP: None
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
---
# Source: web-apps/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-web-app-web-apps
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
---
# Source: web-apps/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-web-app-web-apps
  labels:
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: 1.16.0
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: my-web-app-web-apps-headless
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: web-apps
      app.kubernetes.io/instance: my-web-app
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
        vault.hashicorp.com/agent-inject-template-database-config.txt: |
          {{- with secret "internal/data/database/config" -}}
          postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
          {{- end -}}
        vault.hashicorp.com/role: web-apps
      labels:
        helm.sh/chart: web-apps-0.1.0
        app.kubernetes.io/name: web-apps
        app.kubernetes.io/instance: my-web-app
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: web-apps
      containers:
        - name: web-apps
          image: "lekski/python-web-app:latest"
          imagePullPolicy: IfNotPresent
          env:
          - name: MY_PASSWORD
            valueFrom:
              secretKeyRef:
                name: credentials
                key: password
          - name: STUDENT
            value: "Eldar Mametov"
          envFrom:
          - configMapRef:
              name: web-apps-config
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 60
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 60
            periodSeconds: 5
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: data
              mountPath: /data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
---
# Source: web-apps/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-web-app-web-apps
  labels:
    helm.sh/chart: web-apps-0.1.0
    app.kubernetes.io/name: web-apps
    app.kubernetes.io/instance: my-web-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  rules:
    - host: "new-python-web-app.local"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: my-web-app-web-apps
                port:
                  number: 8000

NOTES:
1. Get the application URL by running these commands:
  http://new-python-web-app.local/
```

```
lekski@LAPTOP-EA8M0FT5:/mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s$ helm install my-web-app ./web-apps
NAME: my-web-app
LAST DEPLOYED: Fri Mar 14 16:59:58 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  http://new-python-web-app.local/
```

```
lekski@LAPTOP-EA8M0FT5:/mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s$ curl http://new-python-web-app.local/
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./static/css/main.css">
    <title>Moscow</title>
</head>
<body>
    <div class="time">
        <h1 id='main_text'>MSC Time</h1>
        <h1 id='msc-time'>14-03-2025 17:02:23</h1>
    </div>
</body>
</html>
```
**Conclusion**: by the terminal output above we can see that statefulset settings have been applied and the site has successfully deployed and is available for opening.

## Task 2
### Task 2.1 Research and Documentation
```
lekski@LAPTOP-EA8M0FT5:/mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s$ kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS      RESTARTS       AGE
pod/my-web-app-web-apps-0                   2/2     Running     0              7m43s
pod/postinstall-hook                        0/1     Completed   0              7m40s
pod/preinstall-hook                         0/1     Completed   0              8m14s
pod/python-app-web-apps-55d87457cc-g7f86    1/2     Running     0              69s
pod/python-app-web-apps-55d87457cc-kp4lx    1/2     Running     0              69s
pod/vault-0                                 1/1     Running     11 (72m ago)   11d
pod/vault-agent-injector-66f45b5fd5-t9x62   1/1     Running     25             11d

NAME                                   READY   AGE
statefulset.apps/my-web-app-web-apps   1/1     7m44s
statefulset.apps/vault                 1/1     11d

NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/helm-hooks-release-web-apps    ClusterIP   10.97.254.224    <none>        8000/TCP            18d
service/kubernetes                     ClusterIP   10.96.0.1        <none>        443/TCP             18d
service/my-web-app-web-apps            ClusterIP   10.100.96.60     <none>        8000/TCP            7m44s
service/my-web-app-web-apps-headless   ClusterIP   None             <none>        8000/TCP            7m44s
service/vault                          ClusterIP   10.106.252.247   <none>        8200/TCP,8201/TCP   11d
service/vault-agent-injector-svc       ClusterIP   10.96.170.185    <none>        443/TCP             11d
service/vault-internal                 ClusterIP   None             <none>        8200/TCP,8201/TCP   11d

NAME                                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-my-web-app-web-apps-0   Bound    pvc-9b1ea2c9-4538-4976-915b-48428cf0e5a4   1Gi        RWO            standard       <unset>                 62m
```

```
lekski@LAPTOP-EA8M0FT5:/mnt/c/Users/Honor/Desktop/S25-core-course-labs/k8s$ minikube service my-web-app-web-apps 
|-----------|---------------------|-------------|--------------|
| NAMESPACE |        NAME         | TARGET PORT |     URL      |
|-----------|---------------------|-------------|--------------|
| default   | my-web-app-web-apps |             | No node port |
|-----------|---------------------|-------------|--------------|
😿  service default/my-web-app-web-apps has no node port
❗  Services [default/my-web-app-web-apps] have type "ClusterIP" not meant to be exposed, however for local development minikube allows you to access this !
🏃  Starting tunnel for service my-web-app-web-apps.
|-----------|---------------------|-------------|------------------------|
| NAMESPACE |        NAME         | TARGET PORT |          URL           |
|-----------|---------------------|-------------|------------------------|
| default   | my-web-app-web-apps |             | http://127.0.0.1:42641 |
|-----------|---------------------|-------------|------------------------|
🎉  Opening service default/my-web-app-web-apps in default browser...
👉  http://127.0.0.1:42641
❗  Because you are using a Docker driver on linux, the terminal needs to be open to run it.
```

![alt text](image-8.png)

**I had problems with my main computer, so I switched to a second laptop. The data used is the same and I followed the same steps as before.**


```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ minikube service my-web-app-web-apps
|-----------|---------------------|-------------|--------------|
| NAMESPACE |        NAME         | TARGET PORT |     URL      |
|-----------|---------------------|-------------|--------------|
| default   | my-web-app-web-apps |             | No node port |
|-----------|---------------------|-------------|--------------|
😿  service default/my-web-app-web-apps has no node port
❗  Services [default/my-web-app-web-apps] have type "ClusterIP" not meant to be exposed, however for local development minikube allows you to access this !
🏃  Starting tunnel for service my-web-app-web-apps.
|-----------|---------------------|-------------|------------------------|
| NAMESPACE |        NAME         | TARGET PORT |          URL           |
|-----------|---------------------|-------------|------------------------|
| default   | my-web-app-web-apps |             | http://127.0.0.1:46883 |
|-----------|---------------------|-------------|------------------------|
🎉  Opening service default/my-web-app-web-apps in default browser...
Error: Failed to open Wayland display, fallback to X11. WAYLAND_DISPLAY='wayland-0' DISPLAY=':1'
❗  Because you are using a Docker driver on linux, the terminal needs to be open to run it.
```
I went to the home page and reloaded it several times to bring up the count of the number of visits to the site

```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs]
└─$ kubectl exec -it my-web-app-web-apps-0 -- cat /app/visits/visits
22                                                                                                                                   
```

### Task 2.2 Persistent Storage Validation
Now we're going to check out our persistent storage that we've configured. To do this, I'm going to delete the pod we've accessed so far and check the data in the persistent storage that was supposed to store the value of site visits.
```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs]
└─$ kubectl delete pod my-web-app-web-apps-0                        
pod "my-web-app-web-apps-0" deleted
```

```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs]
└─$ kubectl get pvc                         
NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-my-web-app-web-apps-0   Bound    pvc-64194b76-a578-4c77-89dd-324340915aae   1Gi        RWO            standard       <unset>                 2m39s
```

```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs]
└─$ kubectl exec -it my-web-app-web-apps-0 -- cat /app/visits/visits
22        
```
As we can see, the values are preserved and we still have access to them after deleting the pod
### Task 2.3 Headless Service Access
```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs]
└─$ kubectl exec my-web-app-web-apps-0 -- nslookup my-web-app-web-apps-0.my-web-app-web-apps-headless.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-web-app-web-apps-0.my-web-app-web-apps-headless.default.svc.cluster.local
Address: 10.244.0.26
```

### Task 2.4 Monitoring & Alerts
liveness/readiness are already in our values.yaml and apply to our web application. 

liveness/readiness are critical for statefulset. Probes checks if our web application is available on the `/` path and also on port 8000. 
Liveness checks its availability and if it is not available (it started incorrectly or an error occurred during startup), it restarts the pod and readiness stops services whose pods are not ready for traffic to ensure that the web application is available for incoming traffic.

### Task 2.5 Ordering Guarantee and Parallel Operations
In the statefulset of my web application, I added `podManagementPolicy: Parallel`. Since my python web application does not require a strict startup order, we can apply parallel startup to it. To test this, I set `replicaCount: 2`.
```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ kubectl get po
NAME                                       READY   STATUS      RESTARTS   AGE
ingress-nginx-controller-cd9d6bbd7-vlnf9   1/1     Running     0          82m
my-web-app-web-apps-0                      0/1     Running     0          31s
my-web-app-web-apps-1                      0/1     Running     0          31s
postinstall-hook                           0/1     Completed   0          23m
preinstall-hook                            0/1     Completed   0          23m
```

```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ kubectl get po
NAME                                       READY   STATUS      RESTARTS   AGE
ingress-nginx-controller-cd9d6bbd7-vlnf9   1/1     Running     0          82m
my-web-app-web-apps-0                      1/1     Running     0          1m24s
my-web-app-web-apps-1                      1/1     Running     0          1m24s
postinstall-hook                           0/1     Completed   0          23m
preinstall-hook                            0/1     Completed   0          23m
```

Summary: As you can see, both pods initialized and started together, without waiting for one pod to start the other.

## Bonus Task
Similarly with my Python web application I adapted my additional golang web application to statefulset. Below you can see the results of this update and proof of its robustness. 

I also added this code for `Rolling Updates` to statefulset.yaml:
```
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 1
```


```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ kubectl get po,sts,svc,pvc                 
NAME                                                READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-controller-cd9d6bbd7-vlnf9        1/1     Running     0          111m
pod/my-golang-app-golang-web-app-0                  1/1     Running     0          87s
pod/my-golang-app-golang-web-app-54dcb6874d-v5gfx   1/1     Running     0          87s
pod/postinstall-hook                                0/1     Completed   0          51m
pod/preinstall-hook                                 0/1     Completed   0          52m

NAME                                            READY   AGE
statefulset.apps/my-golang-app-golang-web-app   1/1     87s

NAME                                            TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/ingress-nginx-controller                LoadBalancer   10.103.94.201    <pending>     80:32149/TCP,443:31987/TCP   111m
service/ingress-nginx-controller-admission      ClusterIP      10.108.192.112   <none>        443/TCP                      111m
service/kubernetes                              ClusterIP      10.96.0.1        <none>        443/TCP                      119m
service/my-golang-app-golang-web-app            ClusterIP      10.104.49.221    <none>        8000/TCP                     87s
service/my-golang-app-golang-web-app-headless   ClusterIP      None             <none>        8000/TCP                     87s

NAME                                                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-my-golang-app-golang-web-app-0   Bound    pvc-e05ece7c-2200-4581-8319-a75d024cc2aa   1Gi        RWO            standard       <unset>                 87s
```

![alt text](image-9.png)


```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ curl http://golang-web-app     
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./static/css/main.css">
    <title>RandNumber web application</title>
</head>
<body>
    <div class="number">
        <h1 id='main_text'>Random Number:</h1>
        <h1 id='main_text'>95</h1>
        <button onclick="location.reload()">Refresh Page</button>
    </div>
</body>
</html>                                                                                                                                                                                 
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ curl http://golang-web-app/visits
<!DOCTYPE html>
<html>
<head>
    <title>Visits Count</title>
</head>
<body>
    <h1>Visits Count:</h1>
    <p><b style="color: black;">105</b></p>
</body>
</html>                            
```

```
┌──(nothere㉿nothere)-[~/Desktop/S25-core-course-labs/k8s]
└─$ kubectl exec -it my-golang-app-golang-web-app-0 -- cat /visits       
105
```

Explain OnDelete, RollingUpdate, and their use cases: 
- **OnDelete**: Updates under only if we deleted it, which gives us more control. 
- **RollingUpdate**: Automatically updates pods with control over their update order.

Deployment update strategies: 
- **Deployment**: used to quickly bring the system to the desired state. Replaces old pods with new ones without additional work with them. Used for stateless. 
- **StatefulSet**: Pods are updated in order, since we may have dependencies (like a database). The pods are fully checked to make sure they work. Runs slower as it has more control over the pods. Used in Statefulset.