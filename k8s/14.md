
# Stateful sets

```bash
$ kubectl get po,sts,svc,pvc
NAME                                READY   STATUS    RESTARTS   AGE
pod/app-go-chart-app-go-0           1/1     Running   0          5m36s
pod/app-go-chart-app-go-1           1/1     Running   0          5m36s
pod/app-python-chart-app-python-0   1/1     Running   0          29s
pod/app-python-chart-app-python-1   1/1     Running   0          29s

NAME                                           READY   AGE
statefulset.apps/app-go-chart-app-go           2/2     5m36s
statefulset.apps/app-python-chart-app-python   2/2     29s

NAME                                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/app-go-chart-app-go           ClusterIP   10.106.3.86      <none>        8080/TCP   5m36s
service/app-python-chart-app-python   ClusterIP   10.102.214.192   <none>        8080/TCP   29s
service/kubernetes                    ClusterIP   10.96.0.1        <none>        443/TCP    5m53s

NAME                                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/app-go-data-app-go-chart-app-go-0               Bound    pvc-bba3e5a6-5437-4e3e-8762-32ffd8675739   10M        RWO            standard       <unset>                 5m36s
persistentvolumeclaim/app-go-data-app-go-chart-app-go-1               Bound    pvc-0279e278-ae93-44f3-9df6-4358179855b3   10M        RWO            standard       <unset>                 5m36s
persistentvolumeclaim/app-python-data-app-python-chart-app-python-0   Bound    pvc-bd7dc161-3e37-45a8-9e6b-4138c4afd1cd   10M        RWO            standard       <unset>                 2m9s
persistentvolumeclaim/app-python-data-app-python-chart-app-python-1   Bound    pvc-91367572-a6e5-4211-a5a4-8a4784268ca2   10M        RWO            standard       <unset>                 29s
```

Lets drop some pod!

```bash
$ kubectl delete pod app-python-chart-app-python-0
pod "app-python-chart-app-python-0" deleted

$ kubectl get po,sts,svc,pvc
NAME                                READY   STATUS    RESTARTS   AGE
pod/app-go-chart-app-go-0           1/1     Running   0          31m
pod/app-go-chart-app-go-1           1/1     Running   0          31m
pod/app-python-chart-app-python-0   0/1     Running   0          10s
pod/app-python-chart-app-python-1   1/1     Running   0          25m
```

Check out pvc:

```bash
$ kubectl get pvc
NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
app-go-data-app-go-chart-app-go-0               Bound    pvc-bba3e5a6-5437-4e3e-8762-32ffd8675739   10M        RWO            standard       <unset>                 31m
app-go-data-app-go-chart-app-go-1               Bound    pvc-0279e278-ae93-44f3-9df6-4358179855b3   10M        RWO            standard       <unset>                 31m
app-python-data-app-python-chart-app-python-0   Bound    pvc-bd7dc161-3e37-45a8-9e6b-4138c4afd1cd   10M        RWO            standard       <unset>                 28m
app-python-data-app-python-chart-app-python-1   Bound    pvc-91367572-a6e5-4211-a5a4-8a4784268ca2   10M        RWO            standard       <unset>                 26m
```

See, storages remain, and data from all previous operation time also persists there.

get the number of visits:

```bash
$ kubectl exec app-python-chart-app-python-1 -- cat /data/visits.txt
87

$ kubectl exec app-python-chart-app-python-0 -- cat /data/visits.txt
92
```

They differ because i used them with different pace, and these numbers are large because of liveness probe, that accesses the root quite often.

## DNS resolution

```bash
$ kubectl exec app-python-chart-app-python-0 -- nslookup app-python-chart-app-python-1.app-python-chart-app-python.default.svc.cluster.local

Server:     10.96.0.10
Address:    10.96.0.10:53


Name:   app-python-chart-app-python.default.svc.cluster.local
Address: 10.244.1.120
```

## Monitoring and alerts

I've always had these set up

```yaml
livenessProbe:
  httpGet:
    path: /
    port: http
readinessProbe:
  httpGet:
    path: /
    port: http
```

Liveness probes are crusial for stateful apps, since they check wether up is alive, and if not, they will trigger a restart. Downtime for stateful apps is very bad since services may get out of sync or lose data.

## Ordering guarantees

Ordering does not matter in this app, because pods do not depend on each other. Like there is no leader that other pods need to operate with. They are independent and may start separately, in parallel.

```yaml
  podManagementPolicy: "Parallel"
```

## RollingUpdate, OnDelete

Rolling updates ensure no downtime of the app. It is typically for apps
that bring no data inconsistency in case of rolling updates.

OnDelete strategy implies possible
downtime, since it is for delecate cases, where manual deletion of pods is needed.

On the other hand, deployment is a stateless app, like a web server it was before we added `/visits` endpoint. And thus it supports two strategies

RollingUpdate (default) – gradual updates with zero downtime

Recreate – full restart of all pods at once
