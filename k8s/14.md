## Lab 14
### Artem Volkonitin, a.volkonitin@innopolis.university
```
utkanos@Ubuntu:~/S25-core-course-labs/k8s$ cd ~/S25-core-course-labs/k8s/moscow-time-app
helm install --dry-run --debug my-app .
install.go:225: 2025-04-29 17:33:16.188633748 +0300 MSK m=+0.070365978 [debug] Original chart version: ""
install.go:242: 2025-04-29 17:33:16.188698501 +0300 MSK m=+0.070430710 [debug] CHART PATH: /home/utkanos/S25-core-course-labs/k8s/moscow-time-app

NAME: my-app
LAST DEPLOYED: Tue Apr 29 17:33:16 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 5
  minReplicas: 2
  targetCPUUtilizationPercentage: 80
image:
  pullPolicy: IfNotPresent
  repository: utkanosss/moscow-time-app
  tag: latest
ingress:
  annotations: {}
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - /
  tls: []
livenessProbe:
  enabled: false
  httpGet:
    path: /healthz
    port: http
nodeSelector: {}
persistence:
  size: 1Gi
podAnnotations: {}
podLabels: {}
readinessProbe:
  enabled: false
  httpGet:
    path: /ready
    port: http
replicaCount: 3
resources:
  limits:
    cpu: "1"
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi
secret:
  password: secret123
service:
  port: 80
  targetPort: 8000
  type: NodePort
serviceAccount:
  annotations: {}
  create: false
  name: ""
tolerations: []
volumeMounts: []
volumes: []

HOOKS:
---
# Source: moscow-time-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "my-app-moscow-time-app-test-connection"
  labels:
    helm.sh/chart: moscow-time-app-0.1.0
    app.kubernetes.io/name: moscow-time-app
    app.kubernetes.io/instance: my-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['my-app-moscow-time-app:80']
  restartPolicy: Never
---
# Source: moscow-time-app/templates/post-install-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: post-install-hook
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": hook-succeeded 
spec:
  template:
    spec:
      containers:
        - name: sleep
          image: busybox
          command: ['sleep', '5']
      restartPolicy: Never
---
# Source: moscow-time-app/templates/pre-install-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pre-install-hook
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      containers:
        - name: sleep
          image: busybox
          command: ['sleep', '5']
      restartPolicy: Never
MANIFEST:
---
# Source: moscow-time-app/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-app-secret
type: Opaque
data:
  MY_PASS: c2VjcmV0MTIz
---
# Source: moscow-time-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-app-moscow-time-app
  labels:
    helm.sh/chart: moscow-time-app-0.1.0
    app.kubernetes.io/name: moscow-time-app
    app.kubernetes.io/instance: my-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
      app.kubernetes.io/name: moscow-time-app
      app.kubernetes.io/instance: my-app
---
# Source: moscow-time-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-app-moscow-time-app
  labels:
    helm.sh/chart: moscow-time-app-0.1.0
    app.kubernetes.io/name: moscow-time-app
    app.kubernetes.io/instance: my-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: my-app-moscow-time-app
  replicas: 3
  podManagementPolicy: Parallel   # Можно убрать, если хотите OrderedReady
  selector:
    matchLabels:
      app.kubernetes.io/name: moscow-time-app
      app.kubernetes.io/instance: my-app
  template:
    metadata:
      labels:
        app.kubernetes.io/name: moscow-time-app
app.kubernetes.io/instance: my-app
    spec:
      terminationGracePeriodSeconds: 10
      containers:
        - name: moscow-time-app
          image: "utkanosss/moscow-time-app:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: my-app-moscow-time-app
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services my-app-moscow-time-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```

```
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ helm install my-app .
NAME: my-app
LAST DEPLOYED: Tue Apr 29 17:34:04 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services my-app-moscow-time-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```
```
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ kubectl get po,sts,svc,pvc
NAME                                              READY   STATUS    RESTARTS      AGE
pod/my-app-moscow-time-app-0                      1/1     Running   0             30s
pod/my-app-moscow-time-app-1                      1/1     Running   0             30s
pod/my-app-moscow-time-app-2                      1/1     Running   0             30s
pod/python-app-moscow-time-app-5cbf9ccc58-2gxt9   1/1     Running   1 (80m ago)   38h
pod/python-app-moscow-time-app-5cbf9ccc58-78wfs   1/1     Running   1 (80m ago)   38h
pod/python-app-moscow-time-app-5cbf9ccc58-chwhc   1/1     Running   1 (80m ago)   38h
pod/python-app-moscow-time-app-5cbf9ccc58-fbnkz   1/1     Running   1 (80m ago)   38h
pod/python-app-moscow-time-app-5cbf9ccc58-t865w   1/1     Running   1 (80m ago)   38h

NAME                                      READY   AGE
statefulset.apps/my-app-moscow-time-app   3/3     30s

NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/kubernetes                   ClusterIP   10.96.0.1       <none>        443/TCP        40h
service/my-app-moscow-time-app       NodePort    10.98.131.229   <none>        80:30674/TCP   30s
service/python-app-moscow-time-app   NodePort    10.101.58.182   <none>        80:31486/TCP   38h

NAME                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-my-app-moscow-time-app-0   Bound    pvc-fa40e02a-57ea-4684-83d2-efcce93f2334   1Gi        RWO            standard       <unset>                 65m
persistentvolumeclaim/data-my-app-moscow-time-app-1   Bound    pvc-a4785bd7-6132-4d8e-9372-217f36d1254f   1Gi        RWO            standard       <unset>                 65m
persistentvolumeclaim/data-my-app-moscow-time-app-2   Bound    pvc-d9398e56-7394-430d-9999-107a306ca82d   1Gi        RWO            standard       <unset>                 65m
```
```
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ kubectl exec my-app-moscow-time-app-0 -- cat /data/visits
kubectl exec my-app-moscow-time-app-1 -- cat /data/visits
kubectl exec my-app-moscow-time-app-2 -- cat /data/visits
Visit count: 1
Visit count: 2
Visit count: 3
```
```
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ kubectl delete pod my-app-moscow-time-app-0
pod "my-app-moscow-time-app-0" deleted
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ kubectl exec my-app-moscow-time-app-0 -- cat /data/visits
Visit count: 1
utkanos@Ubuntu:~/S25-core-course-labs/k8s/moscow-time-app$ kubectl get pvc
NAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
data-my-app-moscow-time-app-0   Bound    pvc-fa40e02a-57ea-4684-83d2-efcce93f2334   1Gi        RWO            standard       <unset>                 68m
data-my-app-moscow-time-app-1   Bound    pvc-a4785bd7-6132-4d8e-9372-217f36d1254f   1Gi        RWO            standard       <unset>                 68m
data-my-app-moscow-time-app-2   Bound    pvc-d9398e56-7394-430d-9999-107a306ca82d   1Gi        RWO            standard       <unset>                 68m
```
