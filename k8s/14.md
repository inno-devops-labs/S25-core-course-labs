# Kubernetes StatefulSet

## StatefulSet Resources

### Deployed Resources:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl get po,sts,svc,pvc
NAME                                          READY   STATUS      RESTARTS      AGE
pod/app-python-stateful-0                     1/1     Running     0             3m
pod/app-python-stateful-1                     1/1     Running     0             3m
pod/python-app-app-python-a477cg07d5-782db    1/1     Running     1 (9m ago)   56m
pod/python-app-app-python-a477cg07d5-3bk5v    1/1     Running     1 (9m ago)   56m
pod/python-app-pre-install-hook               0/1     Completed   0             55m

NAME                                    READY   AGE
statefulset.apps/app-python-stateful    2/2     3m

NAME                                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
service/kubernetes                      ClusterIP      10.107.0.1       <none>        80/TCP          17d
service/app-python-stateful             ClusterIP      10.107.213.27    <none>        80/TCP          3m
service/app-python-stateful-headless    ClusterIP      None             <none>        80/TCP          3m
service/python-app-app-python           ClusterIP      10.107.213.19    <none>        80/TCP          90m

NAME                                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-app-python-stateful-0         Bound    pvc-7n63gj54-22a7-1nd3-gh36-acd70ceg33cd   1Gi        RWO            standard       <unset>                 3m
persistentvolumeclaim/data-app-python-stateful-1         Bound    pvc-1b7c25b7-fd18-41b4-31e7-d9489df5ad67   1Gi        RWO            standard       <unset>                 3m
persistentvolumeclaim/app-python-stateful-visits-pvc     Bound    pvc-2c3df6c8-fe29-4c25-b2f8-e0590ef66778   1Gi        RWO            standard       <unset>                 90m
```

### Accessing the Application:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ minikube service app-python-stateful
|-----------|----------------------|-------------|---------------------------|
| NAMESPACE |         NAME         | TARGET PORT |            URL            |
|-----------|----------------------|-------------|---------------------------|
| default   | app-python-stateful  | http/8000   | http://192.168.49.2:12477 |
|-----------|----------------------|-------------|---------------------------|
üèÉ  Starting tunnel for service app-python-stateful.
|-----------|----------------------|-------------|------------------------|
| NAMESPACE |         NAME         | TARGET PORT |          URL           |
|-----------|----------------------|-------------|------------------------|
| default   | app-python-stateful  |             | http://127.0.0.1:86342 |
|-----------|----------------------|-------------|------------------------|
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ curl http://127.0.0.1:86342/time
{"time":"18:53:13"}
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ curl http://127.0.0.1:86342/visits
{"visits":16}
```

## 2. Persistent Storage Validation

### Initial state of visits:

The number of visits varies for each module because the state sets provide stable, unique network identifiers and permanent storage for each module. Each module maintains its own state independently.

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -n dev app-python-stateful-0 -- cat /data/visits
8
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -n dev app-python-stateful-1 -- cat /data/visits
16
```

### Testing Persistence After Pod Deletion:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl delete pod -n dev app-python-stateful-0
pod "app-python-stateful-0" deleted
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl get pvc -n dev
NAME                                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-app-python-stateful-0         Bound    pvc-7n63gj54-22a7-1nd3-gh36-acd70ceg33cd   1Gi        RWO            standard       <unset>                 23m
persistentvolumeclaim/data-app-python-stateful-1         Bound    pvc-1b7c25b7-fd18-41b4-31e7-d9489df5ad67   1Gi        RWO            standard       <unset>                 23m
persistentvolumeclaim/app-python-stateful-visits-pvc     Bound    pvc-2c3df6c8-fe29-4c25-b2f8-e0590ef66778   1Gi        RWO            standard       <unset>                 110m
```

```bash
fory@pop-os:~/devops-labs/S25-core-course-labs$ kubectl get pods -n dev
NAME                                          READY   STATUS      RESTARTS      AGE
pod/app-python-stateful-0                     1/1     Running     0             55m
pod/app-python-stateful-1                     1/1     Running     0             25m
pod/python-app-app-python-a477cg07d5-782db    1/1     Running     1 (34m ago)   81m
pod/python-app-app-python-a477cg07d5-3bk5v    1/1     Running     1 (34m ago)   81m
pod/python-app-pre-install-hook               0/1     Completed   0             80m
```

The data was retained even after the module was deleted and recreated. This demonstrates the persistent storage capabilities of StatefulSets.

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -n dev app-python-stateful-0 -- cat /data/visits
16
```

## 3. Headless Service DNS Resolution

The headless service enables you to directly identify the DNS addresses of specific modules by their names using status parameters. For every module, this guarantees consistent network identification; this is essential for distributed systems in which modules must interact directly with particular nodes.

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec app-python-stateful-0 -- sh -c "nslookup app-python-stateful-1.app-python-stateful-headless.default.svc.cluster.local"
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   app-python-stateful-1.mapp-python-stateful-headless.default.svc.cluster.local
Address: 10.244.0.67
```

## 4. Monitoring and Health Checks

### Importance of Probes for Stateful 

- **Data Integrity:** Stateful applications often handle critical data. Liveness probes ensure that if an application becomes unresponsive, it is restarted before any data corruption occurs.

- **Coordinated Recovery:** Readiness probes block traffic from reaching pods that are not prepared to process requests, which is particularly crucial when pods are restoring state from persistent storage.

- **Preventing Cascading Failures:** In distributed stateful applications, a single unhealthy node can cause issues for others. Probes assist in isolating and recovering problematic instances.

- **Graceful Handling of State:** Stateful applications usually require time to save data to disk or finish transactions. Well-configured probes allow applications the necessary time to manage their state before being restarted.
    
### `liveness` and `readiness` probes in the StatefulSet:

```yaml
livenessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3
```

## 5. Parallel Pod Management

### Explanation

Strict ordering guarantees are not required for this application, since each module retains its own independent state, modules are independent during initialization, and there is no primary-secondary relationship between modules. Therefore, the use of parallel module management provides a number of advantages:

- **Improved accessibility:** Multiple modules can be updated in parallel during the upgrade.
- **Faster scaling:** modules can be created or completed at the same time.
- **Reduced deployment time:** The initial deployment is faster because the modules do not wait for the previous ones to appear.

### StatefulSet:

```yaml
podManagementPolicy: Parallel
```

