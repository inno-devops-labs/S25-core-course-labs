# Kubernetes StatefulSet

## Implement StatefulSet in Helm Chart

Everything is implemented according to tutorial.

## StatefulSet Exploration and Optimization

Required outputs:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> helm install flask-release .\flask-app\
NAME: flask-release
LAST DEPLOYED: Thu Mar 13 18:00:26 2025
STATUS: deployed
REVISION: 1
NOTES:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=flask-app,app.kubernetes.io/instance=flask-release" -o jsonpath="{.items[0].metadata.name}")    
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po,sts,svc,pvc
NAME                            READY   STATUS    RESTARTS   AGE
pod/flask-release-flask-app-0   1/1     Running   0          3m22s
pod/flask-release-flask-app-1   1/1     Running   0          3m22s

NAME                                       READY   AGE
statefulset.apps/flask-release-flask-app   2/2     3m27s

NAME                              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/flask-release-flask-app   ClusterIP   10.110.20.244   <none>        80/TCP    3m27s
service/kubernetes                ClusterIP   10.96.0.1       <none>        443/TCP   5h1m

NAME                                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/flask-app-volt-flask-release-flask-app-0   Bound    pvc-69185912-0667-4674-ad8b-919903190932   512Mi      RWO            standard       <unset>               
  4h59m
persistentvolumeclaim/flask-app-volt-flask-release-flask-app-1   Bound    pvc-d780695f-d20d-45f2-bb1f-da563f289b33   512Mi      RWO            standard       <unset>               
  4h59m

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl exec pod/flask-release-flask-app-0 -- cat /data/access_count.txt
3528

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl exec pod/flask-release-flask-app-1 -- cat /data/access_count.txt
3524

```

### Pod deletion and data persistence validation

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl delete pod/flask-release-flask-app-0
pod "flask-release-flask-app-0" deleted

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl delete pod/flask-release-flask-app-1
pod "flask-release-flask-app-1" deleted

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get pvc
NAME                                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
flask-app-volt-flask-release-flask-app-0   Bound    pvc-69185912-0667-4674-ad8b-919903190932   512Mi      RWO            standard       <unset>                 5h1m
flask-app-volt-flask-release-flask-app-1   Bound    pvc-d780695f-d20d-45f2-bb1f-da563f289b33   512Mi      RWO            standard       <unset>                 5h1m

```

### Headless Service Access

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl exec flask-release-flask-app-0 -- nslookup flask-release-flask-app-1.flask-release-flask-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   flask-release-flask-app-1.flask-release-flask-app.default.svc.cluster.local
Address: 10.244.0.19

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl exec flask-release-flask-app-1 -- nslookup flask-release-flask-app-0.flask-release-flask-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   flask-release-flask-app-0.flask-release-flask-app.default.svc.cluster.local
Address: 10.244.0.18

```

### How Probes Keep Pods Healthy

Liveness Probe: Checks if the app inside the pod is alive. If the app crashes or freezes (like in a deadlock), Kubernetes restarts the container automatically.
Example: A simple HTTP check to /health endpoint.

Readiness Probe: Checks if the pod is ready to serve traffic. If not ready (e.g., still starting up), Kubernetes stops sending requests to it.
Example: Wait for a database pod to finish loading data before allowing connections.

### Why Probes Matter for Stateful Apps

Liveness Probes: Stateful apps (like databases) can’t afford silent failures. Restarting a stuck pod keeps the app available.

Readiness Probes: Stateful apps often need time to start (e.g., loading data). This prevents traffic from hitting pods that aren’t fully set up.

### Why Ordering Isn’t Needed

My app’s Pods work independently—they don’t rely on each other’s state or data. Since requests are evenly spread across Pods by the load balancer, starting or deleting Pods in a specific order doesn’t affect performance. For example, if Pod 0 starts before Pod 1, it doesn’t matter because they handle traffic separately.

### How to Run Pods in Parallel

To launch or delete all Pods simultaneously (instead of one-by-one), I configured the StatefulSet’s podManagementPolicy to Parallel. This tells Kubernetes to ignore the usual “start Pod 0 first, then Pod 1” rule, speeding up scaling and updates.

## Bonus

Implemented for bonus app:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s>  helm install ktor-app .\ktor-app\
NAME: ktor-app
LAST DEPLOYED: Thu Mar 13 22:00:21 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=ktor-app,app.kubernetes.io/instance=ktor-app" -o jsonpath="{.items[0].metadata.name}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po,sts,svc,pvc
NAME                            READY   STATUS    RESTARTS   AGE
pod/flask-release-flask-app-0   1/1     Running   0          4h8m
pod/flask-release-flask-app-1   1/1     Running   0          4h8m
pod/ktor-app-0                  1/1     Running   0          13m
pod/ktor-app-1                  1/1     Running   0          13m

NAME                                       READY   AGE
statefulset.apps/flask-release-flask-app   2/2     4h13m
statefulset.apps/ktor-app                  2/2     13m

NAME                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/flask-release-flask-app   ClusterIP   10.110.20.244    <none>        80/TCP    4h13m
service/ktor-app                  ClusterIP   10.101.219.133   <none>        80/TCP    13m
service/kubernetes                ClusterIP   10.96.0.1        <none>        443/TCP   9h

NAME                                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/flask-app-volt-flask-release-flask-app-0   Bound    pvc-69185912-0667-4674-ad8b-919903190932   512Mi      RWO            standard       <unset>                 9h
persistentvolumeclaim/flask-app-volt-flask-release-flask-app-1   Bound    pvc-d780695f-d20d-45f2-bb1f-da563f289b33   512Mi      RWO            standard       <unset>                 9h
persistentvolumeclaim/flask-app-volt-ktor-app-0                  Bound    pvc-aa9b1c10-0310-4c2a-a2fa-7f363439d72c   1Gi        RWO            standard       <unset>                 18m
persistentvolumeclaim/flask-app-volt-ktor-release-ktor-app-0     Bound    pvc-429efd16-f5c8-42fb-ae1c-b0e789ab3a35   1Gi        RWO            standard       <unset>                 3h17m
persistentvolumeclaim/ktor-app-volt-ktor-app-0                   Bound    pvc-b58f5938-c11a-4f7b-abdd-b052d030936c   1Gi        RWO            standard       <unset>                 13m
persistentvolumeclaim/ktor-app-volt-ktor-app-1                   Bound    pvc-f289a4dd-e4ef-4c0a-a354-7949d455a82d   1Gi        RWO            standard       <unset>                 13m

```

### Explanation StatefulSet vs. Deployment

### StatefulSet Strategies

`OnDelete:`

Behavior: pods are not updated automatically. We must manually delete old pods to trigger replacements with the new version.

Use cases: critical stateful apps (e.g. databases) where updates need careful control.

`RollingUpdate (Default):`

Behavior: pods are updated one-by-one in reverse order (e.g. pod-2 → pod-1 → pod-0). Supports partitions (partition: N to update pods with index >=N first).

Use cases: gradual rollouts for stateful apps (e.g. canary testing with partition).

### Deployment Strategies

`Recreate:`

Behavior: kills all old Pods first, then creates new ones. Causes downtime during the transition.

Use cases: stateless apps that can tolerate downtime (e.g., simple web apps).

`RollingUpdate (Default):`

Behavior: updates pods incrementally (old and new pods coexist temporarily). Uses maxSurge/maxUnavailable to control parallelism.

Use cass: zero-downtime updates for stateless apps (e.g. APIs).
