# Lab 13: GitOps Deployment with ArgoCD

## Task 1: Deploy and Configure ArgoCD

### Step 1: Install ArgoCD via Helm
### Step 2: Install ArgoCD CLI
### Step 3: Access the ArgoCD UI
Forward the ArgoCD server port:
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```
Retrieve admin password:
```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
```
Login via CLI:
```bash
> kubectl port-forward svc/argo-argocd-server -n argocd 8080:443                     
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
```
### Step 4: Deploy Python App with ArgoCD
Create `argocd-python-app.yaml`.
Apply it:
```bash
> kubectl apply -f ArgoCD/argocd-python-app.yaml
application.argoproj.io/python-app configured
```
Verify:
```bash
> argocd app sync python-app

TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME     STATUS   HEALTH        HOOK  MESSAGE
2025-03-11T12:57:13+03:00          ConfigMap         default            app-config     Synced                       
2025-03-11T12:57:13+03:00             Secret         default             my-secret     Synced                       
2025-03-11T12:57:13+03:00            Service         default  python-app-app-python    Synced  Healthy              
2025-03-11T12:57:13+03:00         ServiceAccount     default  python-app-app-python    Synced                       
2025-03-11T12:57:13+03:00   apps  Deployment         default  python-app-app-python    Synced  Healthy              
2025-03-11T12:57:14+03:00                Pod     default       preinstall-hook                                 
2025-03-11T12:57:16+03:00                Pod     default       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-11T12:57:38+03:00         ServiceAccount     default  python-app-app-python    Synced                        serviceaccount/python-app-app-python unchanged
2025-03-11T12:57:38+03:00             Secret         default             my-secret     Synced                        secret/my-secret unchanged
2025-03-11T12:57:38+03:00          ConfigMap         default            app-config     Synced                        configmap/app-config unchanged
2025-03-11T12:57:38+03:00            Service         default  python-app-app-python    Synced   Healthy              service/python-app-app-python unchanged
2025-03-11T12:57:38+03:00   apps  Deployment         default  python-app-app-python    Synced   Healthy              deployment.apps/python-app-app-python unchanged
2025-03-11T12:57:38+03:00                Pod         default       preinstall-hook   Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-11T12:57:39+03:00                Pod     default      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-11T12:57:59+03:00                Pod     default      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (397ff35)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      397ff3535207cb66b87c2b757731027488609449
Phase:              Succeeded
Start:              2025-03-11 12:57:13 +0300 MSK
Finished:           2025-03-11 12:57:59 +0300 MSK
Duration:           46s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook        Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-app-python  Synced                        serviceaccount/python-app-app-python unchanged
       Secret          default    my-secret              Synced                        secret/my-secret unchanged
       ConfigMap       default    app-config             Synced                        configmap/app-config unchanged
       Service         default    python-app-app-python  Synced     Healthy            service/python-app-app-python unchanged
apps   Deployment      default    python-app-app-python  Synced     Healthy            deployment.apps/python-app-app-python unchanged
       Pod             default    postinstall-hook       Succeeded           PostSync  pod/postinstall-hook created
```
```bash
> argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (397ff35)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook        Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-app-python  Synced                        serviceaccount/python-app-app-python unchanged
       Secret          default    my-secret              Synced                        secret/my-secret unchanged
       ConfigMap       default    app-config             Synced                        configmap/app-config unchanged
       Service         default    python-app-app-python  Synced     Healthy            service/python-app-app-python unchanged
apps   Deployment      default    python-app-app-python  Synced     Healthy            deployment.apps/python-app-app-python unchanged
       Pod             default    postinstall-hook       Succeeded           PostSync  pod/postinstall-hook created
```
Pods now:
```bash
> kubectl get po 
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-app-python-58c79b59f7-5bv7s   1/1     Running   0             7m1s
```
I modify values.yaml, commit, and push changes. Pods after updating the repo:
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Tue Mar 11, 13:15]
└─[$] <git:(lab13)> kubectl get po 
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-app-python-58c79b59f7-5bv7s   1/1     Running   0             23m
python-app-app-python-58c79b59f7-xkmkf   1/1     Running   0             3m24s
```
---

## Task 2: Multi-Environment Deployment & Auto-Sync

### Step 1: Create Namespaces
```bash
> kubectl create namespace dev
namespace/dev created
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Tue Mar 11, 13:24]
└─[$] <git:(lab13*)> kubectl create namespace prod
namespace/prod created
```
### Step 2: Deploy Multi-Environment Configurations
Apply environment-specific configurations:
```bash
> kubectl apply -f ArgoCD/argocd-python-dev.yaml
kubectl apply -f ArgoCD/argocd-python-prod.yaml
application.argoproj.io/python-app-dev created
application.argoproj.io/python-app-prod created
```

### Step 3: Enable Auto-Sync
Modify `values-prod.yaml`, commit, and push changes. Verify auto-sync:
```bash
argocd app sync python-app-prod
argocd app status python-app-prod
```

### Step 4: Test Self-Healing
#### Test 1: Change Replica Count
```bash
kubectl patch deployment python-app-prod -n prod --patch '{"spec":{"replicas": 3}}'
```
Observe ArgoCD auto-reverting:
```bash
argocd app sync python-app-prod
argocd app status python-app-prod
```

#### Test 2: Delete a Pod
```bash
kubectl delete pod -n prod -l app.kubernetes.io/name=python-app
```
Check pod recreation:
```bash
kubectl get pods -n prod -w
```
Check ArgoCD status:
```bash
argocd app diff python-app-prod
```

---

## Task 3: Documentation
### ArgoCD Sync Status Before and After Changes
#### Before Pod Deletion:
```bash
kubectl get pods -n prod
```
Output:
```
NAME                        READY   STATUS    RESTARTS   AGE
python-app-prod-xyz123      1/1     Running   0          10m
```

#### After Pod Deletion:
```bash
kubectl delete pod -n prod -l app.kubernetes.io/name=python-app
kubectl get pods -n prod
```
Output:
```
NAME                        READY   STATUS    RESTARTS   AGE
python-app-prod-abc456      1/1     Running   0          1m
```

### Explanation of Self-Healing Mechanism
- **Drift detection:** ArgoCD continuously monitors the live state vs. the desired state in Git.
- **Runtime changes:** If a manual change (e.g., `kubectl patch`) occurs, ArgoCD reverts it back to the Git-specified state.
- **Self-healing:** When a pod is deleted, Kubernetes recreates it based on the deployment definition, ensuring service availability.

---

## Bonus Task: Deploy Bonus App with ArgoCD
```bash
kubectl apply -f ArgoCD/argocd-bonus-app.yaml
kubectl get pods -n <namespace>
```
Verify sync:
```bash
argocd app sync bonus-app
argocd app status bonus-app
```