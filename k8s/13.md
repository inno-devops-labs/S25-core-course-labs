## Lab 13: ArgoCD Implementation

### Task 1: Deploy and Configure ArgoCD

1. #### **ArgoCD and CLI Installation**

```bash
$ helm install argo argo/argo-cd --namespace argocd --create-namespace  

NAME: argo
LAST DEPLOYED: Sun Mar 16 19:32:48 2025
NAMESPACE: argocd
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
In order to access the server UI you have the following options:

1. kubectl port-forward service/argo-argocd-server -n argocd 8080:443

    and then open the browser on http://localhost:8080 and accept the certificate

2. enable ingress in the values file `server.ingress.enabled` and either
      - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough
      - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts


 with username: admin and the random password generated during the installation. You can find the password by running:

kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

(You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)
```

```bash
$ kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
pod/argo-argocd-server-85f8dbdd5-sb629 condition met
```

```bash
$ argocd version
argocd: v2.14.5+f463a94
  BuildDate: 2025-03-11T03:40:10Z
  GitCommit: f463a945d57267e9691cede37021d9ddc5994f36
  GitTreeState: clean
  GoVersion: go1.23.3
  Compiler: gc
  Platform: linux/amd64
```

2. #### **Access ArgoCD UI**

Forwarded the ArgoCD server port and logged in:

```bash
$ kubectl port-forward svc/argo-argocd-server -n argocd 8080:443
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
Handling connection for 8080
...
```

3. #### **Configure Python App Sync**
Created an ArgoCD application manifest (argocd-python-app.yaml).

Applied the configuration:

```bash
$ kubectl apply -f k8s/ArgoCD/argocd-python-app.yaml
application.argoproj.io/python-app configured
```
Verified sync:

```bash
$ argocd app sync python-app
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS     HEALTH        HOOK  MESSAGE
2025-03-16T21:26:48+03:00         ServiceAccount     default            python-app    Synced
2025-03-16T21:26:48+03:00   apps  Deployment         default            python-app    OutOfSync  Healthy
2025-03-16T21:26:48+03:00          ConfigMap         default            app-config    Synced
2025-03-16T21:26:48+03:00             Secret         default            app-secret    Synced
2025-03-16T21:26:48+03:00            Service         default            python-app    Synced     Healthy
2025-03-16T21:26:48+03:00         ServiceAccount     default            python-app    Synced                         serviceaccount/python-app unchanged
2025-03-16T21:26:48+03:00             Secret         default            app-secret    Synced                         secret/app-secret unchanged
2025-03-16T21:26:48+03:00          ConfigMap         default            app-config    Synced                         configmap/app-config unchanged
2025-03-16T21:26:48+03:00            Service         default            python-app    Synced     Healthy             service/python-app unchanged
2025-03-16T21:26:48+03:00   apps  Deployment         default            python-app    OutOfSync  Healthy             deployment.apps/python-app configured

Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/sonyivanova/S25-devops-labs.git
  Target:           lab13
  Path:             k8s/python-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        OutOfSync from lab13 (dcdfc5b)
Health Status:      Healthy

Operation:          Sync

GROUP  KIND            NAMESPACE  NAME        STATUS     HEALTH   HOOK  MESSAGE
       ServiceAccount  default    python-app  Synced                    serviceaccount/python-app unchanged
       Secret          default    app-secret  Synced                    secret/app-secret unchanged
       ConfigMap       default    app-config  Synced                    configmap/app-config unchanged
       Service         default    python-app  Synced     Healthy        service/python-app unchanged
apps   Deployment      default    python-app  OutOfSync  Healthy        deployment.apps/python-app configured
```

### Task 2: Multi-Environment Deployment & Auto-Sync

1. #### **Multi-Environment Setup**
Created values-dev.yaml and values-prod.yaml for environment-specific configurations.

2. #### **Namespace Creation**
Created namespaces for dev and prod:

```bash
kubectl create namespace dev
kubectl create namespace prod
```

3. #### **Deploy Multi-Environment via ArgoCD**

Defined two ArgoCD applications (argocd-python-dev.yaml and argocd-python-prod.yaml).

Applied the configurations:

```bash
$ kubectl apply -f k8s/ArgoCD/argocd-python-dev.yaml
application.argoproj.io/python-app-dev configured

$ kubectl apply -f k8s/ArgoCD/argocd-python-prod.yaml
application.argoproj.io/python-app-prod configured
```

Verified sync:

```bash
$ argocd app sync python-app-dev
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS    HEALTH        HOOK  MESSAGE
2025-03-16T21:56:52+03:00          ConfigMap             dev            app-config    Synced
2025-03-16T21:56:52+03:00             Secret             dev            app-secret    Synced
2025-03-16T21:56:52+03:00            Service             dev        python-app-dev    Synced   Healthy
2025-03-16T21:56:52+03:00         ServiceAccount         dev        python-app-dev    Synced
2025-03-16T21:56:52+03:00   apps  Deployment             dev        python-app-dev  OutOfSync  Healthy
2025-03-16T21:56:53+03:00   apps  Deployment             dev        python-app-dev  OutOfSync  Healthy              deployment.apps/python-app-dev configured
2025-03-16T21:56:53+03:00         ServiceAccount         dev        python-app-dev    Synced                        serviceaccount/python-app-dev unchanged
2025-03-16T21:56:53+03:00             Secret             dev            app-secret    Synced                        secret/app-secret unchanged
2025-03-16T21:56:53+03:00          ConfigMap             dev            app-config    Synced                        configmap/app-config unchanged
2025-03-16T21:56:53+03:00            Service             dev        python-app-dev    Synced   Healthy              service/python-app-dev unchanged

Name:               argocd/python-app-dev
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          dev
URL:                https://argocd.example.com/applications/python-app-dev
Source:
- Repo:             https://github.com/sonyivanova/S25-devops-labs.git
  Target:           lab13
  Path:             k8s/python-app
  Helm Values:      values-dev.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        OutOfSync from lab13 (9bc8864)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      9bc886477e4ec1b258e2408cef49d34f333f6330
Phase:              Succeeded
Start:              2025-03-16 21:56:52 +0300 MSK
Finished:           2025-03-16 21:56:53 +0300 MSK
Duration:           1s
Message:            successfully synced (all tasks run)

GROUP  KIND            NAMESPACE  NAME            STATUS     HEALTH   HOOK  MESSAGE
       ServiceAccount  dev        python-app-dev  Synced                    serviceaccount/python-app-dev unchanged
       Secret          dev        app-secret      Synced                    secret/app-secret unchanged
       ConfigMap       dev        app-config      Synced                    configmap/app-config unchanged
       Service         dev        python-app-dev  Synced     Healthy        service/python-app-dev unchanged
apps   Deployment      dev        python-app-dev  OutOfSync  Healthy        deployment.apps/python-app-dev configured
```

```bash
$ argocd app sync python-app-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS    HEALTH        HOOK  MESSAGE
2025-03-16T21:57:54+03:00          ConfigMap            prod            app-config    Synced
2025-03-16T21:57:54+03:00             Secret            prod            app-secret    Synced
2025-03-16T21:57:54+03:00            Service            prod       python-app-prod    Synced   Healthy
2025-03-16T21:57:54+03:00         ServiceAccount        prod       python-app-prod    Synced
2025-03-16T21:57:54+03:00   apps  Deployment            prod       python-app-prod  OutOfSync  Healthy
2025-03-16T21:57:54+03:00         ServiceAccount        prod       python-app-prod    Synced                        serviceaccount/python-app-prod unchanged
2025-03-16T21:57:54+03:00             Secret            prod            app-secret    Synced                        secret/app-secret unchanged
2025-03-16T21:57:54+03:00          ConfigMap            prod            app-config    Synced                        configmap/app-config unchanged
2025-03-16T21:57:54+03:00            Service            prod       python-app-prod    Synced   Healthy              service/python-app-prod unchanged
2025-03-16T21:57:54+03:00   apps  Deployment            prod       python-app-prod  OutOfSync  Healthy              deployment.apps/python-app-prod configured

Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/sonyivanova/S25-devops-labs.git
  Target:           lab13
  Path:             k8s/python-app
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        OutOfSync from lab13 (9bc8864)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      9bc886477e4ec1b258e2408cef49d34f333f6330
Phase:              Succeeded
Start:              2025-03-16 21:57:54 +0300 MSK
Finished:           2025-03-16 21:57:54 +0300 MSK
Duration:           0s
Message:            successfully synced (all tasks run)

GROUP  KIND            NAMESPACE  NAME             STATUS     HEALTH   HOOK  MESSAGE
       ServiceAccount  prod       python-app-prod  Synced                    serviceaccount/python-app-prod unchanged
       Secret          prod       app-secret       Synced                    secret/app-secret unchanged
       ConfigMap       prod       app-config       Synced                    configmap/app-config unchanged
       Service         prod       python-app-prod  Synced     Healthy        service/python-app-prod unchanged
apps   Deployment      prod       python-app-prod  OutOfSync  Healthy        deployment.apps/python-app-prod configured
```

4. #### **Self-Heal Testing**

- Test 1: Manual Override of Replica Count

  Modified the deployment’s replica count manually:

  ```bash
  $ kubectl patch deployment python-app-prod -n prod --patch '{"spec":{"replicas": 1}}'
  deployment.apps/python-app-prod patched
  ```

  Observed ArgoCD auto-revert the change (due to `syncPolicy.automated`):

  ```bash
  $ argocd app get python-app-prod
  Name:               argocd/python-app-prod
  Project:            default
  Server:             https://kubernetes.default.svc
  Namespace:          prod
  URL:                https://argocd.example.com/applications/python-app-prod
  Source:
  - Repo:             https://github.com/sonyivanova/S25-devops-labs.git
    Target:           lab13
    Path:             k8s/python-app
    Helm Values:      values-prod.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated
  Sync Status:        OutOfSync from lab13 (9bc8864)
  Health Status:      Healthy

  GROUP  KIND            NAMESPACE  NAME             STATUS     HEALTH   HOOK  MESSAGE
        ServiceAccount  prod       python-app-prod  Synced                    serviceaccount/python-app-prod unchanged
        Secret          prod       app-secret       Synced                    secret/app-secret unchanged
        ConfigMap       prod       app-config       Synced                    configmap/app-config unchanged
        Service         prod       python-app-prod  Synced     Healthy        service/python-app-prod unchanged
  apps   Deployment      prod       python-app-prod  OutOfSync  Healthy        deployment.apps/python-app-prod configured
  ```

- Test 2: Delete a Pod (Replica)

  Deleted a pod in the prod namespace:

  ```bash
  $ kubectl get pods -n prod -w
  NAME                               READY   STATUS    RESTARTS   AGE
  python-app-prod-777477976c-nc5t8   1/1     Running   0          28s
  python-app-prod-777477976c-trtlr   1/1     Running   0          28s
  python-app-prod-777477976c-ts9tp   1/1     Running   0          28s
  ```

  ```bash
  $ kubectl delete pod -n prod -l app.kubernetes.io/name=python-app
  pod "python-app-prod-777477976c-nc5t8" deleted
  pod "python-app-prod-777477976c-trtlr" deleted
  pod "python-app-prod-777477976c-ts9tp" deleted
  ```

  Verified Kubernetes recreated the pod:

  ```bash
  $ kubectl get pods -n prod -w
  NAME                               READY   STATUS    RESTARTS   AGE
  python-app-prod-777477976c-j7tft   1/1     Running   0          57s
  python-app-prod-777477976c-lxqnt   1/1     Running   0          57s
  python-app-prod-777477976c-rh2rr   1/1     Running   0          57s
  ```

  Confirmed ArgoCD showed no drift:

  ```bash
  $ argocd app diff python-app-prod
  ```