# Lab 13: ArgoCD for GitOps Deployment

## Task 1: Deploy and Configure ArgoCD

### Access the ArgoCD UI

```bash
  > kubectl port-forward svc/argo-argocd-server -n argocd 8080:443

  Forwarding from 127.0.0.1:8080 -> 8080
  Forwarding from [::1]:8080 -> 8080
  Handling connection for 8080
  Handling connection for 8080
  Handling connection for 8080
  Handling connection for 8080
  Handling connection for 8080
  Handling connection for 8080
  ...
```

![ArgoCD UI](screenshots\argo-cd-ui.png)

### Configure Python App Sync

`argocd-python-app.yaml`:

```yaml
  apiVersion: argoproj.io/v1alpha1
  kind: Application
  metadata:
    name: python-app
    namespace: argocd
  spec:
    project: default
    source:
      repoURL: https://github.com/anyarylova/S25-core-course-labs.git
      targetRevision: lab13
      path: k8s/app-python-helm
      helm:
        valueFiles:
          - values.yaml
    destination:
      server: https://kubernetes.default.svc
      namespace: default
    syncPolicy:
      automated: {}
```

```bash
  > argocd app get python-app
  
  Name:               argocd/python-app
  Project:            default
  Server:             https://kubernetes.default.svc
  Namespace:          default
  URL:                https://argocd.example.com/applications/python-app
  Source:
  - Repo:             https://github.com/anyarylova/S25-core-course-labs.git
    Target:           lab13
    Path:             k8s/app-python-helm
    Helm Values:      values.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated
  -app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced      -app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced                        serviceaccount/python-app-app-python-helm unchanged
        Secret          default    helm-secret                             Synced                        secret/helm-secret unchanged
  -app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced                        serviceaccount/python-app-app-python-helm unchanged
        Secret          default    helm-secret                             Synced      -app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced                        serviceaccount/python-app-app-python-helm unchanged
  -app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced             ServiceAccount  default    python-app-app-python-helm              Synced                        serviceaccount/python-app-app-python-helm unchanged
                    serviceaccount/python-app-app-python-helm unchanged
        Secret          default    helm-secret                             Synced                        secret/helm-secret unchanged
        ConfigMap       default    python-app-app-python-helm-config       Synced                        configmap/python-app-app-python-helm-config unchanged
        Service         default    python-app-app-python-helm              Synced     Helm              Synced     Healthy            deployment.apps/python-app-app-python-helm unchanged
        Pod             default    python-app-app-python-helm-postinstall  Succeeded           PostSync  pod/python-app-app-python-helm-postinstall created
```

### Test Sync Workflow

`values.yaml` was modified, changes were commited and pushed to the target branch `lab13`.

![Values Commit](screenshots\values-commit.png)

ArgoCD auto-sync the update:

```bash
  > argocd app get python-app

  Name:               argocd/python-app
  Project:            default
  Server:             https://kubernetes.default.svc
  Namespace:          default
  URL:                https://argocd.example.com/applications/python-app
  Source:
  - Repo:             https://github.com/anyarylova/S25-core-course-labs.git
    Target:           lab13
    Path:             k8s/app-python-helm
    Helm Values:      values.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated
  Sync Status:        Synced to lab13 (519fce5)
  Health Status:      Healthy

  GROUP  KIND            NAMESPACE  NAME                                    STATUS     HEALTH   HOOK      MESSAGE
        Pod             default    python-app-app-python-helm-preinstall   Succeeded           PreSync   pod/python-app-app-python-helm-preinstall created
        ServiceAccount  default    python-app-app-python-helm              Synced                        serviceaccount/python-app-app-python-helm unchanged
        Secret          default    helm-secret                             Synced                        secret/helm-secret unchanged
        ConfigMap       default    python-app-app-python-helm-config       Synced                        configmap/python-app-app-python-helm-config unchanged
        Service         default    python-app-app-python-helm              Synced     Healthy            service/python-app-app-python-helm unchanged
  apps   Deployment      default    python-app-app-python-helm              Synced     Healthy            deployment.apps/python-app-app-python-helm unchanged
        Pod             default    python-app-app-python-helm-postinstall  Succeeded           PostSync  pod/python-app-app-python-helm-postinstall created
```

![App Python Sync](screenshots\app-python-sync.png)

## Task 2: Multi-Environment Deployment & Auto-Sync

### Deploy Multi-Environment via ArgoCD

![ArgoCD UI](screenshots\argo-cd-ui-apps.png)

`argocd-python-prod.yaml` (`argocd-python-dev.yaml` is similar)

```yaml
  apiVersion: argoproj.io/v1alpha1
  kind: Application
  metadata:
    name: python-app-prod
    namespace: argocd
  spec:
    project: default
    source:
      repoURL: https://github.com/anyarylova/S25-core-course-labs.git
      targetRevision: lab13
      path: k8s/app-python-helm
      helm:
        valueFiles:
          - values-prod.yaml
    destination:
      server: https://kubernetes.default.svc
      namespace: prod
    syncPolicy:
      automated: {}
```

`values-prod.yaml` (`values-dev.yaml` is similar)

```yaml
  replicaCount: 1

  image:
    repository: anyarylova/app_python
    pullPolicy: IfNotPresent
    tag: "latest"

  service:
    type: ClusterIP
    port: 80

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 100m
      memory: 128Mi

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
```

### Enable Auto-Sync

App Python Prod Sync:

![App Prod Sync](screenshots\prod-sync.png)

### Self-Heal Testing

**Explanation:** `Configuration Drift` occurs when the live configuration (manifests applied in the cluster) differs from what is declared in Git. For example, if someone manually changes a deployment’s replica count, ArgoCD will detect these differences during its sync checks. If auto-sync is enabled, ArgoCD will automatically revert the changes to match the Git configuration. `Runtime events` are not considered configuration drift. These events do not affect the configuration stored in Git. ArgoCD allows runtime events to occur without intervention.

#### Test 1: Manual Override of Replica Count

Modify the deployment’s replica count manually:

```bash
  > kubectl patch deployment python-app-prod-app-python-helm -n prod --patch "{\"spec\":{\"replicas\":2}}"

  deployment.apps/python-app-prod-app-python-helm patched
```

ArgoCD auto-reverted the change:

```bash
  > argocd app sync python-app-prod     

  TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME                           STATUS    HEALTH        HOOK  MESSAGE
  2025-03-16T21:05:48+03:00   apps  Deployment            prod  python-app-prod-app-python-helm              OutOfSync  Healthy
  2025-03-16T21:05:48+03:00          ConfigMap            prod  python-app-prod-app-python-helm-config         Synced
  2025-03-16T21:05:48+03:00                Pod            prod  python-app-prod-app-python-helm-postinstall
  2025-03-16T21:05:48+03:00                Pod            prod  python-app-prod-app-python-helm-preinstall
  2025-03-16T21:05:48+03:00             Secret            prod           helm-secret                           Synced
  2025-03-16T21:05:48+03:00            Service            prod  python-app-prod-app-python-helm                Synced   Healthy
  2025-03-16T21:05:48+03:00         ServiceAccount        prod  python-app-prod-app-python-helm                Synced
  2025-03-16T21:05:52+03:00                Pod        prod  python-app-prod-app-python-helm-preinstall   Running   Synced     PreSync  pod/python-app-prod-app-python-helm-preinstall created
  2025-03-16T21:06:16+03:00   apps  Deployment        prod  python-app-prod-app-python-helm    Synced  Progressing
  2025-03-16T21:06:17+03:00          ConfigMap            prod  python-app-prod-app-python-helm-config        Synced                            configmap/python-app-prod-app-python-helm-config unchanged
  2025-03-16T21:06:17+03:00            Service            prod  python-app-prod-app-python-helm               Synced   Healthy                  service/python-app-prod-app-python-helm unchanged
  2025-03-16T21:06:17+03:00   apps  Deployment            prod  python-app-prod-app-python-helm               Synced   Progressing              deployment.apps/python-app-prod-app-python-helm configured
  2025-03-16T21:06:17+03:00                Pod            prod  python-app-prod-app-python-helm-preinstall  Succeeded   Synced         PreSync  pod/python-app-prod-app-python-helm-preinstall created
  2025-03-16T21:06:17+03:00         ServiceAccount        prod  python-app-prod-app-python-helm               Synced                            serviceaccount/python-app-prod-app-python-helm unchanged
  2025-03-16T21:06:17+03:00             Secret            prod           helm-secret                          Synced                            secret/helm-secret unchanged
  2025-03-16T21:06:18+03:00   apps  Deployment        prod  python-app-prod-app-python-helm    Synced  Healthy              deployment.apps/python-app-prod-app-python-helm configured
  2025-03-16T21:06:18+03:00                Pod        prod  python-app-prod-app-python-helm-postinstall   Running   Synced    PostSync  pod/python-app-prod-app-python-helm-postinstall created
  2025-03-16T21:06:55+03:00                Pod        prod  python-app-prod-app-python-helm-postinstall  Succeeded   Synced    PostSync  pod/python-app-prod-app-python-helm-postinstall created

  Name:               argocd/python-app-prod
  Project:            default
  Server:             https://kubernetes.default.svc
  Namespace:          prod
  URL:                https://argocd.example.com/applications/python-app-prod
  Source:
  - Repo:             https://github.com/anyarylova/S25-core-course-labs.git
    Target:           lab13
    Path:             k8s/app-python-helm
    Helm Values:      values-prod.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated
  Sync Status:        Synced to lab13 (89a67e8)
  Health Status:      Healthy

  Operation:          Sync
  Sync Revision:      89a67e85e7639640697b08b302e59310551f5970
  Phase:              Succeeded
  Start:              2025-03-16 21:05:47 +0300 MSK
  Finished:           2025-03-16 21:06:55 +0300 MSK
  Duration:           1m8s
  Message:            successfully synced (no more tasks)

  GROUP  KIND            NAMESPACE  NAME                                         STATUS     HEALTH   HOOK      MESSAGE
        Pod             prod       python-app-prod-app-python-helm-preinstall   Succeeded           PreSync   pod/python-app-prod-app-python-helm-preinstall created     
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced                        serviceaccount/python-app-prod-app-python-helm unchanged   
        Secret          prod       helm-secret                                  Synced                        secret/helm-secret unchanged
        ConfigMap       prod       python-app-prod-app-python-helm-config       Synced                        configmap/python-app-prod-app-python-helm-config unchanged 
        Service         prod       python-app-prod-app-python-helm              Synced     Healthy            service/python-app-prod-app-python-helm unchanged
  apps   Deployment      prod       python-app-prod-app-python-helm              Synced     Healthy            deployment.apps/python-app-prod-app-python-helm configured 
        Pod             prod       python-app-prod-app-python-helm-postinstall  Succeeded           PostSync  pod/python-app-prod-app-python-helm-postinstall created    
```

```bash
  > argocd app get python-app-prod   

    Path:             k8s/app-python-helm
    Helm Values:      values-prod.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated
  Sync Status:        Synced to lab13 (89a67e8)
  Health Status:      Healthy

  GROUP  KIND            NAMESPACE  NAME                                         STATUS     HEALTH   HOOK      MESSAGE
        Pod             prod       python-app-prod-app-python-helm-preinstall   Succeeded           PreSync   pod/python-app-prod-app-python-helm-preinstall created
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced                        serviceaccount/python-app-prod-app-python-helm unchanged
  Health Status:      Healthy

  GROUP  KIND            NAMESPACE  NAME                                         STATUS     HEALTH   HOOK      MESSAGE
  GROUP  KIND            NAMESPACE  NAME                                         STATUS     HEALTH   HOOK      MESSAGE
    HEALTH   HOOK      MESSAGE
        Pod             prod       python-app-prod-app-python-helm-preinstall   Succeeded       Pod             prod       python-app-prod-app-python-helm-preinstall   Succeeded           PreSync   pod/python-app-prod-app-python-helm-preinstall created
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced                        serviceaccount/python-app-prod-app-python-helm unchanged
        Secret          prod       helm-secret                                  Synced              PreSync   pod/python-app-prod-app-python-helm-preinstall created
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced                        serviceaccount/python-app-prod-app-python-helm unchanged
        Secret          prod       helm-secret                                  Synced              PreSync   pod/python-app-prod-app-python-helm-preinstall created
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced                        serviceaccount/python-app-prod-app-python-helm unchanged
            PreSync   pod/python-app-prod-app-python-helm-preinstall created
        ServiceAccount  prod       python-app-prod-app-python-helm              Synced              PreSync   pod/python-app-prod-app-python-helm-preinstall created
                  configmap/python-app-prod-app-python-helm-config unchanged
        Service         prod       python-app-prod-app-python-helm              Synced     Healthy            service/python-app-prod-app-python-helm unchanged
  apps   Deployment      prod       python-app-prod-app-python-helm              Synced     Healthy            deployment.apps/python-app-prod-app-python-helm configured
        Pod             prod       python-app-prod-app-python-helm-postinstall  Succeeded           PostSync  pod/python-app-prod-app-python-helm-postinstall created
```

![Prod Test 1](screenshots\prod-test-1.png)

#### Test 2: Delete a Pod

Delete a pod in the `prod` namespace `python-app-prod-app-python-helm-788767c65d-8cwp5`:

```bash
  > kubectl get pod -n prod

  NAME                                               READY   STATUS      RESTARTS   AGE
  python-app-prod-app-python-helm-788767c65d-2l87z   1/1     Running     0          45m
  python-app-prod-app-python-helm-788767c65d-8cwp5   1/1     Running     0          4m54s
  python-app-prod-app-python-helm-788767c65d-t9jn4   1/1     Running     0          45m
  27s
  python-app-prod-app-python-helm-preinstall         0/1     Completed   0          7m55s
  27s
  python-app-prod-app-python-helm-preinstall         0/1     Completed   0          7m55s 
```

```bash
  > kubectl delete pod -n prod python-app-prod-app-python-helm-788767c65d-8cwp5

  pod "python-app-prod-app-python-helm-788767c65d-8cwp5" deleted
```

Kubernetes recreates the pod to match the deployment’s `replicaCount`. Created new pod `python-app-prod-app-python-helm-788767c65d-5t469`:

```bash
  > kubectl get pods -n prod -w

  python-app-prod-app-python-helm-788767c65d-2l87z   1/1     Running     0          49m
  python-app-prod-app-python-helm-788767c65d-5t469   1/1     Running     0          8s
  python-app-prod-app-python-helm-788767c65d-t9jn4   1/1     Running     0          49m
  python-app-prod-app-python-helm-postinstall        0/1     Completed   0          8m58s
  python-app-prod-app-python-helm-preinstall         0/1     Completed   0          9m26s
```

Confirm ArgoCD shows no drift:

```bash
  PS C:\S25-core-course-labs\k8s> argocd app diff python-app-prod
  PS C:\S25-core-course-labs\k8s> argocd app diff python-app-prod
  PS C:\S25-core-course-labs\k8s> 
```

![Prod Test 2](screenshots\prod-test-2.png)
