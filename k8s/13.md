# Lab 13

## Test 1: Manual Override of Replica Count

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs> kubectl scale deployment python-app-prod-myapp --replicas=2 -n prod
deployment.apps/python-app-prod-myapp scaled
```

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs> kubectl get deployment python-app-prod-myapp -n prod
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
python-app-prod-myapp   0/2     2            0           20m
```

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs> argocd app sync python-app-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME              
  STATUS    HEALTH            HOOK  MESSAGE
2025-03-11T13:29:44+03:00          ConfigMap            prod                config              
  Synced
2025-03-11T13:29:44+03:00                Pod            prod  python-app-prod-myapp-preinstall  

2025-03-11T13:29:44+03:00             Secret         default             my-secret              
OutOfSync
2025-03-11T13:29:44+03:00            Service            prod  python-app-prod-myapp             
  Synced   Healthy
2025-03-11T13:29:44+03:00         ServiceAccount        prod  python-app-prod-myapp             
  Synced
2025-03-11T13:29:44+03:00   apps  Deployment            prod  python-app-prod-myapp             
OutOfSync  Progressing
2025-03-11T13:29:45+03:00                Pod        prod  python-app-prod-myapp-preinstall    Failed  SyncFailed     PreSync  error when replacing "/dev/shm/1950387737": Pod "python-app-prod-myapp-preinstall" is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)
  core.PodSpec{
-    Volumes: []core.Volume{
-         {
-              Name:         "kube-api-access-v6q85",
-              VolumeSource: core.VolumeSource{Projected: &core.ProjectedVolumeSource{...}},    
-         },
-    },
+    Volumes:        nil,
     InitContainers: nil,
     Containers: []core.Container{
          {
               ... // 9 identical fields
               ResizePolicy:  nil,
               RestartPolicy: nil,
-              VolumeMounts: []core.VolumeMount{
-                   {
-                        Name:      "kube-api-access-v6q85",
-                        ReadOnly:  true,
-                        MountPath: "/var/run/secrets/kubernetes.io/serviceaccount",
-                   },
-              },
+              VolumeMounts:  nil,
               VolumeDevices: nil,
               LivenessProbe: nil,
               ... // 10 identical fields
          },
     },
     EphemeralContainers: nil,
     RestartPolicy:       "Never",
     ... // 2 identical fields
     DNSPolicy:                    "ClusterFirst",
     NodeSelector:                 nil,
-    ServiceAccountName:           "default",
+    ServiceAccountName:           "",
     AutomountServiceAccountToken: nil,
-    NodeName:                     "minikube",
+    NodeName:                     "",
     SecurityContext:              &{},
     ImagePullSecrets:             nil,
     ... // 20 identical fields
  }

Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/nikolaevaElizaveta/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/myapp
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        OutOfSync from lab13 (4866da9)
Health Status:      Progressing

Operation:          Sync
Sync Revision:      4866da956fa137459bb798c91f95d8d2f52b6f5f
Phase:              Failed
Start:              2025-03-11 13:29:44 +0300 MSK
Finished:           2025-03-11 13:29:45 +0300 MSK
Duration:           1s
Message:            one or more objects failed to apply, reason: error when replacing "/dev/shm/1950387737": Pod "python-app-prod-myapp-preinstall" is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)
  core.PodSpec{
-       Volumes: []core.Volume{
-               {
-                       Name:         "kube-api-access-v6q85",
-                       VolumeSource: core.VolumeSource{Projected: &core.ProjectedVolumeSource{...}},
-               },
-       },
+       Volumes:        nil,
        InitContainers: nil,
        Containers: []core.Container{
                {
                        ... // 9 identical fields
                        ResizePolicy:  nil,
                        RestartPolicy: nil,
-                       VolumeMounts: []core.VolumeMount{
-                               {
-                                       Name:      "kube-api-access-v6q85",
-                                       ReadOnly:  true,
-                                       MountPath: "/var/run/secrets/kubernetes.io/serviceaccount",
-                               },
-                       },
+                       VolumeMounts:  nil,
                        VolumeDevices: nil,
                        LivenessProbe: nil,
                        ... // 10 identical fields
                },
        },
        EphemeralContainers: nil,
        RestartPolicy:       "Never",
        ... // 2 identical fields
        DNSPolicy:                    "ClusterFirst",
        NodeSelector:                 nil,
-       ServiceAccountName:           "default",
+       ServiceAccountName:           "",
        AutomountServiceAccountToken: nil,
-       NodeName:                     "minikube",
+       NodeName:                     "",
        SecurityContext:              &{},
        ImagePullSecrets:             nil,
        ... // 20 identical fields
  }

GROUP  KIND  NAMESPACE  NAME                              STATUS  HEALTH      HOOK     MESSAGE
       Pod   prod       python-app-prod-myapp-preinstall  Failed  SyncFailed  PreSync  error when replacing "/dev/shm/1950387737": Pod "python-app-prod-myapp-preinstall" is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)
  core.PodSpec{
-   Volumes: []core.Volume{
-     {
-       Name:         "kube-api-access-v6q85",
-       VolumeSource: core.VolumeSource{Projected: &core.ProjectedVolumeSource{...}},
-     },
-   },
+   Volumes:        nil,
    InitContainers: nil,
    Containers: []core.Container{
      {
        ... // 9 identical fields
        ResizePolicy:  nil,
        RestartPolicy: nil,
-       VolumeMounts: []core.VolumeMount{
-         {
-           Name:      "kube-api-access-v6q85",
-           ReadOnly:  true,
-           MountPath: "/var/run/secrets/kubernetes.io/serviceaccount",
-         },
-       },
+       VolumeMounts:  nil,
        VolumeDevices: nil,
        LivenessProbe: nil,
        ... // 10 identical fields
      },
    },
    EphemeralContainers: nil,
    RestartPolicy:       "Never",
    ... // 2 identical fields
    DNSPolicy:                    "ClusterFirst",
    NodeSelector:                 nil,
-   ServiceAccountName:           "default",
+   ServiceAccountName:           "",
    AutomountServiceAccountToken: nil,
-   NodeName:                     "minikube",
+   NodeName:                     "",
    SecurityContext:              &{},
    ImagePullSecrets:             nil,
    ... // 20 identical fields
  }
      ConfigMap       prod     config                 Synced
      Secret          default  my-secret              OutOfSync
      Service         prod     python-app-prod-myapp  Synced     Healthy
      ServiceAccount  prod     python-app-prod-myapp  Synced
apps  Deployment      prod     python-app-prod-myapp  OutOfSync  Progressing
time="2025-03-11T13:29:47+03:00" level=fatal msg="Operation has completed with phase: Failed"
```

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs> argocd app get python-app-prod
Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/nikolaevaElizaveta/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/myapp
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        OutOfSync from lab13 (4866da9)
Health Status:      Progressing

CONDITION              MESSAGE                                                                  
       LAST TRANSITION
SharedResourceWarning  Secret/my-secret is part of applications argocd/python-app-prod and python-app  2025-03-11 13:09:11 +0300 MSK
SyncError              Failed sync attempt to 4866da956fa137459bb798c91f95d8d2f52b6f5f: one or more objects failed to apply, reason: error when replacing "/dev/shm/2382632865": Pod "python-app-prod-myapp-preinstall" is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)
  core.PodSpec{
-                       Volumes: []core.Volume{
-                         {
-                           Name:         "kube-api-access-v6q85",
-                           VolumeSource: core.VolumeSource{Projected: &core.ProjectedVolumeSource{...}},
-                         },
-                       },
+                       Volumes:        nil,
                        InitContainers: nil,
                        Containers: []core.Container{
                          {
                            ... // 9 identical fields
                            ResizePolicy:  nil,
                            RestartPolicy: nil,
-                           VolumeMounts: []core.VolumeMount{
-                             {
-                               Name:      "kube-api-access-v6q85",
-                               ReadOnly:  true,
-                               MountPath: "/var/run/secrets/kubernetes.io/serviceaccount",     
-                             },
-                           },
+                           VolumeMounts:  nil,
                            VolumeDevices: nil,
                            LivenessProbe: nil,
                            ... // 10 identical fields
                          },
                        },
                        EphemeralContainers: nil,
                        RestartPolicy:       "Never",
                        ... // 2 identical fields
                        DNSPolicy:                    "ClusterFirst",
                        NodeSelector:                 nil,
-                       ServiceAccountName:           "default",
+                       ServiceAccountName:           "",
                        AutomountServiceAccountToken: nil,
-                       NodeName:                     "minikube",
+                       NodeName:                     "",
                        SecurityContext:              &{},
                        ImagePullSecrets:             nil,
                        ... // 20 identical fields
  } (retried 5 times).  2025-03-11 13:29:15 +0300 MSK


GROUP  KIND  NAMESPACE  NAME                              STATUS  HEALTH      HOOK     MESSAGE  
       Pod   prod       python-app-prod-myapp-preinstall  Failed  SyncFailed  PreSync  error when replacing "/dev/shm/2382632865": Pod "python-app-prod-myapp-preinstall" is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`,`spec.initContainers[*].image`,`spec.activeDeadlineSeconds`,`spec.tolerations` (only additions to existing tolerations),`spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)
  core.PodSpec{
-   Volumes: []core.Volume{
-     {
-       Name:         "kube-api-access-v6q85",
-       VolumeSource: core.VolumeSource{Projected: &core.ProjectedVolumeSource{...}},
-     },
-   },
+   Volumes:        nil,
    InitContainers: nil,
    Containers: []core.Container{
      {
        ... // 9 identical fields
        ResizePolicy:  nil,
        RestartPolicy: nil,
-       VolumeMounts: []core.VolumeMount{
-         {
-           Name:      "kube-api-access-v6q85",
-           ReadOnly:  true,
-           MountPath: "/var/run/secrets/kubernetes.io/serviceaccount",
-         },
-       },
+       VolumeMounts:  nil,
        VolumeDevices: nil,
        LivenessProbe: nil,
        ... // 10 identical fields
      },
    },
    EphemeralContainers: nil,
    RestartPolicy:       "Never",
    ... // 2 identical fields
    DNSPolicy:                    "ClusterFirst",
    NodeSelector:                 nil,
-   ServiceAccountName:           "default",
+   ServiceAccountName:           "",
    AutomountServiceAccountToken: nil,
-   NodeName:                     "minikube",
+   NodeName:                     "",
    SecurityContext:              &{},
    ImagePullSecrets:             nil,
    ... // 20 identical fields
  }
      ConfigMap       prod     config                 Synced
      Secret          default  my-secret              OutOfSync
      Service         prod     python-app-prod-myapp  Synced     Healthy
      ServiceAccount  prod     python-app-prod-myapp  Synced
apps  Deployment      prod     python-app-prod-myapp  OutOfSync  Progressing
```

## Test 2: Delete a Pod (Replica)

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs>    kubectl delete pod -n prod -l app.kubernetes.io/name=myapp     
pod "python-app-prod-myapp-796dc954d4-7txnj" deleted
pod "python-app-prod-myapp-796dc954d4-dbxrw" deleted
```

```bash
PS C:\Users\Elizoveta\Desktop\S25-core-course-labs>    kubectl get pods -n prod -w
NAME                                     READY   STATUS                       RESTARTS   AGE
python-app-prod-myapp-796dc954d4-2pgv7   0/1     CreateContainerConfigError   0          7m42s  
python-app-prod-myapp-796dc954d4-m8jfh   0/1     CreateContainerConfigError   0          7m42s  
python-app-prod-myapp-preinstall         0/1     Completed                    0          31m    
```