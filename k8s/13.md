# Lab 13

## Task 1

I installed argocd and verified the installation:

```bash
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
pod/argo-argocd-server-6f848cf7f7-5p254 condition met
```

Then set the port forwarding:

```bash
kubectl port-forward svc/argo-argocd-server -n argocd 8080:443
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
Handling connection for 8080
Handling connection for 8080
...
```

Then I logged in and created ArgoCD/argocd-python-app.yaml, applied the configuration:

```bash
kubectl apply -f k8s/ArgoCD/argocd-python-app.yaml
application.argoproj.io/python-app configured
```

Here I verify sync:

```bash
argocd app sync python-app
TIMESTAMP GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE
2025-03-11T20:32:22+03:00 Secret default credentials OutOfSync
2025-03-11T20:32:22+03:00 Service default python-app-app-python OutOfSync Healthy
2025-03-11T20:32:22+03:00 ServiceAccount default python-app-app-python OutOfSync
2025-03-11T20:32:22+03:00 apps Deployment default python-app-app-python OutOfSync Healthy
2025-03-11T20:32:22+03:00 ConfigMap default config OutOfSync
2025-03-11T20:32:23+03:00 Pod default preinstall-hook
2025-03-11T20:32:25+03:00 Pod default preinstall-hook Running Synced PreSync pod/preinstall-hook created
2025-03-11T20:32:47+03:00 ServiceAccount default python-app-app-python Synced
2025-03-11T20:32:47+03:00 Secret default credentials Synced
2025-03-11T20:32:47+03:00 ConfigMap default config Synced
2025-03-11T20:32:48+03:00 Service default python-app-app-python Synced Healthy
2025-03-11T20:32:48+03:00 apps Deployment default python-app-app-python Synced Progressing
2025-03-11T20:32:48+03:00 apps Deployment default python-app-app-python Synced Healthy
2025-03-11T20:32:50+03:00 Pod default preinstall-hook Succeeded Synced PreSync pod/preinstall-hook created
2025-03-11T20:32:50+03:00 ServiceAccount default python-app-app-python Synced serviceaccount/python-app-app-python configured. Warning: resource serviceaccounts/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
2025-03-11T20:32:50+03:00 Secret default credentials Synced secret/credentials configured. Warning: resource secrets/credentials is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
2025-03-11T20:32:50+03:00 ConfigMap default config Synced configmap/config configured. Warning: resource configmaps/config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
2025-03-11T20:32:50+03:00 Service default python-app-app-python Synced Healthy service/python-app-app-python configured. Warning: resource services/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
2025-03-11T20:32:50+03:00 apps Deployment default python-app-app-python Synced Healthy deployment.apps/python-app-app-python configured. Warning: resource deployments/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
2025-03-11T20:32:50+03:00 Pod default postinstall-hook Running Synced PostSync pod/postinstall-hook created
2025-03-11T20:33:12+03:00 Pod default postinstall-hook Succeeded Synced PostSync pod/postinstall-hook created

Name: argocd/python-app
Project: default
Server: https://kubernetes.default.svc
Namespace: default
URL: https://argocd.example.com/applications/python-app
Source:

- Repo: https://github.com/mngcndl/S25-core-course-labs.git
  Target: lab13
  Path: k8s/app-python
  Helm Values: values.yaml
  SyncWindow: Sync Allowed
  Sync Policy: Automated
  Sync Status: Synced to lab13 (08ea375)
  Health Status: Healthy

Operation: Sync
Sync Revision: 08ea375a0aeff5b62360a7252a50be4243e5e643
Phase: Succeeded
Start: 2025-03-11 20:32:22 +0300 MSK
Finished: 2025-03-11 20:33:12 +0300 MSK
Duration: 50s
Message: successfully synced (no more tasks)

GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE
Pod default preinstall-hook Succeeded PreSync pod/preinstall-hook created
ServiceAccount default python-app-app-python Synced serviceaccount/python-app-app-python configured. Warning: resource serviceaccounts/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Secret default credentials Synced secret/credentials configured. Warning: resource secrets/credentials is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
ConfigMap default config Synced configmap/config configured. Warning: resource configmaps/config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Service default python-app-app-python Synced Healthy service/python-app-app-python configured. Warning: resource services/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
apps Deployment default python-app-app-python Synced Healthy deployment.apps/python-app-app-python configured. Warning: resource deployments/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Pod default postinstall-hook Succeeded PostSync pod/postinstall-hook created
```

Turned out, in my version of argocd there was no command status, so I used "get":

```bash
argocd app get python-app
Name: argocd/python-app
Project: default
Server: https://kubernetes.default.svc
Namespace: default
URL: https://argocd.example.com/applications/python-app
Source:

- Repo: https://github.com/mngcndl/S25-core-course-labs.git
  Target: lab13
  Path: k8s/app-python
  Helm Values: values.yaml
  SyncWindow: Sync Allowed
  Sync Policy: Automated
  Sync Status: Synced to lab13 (08ea375)
  Health Status: Healthy

GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE
Pod default preinstall-hook Succeeded PreSync pod/preinstall-hook created
ServiceAccount default python-app-app-python Synced serviceaccount/python-app-app-python configured. Warning: resource serviceaccounts/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Secret default credentials Synced secret/credentials configured. Warning: resource secrets/credentials is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
ConfigMap default config Synced configmap/config configured. Warning: resource configmaps/config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Service default python-app-app-python Synced Healthy service/python-app-app-python configured. Warning: resource services/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
apps Deployment default python-app-app-python Synced Healthy deployment.apps/python-app-app-python configured. Warning: resource deployments/python-app-app-python is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by apply. apply should only be used on resources created declaratively by either create --save-config or apply. The missing annotation will be patched automatically.
Pod default postinstall-hook Succeeded PostSync pod/postinstall-hook created
```

```bash
argocd app list
NAME CLUSTER NAMESPACE PROJECT STATUS HEALTH SYNCPOLICY CONDITIONS REPO PATH TARGET
argocd/python-app https://kubernetes.default.svc default default Synced Healthy Auto <none> https://github.com/mngcndl/S25-core-course-labs.git k8s/app-python lab13

k8s/app-python lab13

argocd app get python-app
Name: argocd/python-app
Project: default
Server: https://kubernetes.default.svc
Namespace: default
URL: https://argocd.example.com/applications/python-app
Source:

- Repo: https://github.com/mngcndl/S25-core-course-labs.git
  Target: lab13
  Path: k8s/app-python
  Helm Values: values.yaml
  SyncWindow: Sync Allowed
  Sync Policy: Automated
  Sync Status: Synced to lab13 (4321b45)
  Health Status: Healthy

GROUP KIND NAMESPACE NAME STATUS HEALTH HOOK MESSAGE
Pod default preinstall-hook Succeeded PreSync pod/preinstall-hook created
ServiceAccount default python-app-app-python Synced serviceaccount/python-app-app-python unchanged
Secret default credentials Synced secret/credentials unchanged
ConfigMap default config Synced configmap/config unchanged
Service default python-app-app-python Synced Healthy service/python-app-app-python unchanged
apps Deployment default python-app-app-python Synced Healthy deployment.apps/python-app-app-python unchanged
Pod default postinstall-hook Succeeded PostSync pod/postinstall-hook created
```

Output after adding another replica and pushing it to the remote repo:

```bash
kubectl get deployment python-app-app-python -o yaml | grep replicas
{"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"labels":{"app.kubernetes.io/instance":"python-app","app.kubernetes.io/managed-by":"Helm","app.kubernetes.io/name":"app-python","app.kubernetes.io/version":"1.16.0","argocd.argoproj.io/instance":"python-app","helm.sh/chart":"app-python-0.1.0"},"name":"python-app-app-python","namespace":"default"},"spec":{"replicas":2,"selector":{"matchLabels":{"app.kubernetes.io/instance":"python-app","app.kubernetes.io/name":"app-python"}},"template":{"metadata":{"labels":{"app.kubernetes.io/instance":"python-app","app.kubernetes.io/managed-by":"Helm","app.kubernetes.io/name":"app-python","app.kubernetes.io/version":"1.16.0","helm.sh/chart":"app-python-0.1.0"}},"spec":{"containers":[{"env":[{"name":"MY_PASS","valueFrom":{"secretKeyRef":{"key":"password","name":"credentials"}}}],"image":"mangocandle/app_python:latest","imagePullPolicy":"IfNotPresent","livenessProbe":{"httpGet":{"path":"/","port":"http"}},"name":"app-python","ports":[{"containerPort":5001,"name":"http","protocol":"TCP"}],"readinessProbe":{"httpGet":{"path":"/","port":"http"}}}],"serviceAccountName":"python-app-app-python","volumes":[{"configMap":{"name":"config"},"name":"config-volume"}]}}}}
replicas: 2
```

## Task 2

Pod addition via patch:

```bash
kubectl patch deployment python-app-prod-app-python -n prod --patch '{"spec":{"replicas": 5}}'
deployment.apps/python-app-prod-app-python patched
aksss-MacBook-Pro:S25-core-course-labs mangocandle$ kubectl get pods -n prod
NAME READY STATUS RESTARTS AGE
python-app-prod-app-python-b5ccb889c-77jj2 1/1 Running 0 2m7s
python-app-prod-app-python-b5ccb889c-bkmkq 1/1 Running 3 (21m ago) 137m
python-app-prod-app-python-b5ccb889c-nv2v7 1/1 Running 0 35s
python-app-prod-app-python-b5ccb889c-rhtkz 0/1 ContainerCreating 0 4s
python-app-prod-app-python-b5ccb889c-s47zr 0/1 Pending 0 4s
```

Then the changes synced back to the remote repo state.
After it I conducted Test 2:
Before pod deletion:

```bash
kubectl get pods -n prod
NAME                                         READY   STATUS    RESTARTS       AGE
python-app-prod-app-python-b5ccb889c-bkmkq   1/1     Running   3 (8m9s ago)   124m
python-app-prod-app-python-b5ccb889c-jt66g   1/1     Running   2 (8m9s ago)   90m
python-app-prod-app-python-b5ccb889c-wm95t   1/1     Running   4 (8m8s ago)   124m
```

After pod deletion pods returned back to the amount stated in the repository due to the AutoSync enabled (look at the screenshots).

Screenshot proofs:
Patching 5 replicas:
[!5pods.png](5pods.png)

Reverted back to 3 replicas:
[!syncedPods.png](syncedPods.png)

After deletion pods reverted back to sync state (3 replicas):
[!podsRecovered.png](podsRecovered.png)

### Explanation of ArgoCD Behavior

ArgoCD uses a GitOps approach to manage Kubernetes resources. It continuously monitors the desired state defined in Git and ensures that the cluster matches this state.

- **Configuration Drift:** If the cluster state deviates from the desired state (e.g., manual changes to resources), ArgoCD detects the drift and automatically syncs the cluster back to the desired state.
- **Runtime Events:** Events like Pod deletions do not affect the desired state. Kubernetes recreates Pods to match the replica count specified in the Deployment, and ArgoCD does not consider this as drift.
