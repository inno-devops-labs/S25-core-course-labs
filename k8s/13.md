# ArgoCD for GitOps Deployment

## Deploy and configure ArgoCD

Installation

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> helm repo add argo https://argoproj.github.io/argo-helm
"argo" has been added to your repositories

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> helm install argo argo/argo-cd --namespace argocd --create-namespace
NAME: argo
LAST DEPLOYED: Sun Mar  9 17:47:33 2025
NAMESPACE: argocd
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
In order to access the server UI you have the following options:

1. kubectl port-forward service/argo-argocd-server -n argocd 8080:443

    and then open the browser on http://localhost:8080 and accept the certificate

2. enable ingress in the values file `server.ingress.enabled` and either
      - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts


After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:

kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

(You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)        

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
pod/argo-argocd-server-6f848cf7f7-5htq5 condition met
```

CLI installation

```text
PS C:\WINDOWS\system32> choco install argocd-cli
Chocolatey v2.3.0
Installing the following packages:
argocd-cli
By installing, you accept licenses for the packages.
Downloading package from source 'https://community.chocolatey.org/api/v2/'

argocd-cli v2.14.4 [Approved]
argocd-cli package files install completed. Performing other installation steps.
The package argocd-cli wants to run 'chocolateyinstall.ps1'.
Note: If you don't run this script, the installation will fail.
Note: To confirm automatically next time, use '-y' or consider:
choco feature enable -n allowGlobalConfirmation
Do you want to run the script?([Y]es/[A]ll - yes to all/[N]o/[P]rint): Y

Environment Vars (like PATH) have changed. Close/reopen your shell to
 see the changes (or in powershell/cmd.exe just type `refreshenv`).
 ShimGen has successfully created a shim for argocd.exe
 The install of argocd-cli was successful.
  Software install location not explicitly set, it could be in package or
  default install location of installer.

Chocolatey installed 1/1 packages.
 See the log for details (C:\ProgramData\chocolatey\logs\chocolatey.log).

Did you know the proceeds of Pro (and some proceeds from other
 licensed editions) go into bettering the community infrastructure?
 Your support ensures an active community, keeps Chocolatey tip-top,
 plus it nets you some awesome features!
 https://chocolatey.org/compare
 
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd version
argocd: v2.14.4+3d901f2
  BuildDate: 2025-03-04T21:21:26Z
  GitCommit: 3d901f2037888af302a85f518bea70b33ee8e1c7
  GitTreeState: clean
  GoVersion: go1.23.3
  Compiler: gc
  Platform: windows/amd64
time="2025-03-09T17:55:32+03:00" level=fatal msg="Argo CD server address unspecified"
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($k8sSecret))
vO9nfiv8oB1Ml5PK
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd login localhost:8080 --insecure
Username: admin
Password:
'admin:login' logged in successfully
Context 'localhost:8080' updated

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl apply -f argocd/argocd-python-app.yaml
application.argoproj.io/python-app created
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app sync python-app
TIMESTAMP  GROUP        KIND   NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-09T18:22:15+03:00                Pod     default       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-09T18:22:35+03:00         ServiceAccount     default  python-app-flask-app  OutOfSync  Missing              
2025-03-09T18:22:35+03:00   apps  Deployment         default  python-app-flask-app  OutOfSync  Missing
2025-03-09T18:22:35+03:00          ConfigMap         default      flask-app-config  OutOfSync
2025-03-09T18:22:35+03:00             Secret         default     python-app-secret  OutOfSync  Missing
2025-03-09T18:22:35+03:00            Service         default  python-app-flask-app  OutOfSync  Missing
2025-03-09T18:22:36+03:00         ServiceAccount     default  python-app-flask-app    Synced  Missing              
2025-03-09T18:22:36+03:00             Secret     default     python-app-secret    Synced  Missing              
2025-03-09T18:22:36+03:00          ConfigMap     default      flask-app-config    Synced                       
2025-03-09T18:22:36+03:00            Service     default  python-app-flask-app    Synced  Healthy              
2025-03-09T18:22:36+03:00   apps  Deployment     default  python-app-flask-app    Synced  Progressing              
2025-03-09T18:22:38+03:00   apps  Deployment         default  python-app-flask-app    Synced   Progressing              deployment.apps/python-app-flask-app created
2025-03-09T18:22:38+03:00                Pod         default       preinstall-hook  Succeeded   Synced         PreSync  pod/preinstall-hook created
2025-03-09T18:22:38+03:00         ServiceAccount     default  python-app-flask-app    Synced   Missing                  serviceaccount/python-app-flask-app created
2025-03-09T18:22:38+03:00             Secret         default     python-app-secret    Synced   Missing                  secret/python-app-secret created
2025-03-09T18:22:38+03:00          ConfigMap         default      flask-app-config    Synced                            configmap/flask-app-config configured. Warning: resource con
figmaps/flask-app-config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
2025-03-09T18:22:38+03:00            Service         default  python-app-flask-app    Synced   Healthy                  service/python-app-flask-app created
2025-03-09T18:22:49+03:00   apps  Deployment     default  python-app-flask-app    Synced  Healthy              deployment.apps/python-app-flask-app created
2025-03-09T18:22:49+03:00                Pod     default      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-09T18:23:08+03:00                Pod     default      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (f4673fc)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      f4673fcd9d0699f9aad733498fd27ba7d3c02ee4
Phase:              Succeeded
Start:              2025-03-09 18:22:10 +0300 MSK
Finished:           2025-03-09 18:23:08 +0300 MSK
Duration:           58s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app created
       Secret          default    python-app-secret     Synced                        secret/python-app-secret created
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config configured. Warning: resource configmaps/flask-app-config is missin
g the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app created
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app created
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app get python-app   
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (f4673fc)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app created
       Secret          default    python-app-secret     Synced                        secret/python-app-secret created
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config configured. Warning: resource configmaps/flask-app-config is missin
g the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app created
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app created
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
```

Before replicas count update:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po
NAME                                       READY   STATUS    RESTARTS      AGE
flask-release-flask-app-5867b4fcf9-4pkmr   1/1     Running   2 (51m ago)   168m
flask-release-flask-app-5867b4fcf9-wq5n9   1/1     Running   2 (51m ago)   168m
ktor-release-ktor-app-644dbb9cc6-lq2s5     1/1     Running   3             168m
ktor-release-ktor-app-644dbb9cc6-lv6l4     1/1     Running   2 (51m ago)   168m
python-app-flask-app-74c4767b6d-7rkv5      1/1     Running   0             16m
python-app-flask-app-74c4767b6d-8n5gf      1/1     Running   0             16m
python-app-flask-app-74c4767b6d-z57hc      1/1     Running   0             16m
```

After replicas count update (3 -> 2) autosync:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app get python-app
Name:               argocd/python-app
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (b0a22a1)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app unchanged
       Secret          default    python-app-secret     Synced                        secret/python-app-secret unchanged
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config unchanged
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app unchanged
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app configured
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po
NAME                                       READY   STATUS    RESTARTS      AGE
flask-release-flask-app-5867b4fcf9-4pkmr   1/1     Running   2 (72m ago)   3h9m
flask-release-flask-app-5867b4fcf9-gnpf7   1/1     Running   3 (72m ago)   3h9m
flask-release-flask-app-5867b4fcf9-wq5n9   1/1     Running   2 (72m ago)   3h9m
ktor-release-ktor-app-644dbb9cc6-lq2s5     1/1     Running   3             3h9m
ktor-release-ktor-app-644dbb9cc6-lv6l4     1/1     Running   2 (72m ago)   3h9m
python-app-flask-app-74c4767b6d-8n5gf      1/1     Running   0             37m
python-app-flask-app-74c4767b6d-z57hc      1/1     Running   0             37m
```

## Multi-Environment Deployment & Auto-Sync

Dev and Prod are created as described in the task.

Change replicas count for prod.

Before:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl get po -n prod
NAME                                        READY   STATUS    RESTARTS   AGE
python-app-prod-flask-app-5c8f8785b-8dhtc   1/1     Running   0          11m
python-app-prod-flask-app-5c8f8785b-zxfcm   1/1     Running   0          12m
```

After:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl get po -n prod
NAME                                        READY   STATUS    RESTARTS   AGE
preinstall-hook                             1/1     Running   0          3s
python-app-prod-flask-app-5c8f8785b-8dhtc   1/1     Running   0          12m
python-app-prod-flask-app-5c8f8785b-zxfcm   1/1     Running   0          12m
```

### Test 1

[Screenshot Before](screenshots/agro/t1_before.png)

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> @"
>> {
>>   "spec": {
>>     "replicas": 3
>>   }
>> }
>> "@ | Out-File -FilePath patch.json -Encoding utf8

PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl patch deployment python-app-prod-flask-app -n prod --patch-file patch.json
deployment.apps/python-app-prod-flask-app patched
```

[Screenshot After set_3_replicas](screenshots/agro/t1_after_increase_replicas.png)

Revert changes:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd app sync python-app-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME         STATUS    HEALTH        HOOK  MESSAGE
2025-03-09T20:03:29+03:00             Secret            prod  python-app-prod-secret       Synced                        
2025-03-09T20:03:29+03:00            Service            prod  python-app-prod-flask-app    Synced   Healthy
2025-03-09T20:03:29+03:00         ServiceAccount        prod  python-app-prod-flask-app    Synced
2025-03-09T20:03:29+03:00   apps  Deployment            prod  python-app-prod-flask-app  OutOfSync  Healthy
2025-03-09T20:03:29+03:00                Pod        prod       preinstall-hook                                 
2025-03-09T20:03:31+03:00                Pod        prod       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-09T20:03:51+03:00   apps  Deployment        prod  python-app-prod-flask-app    Synced  Progressing              
2025-03-09T20:03:51+03:00   apps  Deployment        prod  python-app-prod-flask-app    Synced  Healthy              
2025-03-09T20:03:53+03:00            Service            prod  python-app-prod-flask-app    Synced   Healthy              service/python-app-prod-flask-app unchanged
2025-03-09T20:03:53+03:00   apps  Deployment            prod  python-app-prod-flask-app    Synced   Healthy              deployment.apps/python-app-prod-flask-app configured       
2025-03-09T20:03:53+03:00                Pod            prod       preinstall-hook       Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-09T20:03:53+03:00         ServiceAccount        prod  python-app-prod-flask-app    Synced                        serviceaccount/python-app-prod-flask-app unchanged
2025-03-09T20:03:53+03:00             Secret            prod  python-app-prod-secret       Synced                        secret/python-app-prod-secret unchanged
2025-03-09T20:03:53+03:00                Pod        prod      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-09T20:04:12+03:00                Pod        prod      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Health Status:      Healthy

Operation:          Sync
Sync Revision:      55bba2d00b43032df32596f20df9be9982b6b725
Phase:              Succeeded
Start:              2025-03-09 20:03:28 +0300 MSK
Finished:           2025-03-09 20:04:12 +0300 MSK
Duration:           44s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                       STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook            Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       python-app-prod-flask-app  Synced                        serviceaccount/python-app-prod-flask-app unchanged
       Secret          prod       python-app-prod-secret     Synced                        secret/python-app-prod-secret unchanged
       Service         prod       python-app-prod-flask-app  Synced     Healthy            service/python-app-prod-flask-app unchanged
apps   Deployment      prod       python-app-prod-flask-app  Synced     Healthy            deployment.apps/python-app-prod-flask-app configured
       Pod             prod       postinstall-hook           Succeeded           PostSync  pod/postinstall-hook created
```

[Screenshot After revert](screenshots/agro/t1_revert.png)

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd app get  python-app-prod
Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (55bba2d)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                       STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook            Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       python-app-prod-flask-app  Synced                        serviceaccount/python-app-prod-flask-app unchanged
       Secret          prod       python-app-prod-secret     Synced                        secret/python-app-prod-secret unchanged
       Service         prod       python-app-prod-flask-app  Synced     Healthy            service/python-app-prod-flask-app unchanged
apps   Deployment      prod       python-app-prod-flask-app  Synced     Healthy            deployment.apps/python-app-prod-flask-app configured
       Pod             prod       postinstall-hook           Succeeded           PostSync  pod/postinstall-hook created
```

### Test 2

[Screenshot Before](screenshots/agro/t2_before.png)

Deletion and recreation:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl get po -n prod
NAME                                        READY   STATUS    RESTARTS   AGE
python-app-prod-flask-app-5c8f8785b-8dhtc   1/1     Running   0          33m
python-app-prod-flask-app-5c8f8785b-zxfcm   1/1     Running   0          34m

PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl delete pod -n prod python-app-prod-flask-app-5c8f8785b-8dhtc
pod "python-app-prod-flask-app-5c8f8785b-8dhtc" deleted

PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl get pods -n prod -w
NAME                                        READY   STATUS    RESTARTS   AGE
python-app-prod-flask-app-5c8f8785b-z5prk   1/1     Running   0          110s
python-app-prod-flask-app-5c8f8785b-zxfcm   1/1     Running   0          38m
```

No drift:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd app diff python-app-prod
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> 
```

[Screenshot Before](screenshots/agro/t2_after_delete_recreate.png)

## Bonus

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl apply -f .\k8s\argocd\argocd-ktor-app.yaml
application.argoproj.io/ktor-app created
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> kubectl get po -n default
NAME                                       READY   STATUS    RESTARTS       AGE
flask-release-flask-app-5867b4fcf9-4pkmr   1/1     Running   2 (159m ago)   4h35m
flask-release-flask-app-5867b4fcf9-gnpf7   1/1     Running   3 (159m ago)   4h35m
flask-release-flask-app-5867b4fcf9-wq5n9   1/1     Running   2 (159m ago)   4h35m
ktor-app-6d449b5458-2zgz8                  1/1     Running   0              13s
ktor-app-6d449b5458-r28b5                  1/1     Running   0              13s
ktor-release-ktor-app-644dbb9cc6-lq2s5     1/1     Running   3              4h36m
ktor-release-ktor-app-644dbb9cc6-lv6l4     1/1     Running   2 (159m ago)   4h36m
python-app-flask-app-fd4f8df8b-86cw2       1/1     Running   0              53m
python-app-flask-app-fd4f8df8b-hbfkz       1/1     Running   0              53m
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd app get ktor-app
Name:               argocd/ktor-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/ktor-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/ktor-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (55bba2d)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME             STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  default    ktor-app         Synced                 serviceaccount/ktor-app created
       ConfigMap       default    ktor-app-config  Synced                 configmap/ktor-app-config configured. Warning: resource configmaps/ktor-app-config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
       Service         default    ktor-app         Synced  Healthy        service/ktor-app created
apps   Deployment      default    ktor-app         Synced  Healthy        deployment.apps/ktor-app created
```

[Screenshot Running Ktor](screenshots/agro/ktor_app.png)
