**Lab 13: ArgoCD for GitOps Deployment**

**Task 1: Deploy and Configure ArgoCD**

1. **Install ArgoCD via Helm**

   - **Add the ArgoCD Helm repository:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm repo add argo https://argoproj.github.io/argo-helm
     "argo" has been added to your repositories
     ```

   - **Install ArgoCD:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> helm install argo argo/argo-cd --namespace argocd --create-namespace
     NAME: argo
     LAST DEPLOYED: Sun Mar 16 19:58:24 2025
     NAMESPACE: argocd
     STATUS: deployed
     REVISION: 1
     TEST SUITE: None
     NOTES:
     In order to access the server UI you have the following options:

     1. kubectl port-forward service/argo-argocd-server -n argocd 8080:443

         and then open the browser on http://localhost:8080 and accept the certificate

     2. enable ingress in the values file `server.ingress.enabled` and either
           - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough
           - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts

     After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:

     kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

     (You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)
     ```

   - **Verify installation:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
     pod/argo-argocd-server-7b688c6d85-4fn4l condition met
     ```

2. **Install ArgoCD CLI**

   - **Download and install the ArgoCD CLI tool:**

     ```powershell
     PS C:\Tools> $version = (Invoke-RestMethod https://api.github.com/repos/argoproj/argo-cd/releases/latest).tag_name
     PS C:\Tools> $url = "https://github.com/argoproj/argo-cd/releases/download/" + $version + "/argocd-windows-amd64.exe"
     PS C:\Tools> $output = "argocd.exe"
     PS C:\Tools> Invoke-WebRequest -Uri $url -OutFile $output
     StatusCode        : 200
     StatusDescription : OK
     Content           : {77, 90, 144, 0...}
     RawContent        : HTTP/1.1 200 OK
                         Connection: keep-alive
                         x-ms-request-id: c7e4fb23-901e-0065-393a-924f11000000
                         x-ms-version: 2025-01-05
                         x-ms-creation-time: Tue, 11 Mar 2025 03:57:33 GMT
                         x-ms-lease-status: unlocked...
     Headers           : {[Connection, keep-alive], [x-ms-request-id, c7e4fb23-901e-0065-393a-924f11000000], [x-ms-version, 2025-01-05], [x-ms-creation-time, Tue, 11 Mar 2025 03:57:33 GMT]...}
     RawContentLength  : 189064704
     ```

   - **Verify CLI installation:**

     ```powershell
     PS C:\Tools> .\argocd.exe version
     argocd: v2.14.5+f463a94
       BuildDate: 2025-03-11T03:40:10Z
       GitCommit: f463a945d57267e9691cede37021d9ddc5994f36
       GitTreeState: clean
       GoVersion: go1.23.3
       Compiler: gc
       Platform: windows/amd64
     ```

3. **Access the ArgoCD UI**

   - **Forward the ArgoCD server port:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl port-forward svc/argo-argocd-server -n argocd 8080:443
     Forwarding from 127.0.0.1:8080 -> 8080
     Forwarding from [::1]:8080 -> 8080
     ```

   - **Retrieve the initial admin password:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
     P@ssw0rd123
     ```

   - **Log in via CLI:**

     ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s> .\argocd.exe login localhost:8080 --username admin --password P@ssw0rd123 --insecure
     'admin' logged in successfully
     Context 'localhost:8080' updated
     ```

4. **Configure Python App Sync**

   - **Define the ArgoCD Application**
   - **Applied the configuration**
   - **Verified the application status:**
    
    ```powershell
     PS C:\Users\bakin\PycharmProjects\S25-devops-engineering-labs\k8s\app-python> argocd app get python-app
    Name:               argocd/python-app
    Project:            default
    Server:             https://kubernetes.default.svc
    Namespace:          default
    URL:                https://argocd.example.com/applications/python-app
    Source:
      Repo:             https://github.com/bakinasa/S25-devops-engineering-labs.git
      Target:           feature/lab13
      Path:             k8s/app-python
      Helm Values:      values.yaml
    SyncWindow:         Sync Allowed
    Sync Policy:        Automated (Prune)
    Sync Status:        Synced to feature/lab13 (c760586)
    Health Status:      Healthy
    
    GROUP                       KIND                 NAMESPACE  NAME                   STATUS  HEALTH   HOOK  MESSAGE
                                ServiceAccount       default    python-app-app-python  Synced                  serviceaccount/python-app-app-python unchanged
                                ConfigMap            default    app-python-config      Synced                  configmap/app-python-config unchanged
                                Service              default    python-app-app-python  Synced  Healthy         service/python-app-app-python unchanged
    apps                        Deployment           default    python-app-app-python  Synced  Healthy         deployment.apps/python-app-app-python unchanged
     ```
