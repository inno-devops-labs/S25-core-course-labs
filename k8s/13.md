# ArgoCD

## Deploy and Configure ArgoCD

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl apply -f ArgoCD/argocd-python-app.yaml
application.argoproj.io/moscow-time-py created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app sync moscow-time-py          
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-09T17:30:44+03:00          ConfigMap         default         py-app-config    Synced
2025-03-09T17:30:44+03:00             Secret         default              password    Synced
2025-03-09T17:30:44+03:00            Service         default        moscow-time-py    Synced  Healthy
2025-03-09T17:30:44+03:00         ServiceAccount     default        moscow-time-py    Synced
2025-03-09T17:30:44+03:00   apps  Deployment         default        moscow-time-py    Synced  Healthy
2025-03-09T17:30:45+03:00                Pod     default       preinstall-hook
2025-03-09T17:30:47+03:00                Pod     default       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-09T17:31:09+03:00             Secret         default              password    Synced                        secret/password unchanged
2025-03-09T17:31:09+03:00          ConfigMap         default         py-app-config    Synced                        configmap/py-app-config unchanged
2025-03-09T17:31:09+03:00            Service         default        moscow-time-py    Synced   Healthy              service/moscow-time-py unchanged
2025-03-09T17:31:09+03:00   apps  Deployment         default        moscow-time-py    Synced   Healthy              deployment.apps/moscow-time-py unchanged   
2025-03-09T17:31:09+03:00                Pod         default       preinstall-hook  Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-09T17:31:09+03:00         ServiceAccount     default        moscow-time-py    Synced                        serviceaccount/moscow-time-py unchanged    
2025-03-09T17:31:09+03:00                Pod     default      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-09T17:31:35+03:00                Pod     default      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/moscow-time-py
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (0591315)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      0591315d41813a4e48d01a2b820887aa16d40777
Phase:              Succeeded
Start:              2025-03-09 17:30:44 +0300 MSK
Finished:           2025-03-09 17:31:34 +0300 MSK
Duration:           50s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME              STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook   Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    moscow-time-py    Synced                        serviceaccount/moscow-time-py unchanged
       Secret          default    password          Synced                        secret/password unchanged
       ConfigMap       default    py-app-config     Synced                        configmap/py-app-config unchanged
       Service         default    moscow-time-py    Synced     Healthy            service/moscow-time-py unchanged
apps   Deployment      default    moscow-time-py    Synced     Healthy            deployment.apps/moscow-time-py unchanged
```

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app get moscow-time-py
Name:               argocd/moscow-time-py
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/moscow-time-py
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (0591315)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME              STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook   Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    moscow-time-py    Synced                        serviceaccount/moscow-time-py unchanged
       Secret          default    password          Synced                        secret/password unchanged
       ConfigMap       default    py-app-config     Synced                        configmap/py-app-config unchanged
       Service         default    moscow-time-py    Synced     Healthy            service/moscow-time-py unchanged
apps   Deployment      default    moscow-time-py    Synced     Healthy            deployment.apps/moscow-time-py unchanged
       Pod             default    postinstall-hook  Succeeded           PostSync  pod/postinstall-hook created
```

Pods before values.yaml change:

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po                   
NAME                              READY   STATUS    RESTARTS   AGE
moscow-time-py-76b45bfc5f-5wsd8   1/1     Running   0          11m
```

Then number of pods was increased to 2, after updating the repo:

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app get moscow-time-py
Name:               argocd/moscow-time-py
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/moscow-time-py
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (83270d6)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME              STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook   Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    moscow-time-py    Synced                        serviceaccount/moscow-time-py unchanged
       Secret          default    password          Synced                        secret/password unchanged
       ConfigMap       default    py-app-config     Synced                        configmap/py-app-config unchanged
       Service         default    moscow-time-py    Synced     Healthy            service/moscow-time-py unchanged
apps   Deployment      default    moscow-time-py    Synced     Healthy            deployment.apps/moscow-time-py configured
       Pod             default    postinstall-hook  Succeeded           PostSync  pod/postinstall-hook created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po
NAME                              READY   STATUS    RESTARTS   AGE
moscow-time-py-76b45bfc5f-5wsd8   1/1     Running   0          14m
moscow-time-py-76b45bfc5f-bkgtb   1/1     Running   0          73s
```

![Task 1 sync](.img/lab13_task1_ui.png)

## Multi-Environment Deployment & Auto-Sync

After setting up dev and prod envs, we can check its sync

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl apply -f ArgoCD/argocd-python-prod.yaml
application.argoproj.io/moscow-time-py-prod created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app sync moscow-time-py-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-09T18:50:23+03:00         ServiceAccount        prod   moscow-time-py-prod    Synced
2025-03-09T18:50:23+03:00   apps  Deployment            prod   moscow-time-py-prod    Synced  Healthy
2025-03-09T18:50:23+03:00            Service            prod   moscow-time-py-prod    Synced  Healthy
2025-03-09T18:50:23+03:00                Pod        prod       preinstall-hook
2025-03-09T18:50:25+03:00                Pod        prod       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-09T18:50:47+03:00                Pod            prod       preinstall-hook  Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-09T18:50:47+03:00         ServiceAccount        prod   moscow-time-py-prod    Synced                        serviceaccount/moscow-time-py-prod unchanged
2025-03-09T18:50:47+03:00            Service            prod   moscow-time-py-prod    Synced   Healthy              service/moscow-time-py-prod unchanged      
2025-03-09T18:50:47+03:00   apps  Deployment            prod   moscow-time-py-prod    Synced   Healthy              deployment.apps/moscow-time-py-prod unchanged
2025-03-09T18:50:48+03:00                Pod        prod      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-09T18:51:13+03:00                Pod        prod      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/moscow-time-py-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (bafe407)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      bafe407ca23179acdb04a7a6af6d0d1176956d0d
Phase:              Succeeded
Start:              2025-03-09 18:50:23 +0300 MSK
Finished:           2025-03-09 18:51:13 +0300 MSK
Duration:           50s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                 STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook      Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       moscow-time-py-prod  Synced                        serviceaccount/moscow-time-py-prod unchanged
       Service         prod       moscow-time-py-prod  Synced     Healthy            service/moscow-time-py-prod unchanged
apps   Deployment      prod       moscow-time-py-prod  Synced     Healthy            deployment.apps/moscow-time-py-prod unchanged
       Pod             prod       postinstall-hook     Succeeded           PostSync  pod/postinstall-hook created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app get moscow-time-py-prod
Name:               argocd/moscow-time-py-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/moscow-time-py-prod
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (bafe407)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                 STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook      Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       moscow-time-py-prod  Synced                        serviceaccount/moscow-time-py-prod unchanged
       Service         prod       moscow-time-py-prod  Synced     Healthy            service/moscow-time-py-prod unchanged
apps   Deployment      prod       moscow-time-py-prod  Synced     Healthy            deployment.apps/moscow-time-py-prod unchanged
       Pod             prod       postinstall-hook     Succeeded           PostSync  pod/postinstall-hook created
```

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po -n prod
NAME                                   READY   STATUS    RESTARTS   AGE
moscow-time-py-prod-54dd66d7f7-2qqbm   1/1     Running   0          7m51s
moscow-time-py-prod-54dd66d7f7-xhz7j   1/1     Running   0          7m51s
```

After values update (pods changed to 1):

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app get moscow-time-py-prod 
Name:               argocd/moscow-time-py-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/moscow-time-py-prod
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (0583f4d)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                 STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook      Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       moscow-time-py-prod  Synced                        serviceaccount/moscow-time-py-prod unchanged
       Service         prod       moscow-time-py-prod  Synced     Healthy            service/moscow-time-py-prod unchanged
apps   Deployment      prod       moscow-time-py-prod  Synced     Healthy            deployment.apps/moscow-time-py-prod configured
       Pod             prod       postinstall-hook     Succeeded           PostSync  pod/postinstall-hook created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po -n prod
NAME                                   READY   STATUS    RESTARTS   AGE
moscow-time-py-prod-54dd66d7f7-xhz7j   1/1     Running   0          13m
```

## Self-Heal Testing

### Test 1: Manual Override of Replica Count

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> @"
>> {
>>   "spec": {
>>     "replicas": 3
>>   }
>> }
>> "@ | Out-File -FilePath patch.json -Encoding utf8
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl patch deployment moscow-time-py-prod -n prod --patch-file patch.json
deployment.apps/moscow-time-py-prod patched
```

Extra pods are terminated automatically:

![Terminating](.img/terminating.png)

After sync returned back to 1 pod:

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app get moscow-time-py-prod 
Name:               argocd/moscow-time-py-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/moscow-time-py-prod
Source:
- Repo:             https://github.com/yeaphm/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/moscow-time-py
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (0583f4d)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                 STATUS     HEALTH   HOOK      MESSAGE
       Pod             prod       preinstall-hook      Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  prod       moscow-time-py-prod  Synced                        serviceaccount/moscow-time-py-prod unchanged
       Service         prod       moscow-time-py-prod  Synced     Healthy            service/moscow-time-py-prod unchanged
apps   Deployment      prod       moscow-time-py-prod  Synced     Healthy            deployment.apps/moscow-time-py-prod configured
       Pod             prod       postinstall-hook     Succeeded           PostSync  pod/postinstall-hook created
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po -n prod
NAME                                   READY   STATUS    RESTARTS   AGE
moscow-time-py-prod-54dd66d7f7-xhz7j   1/1     Running   0          29m
```

![Task 2 sync 1](.img/test11.png)

![Task 2 sync 2](.img/test12.png)

### Test 2: Delete a Pod (Replica)

If we delete a pod, it is being recreated automatically without drift as a result.

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po -n prod
NAME                                   READY   STATUS    RESTARTS   AGE
moscow-time-py-prod-54dd66d7f7-xhz7j   1/1     Running   0          29m
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl delete pods -n prod moscow-time-py-prod-54dd66d7f7-xhz7j
pod "moscow-time-py-prod-54dd66d7f7-xhz7j" deleted
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po -n prod
NAME                                   READY   STATUS    RESTARTS   AGE
moscow-time-py-prod-54dd66d7f7-5cw8m   0/1     Running   0          23s
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> argocd app diff moscow-time-py-prod
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s>
```

![Task 2 sync 2](.img/test2.png)

ArgoCD enforces Git as the source of truth for configurations, automatically detecting and reverting configuration drift (manual changes to cluster resources) when syncPolicy.automated is configured.

## Bonus Task: Sync C# App with ArgoCD

