# ArgoCD for GitOps Deployment

## Deploy and configure ArgoCD

Installation

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> helm repo add argo https://argoproj.github.io/argo-helm
"argo" has been added to your repositories

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> helm install argo argo/argo-cd --namespace argocd --create-namespace
NAME: argo
LAST DEPLOYED: Sun Mar  9 17:47:33 2025
NAMESPACE: argocd
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
In order to access the server UI you have the following options:

1. kubectl port-forward service/argo-argocd-server -n argocd 8080:443

    and then open the browser on http://localhost:8080 and accept the certificate

2. enable ingress in the values file `server.ingress.enabled` and either
      - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts


After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:

kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

(You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)        

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
pod/argo-argocd-server-6f848cf7f7-5htq5 condition met
```

CLI installation

```text
PS C:\WINDOWS\system32> choco install argocd-cli
Chocolatey v2.3.0
Installing the following packages:
argocd-cli
By installing, you accept licenses for the packages.
Downloading package from source 'https://community.chocolatey.org/api/v2/'

argocd-cli v2.14.4 [Approved]
argocd-cli package files install completed. Performing other installation steps.
The package argocd-cli wants to run 'chocolateyinstall.ps1'.
Note: If you don't run this script, the installation will fail.
Note: To confirm automatically next time, use '-y' or consider:
choco feature enable -n allowGlobalConfirmation
Do you want to run the script?([Y]es/[A]ll - yes to all/[N]o/[P]rint): Y

Environment Vars (like PATH) have changed. Close/reopen your shell to
 see the changes (or in powershell/cmd.exe just type `refreshenv`).
 ShimGen has successfully created a shim for argocd.exe
 The install of argocd-cli was successful.
  Software install location not explicitly set, it could be in package or
  default install location of installer.

Chocolatey installed 1/1 packages.
 See the log for details (C:\ProgramData\chocolatey\logs\chocolatey.log).

Did you know the proceeds of Pro (and some proceeds from other
 licensed editions) go into bettering the community infrastructure?
 Your support ensures an active community, keeps Chocolatey tip-top,
 plus it nets you some awesome features!
 https://chocolatey.org/compare
 
PS C:\Users\egora\PycharmProjects\S25-core-course-labs> argocd version
argocd: v2.14.4+3d901f2
  BuildDate: 2025-03-04T21:21:26Z
  GitCommit: 3d901f2037888af302a85f518bea70b33ee8e1c7
  GitTreeState: clean
  GoVersion: go1.23.3
  Compiler: gc
  Platform: windows/amd64
time="2025-03-09T17:55:32+03:00" level=fatal msg="Argo CD server address unspecified"
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($k8sSecret))
vO9nfiv8oB1Ml5PK
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd login localhost:8080 --insecure
Username: admin
Password:
'admin:login' logged in successfully
Context 'localhost:8080' updated

PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl apply -f argocd/argocd-python-app.yaml
application.argoproj.io/python-app created
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app sync python-app
TIMESTAMP  GROUP        KIND   NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-09T18:22:15+03:00                Pod     default       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-09T18:22:35+03:00         ServiceAccount     default  python-app-flask-app  OutOfSync  Missing              
2025-03-09T18:22:35+03:00   apps  Deployment         default  python-app-flask-app  OutOfSync  Missing
2025-03-09T18:22:35+03:00          ConfigMap         default      flask-app-config  OutOfSync
2025-03-09T18:22:35+03:00             Secret         default     python-app-secret  OutOfSync  Missing
2025-03-09T18:22:35+03:00            Service         default  python-app-flask-app  OutOfSync  Missing
2025-03-09T18:22:36+03:00         ServiceAccount     default  python-app-flask-app    Synced  Missing              
2025-03-09T18:22:36+03:00             Secret     default     python-app-secret    Synced  Missing              
2025-03-09T18:22:36+03:00          ConfigMap     default      flask-app-config    Synced                       
2025-03-09T18:22:36+03:00            Service     default  python-app-flask-app    Synced  Healthy              
2025-03-09T18:22:36+03:00   apps  Deployment     default  python-app-flask-app    Synced  Progressing              
2025-03-09T18:22:38+03:00   apps  Deployment         default  python-app-flask-app    Synced   Progressing              deployment.apps/python-app-flask-app created
2025-03-09T18:22:38+03:00                Pod         default       preinstall-hook  Succeeded   Synced         PreSync  pod/preinstall-hook created
2025-03-09T18:22:38+03:00         ServiceAccount     default  python-app-flask-app    Synced   Missing                  serviceaccount/python-app-flask-app created
2025-03-09T18:22:38+03:00             Secret         default     python-app-secret    Synced   Missing                  secret/python-app-secret created
2025-03-09T18:22:38+03:00          ConfigMap         default      flask-app-config    Synced                            configmap/flask-app-config configured. Warning: resource con
figmaps/flask-app-config is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
2025-03-09T18:22:38+03:00            Service         default  python-app-flask-app    Synced   Healthy                  service/python-app-flask-app created
2025-03-09T18:22:49+03:00   apps  Deployment     default  python-app-flask-app    Synced  Healthy              deployment.apps/python-app-flask-app created
2025-03-09T18:22:49+03:00                Pod     default      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-09T18:23:08+03:00                Pod     default      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (f4673fc)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      f4673fcd9d0699f9aad733498fd27ba7d3c02ee4
Phase:              Succeeded
Start:              2025-03-09 18:22:10 +0300 MSK
Finished:           2025-03-09 18:23:08 +0300 MSK
Duration:           58s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app created
       Secret          default    python-app-secret     Synced                        secret/python-app-secret created
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config configured. Warning: resource configmaps/flask-app-config is missin
g the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app created
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app created
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
```

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app get python-app   
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (f4673fc)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app created
       Secret          default    python-app-secret     Synced                        secret/python-app-secret created
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config configured. Warning: resource configmaps/flask-app-config is missin
g the kubectl.kubernetes.io/last-applied-configuration annotation which is required by  apply.  apply should only be used on resources created declaratively by either  create --save-config or  apply. The missing annotation will be patched automatically.
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app created
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app created
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
```

Before replicas count update:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po
NAME                                       READY   STATUS    RESTARTS      AGE
flask-release-flask-app-5867b4fcf9-4pkmr   1/1     Running   2 (51m ago)   168m
flask-release-flask-app-5867b4fcf9-wq5n9   1/1     Running   2 (51m ago)   168m
ktor-release-ktor-app-644dbb9cc6-lq2s5     1/1     Running   3             168m
ktor-release-ktor-app-644dbb9cc6-lv6l4     1/1     Running   2 (51m ago)   168m
python-app-flask-app-74c4767b6d-7rkv5      1/1     Running   0             16m
python-app-flask-app-74c4767b6d-8n5gf      1/1     Running   0             16m
python-app-flask-app-74c4767b6d-z57hc      1/1     Running   0             16m
```

After replicas count update (3 -> 2) autosync:

```text
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> argocd app get python-app
Name:               argocd/python-app
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/RwKaLs/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/flask-app
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (b0a22a1)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                  STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook       Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-flask-app  Synced                        serviceaccount/python-app-flask-app unchanged
       Secret          default    python-app-secret     Synced                        secret/python-app-secret unchanged
       ConfigMap       default    flask-app-config      Synced                        configmap/flask-app-config unchanged
       Service         default    python-app-flask-app  Synced     Healthy            service/python-app-flask-app unchanged
apps   Deployment      default    python-app-flask-app  Synced     Healthy            deployment.apps/python-app-flask-app configured
       Pod             default    postinstall-hook      Succeeded           PostSync  pod/postinstall-hook created
PS C:\Users\egora\PycharmProjects\S25-core-course-labs\k8s> kubectl get po
NAME                                       READY   STATUS    RESTARTS      AGE
flask-release-flask-app-5867b4fcf9-4pkmr   1/1     Running   2 (72m ago)   3h9m
flask-release-flask-app-5867b4fcf9-gnpf7   1/1     Running   3 (72m ago)   3h9m
flask-release-flask-app-5867b4fcf9-wq5n9   1/1     Running   2 (72m ago)   3h9m
ktor-release-ktor-app-644dbb9cc6-lq2s5     1/1     Running   3             3h9m
ktor-release-ktor-app-644dbb9cc6-lv6l4     1/1     Running   2 (72m ago)   3h9m
python-app-flask-app-74c4767b6d-8n5gf      1/1     Running   0             37m
python-app-flask-app-74c4767b6d-z57hc      1/1     Running   0             37m
```

## Multi-Environment Deployment & Auto-Sync


