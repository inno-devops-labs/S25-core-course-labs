# Lab 13: GitOps Deployment with ArgoCD

## Task 1: Deploy and Configure ArgoCD

### Step 1: Install ArgoCD via Helm
### Step 2: Install ArgoCD CLI
### Step 3: Access the ArgoCD UI
Forward the ArgoCD server port:
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```
Retrieve admin password:
```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
```
Login via CLI:
```bash
> kubectl port-forward svc/argo-argocd-server -n argocd 8080:443                     
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
```
### Step 4: Deploy Python App with ArgoCD
Create `argocd-python-app.yaml`.
Apply it:
```bash
> kubectl apply -f ArgoCD/argocd-python-app.yaml
application.argoproj.io/python-app configured
```
Verify:
```bash
> argocd app sync python-app

TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME     STATUS   HEALTH        HOOK  MESSAGE
2025-03-11T12:57:13+03:00          ConfigMap         default            app-config     Synced                       
2025-03-11T12:57:13+03:00             Secret         default             my-secret     Synced                       
2025-03-11T12:57:13+03:00            Service         default  python-app-app-python    Synced  Healthy              
2025-03-11T12:57:13+03:00         ServiceAccount     default  python-app-app-python    Synced                       
2025-03-11T12:57:13+03:00   apps  Deployment         default  python-app-app-python    Synced  Healthy              
2025-03-11T12:57:14+03:00                Pod     default       preinstall-hook                                 
2025-03-11T12:57:16+03:00                Pod     default       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-11T12:57:38+03:00         ServiceAccount     default  python-app-app-python    Synced                        serviceaccount/python-app-app-python unchanged
2025-03-11T12:57:38+03:00             Secret         default             my-secret     Synced                        secret/my-secret unchanged
2025-03-11T12:57:38+03:00          ConfigMap         default            app-config     Synced                        configmap/app-config unchanged
2025-03-11T12:57:38+03:00            Service         default  python-app-app-python    Synced   Healthy              service/python-app-app-python unchanged
2025-03-11T12:57:38+03:00   apps  Deployment         default  python-app-app-python    Synced   Healthy              deployment.apps/python-app-app-python unchanged
2025-03-11T12:57:38+03:00                Pod         default       preinstall-hook   Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-11T12:57:39+03:00                Pod     default      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-11T12:57:59+03:00                Pod     default      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (397ff35)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      397ff3535207cb66b87c2b757731027488609449
Phase:              Succeeded
Start:              2025-03-11 12:57:13 +0300 MSK
Finished:           2025-03-11 12:57:59 +0300 MSK
Duration:           46s
Message:            successfully synced (no more tasks)

GROUP  KIND            NAMESPACE  NAME                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook        Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-app-python  Synced                        serviceaccount/python-app-app-python unchanged
       Secret          default    my-secret              Synced                        secret/my-secret unchanged
       ConfigMap       default    app-config             Synced                        configmap/app-config unchanged
       Service         default    python-app-app-python  Synced     Healthy            service/python-app-app-python unchanged
apps   Deployment      default    python-app-app-python  Synced     Healthy            deployment.apps/python-app-app-python unchanged
       Pod             default    postinstall-hook       Succeeded           PostSync  pod/postinstall-hook created
```
```bash
> argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (397ff35)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    preinstall-hook        Succeeded           PreSync   pod/preinstall-hook created
       ServiceAccount  default    python-app-app-python  Synced                        serviceaccount/python-app-app-python unchanged
       Secret          default    my-secret              Synced                        secret/my-secret unchanged
       ConfigMap       default    app-config             Synced                        configmap/app-config unchanged
       Service         default    python-app-app-python  Synced     Healthy            service/python-app-app-python unchanged
apps   Deployment      default    python-app-app-python  Synced     Healthy            deployment.apps/python-app-app-python unchanged
       Pod             default    postinstall-hook       Succeeded           PostSync  pod/postinstall-hook created
```
Pods now:
```bash
> kubectl get po 
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-app-python-58c79b59f7-5bv7s   1/1     Running   0             7m1s
```
I modify values.yaml, commit, and push changes. Pods after updating the repo:
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Tue Mar 11, 13:15]
└─[$] <git:(lab13)> kubectl get po 
NAME                                     READY   STATUS    RESTARTS      AGE
python-app-app-python-58c79b59f7-5bv7s   1/1     Running   0             23m
python-app-app-python-58c79b59f7-xkmkf   1/1     Running   0             3m24s
```
---

## Task 2: Multi-Environment Deployment & Auto-Sync

### Step 1: Create Namespaces
```bash
> kubectl create namespace dev
namespace/dev created
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Tue Mar 11, 13:24]
└─[$] <git:(lab13*)> kubectl create namespace prod
namespace/prod created
```
### Step 2: Deploy Multi-Environment Configurations
Apply environment-specific configurations:
```bash
> kubectl apply -f ArgoCD/argocd-python-dev.yaml
kubectl apply -f ArgoCD/argocd-python-prod.yaml
application.argoproj.io/python-app-dev created
application.argoproj.io/python-app-prod created
```

### Step 3: Enable Auto-Sync
Modify `values-prod.yaml`, commit, and push changes. Verify auto-sync:
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 11:50]
└─[$] <git:(lab13)> argocd app sync python-app-prod                                                                           
TIMESTAMP                  GROUP              KIND                NAMESPACE                  NAME          STATUS   HEALTH            HOOK  MESSAGE
2025-03-13T11:51:10+03:00                   Secret                     prod             my-secret          Synced                           
2025-03-13T11:51:10+03:00                  Service                     prod  python-app-prod-app-python    Synced  Progressing              
2025-03-13T11:51:10+03:00               ServiceAccount                 prod  python-app-prod-app-python    Synced                           
2025-03-13T11:51:10+03:00   apps        Deployment                     prod  python-app-prod-app-python    Synced  Healthy                  
2025-03-13T11:51:10+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced  Healthy                  
2025-03-13T11:51:10+03:00                ConfigMap                     prod            app-config          Synced                           
2025-03-13T11:51:10+03:00                      Pod                     prod       preinstall-hook                                           
2025-03-13T11:51:28+03:00   apps  Deployment        prod  python-app-prod-app-python  OutOfSync  Healthy              
2025-03-13T11:51:28+03:00          ConfigMap        prod            app-config        OutOfSync                       
2025-03-13T11:51:31+03:00                Pod        prod       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook unchanged
2025-03-13T11:51:32+03:00          ConfigMap        prod            app-config    Synced                       
2025-03-13T11:51:33+03:00   apps  Deployment        prod  python-app-prod-app-python    Synced  Progressing              
2025-03-13T11:51:34+03:00                ConfigMap                     prod            app-config          Synced                            configmap/app-config configured
2025-03-13T11:51:34+03:00                  Service                     prod  python-app-prod-app-python    Synced   Progressing              service/python-app-prod-app-python unchanged
2025-03-13T11:51:34+03:00   apps        Deployment                     prod  python-app-prod-app-python    Synced   Progressing              deployment.apps/python-app-prod-app-python configured
2025-03-13T11:51:34+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced   Healthy                  horizontalpodautoscaler.autoscaling/python-app-prod-app-python unchanged
2025-03-13T11:51:34+03:00                      Pod                     prod       preinstall-hook        Succeeded   Synced         PreSync  pod/preinstall-hook unchanged
2025-03-13T11:51:34+03:00               ServiceAccount                 prod  python-app-prod-app-python    Synced                            serviceaccount/python-app-prod-app-python unchanged
2025-03-13T11:51:34+03:00                   Secret                     prod             my-secret          Synced                            secret/my-secret unchanged
2025-03-13T11:51:35+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced  Healthy              the HPA controller was able to get the target's current scale
2025-03-13T11:51:43+03:00   apps  Deployment        prod  python-app-prod-app-python    Synced  Healthy              deployment.apps/python-app-prod-app-python configured
2025-03-13T12:10:19+03:00            Service        prod  python-app-prod-app-python    Synced  Healthy              service/python-app-prod-app-python unchanged
2025-03-13T12:10:20+03:00                Pod        prod      postinstall-hook   Running   Synced    PostSync  pod/postinstall-hook created
2025-03-13T12:10:45+03:00                Pod        prod      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (a10953d)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      a10953dcb66bb187066418566236c5a4d3b8aa2e
Phase:              Succeeded
Start:              2025-03-13 11:51:28 +0300 MSK
Finished:           2025-03-13 12:10:45 +0300 MSK
Duration:           19m17s
Message:            successfully synced (no more tasks)

GROUP        KIND                     NAMESPACE  NAME                        STATUS     HEALTH   HOOK      MESSAGE
             Pod                      prod       preinstall-hook             Succeeded           PreSync   pod/preinstall-hook unchanged
             ServiceAccount           prod       python-app-prod-app-python  Synced                        serviceaccount/python-app-prod-app-python unchanged
             Secret                   prod       my-secret                   Synced                        secret/my-secret unchanged
             ConfigMap                prod       app-config                  Synced                        configmap/app-config configured
             Service                  prod       python-app-prod-app-python  Synced     Healthy            service/python-app-prod-app-python unchanged
apps         Deployment               prod       python-app-prod-app-python  Synced     Healthy            deployment.apps/python-app-prod-app-python configured
autoscaling  HorizontalPodAutoscaler  prod       python-app-prod-app-python  Synced     Healthy            the HPA controller was able to get the target's current scale
             Pod                      prod       postinstall-hook            Succeeded           PostSync  pod/postinstall-hook created
```
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 12:10]
└─[$] <git:(lab13)> argocd app get python-app-prod 
Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (a10953d)
Health Status:      Healthy

GROUP        KIND                     NAMESPACE  NAME                        STATUS     HEALTH   HOOK      MESSAGE
             Pod                      prod       preinstall-hook             Succeeded           PreSync   pod/preinstall-hook unchanged
             ServiceAccount           prod       python-app-prod-app-python  Synced                        serviceaccount/python-app-prod-app-python unchanged
             Secret                   prod       my-secret                   Synced                        secret/my-secret unchanged
             ConfigMap                prod       app-config                  Synced                        configmap/app-config configured
             Service                  prod       python-app-prod-app-python  Synced     Healthy            service/python-app-prod-app-python unchanged
apps         Deployment               prod       python-app-prod-app-python  Synced     Healthy            deployment.apps/python-app-prod-app-python configured
autoscaling  HorizontalPodAutoscaler  prod       python-app-prod-app-python  Synced     Healthy            the HPA controller was able to get the target's current scale
             Pod                      prod       postinstall-hook            Succeeded           PostSync  pod/postinstall-hook created
```
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 12:13]
└─[$] <git:(lab13*)> kubectl get po -n prod
NAME                                         READY   STATUS    RESTARTS   AGE
python-app-prod-app-python-ff9666799-5wgpn   1/1     Running   0          22m
python-app-prod-app-python-ff9666799-mpdw4   1/1     Running   0          22m
python-app-prod-app-python-ff9666799-ttghn   1/1     Running   0          22m
```
### Step 4: Test Self-Healing
#### Test 1: Change Replica Count
```bash
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 13:49]
└─[$] <git:(lab13*)> kubectl patch deployment python-app-prod-app-python -n prod --patch '{"spec":{"replicas": 3}}'                
deployment.apps/python-app-prod-app-python patched (no change)
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 13:49]
└─[$] <git:(lab13*)> kubectl get po -n prod                                                              
NAME                                         READY   STATUS    RESTARTS   AGE
python-app-prod-app-python-ff9666799-5wgpn   1/1     Running   0          118m
python-app-prod-app-python-ff9666799-mpdw4   1/1     Running   0          117m
python-app-prod-app-python-ff9666799-ttghn   1/1     Running   0          118m
```
Observe ArgoCD auto-reverting:
```bash
> argocd app sync python-app-prod

TIMESTAMP                  GROUP              KIND                NAMESPACE                  NAME          STATUS   HEALTH        HOOK  MESSAGE
2025-03-13T13:50:17+03:00                ConfigMap                     prod            app-config          Synced                       
2025-03-13T13:50:17+03:00                   Secret                     prod             my-secret          Synced                       
2025-03-13T13:50:17+03:00                  Service                     prod  python-app-prod-app-python    Synced  Healthy              
2025-03-13T13:50:17+03:00               ServiceAccount                 prod  python-app-prod-app-python    Synced                       
2025-03-13T13:50:17+03:00   apps        Deployment                     prod  python-app-prod-app-python    Synced  Healthy              
2025-03-13T13:50:17+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced  Healthy              
2025-03-13T13:50:18+03:00                Pod        prod       preinstall-hook                                 
2025-03-13T13:50:20+03:00                Pod        prod       preinstall-hook   Running   Synced     PreSync  pod/preinstall-hook created
2025-03-13T13:50:44+03:00                   Secret                     prod             my-secret          Synced                        secret/my-secret unchanged
2025-03-13T13:50:44+03:00                ConfigMap                     prod            app-config          Synced                        configmap/app-config unchanged
2025-03-13T13:50:44+03:00                  Service                     prod  python-app-prod-app-python    Synced   Healthy              service/python-app-prod-app-python unchanged
2025-03-13T13:50:44+03:00   apps        Deployment                     prod  python-app-prod-app-python    Synced   Healthy              deployment.apps/python-app-prod-app-python configured
2025-03-13T13:50:44+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced   Healthy              horizontalpodautoscaler.autoscaling/python-app-prod-app-python unchanged
2025-03-13T13:50:44+03:00                      Pod                     prod       preinstall-hook        Succeeded   Synced     PreSync  pod/preinstall-hook created
2025-03-13T13:50:44+03:00               ServiceAccount                 prod  python-app-prod-app-python    Synced                        serviceaccount/python-app-prod-app-python unchanged
2025-03-13T13:50:45+03:00  autoscaling  HorizontalPodAutoscaler        prod  python-app-prod-app-python    Synced  Healthy              the HPA controller was able to get the target's current scale
2025-03-13T13:50:45+03:00                      Pod                     prod      postinstall-hook         Running   Synced    PostSync  pod/postinstall-hook created
2025-03-13T13:51:08+03:00                Pod        prod      postinstall-hook  Succeeded   Synced    PostSync  pod/postinstall-hook created

Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/ramilevna/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (a10953d)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      a10953dcb66bb187066418566236c5a4d3b8aa2e
Phase:              Succeeded
Start:              2025-03-13 13:50:18 +0300 MSK
Finished:           2025-03-13 13:51:08 +0300 MSK
Duration:           50s
Message:            successfully synced (no more tasks)

GROUP        KIND                     NAMESPACE  NAME                        STATUS     HEALTH   HOOK      MESSAGE
             Pod                      prod       preinstall-hook             Succeeded           PreSync   pod/preinstall-hook created
             ServiceAccount           prod       python-app-prod-app-python  Synced                        serviceaccount/python-app-prod-app-python unchanged
             Secret                   prod       my-secret                   Synced                        secret/my-secret unchanged
             ConfigMap                prod       app-config                  Synced                        configmap/app-config unchanged
             Service                  prod       python-app-prod-app-python  Synced     Healthy            service/python-app-prod-app-python unchanged
apps         Deployment               prod       python-app-prod-app-python  Synced     Healthy            deployment.apps/python-app-prod-app-python configured
autoscaling  HorizontalPodAutoscaler  prod       python-app-prod-app-python  Synced     Healthy            the HPA controller was able to get the target's current scale
             Pod                      prod       postinstall-hook            Succeeded           PostSync  pod/postinstall-hook created
```

#### Test 2
Delete a Pod, Check pod recreation, Check ArgoCD status.
```bash
> kubectl get pods -n prod -w                                                    
NAME                                         READY   STATUS    RESTARTS   AGE
python-app-prod-app-python-ff9666799-lhlx6   1/1     Running   0          14s
python-app-prod-app-python-ff9666799-mpdw4   1/1     Running   0          124m
python-app-prod-app-python-ff9666799-ttghn   1/1     Running   0          124m
^C%                                                                                                                                                                    (base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 13:55]
└─[$] <git:(lab13*)> kubectl delete pod python-app-prod-app-python-ff9666799-lhlx6 -n prod
pod "python-app-prod-app-python-ff9666799-lhlx6" deleted
(base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 13:56]
└─[$] <git:(lab13*)> kubectl get pods -n prod -w                                          
NAME                                         READY   STATUS    RESTARTS   AGE
python-app-prod-app-python-ff9666799-2v5hd   1/1     Running   0          4s
python-app-prod-app-python-ff9666799-mpdw4   1/1     Running   0          124m
python-app-prod-app-python-ff9666799-ttghn   1/1     Running   0          124m
^C%                                                                                                                                                                    (base) ┌─[renatalatypova@MacBook-Pro-Renata] - [~/PycharmProjects/S25-core-course-labs/k8s] - [Thu Mar 13, 13:56]
└─[$] <git:(lab13*)> argocd app diff python-app-prod


```
---
