# Lab 13

## ArgoCD

### Verify argocd installation

```text
dm@DESKTOP-85MKAD8:/mnt/d/github_repos/S25-core-course-labs/k8s$ kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
pod/argo-argocd-server-56c6d4f9b7-9czkf condition met
```

### App status

```text
argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/Friedox/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (9e10d17)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                                STATUS     HEALTH   HOOK      MESSAGE
batch  Job             default    preinstall-hook                     Succeeded           PreSync   job.batch/preinstall-hook created
       ServiceAccount  default    python-app-app-python               Synced                        serviceaccount/python-app-app-python created
       Secret          default    python-app-app-python-vault-secret  Synced                        secret/python-app-app-python-vault-secret created
       Secret          default    python-app-app-python-secret        Synced                        secret/python-app-app-python-secret created
       ConfigMap       default    app-python-config                   Synced                        configmap/app-python-config created
       Service         default    python-app-app-python               Synced     Healthy            service/python-app-app-python created
apps   Deployment      default    python-app-app-python               Synced     Healthy            deployment.apps/python-app-app-python created
batch  Job             default    post-install-hook                   Succeeded           PostSync  job.batch/post-install-hook created
```

### ArgoCD UI
![argo-ui](assets/arg_ui.jpg)

### Test Sync Workflow

The result after updating replica count to 3

```text
argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/Friedox/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/app-python
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (9e10d17)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                                STATUS     HEALTH   HOOK      MESSAGE
batch  Job             default    preinstall-hook                     Succeeded           PreSync   job.batch/preinstall-hook created
       ServiceAccount  default    python-app-app-python               Synced                        serviceaccount/python-app-app-python created
       Secret          default    python-app-app-python-vault-secret  Synced                        secret/python-app-app-python-vault-secret created
       Secret          default    python-app-app-python-secret        Synced                        secret/python-app-app-python-secret created
       ConfigMap       default    app-python-config                   Synced                        configmap/app-python-config created
       Service         default    python-app-app-python               Synced     Healthy            service/python-app-app-python created
apps   Deployment      default    python-app-app-python               Synced     Healthy            deployment.apps/python-app-app-python created
batch  Job             default    post-install-hook                   Succeeded           PostSync  job.batch/post-install-hook created 
```

We also can see the change in UI

![changes](assets/changes_ui.png)

## Task 2

### Creating namespaces

```bash
kubectl create namespace dev
kubectl create namespace prod
```

```text
namespace/dev created
namespace/prod created
```

### Multi-Environment deployment

```text
kubectl apply -f ArgoCD/argocd-python-dev.yaml
application.argoproj.io/python-app-dev created
kubectl apply -f ArgoCD/argocd-python-prod.yaml
application.argoproj.io/python-app-prod created
```

```text
➜  k8s git:(lab13) ✗ argocd app sync argocd/python-time-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-10T20:52:54+03:00          ConfigMap            prod         my-app-config    Synced
2025-03-10T20:52:54+03:00            Service            prod      python-time-prod    Synced  Healthy
2025-03-10T20:52:54+03:00         ServiceAccount        prod      python-time-prod    Synced
2025-03-10T20:52:54+03:00   apps  Deployment            prod      python-time-prod    Synced  Healthy
2025-03-10T20:52:55+03:00         ServiceAccount        prod      python-time-prod    Synced                       serviceaccount/python-time-prod unchanged
2025-03-10T20:52:55+03:00          ConfigMap            prod         my-app-config    Synced                       configmap/my-app-config unchanged
2025-03-10T20:52:55+03:00            Service            prod      python-time-prod    Synced  Healthy              service/python-time-prod unchanged
2025-03-10T20:52:55+03:00   apps  Deployment            prod      python-time-prod    Synced  Healthy              deployment.apps/python-time-prod unchanged
Name:               argocd/python-time-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/argocd/python-time-prod
Source:
- Repo:             https://github.com/MishaBlin/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (1a579db)
Health Status:      Healthy
Operation:          Sync
Sync Revision:      1a579dbfb08c487f2462587f68e6c28e32cf8ed2
Phase:              Succeeded
Start:              2025-03-10 20:52:54 +0300 MSK
Finished:           2025-03-10 20:52:55 +0300 MSK
Duration:           1s
Message:            successfully synced (all tasks run)
GROUP  KIND            NAMESPACE  NAME              STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  prod       python-time-prod  Synced                 serviceaccount/python-time-prod unchanged
       ConfigMap       prod       my-app-config     Synced                 configmap/my-app-config unchanged
       Service         prod       python-time-prod  Synced  Healthy        service/python-time-prod unchanged
apps   Deployment      prod       python-time-prod  Synced  Healthy        deployment.apps/python-time-prod unchanged
```

```text
➜  k8s git:(lab13) ✗ argocd app sync argocd/python-time-dev
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS   HEALTH        HOOK  MESSAGE
2025-03-10T20:53:28+03:00          ConfigMap             dev         my-app-config    Synced
2025-03-10T20:53:28+03:00            Service             dev       python-time-dev    Synced  Healthy
2025-03-10T20:53:28+03:00         ServiceAccount         dev       python-time-dev    Synced
2025-03-10T20:53:28+03:00   apps  Deployment             dev       python-time-dev    Synced  Healthy
2025-03-10T20:53:29+03:00         ServiceAccount         dev       python-time-dev    Synced                       serviceaccount/python-time-dev unchanged
2025-03-10T20:53:29+03:00          ConfigMap             dev         my-app-config    Synced                       configmap/my-app-config unchanged
2025-03-10T20:53:29+03:00            Service             dev       python-time-dev    Synced  Healthy              service/python-time-dev unchanged
2025-03-10T20:53:29+03:00   apps  Deployment             dev       python-time-dev    Synced  Healthy              deployment.apps/python-time-dev unchanged
Name:               argocd/python-time-dev
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          dev
URL:                https://argocd.example.com/applications/argocd/python-time-dev
Source:
- Repo:             https://github.com/MishaBlin/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time
  Helm Values:      values-dev.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (1a579db)
Health Status:      Healthy
Operation:          Sync
Sync Revision:      1a579dbfb08c487f2462587f68e6c28e32cf8ed2
Phase:              Succeeded
Start:              2025-03-10 20:53:28 +0300 MSK
Finished:           2025-03-10 20:53:29 +0300 MSK
Duration:           1s
Message:            successfully synced (all tasks run)
GROUP  KIND            NAMESPACE  NAME             STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  dev        python-time-dev  Synced                 serviceaccount/python-time-dev unchanged
       ConfigMap       dev        my-app-config    Synced                 configmap/my-app-config unchanged
       Service         dev        python-time-dev  Synced  Healthy        service/python-time-dev unchanged
apps   Deployment      dev        python-time-dev  Synced  Healthy        deployment.apps/python-time-dev unchanged
```

![multi-env](assets/multi-env.jpg)

### Self-heal testing

#### Test 1

```text
➜  k8s git:(lab13) ✗ kubectl patch deployment python-time-prod -n prod --patch '{"spec":{"replicas": 3}}'
deployment.apps/python-time-prod patched
```

We can notice that app is out of sync

![out-of-sync](assets/out-of-sync.jpg)

```text
➜  k8s git:(lab13) ✗ argocd app sync python-time-prod
TIMESTAMP                  GROUP        KIND       NAMESPACE                  NAME    STATUS    HEALTH        HOOK  MESSAGE
2025-03-10T20:56:48+03:00          ConfigMap            prod         my-app-config    Synced
2025-03-10T20:56:48+03:00            Service            prod      python-time-prod    Synced   Healthy
2025-03-10T20:56:48+03:00         ServiceAccount        prod      python-time-prod    Synced
2025-03-10T20:56:48+03:00   apps  Deployment            prod      python-time-prod  OutOfSync  Healthy
2025-03-10T20:56:49+03:00   apps  Deployment            prod      python-time-prod  OutOfSync  Healthy              deployment.apps/python-time-prod configured
2025-03-10T20:56:49+03:00         ServiceAccount        prod      python-time-prod    Synced                        serviceaccount/python-time-prod unchanged
2025-03-10T20:56:49+03:00          ConfigMap            prod         my-app-config    Synced                        configmap/my-app-config unchanged
2025-03-10T20:56:49+03:00            Service            prod      python-time-prod    Synced   Healthy              service/python-time-prod unchanged
2025-03-10T20:56:49+03:00   apps  Deployment        prod      python-time-prod    Synced  Progressing              deployment.apps/python-time-prod configured
2025-03-10T20:56:49+03:00   apps  Deployment        prod      python-time-prod    Synced  Progressing              deployment.apps/python-time-prod unchanged
2025-03-10T20:56:49+03:00   apps  Deployment        prod      python-time-prod    Synced  Healthy              deployment.apps/python-time-prod unchanged
Name:               argocd/python-time-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-time-prod
Source:
- Repo:             https://github.com/MishaBlin/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (1a579db)
Health Status:      Healthy
Operation:          Sync
Sync Revision:      1a579dbfb08c487f2462587f68e6c28e32cf8ed2
Phase:              Succeeded
Start:              2025-03-10 20:56:48 +0300 MSK
Finished:           2025-03-10 20:56:49 +0300 MSK
Duration:           1s
Message:            successfully synced (all tasks run)
GROUP  KIND            NAMESPACE  NAME              STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  prod       python-time-prod  Synced                 serviceaccount/python-time-prod unchanged
       ConfigMap       prod       my-app-config     Synced                 configmap/my-app-config unchanged
       Service         prod       python-time-prod  Synced  Healthy        service/python-time-prod unchanged
apps   Deployment      prod       python-time-prod  Synced  Healthy        deployment.apps/python-time-prod unchanged
```

And the app syncs back

![sync-back](assets/sync-back.jpg)

#### Test 2

Initial state (all pods running)

```text
➜  k8s git:(lab13) ✗ kubectl get po -n prod
NAME                               READY   STATUS    RESTARTS   AGE
python-time-prod-874f94f55-fct5r   1/1     Running   0          16m
python-time-prod-874f94f55-knssf   1/1     Running   0          45s
```

Delete a pod

```text
➜ k8s git:(lab13) ✗ kubectl delete pods -n prod python-time-prod-874f94f55-fct5r
pod "python-time-prod-874f94f55-fct5r" deleted
```

No drift in argocd

```text
➜ k8s git:(lab13) ✗ argocd app diff python-time-prod
```

Check that the pod was recreated

![pod-recreated](assets/pod-recreated.jpg)

### How ArgoCD handles configuration drift vs. runtime events

ArgoCD monitors the state of a cluster and checks if it is different from the state in git repository.
If a drift is detected, ArgoCD syncs the cluster with git repository and restores the state accoriding to
its configuration.

Runtime events like pod deletion are not detected by ArgoCD. Kubernetes detects the changes by itself and runs
self-healing processes to react to these events. For ArgoCD the state remains unchanged in such cases.