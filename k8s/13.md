# Lab 13: ArgoCD for GitOps Deployment

## Task 1: Deploy and Configure ArgoCD

1. **Install ArgoCD via Helm**

   - **Add the ArgoCD Helm repository:**

     ```powershell
     suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$  helm repo add argo https://argoproj.github.io/argo-helm
     "argo" has been added to your repositories
     ```
   - **Install ArgoCD:**

     ```powershell
     suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ helm install argo argo/argo-cd --namespace argocd --create-namespace
     NAME: argo
     LAST DEPLOYED: Wed Mar 26 14:32:10 2025
     NAMESPACE: argocd
     STATUS: deployed
     REVISION: 1
     TEST SUITE: None
     NOTES:
     In order to access the server UI you have the following options:

     1. kubectl port-forward service/argo-argocd-server -n argocd 8080:443

         and then open the browser on http://localhost:8080 and accept the certificate

     2. enable ingress in the values file `server.ingress.enabled` and either
           - Add the annotation for ssl passthrough: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-1-ssl-passthrough
           - Set the `configs.params."server.insecure"` in the values file and terminate SSL at your ingress: https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/#option-2-multiple-ingress-objects-and-hosts

     After reaching the UI the first time you can login with username: admin and the random password generated during the installation. You can find the password by running:

     kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

     (You should delete the initial secret afterwards as suggested by the Getting Started Guide: https://argo-cd.readthedocs.io/en/stable/getting_started/#4-login-using-the-cli)
     ```
   - **Verify installation:**

     ```powershell
     suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
     pod/argo-argocd-server-7b688c6d85-4fn4l condition met
     ```
# Install ArgoCD CLI
- **Download and install the ArgoCD CLI tool:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | jq -r .tag_name)
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/download/${VERSION}/argocd-linux-amd64"
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ chmod +x argocd
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ sudo mv argocd /usr/local/bin/
  ```

- **Verify CLI installation:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ argocd version
  ```

# Access the ArgoCD UI
- **Forward the ArgoCD server port:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ kubectl port-forward svc/argo-argocd-server -n argocd 8080:443
  ```

- **Retrieve the initial admin password:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
  ```

- **Log in via CLI:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ argocd login localhost:8080 --username admin --password P@ssw0rd123 --insecure
  ```

# Configure Python App Sync
- **Define the ArgoCD Application**
- **Apply the configuration**
- **Verify the application status:**

  ```bash
  suleiman@suleiman-lap:~/code/university/devops/S25-core-course-labs/k8s$ argocd app get python-app
  ```

  ```
  Name:               argocd/python-app
  Project:            default
  Server:             https://kubernetes.default.svc
  Namespace:          default
  URL:                https://argocd.example.com/applications/python-app
  Source:
    Repo:             https://github.com/SuleimanKarimEddin/S25-devops-engineering-labs.git
    Target:           lab13
    Path:             k8s/app-python
    Helm Values:      values.yaml
  SyncWindow:         Sync Allowed
  Sync Policy:        Automated (Prune)
  Sync Status:        Synced to lab13 (c760586)
  Health Status:      Healthy

  GROUP                       KIND                 NAMESPACE  NAME                   STATUS  HEALTH   HOOK  MESSAGE
                              ServiceAccount       default    python-app  Synced                  serviceaccount/python-app unchanged
                              ConfigMap            default    app-python-config      Synced                  configmap/app-python-config unchanged
                              Service              default    python-app  Synced  Healthy         service/python-app unchanged
  apps                        Deployment           default    python-app  Synced  Healthy         deployment.apps/python-app unchanged
  ```

### **ArgoCD Auto-Sync and Self-Healing**  

#### **Auto-Sync**  
ArgoCD continuously monitors the Git repository for any changes in the declared configuration. When an update occurs—such as modifying the `replicaCount` in a deployment manifest—ArgoCD automatically detects the change and synchronizes the live Kubernetes state to match the desired state defined in Git. This ensures that deployments remain consistent with the latest approved configurations without requiring manual intervention.  

#### **Self-Healing**  
In environments where ArgoCD's auto-sync is enabled, the system actively detects and corrects configuration drift. If an unauthorized manual change is made—such as modifying the replica count directly within the cluster—or if a pod is unexpectedly deleted, ArgoCD automatically restores the defined state. While Kubernetes' native controllers handle runtime events like pod restarts, ArgoCD ensures that any unintended modifications to the declared infrastructure are reverted, maintaining consistency, security, and operational reliability.
