# Lab 13: ArgoCD for GitOps Deployment

## Task 1: Deploy and Configure ArgoCD

### Installation and Setup

I installed ArgoCD using Helm:

```bash
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
helm install argo argo/argo-cd --namespace argocd --create-namespace
```

Verified the installation:

```bash
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=90s
```

Output: 
```bash
pod/argo-argocd-server-7b688c6d85-79fb9 condition met
```


### ArgoCD CLI Installation

Installed the ArgoCD CLI and verified it:

```bash
argocd version
```

Output:

```bash
argocd: v2.14.5+f463a94
  BuildDate: 2025-03-11T04:57:25Z
  GitCommit: f463a945d57267e9691cede37021d9ddc5994f36
  GitTreeState: clean
  GoVersion: go1.24.1
  Compiler: gc
  Platform: darwin/arm64
```


### Accessing ArgoCD UI

Set up port forwarding and retrieved the initial admin password:

```bash
kubectl port-forward svc/argo-server -n argocd 8080:443 &
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
```

### Python App Sync Configuration

Created the ArgoCD application manifest and applied it:

```bash
kubectl apply -f k8s/ArgoCD/argocd-python-app.yaml
```

Verified the sync:

```bash
argocd app sync python-app
argocd app get python-app
```

Output:

```bash
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/mazzz3r/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/helm-chart
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (5aadfba)
Health Status:      Healthy

Operation:          Sync
Sync Revision:      a879b91514dc03d77573d36fa4deb4d3895ae579
Phase:              Succeeded
Start:              2025-03-16 17:04:40 +0300 MSK
Finished:           2025-03-16 17:04:40 +0300 MSK
Duration:           0s
Message:            successfully synced (all tasks run)

GROUP  KIND            NAMESPACE  NAME                          STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  default    python-app-helm-chart         Synced                 serviceaccount/python-app-helm-chart unchanged
       Secret          default    python-app-helm-chart-secret  Synced                 secret/python-app-helm-chart-secret unchanged
       ConfigMap       default    python-app-helm-chart-config  Synced                 configmap/python-app-helm-chart-config unchanged
       Service         default    python-app-helm-chart         Synced  Healthy        service/python-app-helm-chart unchanged
apps   Deployment      default    python-app-helm-chart         Synced  Healthy        deployment.apps/python-app-helm-chart unchanged
```


### Testing Sync Workflow

Modified values.yaml to update replicaCount and observed ArgoCD auto-sync the update.

```bash
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/mazzz3r/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/helm-chart
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (b16de66)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                          STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  default    python-app-helm-chart         Synced                 serviceaccount/python-app-helm-chart unchanged
       Secret          default    python-app-helm-chart-secret  Synced                 secret/python-app-helm-chart-secret unchanged
       ConfigMap       default    python-app-helm-chart-config  Synced                 configmap/python-app-helm-chart-config unchanged
       Service         default    python-app-helm-chart         Synced  Healthy        service/python-app-helm-chart unchanged
apps   Deployment      default    python-app-helm-chart         Synced  Healthy        deployment.apps/python-app-helm-chart configured
```

## Task 2: Multi-Environment Deployment & Auto-Sync

### Multi-Environment Setup

Created environment-specific values files and namespaces:

```bash
kubectl create namespace dev
kubectl create namespace prod
```

Applied ArgoCD application manifests for dev and prod environments:

```bash
kubectl apply -f k8s/ArgoCD/argocd-python-dev.yaml
kubectl apply -f k8s/ArgoCD/argocd-python-prod.yaml
```

Output of `argocd app get python-app-dev`:

```bash
Name:               argocd/python-app-dev
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          dev
URL:                https://argocd.example.com/applications/python-app-dev
Source:
- Repo:             https://github.com/mazzz3r/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/helm-chart
  Helm Values:      values-dev.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (5459b0f)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                              STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  dev        python-app-dev-helm-chart         Synced                 serviceaccount/python-app-dev-helm-chart unchanged
       Secret          dev        python-app-dev-helm-chart-secret  Synced                 secret/python-app-dev-helm-chart-secret unchanged
       ConfigMap       dev        python-app-dev-helm-chart-config  Synced                 configmap/python-app-dev-helm-chart-config unchanged
       Service         dev        python-app-dev-helm-chart         Synced  Healthy        service/python-app-dev-helm-chart unchanged
apps   Deployment      dev        python-app-dev-helm-chart         Synced  Healthy        deployment.apps/python-app-dev-helm-chart configured
```

Output of `argocd app get python-app-prod`:

```bash
Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/mazzz3r/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/helm-chart
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to lab13 (25208cb)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                               STATUS  HEALTH   HOOK  MESSAGE
       ServiceAccount  prod       python-app-prod-helm-chart         Synced                 serviceaccount/python-app-prod-helm-chart unchanged
       Secret          prod       python-app-prod-helm-chart-secret  Synced                 secret/python-app-prod-helm-chart-secret unchanged
       ConfigMap       prod       python-app-prod-helm-chart-config  Synced                 configmap/python-app-prod-helm-chart-config unchanged
       Service         prod       python-app-prod-helm-chart         Synced  Healthy        service/python-app-prod-helm-chart unchanged
apps   Deployment      prod       python-app-prod-helm-chart         Synced  Healthy        deployment.apps/python-app-prod-helm-chart unchanged
```

### Self-Heal Testing

#### Test 1: Manual Override of Replica Count

Before:
```bash
kubectl get pods -n prod
```

Output:

```bash
NAME                                          READY   STATUS    RESTARTS   AGE
python-app-prod-helm-chart-667d784dc4-2mjt5   1/1     Running   0          93s
python-app-prod-helm-chart-667d784dc4-vcwp6   1/1     Running   0          91s
```


Modified the deployment's replica count manually:

```bash
kubectl patch deployment python-app-prod-helm-chart -n prod --patch '{"spec":{"replicas": 3}}'
```

After (ArgoCD auto-reverted the change):
```bash
kubectl get pods -n prod
```

Output:

```bash
NAME                                          READY   STATUS    RESTARTS   AGE
python-app-prod-helm-chart-667d784dc4-2mjt5   1/1     Running   0          2m40s
python-app-prod-helm-chart-667d784dc4-vcwp6   1/1     Running   0          2m38s
```


#### Test 2: Delete a Pod (Replica)

Before:
```bash
kubectl get pods -n prod
```

Output:

```bash
NAME                                          READY   STATUS    RESTARTS   AGE
python-app-prod-helm-chart-667d784dc4-2mjt5   1/1     Running   0          2m56s
python-app-prod-helm-chart-667d784dc4-vcwp6   1/1     Running   0          2m54s
```


Deleted a pod:
```bash
kubectl delete pod python-app-prod-helm-chart-667d784dc4-2mjt5 -n prod
```

After (Kubernetes recreated the pod):
```bash
kubectl get pods -n prod
```

Output:
```bash
NAME                                          READY   STATUS    RESTARTS   AGE
python-app-prod-helm-chart-667d784dc4-675tf   1/1     Running   0          3s
python-app-prod-helm-chart-667d784dc4-vcwp6   1/1     Running   0          3m18s
```


### Explanation of ArgoCD Behavior

ArgoCD handles configuration drift and runtime events differently:

1. **Configuration Drift**: When the actual state of resources (like the number of replicas) differs from the desired state defined in Git, ArgoCD detects this as drift and automatically corrects it if auto-sync is enabled. This is what happened in Test 1 when we manually changed the replica count.

2. **Runtime Events**: When a pod is deleted (Test 2), Kubernetes itself handles this event through the Deployment controller, which ensures the desired number of replicas is maintained. ArgoCD doesn't need to intervene because the desired state (number of replicas) hasn't changed, only the specific pod instances.

This demonstrates how ArgoCD focuses on maintaining the desired configuration state, while Kubernetes handles runtime operations and self-healing at the pod level.
