# Lab 12: Kubernetes ConfigMaps Implementation

## ConfigMap Implementation

### Files Created
1. `app_python/files/config.json` - Configuration file containing application settings
2. `k8s/python-app/templates/configmap.yaml` - ConfigMap template that mounts the config file
3. Updated `k8s/python-app/templates/deployment.yaml` - Added volume and volumeMount configurations

### Configuration Details
The ConfigMap is mounted at `/app/config.json` in the container, making the configuration available to the application.

### Verification Steps and Outputs

1. Install/Upgrade the Helm chart:
```bash
$ helm upgrade --install python-app ./k8s/python-app
Release "python-app" has been upgraded. Happy Helming!
NAME: python-app
LAST DEPLOYED: Tue May 20 04:34:13 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

2. Verify the ConfigMap was created:
```bash
$ kubectl get configmap python-app-config
NAME                DATA   AGE
python-app-config   1      6s
```

3. Verify the pod is running:
```bash
$ kubectl get pods -l app.kubernetes.io/instance=python-app
NAME                          READY   STATUS     RESTARTS   AGE
python-app-76b4ff8584-xrcmm   0/2     Init:0/1   0          8s
python-app-788f5cc5d-kl6lf    1/1     Running    0          30m
```

4. Check the ConfigMap inside the pod:
```bash
$ kubectl exec python-app-788f5cc5d-kl6lf -- cat /app/config.json
cat: can't open '/app/config.json': No such file or directory
command terminated with exit code 1
```

Note: The ConfigMap mount appears to be having issues. This might need further investigation.

## Application Persistence Implementation

### Changes Made
1. Added visit counter functionality to `app.py`
2. Created `docker-compose.yml` with volume mounting
3. Updated README.md with new features documentation

### Testing Persistence and Outputs

1. Run the application locally:
```bash
$ docker-compose up --build -d
Creating network "app_python_default" with the default driver
Building web
[+] Building 12.6s (14/14) FINISHED
 => [internal] load build definition from Dockerfile                                                   0.3s
 => => transferring dockerfile: 74B                                                                    0.2s
 => [internal] load .dockerignore                                                                      0.2s
 => => transferring context: 71B                                                                       0.0s
 => [internal] load metadata for docker.io/library/python:3.9-alpine3.15                               2.7s
 => [auth] library/python:pull token for registry-1.docker.io                                          0.0s
 => [1/8] FROM docker.io/library/python:3.9-alpine3.15@sha256:86d5546236a8f8dd6505a92c40db8a01f8c22b7  0.0s
 => [internal] load build context                                                                      0.1s
 => => transferring context: 9.38kB                                                                    0.0s
 => CACHED [2/8] RUN apk add --no-cache     build-base     libffi-dev     libressl-dev     && pip ins  0.0s
 => CACHED [3/8] RUN adduser -D appuser                                                                0.0s
 => CACHED [4/8] WORKDIR /home/appuser/app                                                             0.0s
 => CACHED [5/8] COPY requirements.txt .                                                               0.0s
 => CACHED [6/8] RUN pip install --no-cache-dir -r requirements.txt                                    0.0s
 => [7/8] COPY . .                                                                                     0.2s
 => [8/8] RUN chown -R appuser:appuser /home/appuser/app                                               8.4s
 => exporting to image                                                                                 0.5s
 => => exporting layers                                                                                0.4s
 => => writing image sha256:c42cb9ff0b26849722c1e97486c1f8787cbb1d4a9fcfd5d4e8e049844693cc8e           0.0s
 => => naming to docker.io/library/app_python_web                                                      0.0s
Creating app_python_web_1 ... done
```

2. Access the application:
```bash
$ curl http://localhost:8000/
{"message":"The current time in Moscow is: 2025-05-20 04:35:00","visits":1}
```

3. Check the visits count:
```bash
$ curl http://localhost:8000/visits
{"total_visits":1}
```

4. Verify the visits file:
```bash
$ cat visits
cat: visits: Is a directory
``` 