# Kubernetes ConfigMaps

## Upgrade Application for Persistence

I have added /visits endpoint for both apps with respective persistence in file `data/visits`

You can see the results after testing locally using `docker-compose up --build`.

### Python app

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> curl http://localhost:8081       


StatusCode        : 200
StatusDescription : OK
RawContent        : HTTP/1.1 200 OK
                    Content-Length: 48
                    Content-Type: application/json
                    Date: Thu, 06 Mar 2025 21:45:39 GMT
                    Server: uvicorn

                    {"Current time in Moscow":"2025-03-07 00:45:39"}
Forms             : {}
Headers           : {[Content-Length, 48], [Content-Type, application/json], [Date, Thu, 06 Mar 2025 21:45:39 GMT], [Server, uvicorn]}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 48



PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> curl http://localhost:8081/visits


StatusCode        : 200
StatusDescription : OK
RawContent        : HTTP/1.1 200 OK
                    Content-Type: application/json
                    Date: Thu, 06 Mar 2025 21:45:50 GMT
                    Server: uvicorn

                    {"visits":1}
Forms             : {}
Headers           : {[Content-Length, 12], [Content-Type, application/json], [Date, Thu, 06 Mar 2025 21:45:50 GMT], [Server, uvicorn]}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 12



PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> Get-Content -Path .\py_visits_data\visits
1
```

### C# bonus app

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> curl http://localhost:8082/


StatusCode        : 200
StatusDescription : OK
Content           : <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <title>Moscow Time - MoscowTimeApp</title>
                        <li...
RawContent        : HTTP/1.1 200 OK
                    Transfer-Encoding: chunked
                    Content-Type: text/html; charset=utf-8
                    Date: Thu, 06 Mar 2025 21:46:14 GMT
                    Server: Kestrel

                    <html lang="en">
                    <head>
                        <meta charset="...
Forms             : {}
Headers           : {[Transfer-Encoding, chunked], [Content-Type, text/html; charset=utf-8], [Date, Thu, 06 Mar 2025 21:46:14 GMT], [Server, Kestrel]}        
Images            : {}
InputFields       : {}
Links             : {@{innerHTML=MoscowTimeApp; innerText=MoscowTimeApp; outerHTML=<A class=navbar-brand href="/">MoscowTimeApp</A>; outerText=MoscowTimeApp; 
                     tagName=A; class=navbar-brand; href=/}, @{innerHTML=Home; innerText=Home; outerHTML=<A class="nav-link text-dark" href="/">Home</A>; out 
                    erText=Home; tagName=A; class=nav-link text-dark; href=/}, @{innerHTML=Privacy; innerText=Privacy; outerHTML=<A class="nav-link text-dark 
                    " href="/Home/Privacy">Privacy</A>; outerText=Privacy; tagName=A; class=nav-link text-dark; href=/Home/Privacy}, @{innerHTML=Privacy; inn 
                    erText=Privacy; outerHTML=<A href="/Home/Privacy">Privacy</A>; outerText=Privacy; tagName=A; href=/Home/Privacy}}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 2454



PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> curl http://localhost:8082/visits        


StatusCode        : 200
StatusDescription : OK
RawContent        : HTTP/1.1 200 OK
                    Content-Length: 9
                    Content-Type: text/plain
                    Date: Thu, 06 Mar 2025 21:46:19 GMT
                    Server: Kestrel

                    Visits: 3
Forms             : {}
Headers           : {[Content-Length, 9], [Content-Type, text/plain], [Date, Thu, 06 Mar 2025 21:46:19 GMT], [Server, Kestrel]}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 9



PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\monitoring> Get-Content -Path .\cs_visits_data\visits
3
```

## ConfigMap Implementation

### Result for python app with configmap

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> helm install moscow-time-py ./moscow-time-py
LAST DEPLOYED: Fri Mar  7 22:52:53 2025
NAMESPACE: default
STATUS: deployed
NOTES:
1. Get the application URL by running these commands:
h="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po
NAME                              READY   STATUS    RESTARTS   AGE
moscow-time-py-76b45bfc5f-d2tqn   0/1     Running   0          40s
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get configmaps
NAME               DATA   AGE
kube-root-ca.crt   1      16m
py-app-config      1      103s
```

### Python Configmap content

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec moscow-time-py-76b45bfc5f-d2tqn -- cat /data/config.json
{
    "Wishlist1": "Mercedes-Benz CLS",
    "Wishlist2": "Porsche Panamera",
    "Wishlist3": "Land Rover"
}
```

### Result for C# app with configmap

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> helm install moscow-time-cs ./moscow-time-cs
NAME: moscow-time-cs
LAST DEPLOYED: Fri Mar  7 23:08:11 2025
NAMESPACE: default
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=moscow-time-cs,app.kubernetes.io/instance=moscow-time-cs" -o jsonpath="{.items[0].metadata.name}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get po
NAME                              READY   STATUS              RESTARTS   AGE
moscow-time-cs-7cf88c8ff8-p9dfs   0/1     ContainerCreating   0          34s
moscow-time-py-76b45bfc5f-d2tqn   1/1     Running             0          15m
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl get configmaps
NAME               DATA   AGE
cs-app-config      1      79s
kube-root-ca.crt   1      31m
py-app-config      1      16m
```

### C# Configmap content

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec moscow-time-cs-7cf88c8ff8-p9dfs -- cat /data/config.json
{
    "Wishlist4": "Volkswagen Golf",
    "Wishlist5": "BMW 340d",
    "Wishlist6": "Audi A5"
}
```

## BONUS

### envFrom property utilization result

Python

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec moscow-time-py-76b45bfc5f-d2tqn -- printenv config.json
{
    "Wishlist1": "Mercedes-Benz CLS",
    "Wishlist2": "Porsche Panamera",
    "Wishlist3": "Land Rover"
}
```

C#

```bash
PS E:\Documents\Innop\C3\S2\devops\S25-core-course-labs\k8s> kubectl exec moscow-time-cs-7cf88c8ff8-p9dfs -- printenv config.json
{
    "Wishlist4": "Volkswagen Golf",
    "Wishlist5": "BMW 340d",
    "Wishlist6": "Audi A5"
}
```
