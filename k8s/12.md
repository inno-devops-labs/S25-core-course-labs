# Lab 12

## Task 1

1. Updated app_python with visits (check app_python for changes) and added visits to the docker-compose:

```bash
...
  app_python:
    image: mangocandle/app_python:latest
    ports:
      - "5001:5001"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
    volumes:
      - ./data:/app/data
...
```

2. Checked that changes worked and are present in the deployment (and manual check on the web page):

```bash
curl http://localhost:5001/visits
{"visits":1}
```

## Task 2

1. Created the config.json file in files directory:

```bash
{
    "app_name": "Python app for Moscow Time",
    "version": "1.0.0",
    "maintainer": "Liubov Smirnova"
}
```

2. Created configmap.yaml in templates folder:

```bash
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
data:
  config: |- {{ .Files.Get "files/config.json" | nindent 4 }}
```

3. Updated deployments.yaml in templates and installed a new helmchart:

```bash
helm upgrade app-python ./app-python
Release "app-python" has been upgraded. Happy Helming!
NAME: app-python
LAST DEPLOYED: Sat Mar  8 13:05:46 2025
NAMESPACE: default
STATUS: deployed
REVISION: 3
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

4. Verified the installation:

```bash

kubectl get po
NAME                                    READY   STATUS    RESTARTS        AGE
app-python-5fbd6d9f77-sd4bl             1/1     Running   0               36s
vault-0                                 1/1     Running   1 (8m53s ago)   18h
vault-agent-injector-66f45b5fd5-bf5q8   1/1     Running   1 (8m53s ago)   18h
```

5. Checked the ConfigMap inside the pod:

```bash
kubectl exec -it app-python-5fbd6d9f77-sd4bl -- cat /app/config/config.json

{
    "app_name": "Python app for Moscow Time",
    "version": "1.0.0",
    "maintainer": "Liubov Smirnova"
}
```
