# Lab 12: Kubernetes ConfigMaps

## Overview

In this lab, we explored Kubernetes ConfigMaps to manage non-confidential data and upgraded our application for persistence. ConfigMaps allow us to decouple configuration artifacts from image content, enabling better management of configuration data separately from the application.

---

## Task 2: ConfigMap Implementation

### Steps

1. **Created a ConfigMap:**
   - Created a `files` folder with a `config.json` file containing the following data:

     ```json
     {
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

   - Used Helm to mount `config.json` into the application container.

2. **Helm Chart Updates:**
   - Created a `configMap` manifest using `.Files.Get` to retrieve data from `config.json`.
   - Updated `deployment.yaml` with `Volumes` and `VolumeMounts` to mount the ConfigMap.

3. **Deployed and Verified:**
   - Installed the updated Helm chart:

     ```bash
     helm upgrade --install app-python ./app-python/
     ```

     Output:

     ```log
     Release "app-python" has been upgraded. Happy Helming!
     NAME: app-python
     LAST DEPLOYED: Sat Mar  8 13:47:34 2025
     NAMESPACE: default
     STATUS: deployed
     REVISION: 3
     NOTES:
     1. Get the application URL by running these commands:
       export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python" -o jsonpath="{.items[0].metadata.name}")
       export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
       echo "Visit http://127.0.0.1:8080 to use your application"
       kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
     ```

   - Verified the deployment:

     ```bash
     kubectl get po
     ```

     Output:

     ```log
     NAME                          READY   STATUS    RESTARTS   AGE
     app-python-64448d9c7f-sk5dq   1/1     Running   0          83s
     ```

   - Checked the ConfigMap:

     ```bash
     kubectl get configmaps
     ```

     Output:

     ```log
     NAME               DATA   AGE
     flask-config       1      6m18s
     kube-root-ca.crt   1      12m
     ```

   - Described the ConfigMap:

     ```bash
     kubectl describe configmaps flask-config
     ```

     Output:

     ```log
     Name:         flask-config
     Namespace:    default
     Labels:       app.kubernetes.io/managed-by=Helm
     Annotations:  meta.helm.sh/release-name: app-python
                   meta.helm.sh/release-namespace: default

     Data
     ====
     config.json:
     ----
     {
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

   - Verified the ConfigMap inside the pod:

     ```bash
     kubectl exec app-python-64448d9c7f-sk5dq -- cat /config/config.json
     ```

     Output:

     ```log
     {
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

   - Described the pod:

     ```bash
     kubectl describe po app-python-64448d9c7f-sk5dq
     ```

     Output:

     ```log
     Name:             app-python-64448d9c7f-sk5dq
     Namespace:        default
     Priority:         0
     Service Account:  app-python
     Node:             minikube/192.168.49.2
     Start Time:       Sat, 08 Mar 2025 13:47:34 +0300
     Labels:           app.kubernetes.io/instance=app-python
                       app.kubernetes.io/managed-by=Helm
                       app.kubernetes.io/name=app-python
                       app.kubernetes.io/version=1.16.0
                       helm.sh/chart=app-python-0.1.0
                       pod-template-hash=64448d9c7f
     Annotations:      <none>
     Status:           Running
     IP:               10.244.0.7
     IPs:
       IP:           10.244.0.7
     Controlled By:  ReplicaSet/app-python-64448d9c7f
     Containers:
       app-python:
         Container ID:   docker://63c57b54141ca09ca9e722273894b4b03a5f3a1b40252847c37e6334d764f91b
         Image:          ali12hamdan/app_python:app_python-prod-1.0.0
         Image ID:       docker-pullable://ali12hamdan/app_python@sha256:c84d12612850739a39f1da7e55aedb9e1c92a00c5d320d2bf47f3ac358e78df2
         Port:           5000/TCP
         Host Port:      0/TCP
         State:          Running
           Started:      Sat, 08 Mar 2025 13:47:35 +0300
         Ready:          True
         Restart Count:  0
         Limits:
           cpu:     500m
           memory:  100Mi
         Requests:
           cpu:      500m
           memory:   50Mi
         Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
         Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
         Environment:
           NAME:   Ali Hamdan
           EMAIL:  al.hamdan@innopolis.university
         Mounts:
           /config/config.json from flask-volume (ro,path="config.json")
           /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-9klpr (ro)
     Conditions:
       Type                        Status
       PodReadyToStartContainers   True 
       Initialized                 True 
       Ready                       True 
       ContainersReady             True 
       PodScheduled                True 
     Volumes:
       flask-volume:
         Type:      ConfigMap (a volume populated by a ConfigMap)
         Name:      flask-config
         Optional:  false
       kube-api-access-9klpr:
         Type:                    Projected (a volume that contains injected data from multiple sources)
         TokenExpirationSeconds:  3607
         ConfigMapName:           kube-root-ca.crt
         ConfigMapOptional:       <nil>
         DownwardAPI:             true
     QoS Class:                   Burstable
     Node-Selectors:              <none>
     Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                                  node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
     Events:
       Type     Reason     Age                From               Message
       ----     ------     ----               ----               -------
       Normal   Scheduled  16m                default-scheduler  Successfully assigned default/app-python-64448d9c7f-sk5dq to minikube
       Normal   Pulled     16m                kubelet            Container image "ali12hamdan/app_python:app_python-prod-1.0.0" already present on machine
       Normal   Created    16m                kubelet            Created container: app-python
       Normal   Started    16m                kubelet            Started container app-python
       Warning  Unhealthy  16m (x2 over 16m)  kubelet            Readiness probe failed: Get "http://10.244.0.7:5000/": dial tcp 10.244.0.7:5000: connect: connection refused
     ```

---

## Bonus Task: ConfigMap via Environment Variables (Go App)

1. **Upgraded the Go App:**
   - Implemented persistence logic in the Go application.

2. **Deployed the Go App:**
   - Installed the updated Helm chart for the Go app:

     ```bash
     helm upgrade --install app-go ./app-go/
     ```

     Output:

     ```log
     Release "app-go" has been upgraded. Happy Helming!
     NAME: app-go
     LAST DEPLOYED: Sat Mar  8 17:28:09 2025
     NAMESPACE: default
     STATUS: deployed
     REVISION: 2
     NOTES:
     1. Get the application URL by running these commands:
       export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-go,app.kubernetes.io/instance=app-go" -o jsonpath="{.items[0].metadata.name}")
       export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
       echo "Visit http://127.0.0.1:8080 to use your application"
       kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
     ```

   - Verified the deployment:

     ```bash
     kubectl get po
     ```

     Output:

     ```log
     NAME                          READY   STATUS    RESTARTS   AGE
     app-go-69665c7766-sctpl       1/1     Running   0          109m
     app-python-64448d9c7f-sk5dq   1/1     Running   0          3h40m
     ```

   - Checked the ConfigMap:

     ```bash
     kubectl get configmaps
     ```

     Output:

     ```log
     NAME               DATA   AGE
     flask-config       1      3h53m
     go-config          1      110m
     kube-root-ca.crt   1      3h59m
     ```

   - Described the ConfigMap:

     ```bash
     kubectl describe configmaps go-config
     ```

     Output:

     ```log
     Name:         go-config
     Namespace:    default
     Labels:       app.kubernetes.io/managed-by=Helm
     Annotations:  meta.helm.sh/release-name: app-go
                   meta.helm.sh/release-namespace: default

     Data
     ====
     config.json:
     ----
     {
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

   - Verified the ConfigMap inside the pod:

     ```bash
     kubectl exec app-go-69665c7766-sctpl -- cat /config/config.json
     ```

     Output:

     ```log
     {
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

   - Described the pod:

     ```bash
     kubectl describe po app-go-69665c7766-sctpl
     ```

     Output:

     ```log
     Name:             app-go-69665c7766-sctpl
     Namespace:        default
     Priority:         0
     Service Account:  app-go
     Node:             minikube/192.168.49.2
     Start Time:       Sat, 08 Mar 2025 15:38:30 +0300
     Labels:           app.kubernetes.io/instance=app-go
                       app.kubernetes.io/managed-by=Helm
                       app.kubernetes.io/name=app-go
                       app.kubernetes.io/version=1.16.0
                       helm.sh/chart=app-go-0.1.0
                       pod-template-hash=69665c7766
     Annotations:      <none>
     Status:           Running
     IP:               10.244.0.9
     IPs:
       IP:           10.244.0.9
     Controlled By:  ReplicaSet/app-go-69665c7766
     Containers:
       app-go:
         Container ID:   docker://36c58926daddababd2797992ca119b524fa2ddbd009ef09b9abb4208adaccc3b
         Image:          ali12hamdan/app_go:app_go-prod-1.0.0
         Image ID:       docker-pullable://ali12hamdan/app_go@sha256:746d2ab8d19d1baf555e6847bbfba371a3360c065b6ecec6a7bab4279fd2ff30
         Port:           3000/TCP
         Host Port:      0/TCP
         State:          Running
           Started:      Sat, 08 Mar 2025 15:41:41 +0300
         Ready:          True
         Restart Count:  0
         Limits:
           cpu:     500m
           memory:  100Mi
         Requests:
           cpu:      500m
           memory:   50Mi
         Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
         Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
         Environment:
           NAME:   Ali Hamdan
           EMAIL:  al.hamdan@innopolis.university
         Mounts:
           /config/config.json from go-volume (ro,path="config.json")
           /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-pws24 (ro)
     Conditions:
       Type                        Status
       PodReadyToStartContainers   True 
       Initialized                 True 
       Ready                       True 
       ContainersReady             True 
       PodScheduled                True 
     Volumes:
       go-volume:
         Type:      ConfigMap (a volume populated by a ConfigMap)
         Name:      go-config
         Optional:  false
       kube-api-access-pws24:
         Type:                    Projected (a volume that contains injected data from multiple sources)
         TokenExpirationSeconds:  3607
         ConfigMapName:           kube-root-ca.crt
         ConfigMapOptional:       <nil>
         DownwardAPI:             true
     QoS Class:                   Burstable
     Node-Selectors:              <none>
     Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                                  node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
     Events:                      <none>
     ```

3. **ConfigMap via Environment Variables:**
   - Used the `envFrom` property to inject ConfigMap data as environment variables.
   - Verified the environment variables inside the container:

     ```bash
     kubectl exec app-go-69665c7766-sctpl -- env
     ```

     Output:

     ```log
     PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
     HOSTNAME=app-go-69665c7766-sctpl
     config.json={
         "first_name": "Ali",
         "last_name": "Hamdan",
         "email": "al.hamdan@innopolis.university"
     }
     ```

---