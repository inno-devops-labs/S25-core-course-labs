# Lab 12: Kubernetes ConfigMaps

## Task 1: Upgrade Application for Persistence

### Application Modifications

I've updated the Moscow Time application to implement persistence with a visit counter:

1. Added visit counter logic to track page visits
2. Created a new `/visits` endpoint to display the count
3. Modified the UI to show the visit count on the main page
4. Implemented file-based persistence with the `visits` file

Key code modifications:

```python
# Path to the visits file
VISITS_DIR = Path('/app/app/visits')
VISITS_FILE = VISITS_DIR / "visits_count.txt"

def get_visit_count():
    """Get the current visit count from the file"""
    if not os.path.exists(VISITS_FILE):
        return 0
    
    try:
        with open(VISITS_FILE, "r") as f:
            content = f.read().strip()
            return int(content) if content else 0
    except (IOError, ValueError):
        return 0

def increment_visit_count():
    """Increment the visit count and save it to the file"""
    count = get_visit_count() + 1
    
    try:
        with open(VISITS_FILE, "w") as f:
            f.write(str(count))
        return count
    except IOError:
        return count
```

### Docker Setup

I've updated the `docker-compose.yml` to include a volume for persisting the visits file:

```yaml
volumes:
  - ./visits_data:/app/app/visits
```

Verification of persistence:
```bash
# Check initial count (I've accessed site few times previously)
$ curl http://localhost:8000/visits
{"visits":2}

# Restart container
$ docker-compose down
$ docker-compose up -d

# Verify count persists
$ curl http://localhost:8000/visits
{"visits":2}
```

## Task 2: ConfigMap Implementation

### Config File Creation

Created a `config.json` file in the Helm chart's `files` folder with the following content:

```json
{
  "app": {
    "name": "Moscow Time App",
    "version": "1.0.0",
    "description": "A simple web application displaying current Moscow time"
  },
  "settings": {
    "timeFormat": "HH:MM:SS",
    "timezone": "Europe/Moscow",
    "refreshRate": 1000,
    "showVisitCounter": true,
    "maxVisitsToStore": 1000000
  },
  "api": {
    "endpoints": {
      "time": "/time",
      "visits": "/visits"
    }
  },
  "logging": {
    "level": "info",
    "format": "json",
    "file": "/logs/app.log"
  }
}
```

### ConfigMap Creation

Created a `configmap.yaml` template in the Helm chart:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "moscow-time-app.fullname" . }}-config
  labels:
    {{- include "moscow-time-app.labels" . | nindent 4 }}
data:
  config.json: |
    {
      "app": {
        "name": "Moscow Time App",
        "version": "1.0.0",
        "description": "A simple web application displaying current Moscow time"
      },
      "settings": {
        "timeFormat": "HH:MM:SS",
        "timezone": "Europe/Moscow",
        "refreshRate": 1000,
        "showVisitCounter": true,
        "maxVisitsToStore": 1000000
      },
      "api": {
        "endpoints": {
          "time": "/time",
          "visits": "/visits"
        }
      },
      "logging": {
        "level": "info",
        "format": "json",
        "file": "/logs/app.log"
      }
    }
```

### Mounting ConfigMap in Deployment

Modified the `deployment.yaml` to mount the ConfigMap:

```yaml
volumeMounts:
  - name: config-volume
    mountPath: /config
  - name: visits-volume
    mountPath: /app/app/visits

volumes:
  - name: config-volume
    configMap:
      name: {{ include "moscow-time-app.fullname" . }}-config
  - name: visits-volume
    emptyDir: {}
```

### Verification

The ConfigMap was successfully created and mounted:

```bash
$ kubectl get configmap moscow-time-app-config
NAME                     DATA   AGE
moscow-time-app-config   1      10m
```

Verifying the content is accessible in the pod:

```bash
$ kubectl exec -it moscow-time-app-88f4f5c76-7tdnk -c moscow-time-app -- cat /config/config.json
{
  "app": {
    "name": "Moscow Time App",
    "version": "1.0.0",
    "description": "A simple web application displaying current Moscow time"
  },
  "settings": {
    "timeFormat": "HH:MM:SS",
    "timezone": "Europe/Moscow",
    "refreshRate": 1000,
    "showVisitCounter": true,
    "maxVisitsToStore": 1000000
  },
  "api": {
    "endpoints": {
      "time": "/time",
      "visits": "/visits"
    }
  },
  "logging": {
    "level": "info",
    "format": "json",
    "file": "/logs/app.log"
  }
}
```

## Challenges Encountered

1. **File Permissions**: When implementing the persistent counter, there were issues with file permissions in the Docker container. The solution was to modify the Docker Compose configuration to ensure the mounted volume had proper permissions

2. **ConfigMap Mounting**: Initially tried to mount the ConfigMap using `subPath` which caused empty files. Changed to mounting the ConfigMap as a directory instead which resolved the issue