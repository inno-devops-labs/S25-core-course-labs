# Lab 12: Kubernetes ConfigMaps

## Application Enhancement for Persistence

For this lab, I upgraded my Moscow Time application to include visit tracking functionality:

1. Added a counter logic that increments each time the root endpoint is accessed
2. Created a visits file to persist the counter between pod restarts
3. Added a new `/visits` endpoint to display the total number of visits

### Implementation Details

The visit counter works by:
1. Reading the current count from the `visits` file
2. Incrementing the count by 1
3. Writing the updated count back to the file
4. Exposing the count via a new `/visits` endpoint

## ConfigMap Implementation

### Creating the ConfigMap

I created a JSON configuration file with application settings in `files/config.json`:

```json
{
  "app_name": "Moscow Time App",
  "display_timezone": "Europe/Moscow",
  "show_date": true,
  "refresh_interval": 1000,
  "app_version": "1.2.0",
  "debug_mode": false,
  "log_level": "info",
  "default_theme": "light",
  "available_themes": ["light", "dark", "blue"],
  "api_endpoints": {
    "time": "/get_time",
    "visits": "/visits"
  }
}
```

### Configuring the Helm Chart

1. Added a ConfigMap template in `templates/configmap.yaml` that:
   - Creates a ConfigMap with the application name
   - Uses `.Files.Get` to extract data from the config.json file

2. Updated the Deployment template to:
   - Mount the ConfigMap as a volume
   - Mount an emptyDir volume for the visits file
   - Make these available to the application container

### Verification Commands and Results

```bash
# Getting list of pods
$ kubectl get po
NAME                              READY   STATUS    RESTARTS   AGE
moscow-time-app-f8d49c6b7-2xpnv   1/1     Running   0          3m45s

# Checking the ConfigMap inside the pod
$ kubectl exec moscow-time-app-f8d49c6b7-2xpnv -- cat /app/config.json
{
  "app_name": "Moscow Time App",
  "display_timezone": "Europe/Moscow",
  "show_date": true,
  "refresh_interval": 1000,
  "app_version": "1.2.0",
  "debug_mode": false,
  "log_level": "info",
  "default_theme": "light",
  "available_themes": ["light", "dark", "blue"],
  "api_endpoints": {
    "time": "/get_time",
    "visits": "/visits"
  }
}

# Testing the visits counter
$ kubectl exec moscow-time-app-f8d49c6b7-2xpnv -- cat /app/visits
15

# After accessing the application a few more times
$ kubectl exec moscow-time-app-f8d49c6b7-2xpnv -- cat /app/visits
18
```

### Testing Persistence Across Pod Restarts

I deleted the pod to verify that the ConfigMap remains intact:

```bash
$ kubectl delete pod moscow-time-app-f8d49c6b7-2xpnv
pod "moscow-time-app-f8d49c6b7-2xpnv" deleted

$ kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
moscow-time-app-f8d49c6b7-9tjz4   1/1     Running   0          28s

# Checking ConfigMap in the new pod
$ kubectl exec moscow-time-app-f8d49c6b7-9tjz4 -- cat /app/config.json
{
  "app_name": "Moscow Time App",
  "display_timezone": "Europe/Moscow",
  "show_date": true,
  "refresh_interval": 1000,
  "app_version": "1.2.0",
  "debug_mode": false,
  "log_level": "info",
  "default_theme": "light",
  "available_themes": ["light", "dark", "blue"],
  "api_endpoints": {
    "time": "/get_time",
    "visits": "/visits"
  }
}

$ kubectl exec moscow-time-app-f8d49c6b7-9tjz4 -- cat /app/visits
3
```