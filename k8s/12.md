# 12.md

## Task 1: Persistent Counter via Docker Compose

### 1. Description
We updated the Python Flask application to maintain a persistent counter in a file named `visits`. Each time a user visits the root endpoint, the application increments the counter in `/app/data/visits`. A new endpoint `/visits` displays the current visit count.

### 2. docker-compose.yml

```yaml
version: "3.8"

services:
  app_python:
    build:
      context: ../app_python
      dockerfile: Dockerfile
    container_name: app_python
    ports:
      - "5001:5001"
    volumes:
      - ./data:/app/data
```
This volume maps the host’s ./data folder to /app/data inside the container, ensuring the visits file persists locally.

## Task 2: ConfigMap via Environment Variables and Mounted File
### 1. `files/config.json`
```
{
  "port": 4567,
  "isProd": false,
  "mode": "test"
}
```
### 2. `templates/configmap.yaml`
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: python-app-config
data:
  config.json: |
    {{ .Files.Get "files/config.json" | nindent 4 }}
```
### 3. Deployment Configuration
- Added `envFrom` in `deployment.yaml`
  ```
  envFrom:
    - configMapRef:
        name: python-app-config
  ```
  With this, the ConfigMap’s keys become environment variables. In the example above, the key is `config.json`. Since it’s a single key containing multiline data, you see `config.json=` plus the JSON content when running `printenv`.
- Mount as File. Added in `values.yaml`
    ```
    volumes:
      - name: config
        configMap:
          name: python-app-config
          items:
            - key: config.json
              path: config.json
    
    volumeMounts:
      - name: config
        mountPath: /config.json
        subPath: config.json
    ```
  This ensures the same `config.json` is available as a file at `/config.json`.
### 4. Verification Commands and Outputs
1. **Check Pods**
   `kubectl get po`  
   Output:
    ```
    andrew@Andrews-MacBook-Pro golang-app % kubectl get po
    NAME                                    READY   STATUS    RESTARTS   AGE
    golang-app-54c5c694b6-ckvn9             1/1     Running   0          26s
    python-app-59bdffddd-cr697              1/1     Running   0          15m
    vault-0                                 1/1     Running   0          19h
    vault-agent-injector-66f45b5fd5-rdncj   1/1     Running   0          19h
    ```
2. **Environment Variables**  
    `kubectl exec python-app-59bdffddd-cr697 -- printenv`
    ```
    andrew@Andrews-MacBook-Pro golang-app % kubectl exec python-app-59bdffddd-cr697 -- printenv
    PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    HOSTNAME=python-app-59bdffddd-cr697
    flight=aviasales
    config.json=
    {
      "port": 4567,
      "isProd": false,
      "mode": "test",
    }
    
    gpt_key=hahahuman
    my-pass=supersecret123
    api-key=nokia3310
    KUBERNETES_PORT=tcp://10.96.0.1:443
    KUBERNETES_PORT_443_TCP_PROTO=tcp
    PYTHON_APP_SERVICE_HOST=10.98.167.230
    PYTHON_APP_PORT_5001_TCP=tcp://10.98.167.230:5001
    VAULT_SERVICE_HOST=10.104.110.68
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
    KUBERNETES_SERVICE_PORT_HTTPS=443
    KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
    VAULT_PORT=tcp://10.104.110.68:8200
    VAULT_PORT_8201_TCP_PROTO=tcp
    VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
    VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.110.10.101:443
    PYTHON_APP_SERVICE_PORT=5001
    PYTHON_APP_SERVICE_PORT_HTTP=5001
    PYTHON_APP_PORT=tcp://10.98.167.230:5001
    PYTHON_APP_PORT_5001_TCP_PORT=5001
    VAULT_SERVICE_PORT=8200
    KUBERNETES_SERVICE_HOST=10.96.0.1
    KUBERNETES_SERVICE_PORT=443
    PYTHON_APP_PORT_5001_TCP_PROTO=tcp
    VAULT_PORT_8200_TCP_PROTO=tcp
    VAULT_PORT_8201_TCP_ADDR=10.104.110.68
    KUBERNETES_PORT_443_TCP_PORT=443
    PYTHON_APP_PORT_5001_TCP_ADDR=10.98.167.230
    VAULT_PORT_8201_TCP_PORT=8201
    KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
    VAULT_PORT_8200_TCP=tcp://10.104.110.68:8200
    VAULT_PORT_8200_TCP_PORT=8200
    VAULT_PORT_8200_TCP_ADDR=10.104.110.68
    VAULT_PORT_8201_TCP=tcp://10.104.110.68:8201
    VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.110.10.101:443
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.110.10.101
    VAULT_SERVICE_PORT_HTTP=8200
    VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.110.10.101
    VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
    LANG=C.UTF-8
    GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
    PYTHON_VERSION=3.11.9
    PYTHON_PIP_VERSION=24.0
    PYTHON_SETUPTOOLS_VERSION=65.5.1
    PYTHON_GET_PIP_URL=https://github.com/pypa/get-pip/raw/dbf0c85f76fb6e1ab42aa672ffca6f0a675d9ee4/public/get-pip.py
    PYTHON_GET_PIP_SHA256=dfe9fd5c28dc98b5ac17979a953ea550cec37ae1b47a5116007395bfacff2ab9
    HOME=/home/appuser
    ```
3. **Mounted File**  
   `kubectl exec python-app-59bdffddd-cr697 -- cat /config.json`
    ```
    andrew@Andrews-MacBook-Pro golang-app % kubectl exec python-app-59bdffddd-cr697 -- cat /config.json
    
    {
      "port": 4567,
      "isProd": false,
      "mode": "test",
    }
    ```
   Confirms the same JSON content is available in the container’s filesystem.
4. **Bonus Application**
    ```
    andrew@Andrews-MacBook-Pro golang-app % kubectl exec golang-app-54c5c694b6-ckvn9 -- printenv
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    HOSTNAME=golang-app-54c5c694b6-ckvn9
    config.json=
    {
      "port": 4567,
      "isProd": false,
      "mode": "test",
    }
    
    my-pass=supersecret123
    api-key=nokia3310
    flight=aviasales
    GOLANG_APP_PORT_8080_TCP_ADDR=10.108.251.123
    KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
    KUBERNETES_PORT_443_TCP_PORT=443
    PYTHON_APP_PORT_5001_TCP_PORT=5001
    VAULT_SERVICE_HOST=10.104.110.68
    VAULT_PORT_8200_TCP_PORT=8200
    KUBERNETES_SERVICE_HOST=10.96.0.1
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
    GOLANG_APP_PORT_8080_TCP_PORT=8080
    PYTHON_APP_SERVICE_PORT_HTTP=5001
    PYTHON_APP_PORT_5001_TCP_PROTO=tcp
    VAULT_SERVICE_PORT_HTTP=8200
    VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
    VAULT_PORT=tcp://10.104.110.68:8200
    VAULT_PORT_8201_TCP=tcp://10.104.110.68:8201
    GOLANG_APP_SERVICE_HOST=10.108.251.123
    GOLANG_APP_SERVICE_PORT=8080
    VAULT_PORT_8201_TCP_PROTO=tcp
    VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.110.10.101:443
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.110.10.101
    VAULT_PORT_8201_TCP_ADDR=10.104.110.68
    GOLANG_APP_SERVICE_PORT_HTTP=8080
    GOLANG_APP_PORT=tcp://10.108.251.123:8080
    GOLANG_APP_PORT_8080_TCP=tcp://10.108.251.123:8080
    GOLANG_APP_PORT_8080_TCP_PROTO=tcp
    PYTHON_APP_PORT=tcp://10.98.167.230:5001
    PYTHON_APP_PORT_5001_TCP=tcp://10.98.167.230:5001
    VAULT_SERVICE_PORT=8200
    VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.110.10.101
    KUBERNETES_PORT=tcp://10.96.0.1:443
    VAULT_PORT_8200_TCP_ADDR=10.104.110.68
    VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
    KUBERNETES_SERVICE_PORT=443
    KUBERNETES_PORT_443_TCP_PROTO=tcp
    KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
    PYTHON_APP_SERVICE_HOST=10.98.167.230
    PYTHON_APP_SERVICE_PORT=5001
    VAULT_PORT_8200_TCP=tcp://10.104.110.68:8200
    VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.110.10.101:443
    KUBERNETES_SERVICE_PORT_HTTPS=443
    PYTHON_APP_PORT_5001_TCP_ADDR=10.98.167.230
    VAULT_PORT_8200_TCP_PROTO=tcp
    VAULT_PORT_8201_TCP_PORT=8201
    VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
    HOME=/home/appuser
    andrew@Andrews-MacBook-Pro golang-app % kubectl exec golang-app-54c5c694b6-ckvn9 -- cat /config.json
    
    {
      "port": 4567,
      "isProd": false,
      "mode": "test",
    }
    ```
   
