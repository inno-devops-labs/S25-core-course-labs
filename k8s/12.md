# Lab 12: Application Persistence and ConfigMap Implementation

## Task 1: Upgrade Application for Persistence

### **Application Modifications**
- Implemented a counter logic to track the number of times `/` (main) page is accessed
- Counter number is being saved into `app_data/visits.txt` file which is mounted on the host machine to `app_python/app_data/visits.txt`
- Endpoint `/visits` is introduced to check the current number of counted visits

### **Testing and Verification**
0. **Updated FastAPI web app to create new endpoint**:
    ```python
    def read_visits():
    """Read the visit count from the file"""
    if not os.path.exists(VISITS_FILE):
        return 0
    try:
        with open(VISITS_FILE, "r") as f:
            return int(f.read().strip())
    except ValueError:
        return 0

    def write_visits(count):
        """Write the updated visit count to the file"""
        with open(VISITS_FILE, "w") as f:
            f.write(str(count))


    @app.get("/visits")
    def get_visits():
        """Endpoint to retrieve the visit count"""
        visit_count = read_visits()
        return {"visits": visit_count}
    ```
1. **Updated `docker-compose.yml` to include a new volume**:
    ```yaml
    services:
      fastapi_app:
        image: iucd/fastapi-mt:latest
        container_name: fastapi-mt
        user: "1000:1000"
        ports:
          - "8000:8000"
        environment:
          - LOG_LEVEL=info
        command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
        volumes:
          - ./app_data:/app_data
        restart: unless-stopped
    ```
2. **Verified enhancements**:
    - Accessed the application multiple times.
    - Checked `visits` persistence:
    ```sh
    $ curl http://localhost:8000/visits
    {"visits":1}
    $ curl http://localhost:8000
    $ curl http://localhost:8000/visits
    {"visits":2}

    $ docker-compose down
    $ docker-compose up -d

    $ curl http://localhost:8000/visits
    {"visits":2}
    ```

3. **Updated `README.md`**

---

## Task 2: ConfigMap Implementation

### **Config File Creation and Mounting**
1. **Created `k8s/fastapi-mt/files/config.json`**:
    ```json
    {
        "app": {
        "name": "Moscow Time App",
        "version": "1.0.0",
        "description": "FastAPI-based web application displaying current Moscow time"
        },
        "logging": {
        "level": "info",
        "format": "json",
        "file": "/var/log/app_logs/python_app.log"
        }
    }
    ```

2. **ConfigMap Manifest (`k8s/fastapi-mt/templates/configMap.yaml`)**:
    ```yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: test-config
    data:
      config.json: |
        {{ .Files.Get "files/config.json" | nindent 4 }}
    ```

3. **Updated `deployment.yaml` with Volumes and VolumeMounts**:
    ```yaml
    # ...
    volumes:
        - name: config-volume
          configMap:
            name: test-config
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    #...

    containers:
      - name: {{ .Chart.Name }}
      # ...
        volumeMounts:
            - name: config-volume
              mountPath: /config.json
              subPath: config.json
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
    ```

### **Helm Installation and Verification**
1. **Installed (upgraded) Helm chart**:
    ```sh
    helm upgrade --install test ./k8s/fastapi-mt
    ```
2. **Verified deployment & ConfigMap inside the pod**:
    ```sh
    kubectl get configmap test-config -o yaml
    kubectl get po
    kubectl exec test-fastapi-mt-7bb4b59bcf-t6lkh -- can /config.json
    ```
    Output:
    ![alt text](assets/images-12/image.png)