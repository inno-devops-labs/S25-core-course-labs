# Kubernetes ConfigMaps

## Task 1: Upgrade Application for Persistence

### Application Changes

The application has been upgraded to implement visit tracking functionality with the following modifications:

1. Added a `/visits` endpoint to display the number of visits
2. Implemented a counter that increments on each `/time` endpoint access
3. Created persistence by saving the counter to a file
4. Added volume mounting in docker-compose.yml for local development

### Implementation Details

The visit counter works by reading from and writing to a file named `visits` that is mounted as a volume. This ensures that the count persists across container restarts.

Key code additions:
```python
# File to store visit count
VISITS_FILE = "visits"

def get_visit_count():
    """Get the current visit count from the file."""
    try:
        if os.path.exists(VISITS_FILE):
            with open(VISITS_FILE, "r") as f:
                return int(f.read().strip() or "0")
        return 0
    except Exception:
        return 0

def save_visit_count(count):
    """Save the visit count to the file."""
    try:
        with open(VISITS_FILE, "w") as f:
            f.write(str(count))
    except Exception as e:
        print(f"Error saving visit count: {e}")

@app.get("/visits")
def get_visits():
    """Return the current visit count."""
    count = get_visit_count()
    return {"visits": count}
```

## Task 2: ConfigMap Implementation

### ConfigMap Creation

1. Created a `files` folder with a `config.json` file:

```json
{
  "app_name": "Moscow Time API",
  "version": "1.2.0",
  "description": "API that shows the current time in Moscow with visit tracking",
  "logging": {
    "level": "INFO",
    "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  },
  "features": {
    "visits_tracking": true,
    "metrics_enabled": true,
    "response_time_tracking": true
  },
  "timeouts": {
    "read_timeout": 5,
    "connect_timeout": 3
  }
}
```

2. Created a ConfigMap template in `templates/configmap.yaml`:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "moscow-time.fullname" . }}-config
  labels:
    {{- include "moscow-time.labels" . | nindent 4 }}
data:
  config.json: |-
{{ .Files.Get "files/config.json" | indent 4 }}
```

3. Updated `deployment.yaml` to mount the ConfigMap:

```yaml
volumeMounts:
  - name: config-volume
    mountPath: /app/config

volumes:
  - name: config-volume
    configMap:
      name: {{ include "moscow-time.fullname" . }}-config
```

### Persistence Configuration

1. Added persistence configuration to `values.yaml`:

```yaml
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 1Gi
```

2. Created a PVC template for storing visits data:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "moscow-time.fullname" . }}-visits-pvc
spec:
  accessModes:
    - {{ .Values.persistence.accessMode | quote }}
  resources:
    requests:
      storage: {{ .Values.persistence.size | quote }}
```

### Verification

After deploying the application, we can verify the ConfigMap implementation:

```bash
# Get the pod name
kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
moscow-time-7744598b7c-49r9c            2/2     Running   0          4s
vault-0                                 1/1     Running   0          36m
vault-agent-injector-66f45b5fd5-hjsjv   1/1     Running   0          36m

# Check if ConfigMap is mounted
kubectl exec moscow-time-7744598b7c-49r9c -c moscow-time -- ls -la /app/config
total 8
drwxrwxrwx    1 root     root            98 Mar  8 11:05 .
drwxr-xr-x    1 root     root            24 Mar  8 11:05 ..
drwxr-xr-x    1 root     root            22 Mar  8 11:05 ..2025_03_08_11_05_30.3908821520
lrwxrwxrwx    1 root     root            32 Mar  8 11:05 ..data -> ..2025_03_08_11_05_30.3908821520
lrwxrwxrwx    1 root     root            18 Mar  8 11:05 config.json -> ..data/config.json

# View the content of the config.json file
kubectl exec moscow-time-7744598b7c-49r9c -c moscow-time -- cat /app/config/config.json
{
  "app_name": "Moscow Time API",
  "version": "1.2.0",
  "description": "API that shows the current time in Moscow with visit tracking",
  "logging": {
    "level": "INFO",
    "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  },
  "features": {
    "visits_tracking": true,
    "metrics_enabled": true,
    "response_time_tracking": true
  },
  "timeouts": {
    "read_timeout": 5,
    "connect_timeout": 3
  }
}

# Check if the visits volume is mounted
kubectl exec moscow-time-7744598b7c-49r9c -c moscow-time -- ls -la /app
total 8
drwxr-xr-x    1 root     root            24 Mar  8 11:05 .
drwxr-xr-x    1 root     root            22 Mar  8 11:05 ..
-rw-r--r--    1 root     root           563 Feb 18 21:23 app.py
drwxrwxrwx    1 root     root            98 Mar  8 11:05 config
-rw-r--r--    1 root     root            78 Feb 18 21:16 requirements.txt
drwxrwxrwx    1 root     root             0 Mar  8 11:05 visits
```

Both the ConfigMap and persistence volume are correctly configured and mounted. The ConfigMap provides application configuration through a config.json file, and the PVC provides persistence for the visit counter. 