# ConfigMaps and persistence

I've created a configmap using Helm and mounted it to main exercise deployment in different ways.

```bash
➜  k8s git:(lab-12) ✗ kubectl get po
NAME      READY   STATUS    RESTARTS      AGE
moscow-time-95578bf5c-dwlmb             2/2     Running   0             28s
moscow-time-95578bf5c-kkfr9             2/2     Running   0             28s
moscow-time-95578bf5c-n9grm             2/2     Running   0             28s
vault-0                                 1/1     Running   1 (23h ago)   24h
vault-agent-injector-66f45b5fd5-fw7wh   1/1     Running   1 (23h ago)   24h
➜  k8s git:(lab-12) ✗ kubectl get configmaps
NAME               DATA   AGE
app-config         1      42s
kube-root-ca.crt   1      7d
➜  k8s git:(lab-12) ✗ kubectl describe configmaps app-config
Name:         app-config
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: moscow-time
              meta.helm.sh/release-namespace: default

Data
====
config.json:
----
{
  "name": "Matvey",
  "surname": "Korinenko"
}


BinaryData
====

Events:  <none>
➜  k8s git:(lab-12) ✗ kubectl exec -it moscow-time-95578bf5c-dwlmb --container moscow-time -- /bin/sh
/app $ cd ..
/ $ ls -a
.           .dockerenv  bin         dev         home        media       opt         root        sbin        sys         usr         vault
..          app         data        etc         lib         mnt         proc        run         srv         tmp         var
/ $ cd data/
/data $ ls -a
.            ..           config.json
/data $ cat config.json
{
  "name": "Matvey",
  "surname": "Korinenko"
}/data $ exit
➜  k8s git:(lab-12) ✗ kubectl describe po moscow-time-95578bf5c-dwlmb
Name:             moscow-time-95578bf5c-dwlmb
Namespace:        default
Priority:         0
Service Account:  internal-app
Node:             minikube/192.168.49.2
Start Time:       Fri, 28 Feb 2025 22:29:09 +0300
Labels:           app.kubernetes.io/instance=moscow-time
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=moscow-time
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=moscow-time-0.1.0
                  pod-template-hash=95578bf5c
Annotations:      vault.hashicorp.com/agent-inject: true
                  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                  vault.hashicorp.com/agent-inject-status: injected
                  vault.hashicorp.com/role: internal-app
Status:           Running
IP:               10.244.1.16
IPs:
  IP:           10.244.1.16
Controlled By:  ReplicaSet/moscow-time-95578bf5c
Init Containers:
  vault-agent-init:
    Container ID:  docker://6835c4d1d9be24694d632de212e4b70b52931bad1ec99d5f29b3aeb3f9370726
    Image:         hashicorp/vault:1.18.1
    Image ID:      docker-pullable://hashicorp/vault@sha256:3580fa352195aa7e76449cb8fadeef6d2f90a454c38982d30cf094e9013be786
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Fri, 28 Feb 2025 22:29:10 +0300
      Finished:     Fri, 28 Feb 2025 22:29:10 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOnRydWUsInBpZF9maWxlIjoiL2hvbWUvdmF1bHQvLnBpZCIsInZhdWx0Ijp7ImFkZHJlc3MiOiJodHRwOi8vdmF1bHQuZGVmYXVsdC5zdmM6ODIwMCJ9LCJ0ZW1wbGF0ZSI6W3siZGVzdGluYXRpb24iOiIvdmF1bHQvc2VjcmV0cy9kYXRhYmFzZS1jb25maWcudHh0IiwiY29udGVudHMiOiJ7eyB3aXRoIHNlY3JldCBcImludGVybmFsL2RhdGEvZGF0YWJhc2UvY29uZmlnXCIgfX17eyByYW5nZSAkaywgJHYgOj0gLkRhdGEgfX17eyAkayB9fToge3sgJHYgfX1cbnt7IGVuZCB9fXt7IGVuZCB9fSIsImxlZnRfZGVsaW1pdGVyIjoie3siLCJyaWdodF9kZWxpbWl0ZXIiOiJ9fSJ9XSwidGVtcGxhdGVfY29uZmlnIjp7ImV4aXRfb25fcmV0cnlfZmFpbHVyZSI6dHJ1ZX19
    Mounts:
      /home/vault from home-init (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-qvx82 (ro)
      /vault/secrets from vault-secrets (rw)
Containers:
  moscow-time:
    Container ID:   docker://e2da7ef53873d9722ecad6a9bf1bec532be55246ff9bda6c2093a0dc4d83ca3b
    Image:          m0t9docker/pyapp:latest
    Image ID:       docker-pullable://m0t9docker/pyapp@sha256:01d57c101f0b561b09a0d31e4b805bd6f82cb5bbd5515619ecbd964ec2cf5c24
    Port:           8000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 28 Feb 2025 22:29:10 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment Variables from:
      app-config  ConfigMap  Optional: false
    Environment:
      ENVIRONMENT:  stage
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-qvx82 (ro)
      /vault/secrets from vault-secrets (rw)
  vault-agent:
    Container ID:  docker://78a2074dba5a05c7e3c4135a87f993e4ed61ecb9b7817a5e877ae683a794621f
    Image:         hashicorp/vault:1.18.1
    Image ID:      docker-pullable://hashicorp/vault@sha256:3580fa352195aa7e76449cb8fadeef6d2f90a454c38982d30cf094e9013be786
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Running
      Started:      Fri, 28 Feb 2025 22:29:10 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOmZhbHNlLCJwaWRfZmlsZSI6Ii9ob21lL3ZhdWx0Ly5waWQiLCJ2YXVsdCI6eyJhZGRyZXNzIjoiaHR0cDovL3ZhdWx0LmRlZmF1bHQuc3ZjOjgyMDAifSwidGVtcGxhdGUiOlt7ImRlc3RpbmF0aW9uIjoiL3ZhdWx0L3NlY3JldHMvZGF0YWJhc2UtY29uZmlnLnR4dCIsImNvbnRlbnRzIjoie3sgd2l0aCBzZWNyZXQgXCJpbnRlcm5hbC9kYXRhL2RhdGFiYXNlL2NvbmZpZ1wiIH19e3sgcmFuZ2UgJGssICR2IDo9IC5EYXRhIH19e3sgJGsgfX06IHt7ICR2IH19XG57eyBlbmQgfX17eyBlbmQgfX0iLCJsZWZ0X2RlbGltaXRlciI6Int7IiwicmlnaHRfZGVsaW1pdGVyIjoifX0ifV0sInRlbXBsYXRlX2NvbmZpZyI6eyJleGl0X29uX3JldHJ5X2ZhaWx1cmUiOnRydWV9fQ==
    Mounts:
      /home/vault from home-sidecar (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-qvx82 (ro)
      /vault/secrets from vault-secrets (rw)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      app-config
    Optional:  false
  kube-api-access-qvx82:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
  home-init:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  home-sidecar:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  vault-secrets:
    Type:        EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:      Memory
    SizeLimit:   <unset>
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  91s                default-scheduler  Successfully assigned default/moscow-time-95578bf5c-dwlmb to minikube
  Normal   Pulled     90s                kubelet            Container image "hashicorp/vault:1.18.1" already present on machine
  Normal   Created    90s                kubelet            Created container: vault-agent-init
  Normal   Started    90s                kubelet            Started container vault-agent-init
  Normal   Pulled     90s                kubelet            Container image "m0t9docker/pyapp:latest" already present on machine
  Normal   Created    90s                kubelet            Created container: moscow-time
  Normal   Started    90s                kubelet            Started container moscow-time
  Normal   Pulled     90s                kubelet            Container image "hashicorp/vault:1.18.1" already present on machine
  Normal   Created    90s                kubelet            Created container: vault-agent
  Normal   Started    90s                kubelet            Started container vault-agent
  Warning  Unhealthy  88s (x2 over 89s)  kubelet            Readiness probe failed: Get "http://10.244.1.16:8000/": dial tcp 10.244.1.16:8000: connect: connection refused
```

The same is done for bonus applications

```bash
➜  S25-core-course-labs git:(lab-12) ✗ kubectl get po
NAME                                    READY   STATUS    RESTARTS      AGE
numbers-app-5659848f96-48qrl            1/1     Running   0             4s
numbers-app-5659848f96-pw8vl            1/1     Running   0             4s
numbers-app-5659848f96-tgdkr            1/1     Running   0             4s
vault-0                                 1/1     Running   1 (24h ago)   25h
vault-agent-injector-66f45b5fd5-fw7wh   1/1     Running   1 (24h ago)   25h
➜  S25-core-course-labs git:(lab-12) ✗ kubectl get configmaps
NAME               DATA   AGE
go-app-config      1      8s
kube-root-ca.crt   1      7d1h
➜  S25-core-course-labs git:(lab-12) ✗ kubectl describe configmaps go-app-config
Name:         go-app-config
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: numbers-app
              meta.helm.sh/release-namespace: default

Data
====
config.json:
----
{
  "language": "go"
}


BinaryData
====

Events:  <none>
➜  S25-core-course-labs git:(lab-12) ✗ kubectl describe po numbers-app-5659848f96-48qrl
Name:             numbers-app-5659848f96-48qrl
Namespace:        default
Priority:         0
Service Account:  numbers-app
Node:             minikube/192.168.49.2
Start Time:       Fri, 28 Feb 2025 23:16:01 +0300
Labels:           app.kubernetes.io/instance=numbers-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=numbers-app
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=numbers-app-0.1.0
                  pod-template-hash=5659848f96
Annotations:      <none>
Status:           Running
IP:               10.244.1.23
IPs:
  IP:           10.244.1.23
Controlled By:  ReplicaSet/numbers-app-5659848f96
Containers:
  numbers-app:
    Container ID:   docker://385822e348be90fa77ea77b011bda11b602fbc6541fdabbb17778e40ccf54360
    Image:          m0t9docker/goapp:latest
    Image ID:       docker-pullable://m0t9docker/goapp@sha256:b08ed14f5d3234a2b12dcd8807bc2b96db4a07193970e8516091067b830cd5ef
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 28 Feb 2025 23:16:01 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment Variables from:
      go-app-config  ConfigMap  Optional: false
    Environment:
      ENVIRONMENT:  stage
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-qnwhp (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      go-app-config
    Optional:  false
  kube-api-access-qnwhp:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Guaranteed
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  85s   default-scheduler  Successfully assigned default/numbers-app-5659848f96-48qrl to minikube
  Normal  Pulled     85s   kubelet            Container image "m0t9docker/goapp:latest" already present on machine
  Normal  Created    85s   kubelet            Created container: numbers-app
  Normal  Started    85s   kubelet            Started container numbers-app
```
