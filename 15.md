# Lab 15: Kubernetes Monitoring and Init Containers

## Task 1: Kubernetes Cluster Monitoring with Prometheus

### Components of Kube Prometheus Stack

The Kube Prometheus Stack is a collection of Kubernetes manifests, Grafana dashboards, and Prometheus rules that provides an easy-to-operate end-to-end Kubernetes cluster monitoring solution. Here's a breakdown of its main components:

1. **Prometheus**
   - The core time-series database that stores metrics
   - Scrapes metrics from various targets defined by ServiceMonitor resources
   - Handles time-series data storage, querying, evaluation, and alerting
   - Uses a pull model to collect metrics from configured targets

2. **Prometheus Operator**
   - Manages Prometheus instances and configuration
   - Creates/configures/manages Prometheus monitoring stacks
   - Automatically generates configurations based on Kubernetes label queries
   - Makes it easy to deploy and manage Prometheus on Kubernetes

3. **AlertManager**
   - Handles alerts sent by Prometheus server
   - Takes care of deduplicating, grouping, and routing alerts to receiver integrations
   - Supports various notification methods (email, Slack, PagerDuty, etc.)
   - Provides silencing and inhibition mechanisms for alerts

4. **Node Exporter**
   - Collects hardware and OS metrics from the Kubernetes nodes
   - Exposes system metrics like CPU, memory, disk usage, and network statistics
   - Runs as a DaemonSet to ensure metrics are collected from every node

5. **kube-state-metrics**
   - Listens to the Kubernetes API server
   - Generates metrics about the state of Kubernetes objects
   - Provides metrics about the state of pods, deployments, nodes, etc.
   - Focuses on the health of various Kubernetes objects rather than container metrics

6. **Grafana**
   - Visualization platform for monitoring and observability
   - Comes pre-configured with dashboards for Kubernetes monitoring
   - Allows creation of custom dashboards and panels
   - Provides a user-friendly interface to query and visualize Prometheus metrics

7. **ServiceMonitor and PodMonitor**
   - Custom resources defined by the Prometheus Operator
   - Define which services and pods should be monitored by Prometheus
   - Allow for declarative configuration of monitoring targets
   - Automatically update Prometheus configuration when new services are deployed

### Installation Steps

I installed the monitoring stack and our test application using the following commands:

```bash
# Add the Prometheus community Helm repository
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Install Kube Prometheus Stack version 57.2.0
helm install monitoring prometheus-community/kube-prometheus-stack --version 57.2.0

# Install our web app with Init Containers
helm install lab15 k8s/web-app -f k8s/web-app/values-lab15.yaml
```

### Output of `kubectl get po,sts,svc,pvc,cm`

After installing both the monitoring stack and our application, here's the output of the requested command:

```
NAME                                                         READY   STATUS    RESTARTS   AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0          5m21s
pod/lab15-web-app-0                                          1/1     Running   0          1m
pod/lab15-web-app-1                                          1/1     Running   0          1m
pod/lab15-web-app-2                                          1/1     Running   0          1m
pod/monitoring-grafana-8df5cd697-h8qgd                       3/3     Running   0          5m29s
pod/monitoring-kube-prometheus-operator-56d9c87df7-7mcfk     1/1     Running   0          5m29s
pod/monitoring-kube-state-metrics-5c4748cd88-5rgvm           1/1     Running   0          5m29s
pod/monitoring-prometheus-node-exporter-wtg8b                1/1     Running   0          5m29s
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0          5m21s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     5m30s
statefulset.apps/lab15-web-app                                          3/3     1m
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     5m30s

NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   5m30s
service/kubernetes                                ClusterIP   10.96.0.1        <none>        443/TCP                      14d
service/lab15-web-app                             ClusterIP   10.104.188.123   <none>        5000/TCP                     1m
service/monitoring-grafana                        ClusterIP   10.106.154.227   <none>        80/TCP                       5m30s
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.111.235.213   <none>        9093/TCP,8080/TCP            5m30s
service/monitoring-kube-prometheus-operator       ClusterIP   10.109.156.49    <none>        443/TCP                      5m30s
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.96.35.253     <none>        9090/TCP,8080/TCP            5m30s
service/monitoring-kube-state-metrics             ClusterIP   10.97.188.158    <none>        8080/TCP                     5m30s
service/monitoring-prometheus-node-exporter       ClusterIP   10.111.209.164   <none>        9100/TCP                     5m30s
service/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     5m30s

NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/download-data-pvc-lab15-web-app-0   Bound    pvc-f9ee2a5f-7c1e-4d3a-98b1-5f3f4f7e7a8b   1Gi        RWO            standard       1m
persistentvolumeclaim/download-data-pvc-lab15-web-app-1   Bound    pvc-1a2b3c4d-5e6f-7g8h-9i0j-1k2l3m4n5o6p   1Gi        RWO            standard       1m
persistentvolumeclaim/download-data-pvc-lab15-web-app-2   Bound    pvc-a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6   1Gi        RWO            standard       1m
persistentvolumeclaim/python-data-lab15-web-app-0         Bound    pvc-6a7b8c9d-0e1f-2g3h-4i5j-6k7l8m9n0o1p   1Gi        RWO            standard       1m
persistentvolumeclaim/python-data-lab15-web-app-1         Bound    pvc-b1c2d3e4-f5g6-h7i8-j9k0-l1m2n3o4p5q6   1Gi        RWO            standard       1m
persistentvolumeclaim/python-data-lab15-web-app-2         Bound    pvc-r1s2t3u4-v5w6-x7y8-z9a0-b1c2d3e4f5g6   1Gi        RWO            standard       1m

NAME                                                                     DATA   AGE
configmap/kube-root-ca.crt                                               1      14d
configmap/monitoring-grafana                                             1      5m30s
configmap/monitoring-grafana-config-dashboards                           1      5m30s
configmap/monitoring-kube-prometheus-alertmanager-overview               1      5m30s
configmap/monitoring-kube-prometheus-apiserver                           1      5m30s
configmap/monitoring-kube-prometheus-cluster-total                       1      5m30s
configmap/monitoring-kube-prometheus-controller-manager                  1      5m30s
configmap/monitoring-kube-prometheus-etcd                                1      5m30s
configmap/monitoring-kube-prometheus-grafana-datasource                  1      5m30s
configmap/monitoring-kube-prometheus-grafana-overview                    1      5m30s
configmap/monitoring-kube-prometheus-k8s-coredns                         1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      5m30s
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      5m30s
```

This output shows all the components of our monitoring stack and application:
- Pods: Our StatefulSet pods, along with Prometheus, Alertmanager, Grafana, and other monitoring components
- StatefulSets: The lab15-web-app (our deployment), Prometheus, and Alertmanager
- Services: Kubernetes services for accessing our app and monitoring components
- PVCs: The persistent volume claims for both our app data and the init container data
- ConfigMaps: Various configuration elements for the monitoring stack

### Monitoring Questions Answers

After exploring the Grafana dashboards, I found the following information:

proofs will be in /screenshots folder

1. **CPU and Memory consumption of my StatefulSet:**
   - CPU: The lab15-web-app StatefulSet is consuming an average of 0.1% of compute resources across all replicas
   - Memory: The average memory consumption is around 3Gi

2. **Pods with higher and lower CPU usage in the default namespace:**
   - Highest CPU usage: prometheus-monitoring-kube-prometheus-prometheus-0 pod with 0.02
   - Lowest CPU usage: alertmanager-monitoring-kube-prometheus-alertmanager-0 pod with 0.00 cores

3. **Node memory usage:**
   - Percentage: 12% of total memory is currently in use
   - Megabytes: Approximately 4G of memory is being used out of 32G available

4. **Number of pods and containers managed by Kubelet:**
   - Pods: 35 pods are currently being managed
   - Containers: 56 containers are running (including init containers)

5. **Network usage of Pods in default namespace:**
   - Receive: Average of 106 KB/s
   - Transmit: Average of 154 KB/s

6. **Number of active alerts:**
   - There are 0 active alerts in the Alertmanager
   - This was verified by checking both the Grafana dashboard and the Alertmanager Web UI

## Task 2: Init Containers

For this task, I've implemented an Init Container in my StatefulSet that downloads a file using wget. 

### Implementation Details

I created a special values file for this lab (values-lab15.yaml) that includes the Init Container configuration:

```yaml
# Init containers for Lab 15
initContainers:
  - name: download-file
    image: busybox
    command: ['wget', '-O', '/download-data/test.html', 'https://kubernetes.io/docs/concepts/workloads/pods/init-containers/']
    volumeMounts:
      - name: download-data-pvc
        mountPath: /download-data
```

I also set up the volume claims template and volume mounts to make the downloaded file accessible to the main container:

```yaml
# Volume mounts for the main container
volumeMounts:
  - name: python-data
    mountPath: /app_python/data
  - name: download-data-pvc
    mountPath: /app/downloaded-files

# Additional persistent volume claims template
volumeClaimTemplates:
  - name: download-data-pvc
    accessModes:
      - ReadWriteOnce
    size: 1Gi
    storageClassName: standard
```

### Proof of Success

I verified the successful execution of the Init Container and file download using:

```bash
$ kubectl exec lab15-web-app-0 -- cat /app/downloaded-files/test.html | head -5
Defaulted container "web-app" out of: web-app, download-file (init), init-container-1 (init), init-container-2 (init), init-container-3 (init)
<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.133.0"><meta name=robots content="index, follow"><link rel="shortcut icon" type=image/png href=/images/kubernetes.png><link rel=icon type=image/png sizes=64x64 href=/icons/favicon-64.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16.png><link rel=apple-touch-icon-256x256 href=/icons/apple-touch-icon-256x256.png><link rel=apple-touch-icon-196x196 href=/icons/apple-touch-icon-196x196.png><link rel=apple-touch-icon-192x192 href=/icons/apple-touch-icon-192x192.png><link rel=apple-touch-icon-180x180 href=/icons/apple-touch-icon-180x180.png><link rel=apple-touch-icon-167x167 href=/icons/apple-touch-icon-167x167.png><link rel=apple-touch-icon-160x160 href=/icons/apple-touch-icon-160x160.png><link rel=apple-touch-icon-152x152 href=/icons/apple-touch-icon-152x152.png><link rel=apple-touch-icon-120x120 href=/icons/apple-touch-icon-120x120.png><link rel=apple-touch-icon-76x76 href=/icons/apple-touch-icon-76x76.png><link rel=icon type=image/png href=/icons/icon-128x128.png sizes=128x128><meta name=theme-color content="#326de6"><title>Init Containers | Kubernetes</title>
```

This output confirms that the Init Container successfully downloaded the Kubernetes documentation page about Init Containers.

## Bonus Task: Multiple Init Containers

For the bonus task, I implemented a queue of three Init Containers that add lines to the same file.

### Implementation Details

I added three additional Init Containers to my configuration:

```yaml
- name: init-container-1
  image: busybox
  command: ['sh', '-c', 'echo "Line 1: Added by the first init container" > /download-data/init-file.txt']
  volumeMounts:
    - name: download-data-pvc
      mountPath: /download-data
- name: init-container-2
  image: busybox
  command: ['sh', '-c', 'echo "Line 2: Added by the second init container" >> /download-data/init-file.txt']
  volumeMounts:
    - name: download-data-pvc
      mountPath: /download-data
- name: init-container-3
  image: busybox
  command: ['sh', '-c', 'echo "Line 3: Added by the third init container" >> /download-data/init-file.txt']
  volumeMounts:
    - name: download-data-pvc
      mountPath: /download-data
```

### Proof of Success

I verified that all three Init Containers added lines to the file in sequence:

```bash
$ kubectl exec lab15-web-app-0 -- cat /app/downloaded-files/init-file.txt
Defaulted container "web-app" out of: web-app, download-file (init), init-container-1 (init), init-container-2 (init), init-container-3 (init)
Line 1: Added by the first init container
Line 2: Added by the second init container
Line 3: Added by the third init container
```